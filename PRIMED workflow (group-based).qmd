---
title: "PRIMED Workflow for Group-Based Review"
author: "Mikkel H. Vembye"
subtitle: ""
date: "`r Sys.Date()`"
format:
  html: 
    keep-md: true
    self-contained: true
    grid: 
      margin-width: 350px
    code-fold: true
    code-summary: "Show the code"
    toc: true
    toc-location: left
pdf-engine: pdflatex
execute: 
  echo: fenced
  warning: false
knitr:
  opts_chunk: 
    fig.pos: "H"
    fig.retina: 2
    cache: FALSE
    R.options:
      knitr.graphics.auto_pdf: true
      width: 100
      knitr.kable.NA: "-"
      dplyr.summarise.inform: FALSE
reference-location: margin
citation-location: margin
bibliography: bibliography.bib  
---

# Introduction 

This document contains all preliminary data analysis for the meta-analyses with dependent effects (PRIMED) in [@Dalgaard2022a]. Below one can inspect the R packages we use for this analysis as well as the data set behind our analyses. 

# Data manipulation

In the following section, we construct all the main variables that are used in the main analysis of the review. 

## R packages
For the exact R package version, see colophon at the bottom of this document. 

```{r set-up}
#| cache: false
#| code-fold: false

# Load packages -----------------------------------------------------------
library(knitr)
library(kableExtra)
library(skimr)
library(janitor)
library(tidyverse)
library(metafor)
library(clubSandwich)
library(fastDummies)  
library(ggrepel)
library(ggExtra)
library(ggridges)
library(MetBrewer)
library(GGally)
```

::: {.panel-tabset}
## Reintegration data


```{r load-reint-data}

reintergation_dat <- 
  readRDS("reintergation_dat.rds") |> 
  mutate(esid = 1:n()) |> 
  select(
    study, eppi_id, esid, N_t, N_c, N_total, inv_sample_size, gt, vgt, Wgt, Wse, 
    prereg_chr, conventional, analysis_plan, Overall, D5, D7, timing
  )

reintergation_dat |> 
  mutate(
    p_val = 2 * ( 1 - pnorm( abs(gt) / sqrt(Wgt) ) )
  ) |> 
  select(
    `Authors (year)` = study, N_t, N_c,
    `Outcome construct` = analysis_plan, gt, vgt, Wgt, Wse, p_val, 
    `No protocol` = conventional, `Overall RoB` = Overall
  ) |> 
  kable(digits=3)  |> 
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    font_size = 10
  ) |> 
  scroll_box(width = "100%", height = "300px", fixed_thead = TRUE)
```

## Mental health data

```{r}
mental_health_dat <- 
  readRDS("mental_health_dat.rds") |> 
  mutate(esid = 1:n()) |> 
  select(
    study, eppi_id, esid, N_t, N_c, N_total, inv_sample_size, gt, vgt, Wgt, Wse, 
    prereg_chr, conventional, analysis_plan, Overall, D5, D7, timing
  )

mental_health_dat |> 
  mutate(
    p_val = 2 * ( 1 - pnorm( abs(gt) / sqrt(Wgt) ) )
  ) |> 
  select(
    `Authors (year)` = study, N_t, N_c,
    `Outcome construct` = analysis_plan, gt, vgt, Wgt, Wse, p_val, 
    `No protocol` = conventional, `Overall RoB` = Overall
  ) |> 
  kable(digits=3)  |> 
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    font_size = 10
  ) |> 
  scroll_box(width = "100%", height = "300px", fixed_thead = TRUE)
```


:::


# Step 1 - Describe the Amount of Data and Dependence Structure
Number of effect size estimates per study


::: {.columns}

::: {.column width="95%"}
```{r es-plot-reint}
#| label: fig-es-hist
#| fig-cap: "Distribution of number of effect size estimates per study for reintegrational outcomes."
#| fig-width: 12
#| fig-height: 8
#| message: false

es_plot_per_study_reint <- 
  reintergation_dat |>
  arrange(desc(study)) |>
  mutate(study = factor(study, unique(study))) |> 
  ggplot(aes(x = study)) +
  geom_bar() +
  scale_y_continuous(breaks = seq(5, 30, by = 5)) + 
  theme_minimal() +
  coord_flip() +
  labs(
    title = "Reintegration",
    x = "Study (42 studies in total)", 
    y = "Number of Effect Size Estimates"
  )

es_plot_per_study_reint
```
:::

::: {.column-margin}
```{r es-plot-mental}
#| label: fig-es-hist2
#| fig-cap: "Distribution of number of effect size estimates per study for mental health outcomes."
#| fig-height: 8
#| message: false

es_plot_per_study_mental <- 
  mental_health_dat |> 
  arrange(desc(study)) |>
  mutate(study = factor(study, unique(study))) |> 
  ggplot(aes(x = study)) +
  geom_bar() +
  scale_y_continuous(breaks = seq(5, 30, by = 5)) + 
  theme_minimal() +
  coord_flip() +
  labs(
    title = "Mental Health",
    x = "Study ID (41 studies in total)", 
    y = "Number of Effect Size Estimates"
  )

es_plot_per_study_mental
```
:::

:::

# Step 2 - Explore Study Characteristics and Potential Moderators




