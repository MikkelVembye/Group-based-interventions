---
title: "Adjusting Selection Bias"
date: "`r Sys.Date()`"
output: 
  html_document:
      number_sections: no
      toc: true
      toc_float: true
      # code_folding: hide
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

rm(list = ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(knitr)
library(kableExtra)

source("plot-functions.R")
load("sim-res.Rdata")

# for graphs with criteria as row facet
yints <- data.frame(criteria = c("Bias", "Coverage"), yint = c(0, 0.95))
yints <- 
  yints |> 
  mutate(criteria = factor(criteria, levels = c("Bias", "Coverage")))

plot_height <- 7
plot_width <- 8
```

- Three research questions
  - How do the univariate adjustment methods perform in the context of meta-analysis with multiple, dependent effect sizes?
  - How do the adaptations work for adjusting selection bias in the context of dependent effect sizes?
  - How do the promising adaptations perform versus the comparison methods?

# Compare WILS for different stopping rules

- $\text{k_stop} = 2, 5, 7$.
- Stanley et al. used $\text{k_stop} = 2$ as the stopping rule.
- Hypothesis: the smaller the $\text{k_stop}$, the more biases.
- The smaller k, larger tau, larger mu, smaller weights, more discrepancies.

```{r}
res_dat %>% 
  filter(method %in% c("UNI_WILS", "MV_WILS")) %>% 
  filter(sel_mechanism == "One-step selection", 
         tau == 0.2, cor_mu == 0.4, method == "UNI_WILS") %>% 
  ggplot(aes(x = wts, y = bias, color = k_stop, group = k_stop)) +
  geom_point() +
  geom_line(aes(linetype = k_stop), linewidth = 0.7) +
  facet_grid(k ~ paste0("mu == ", mu),
             scales = "free_y", labeller = label_parsed) +
  # facet_grid(paste0("tau == ", tau) ~ paste0("mu == ", mu), 
  #            scales = "free_y", labeller = label_parsed) +
  labs(linetype = "") +
  scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                   labels = dropLeadingZero) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") + 
  labs(fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())

res_dat %>% 
  filter(method %in% c("UNI_WILS", "MV_WILS")) %>% 
  filter(sel_mechanism == "One-step selection", 
         tau == 0.2, cor_mu == 0.4, method == "UNI_WILS") %>% 
  ggplot(aes(x = wts, y = rmse, color = k_stop, group = k_stop)) +
  geom_point() +
  geom_line(aes(linetype = k_stop), linewidth = 0.7) +
  facet_grid(k ~ paste0("mu == ", mu),
             scales = "free_y", labeller = label_parsed) +
  # facet_grid(paste0("tau == ", tau) ~ paste0("mu == ", mu), 
  #            scales = "free_y", labeller = label_parsed) +
  labs(linetype = "") +
  scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                   labels = dropLeadingZero) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") + 
  labs(fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())
```

# RQ1: Compare univariate methods

- WILS is less biased than other methods, but tend to under-estimate the true effect when it is large, worsen as selection gets more severe. In scenarios where WILS does not seem working, EK seems like a good option.

- PET-PEESE is sensitive to $\tau$. PET seems to work better for large $\tau$, although not comparable to WILS. WAAP tends to over-estimate.

## PET/PEESE
- $k=30$
- Bias
  - PET is less biased than PEESE for $\mu = 0$, especially for large selection. 
  - PET tends to under-estimate for $\mu = 0.5$ and $\mu = 0.8$ while PEESE is less under-estimated. However, this is sensitive to between-study heterogeneity. 
  - When $\tau = 0.4$, PET seems to be less biased than PEESE. It is also interesting to see that these estimators tend to over-estimate for $\tau = 0.4$.
  
- RMSE: messy
  - PEESE < PET-PEESE < PET

```{r}
# plot the results when k == 30
# bias
plot_SR(dat = dat_uni_pp_one_step |> filter(k == 30), 
        x = wts, y = bias, 
        rowfacet = tau, colfacet = mu)

dat_uni_pp_one_step %>% 
  filter(k == 30) %>% 
  mutate(mu = factor(mu, levels = c(0, 0.2, 0.5, 0.8),
                     labels = c("0.0", "0.2", "0.5", "0.8"))) %>% 
        ggplot(aes(x = wts, y = bias, color = method, group = method, shape = method)) +
        geom_point() +
        geom_line(aes(linetype = method), linewidth = 0.7) +
        facet_grid(paste("tau == ", formatC(tau, format = "f", digits = 1)) ~ 
                     paste("mu == ", mu), 
                   scales = NULL, labeller = "label_parsed") +
        labs(linetype = "", shape = "") +
        scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                         labels = dropLeadingZero)

# rmse
plot_SR(dat = dat_uni_pp_one_step |> filter(k == 30), 
        x = wts, y = rmse, 
        rowfacet = tau, colfacet = mu, scale = TRUE)

# CI
plot_SR(dat = dat_uni_pp_one_step |> filter(k == 30), 
        x = wts, y = coverage, 
        rowfacet = tau, colfacet = mu)

plot_SR(dat = dat_uni_pp_one_step |> filter(k == 30), 
        x = wts, y = width, rowfacet = tau, colfacet = mu)
```

## RQ1: Compare one-step and two-step

```{r}
res_dat |> 
  filter(k == 30, cor_mu == 0.4, k_stop == "NA",
         method %in% c("3PSM", "4PSM", "UNI_EK", "UNI_RE-ISW", 
                                "p-uniform*", "UNI_PET-PEESE")) |>
  mutate(method = ifelse(method == "UNI_EK", "Univariate EK",
                         ifelse(method == "UNI_PET-PEESE", "Univariate PET-PEESE",
                                ifelse(method == "UNI_RE-ISW", "RE-ISW", method)))) |>
  select(mu, wts, sel_mechanism, bias, rmse, coverage, width, method) |> 
  pivot_longer(cols = bias:width, names_to = "criteria") |>
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
  ggplot(aes(x = wts, y = value, color = method, fill = method)) +
  geom_boxplot(alpha = .3, coef = Inf) +
  facet_grid(criteria ~ sel_mechanism, scales = "free_y") +
  geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
  labs(x = "Selection weight", y = "", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                         labels = dropLeadingZero)

ggsave("graphs/uni-one-two.png", device = "png", dpi = 500, 
       height = 10, width = plot_width)
```

## RQ1: Compare uni methods

- $k=30$
- Did not report p-uniform bc it performs worse than p-unistar.

```{r}
# bias
plot_SR(dat = main_dat_uni_one_step |> filter(k == 30, k_stop %in% c("NA", 7)), 
        x = wts, y = bias, rowfacet = tau, colfacet = mu, scale = TRUE)
ggsave("graphs/uni-bias-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

# main_dat_uni_one_step %>% 
#   mutate(tau = ifelse(tau == 0, "tau == 0.0",
#                       ifelse(tau == 0.1, "0.1",
#                              ifelse(tau == 0.2, "0.2",
#                                     "0.4")))) %>% 
#   filter(k == 30, k_stop %in% c("NA", 7)) %>%  
#         ggplot(aes(x = wts, y = bias, color = method, group = method, shape = method)) +
#         geom_point() +
#         geom_line(aes(linetype = method), linewidth = 0.7) +
#         facet_grid(paste0("tau == ", tau) ~ paste0("mu == ", mu), 
#                    scales = NULL, labeller = label_parsed) +
#         labs(linetype = "", shape = "") +
#         scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
#                          labels = dropLeadingZero)

# rmse
plot_SR(dat = main_dat_uni_one_step |> filter(k == 30, k_stop %in% c("NA", 7)), 
        x = wts, y = rmse, rowfacet = tau, colfacet = mu, scale = TRUE)
ggsave("graphs/uni-rmse-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

# CI
plot_SR(dat = main_dat_uni_one_step |> filter(k == 30, k_stop %in% c("NA", 7)), 
        x = wts, y = coverage, rowfacet = tau, colfacet = mu)
ggsave("graphs/uni-cover-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

plot_SR(dat = main_dat_uni_one_step |> filter(k == 30, k_stop %in% c("NA", 7)), 
        x = wts, y = width, rowfacet = tau, colfacet = mu)
ggsave("graphs/uni-width-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

# dat_uni_one_step |> 
#   filter(k == 30, mu == 0, tau %in% c(0.1, 0.4),
#          method %in% c("3PSM", "EK", "PET-PEESE", "RE-ISW", "WAAP", "WILS")) %>% 
#   select(mu, tau, wts, sel_mechanism, bias, coverage, method) %>%
#   pivot_longer(cols = bias:coverage, names_to = "criteria") %>%
#   mutate(criteria = factor(criteria, 
#                            levels = c("bias", "coverage"),
#                            labels = c("Bias", "Coverage"))) %>%
#   ggplot(aes(x = wts, y = value, color = method, group = method, shape = method)) +
#   geom_point() +
#   geom_line(aes(linetype = method), linewidth = 0.8) +
#   geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
#   facet_grid(criteria ~ paste0("tau == ", tau), scales = "free_y", labeller = label_parsed) +
#   labs(x = "Selection weight", y = "", color = "", group = "", shape = "", linetype = "") +
#   theme_bw() +
#   theme(legend.position = "bottom", 
#         axis.title = element_text(size = 12),
#         legend.text = element_text(size = 12),
#         strip.text = element_text(size = 12)) +
#   guides(colour = guide_legend(nrow = 1)) +
#   scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
#                          labels = dropLeadingZero)
# 
# ggsave("../Dissertation/presentation/figures/study1-RQ1.png", 
#        device = "png", dpi = 500, height = 7, width = 10)
```


## Replications

### Bom & Rachinger 2019

- Consistent with Figure 3-5 in Bom & Rachinger (2019)
- Summary
  - Generally, both estimators tend to have more bias for large heterogeneity and severe selection.
  - Biased: For small true effect, EK is less biased than WAAP, but they both tend to be unbiased for larger true effect. This holds for different levels of heterogeneity. 
  - RMSE: 

```{r}
# check against Bom & Rachinger 2019
dat_uni_one_step |> 
  filter(k == 100, method %in% c("WAAP", "EK")) |> 
  ggplot(aes(x = mu, y = bias, color = method, group = method)) + 
  geom_point() +
  geom_line(linewidth = 0.7) +
  facet_grid(paste0("tau == ", tau) ~ paste0("wt == ", wts), 
             scales = "free_y", labeller = label_parsed) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  labs(x = "True effect", y = "Bias", 
       title = "k = 100, Bom & Rachinger(2019)", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())

dat_uni_one_step |> 
  filter(k == 100, method %in% c("WAAP", "EK")) |> 
  ggplot(aes(x = mu, y = rmse, color = method, group = method)) + 
  geom_point() +
  geom_line(linewidth = 0.7) +
  facet_grid(paste0("tau == ", tau) ~ paste0("wt == ", wts), 
             scales = "free_y", labeller = label_parsed) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  labs(x = "True effect", y = "RMSE", 
       title = "k = 100, Bom & Rachinger(2019)", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())
```

### Stanley & Doucouliagos, 2022

- Figure 1 & 3
  - Not so sure about the discrepancy. Maybe their 50% selection is like our super severe selection. Then the results sort of match.

```{r}
dat_uni_one_step |> 
  filter(k == 100, method %in% c("WAAP", "PET-PEESE", "WILS"), k_stop %in% c("NA", 7)) |> 
  ggplot(aes(x = tau, y = bias, color = method, group = method)) + 
  geom_point() +
  geom_line(linewidth = 0.7) +
  facet_grid(paste0("mu == ", mu) ~ paste0("wt == ", weights), 
             scales = "free_y", labeller = label_parsed) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  labs(x = "Tau", y = "Bias", 
       title = "k = 100, Stanley & Doucouliagos (2022)", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())

# Figure 1
dat_uni_one_step |> 
  filter(k == 100, mu == 0, 
         method %in% c("WAAP", "PET-PEESE", "WILS"),
         k_stop %in% c("NA", 7)) |> 
  ggplot(aes(x = tau, y = bias, color = method, group = method)) + 
  geom_point() +
  geom_line(linewidth = 0.7) +
  facet_grid( ~ paste0("wt == ", wts), 
             scales = "free_y", labeller = label_parsed) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  labs(x = "Tau", y = "Bias", 
       title = "mu = 0, k = 100, Stanley & Doucouliagos (2022)", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())

# Figure 3
dat_uni_one_step |> 
  filter(k == 100, mu == 0, 
         method %in% c("WAAP", "PET-PEESE", "WILS"),
         k_stop %in% c("NA", 7)) |> 
  ggplot(aes(x = tau, y = rmse, color = method, group = method)) + 
  geom_point() +
  geom_line(linewidth = 0.7) +
  facet_grid( ~ paste0("wt == ", wts), 
             scales = "free_y", labeller = label_parsed) +
  geom_hline(aes(yintercept = 0), color = "black", linetype = "dashed") +
  labs(x = "Tau", y = "RMSE", 
       title = "mu = 0, k = 100, Stanley & Doucouliagos (2022)", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())
```

# RQ2: Examine adaptations

## RQ2: Compare adaptations in one-step and two-step

```{r}
res_dat %>% 
  filter(k == 30, cor_mu == 0.4, 
         method %in% c("MV_PET-PEESE", "MV_EK", "MV_WILS", "MV_WAAP", "CHE-ISCW"),
         k_stop %in% c("NA", 7)) |> 
  mutate(method = str_sub(method, start = 4L, end = -1L),
         method = ifelse(method == "-ISCW", "CHE-ISCW", method)) |> 
  select(mu, wts, sel_mechanism, bias, rmse, coverage, width, method) |> 
  pivot_longer(cols = bias:width, names_to = "criteria") |>
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
  ggplot(aes(x = wts, y = value, color = method, fill = method)) +
  geom_boxplot(alpha = .3, coef = Inf) +
  facet_grid(criteria ~ sel_mechanism, scales = "free_y") +
  geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
  labs(x = "Selection weight", y = "", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                         labels = dropLeadingZero)

ggsave("graphs/mv-one-two.png", device = "png", dpi = 500, 
       height = 10, width = plot_width)

# compare CHE and CHE-ISCW
# res_dat %>% 
#   filter(k == 30, 
#          method %in% c("CHE", "CHE-ISCW"),
#          k_stop %in% c("NA", 7)) |> 
#   select(mu, wts, sel_mechanism, bias, rmse, coverage, width, method) |> 
#   pivot_longer(cols = bias:width, names_to = "criteria") |>
#   mutate(criteria = factor(criteria, 
#                            levels = c("bias", "rmse", "coverage", "width"),
#                            labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
#   ggplot(aes(x = wts, y = value, color = method, fill = method)) +
#   geom_boxplot(alpha = .3, coef = Inf) +
#   facet_grid(criteria ~ sel_mechanism, scales = "free_y") +
#   geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
#   labs(x = "Selection weight", y = "", fill = "", color = "") +
#   theme_bw() +
#   theme(legend.position = "bottom", legend.title = element_blank()) +
#   scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
#                          labels = dropLeadingZero)
# 
# ggsave("../Dissertation/chapters/appendices/study1-supp-che-iscw.png", 
#        device = "png", dpi = 500, 
#        height = plot_height, width = plot_width)
```

## RQ2: Compare uni and mv reg-based adjustments

- Multivariate > Univariate (all criteria), except for WILS when $\mu = 0.2$ and $\mu = 0.5$.

- Now using mu as facet, same pattern if using tau or k

### Quantify the differences

```{r}
adaptations_improvement <- 
  main_dat_reg_one_step |> 
  filter(k == 30, k_stop %in% c("NA", 7)) |> 
  group_by(dependence, method, mu) |> 
  summarize(
    m_bias = mean(bias),
    m_rmse = mean(rmse),
    m_cover = mean(coverage),
    m_width = mean(width),
    .groups = "drop_last"
  ) |> 
  pivot_wider(
    names_from = dependence, 
    values_from = m_bias:m_width
  ) |> 
  mutate(
    m_ptc_bias = (m_bias_UNI - m_bias_MV) / m_bias_UNI,
    m_ptc_rmse = (m_rmse_UNI - m_rmse_MV) / m_rmse_UNI,
    m_ptc_cover = (m_cover_UNI - m_cover_MV) / m_cover_UNI,
    m_ptc_width = (m_width_UNI - m_width_MV) / m_width_UNI
  ) |> 
  dplyr::select(method, mu, m_ptc_bias, m_ptc_rmse, m_ptc_cover, m_ptc_width)

adaptations_improvement |> 
  pivot_longer(cols = m_ptc_bias:m_ptc_width, 
               names_to = "Criteria", values_to = "Value") |> 
  filter(method %in% c("EK", "PET_PEESE", "WAAP", "WILS")) |> 
  ggplot(aes(x = mu, y = Value, group = method, color = method)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ Criteria, ncol = 2, scales = "free_y") +
  geom_hline(aes(yintercept = 0), linetype = "dashed")
```

### Graphing the differences

```{r}
x <- 
  main_dat_reg_one_step %>% 
  filter(k == 30, !method %in% c("PET", "PEESE"), k_stop %in% c("NA", 7)) %>% 
  mutate(dependence = ifelse(dependence == "MV", "Multivariate", "Univariate")) %>% 
  select(wts, bias, rmse, coverage, width, method, dependence) %>% 
  pivot_longer(cols = c(bias, rmse, coverage, width), 
               names_to = "criteria", values_to = "value")

x_mul <- 
  x %>% filter(dependence == "Multivariate") %>% 
  select(-dependence) %>% rename(Multivariate = value)
x_uni <- 
  x %>% filter(dependence == "Univariate") %>% 
  select(-dependence) %>% rename(Univariate = value)

x_mul %>% 
  mutate(Univariate = x_uni$Univariate) %>% 
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) %>% 
  mutate(weights = as.numeric(as.character(wts))) %>% 
  ggplot(aes(x = Univariate, y = Multivariate)) +
  geom_point(aes(color = weights), size = 2) +
  # facet_grid(criteria ~ method, scales = "free_y") +
  facet_grid(criteria ~ method) +
  geom_abline(slope = 1, color = "blue", linetype = "dashed", linewidth = 0.8) +
  # labs(x = "Univariate estimators", 
  #      y = "Multivariate estimators", colour = "Weigths") +
  labs(color='Selection weight') +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave("graphs/reg-one-step.png", device = "png", dpi = 500, 
       height = plot_height, width = 9)

x_mul %>% 
  mutate(Univariate = x_uni$Univariate) %>% 
  filter(criteria == "bias") %>% 
  rename(`Selection weight` = wts) %>% 
  ggplot(aes(x = Univariate, y = Multivariate)) +
  geom_point(aes(color = `Selection weight`, shape = `Selection weight`), size = 5, alpha = 0.7) +
  facet_wrap( ~ method) +
  geom_abline(slope = 1, color = "black", linetype = "dashed", linewidth = 0.8) +
  coord_fixed(ratio = 1) +
  scale_x_continuous(breaks = seq(-0.5, 0.5, by = 0.2)) +  # Set x-axis breaks
  scale_y_continuous(breaks = seq(-0.5, 0.5, by = 0.2)) +  # Set y-axis breaks
  guides(color = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave("graphs/reg-one-step-bias.png", device = "png", dpi = 500, 
       height = 9, width = 9)

x_mul %>% 
  mutate(Univariate = x_uni$Univariate) %>% 
  filter(criteria == "rmse") %>% 
  rename(`Selection weight` = wts) %>% 
  ggplot(aes(x = Univariate, y = Multivariate)) +
  geom_point(aes(color = `Selection weight`, shape = `Selection weight`), size = 5, alpha = 0.7) +
  facet_wrap( ~ method) +
  geom_abline(slope = 1, color = "black", linetype = "dashed", linewidth = 0.8) +
  coord_fixed(ratio = 1) +
  labs(color='Selection weight') +
  guides(color = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(legend.position = "bottom")

ggsave("graphs/reg-one-step-rmse.png", device = "png", dpi = 500, 
       height = 9, width = 9)

# x_mul %>% 
#   mutate(Univariate = x_uni$Univariate) %>% 
#   filter(criteria %in% c("bias", "rmse", "coverage"), method %in% c("RE-ISW", "EK", "PET-PEESE")) %>% 
#   mutate(weights = as.numeric(as.character(wts))) %>% 
#   mutate(criteria = factor(criteria, 
#                            levels = c("bias", "rmse", "coverage"),
#                            labels = c("Bias", "RMSE", "Coverage"))) %>% 
#   ggplot(aes(x = Univariate, y = Multivariate)) +
#   geom_point(aes(color = weights), size = 3) +
#   facet_grid(criteria ~ method) +
#   geom_abline(slope = 1, color = "black", linetype = "dashed", linewidth = 0.8) +
#   scale_color_gradient(low="red", high="yellow") +
#   labs(color='Selection weight') +
#   theme_bw() +
#   theme(axis.title = element_text(size = 12),
#         legend.title = element_text(size = 12),
#         strip.text = element_text(size = 12))
# 
# ggsave("../Dissertation/presentation/figures/study1-RQ2.png", 
#        device = "png", dpi = 500, height = 6, width = 9)
```

### PET/PEESE
- When $\tau <= 0.2$, PET-PEESE is fine.

```{r}
plot_SR(dat = dat_mv_pp_one_step |> filter(k == 30), 
        x = wts, y = bias,
        rowfacet = tau, colfacet = mu, scale = TRUE) +
  labs(title = "One-step selection")

plot_SR(dat = dat_mv_pp_one_step |> filter(k == 30),
        x = wts, y = rmse,
        rowfacet = tau, colfacet = mu, scale = TRUE) +
  labs(title = "One-step selection")

plot_SR(dat = dat_mv_pp_one_step |> filter(k == 30), 
        x = wts, y = coverage,
        rowfacet = tau, colfacet = mu) +
  labs(title = "One-step selection")

plot_SR(dat = dat_mv_pp_one_step |> filter(k == 30), 
        x = wts, y = width,
        rowfacet = tau, colfacet = mu) +
  labs(title = "One-step selection")
```


# Compare p-value methods

## Performance

```{r}
plot_SR(dat = dat_sel_one_step |> filter(k == 30), 
        x = wts, y = bias,
        rowfacet = tau, colfacet = mu, scale = TRUE)

plot_SR(dat = dat_sel_one_step |> filter(k == 30), 
        x = wts, y = rmse,
        rowfacet = tau, colfacet = mu, scale = TRUE)

plot_SR(dat = dat_sel_one_step |> filter(k == 30), 
        x = wts, y = coverage,
        rowfacet = tau, colfacet = mu, scale = TRUE)

plot_SR(dat = dat_sel_one_step |> filter(k == 30), 
        x = wts, y = width,
        rowfacet = tau, colfacet = mu, scale = TRUE)
```

## McShane 2016

- McShane does not have $k=10$ in their simulation.
- Figure 1: $\tau = 0$ & $\lambda = 1$.
  - The CI coverage and width are missing for p-uniform when $k=10$. p-uniform is acting bad for $k=10$.
  - I remove $k=10$ in our study just trying to reproduce McShane's plots.
  - Summary: could basically reproduce the bias and RMSE results in McShane, where p-uniform has small negative bias and larger RMSE for small true effect compared to 3PSM. However, note that the confidence interval coverage is close to 95% but in our cases the rates are lower, with p-uniform (80%-90% for $\mu=0.2$) having higher coverage rates than 3PSM (75%-85% for $\mu = 0.2$).

```{r}
# figure 1

dat_sel_one_step |>
  filter(method %in% c("3PSM", "p-uniform"),
         tau == 0, mu!= 0, k != 10, wts == 1, mu!= 0.8) |> 
  select(mu, k, bias, rmse, coverage, width, method) |> 
  pivot_longer(cols = bias:width, names_to = "criteria") |>
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
  ggplot(aes(x = k, y = value, color = method, fill = method)) +
  geom_boxplot() +
  facet_grid(criteria ~ paste0("mu == ", mu), scales = "free_y", labeller = label_parsed) +
  geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
  labs(x = "Number of studies", y = "Bias", title = "No selection, no heterogeneity", 
       fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())
```

```{r}
# figure 2
dat_sel_one_step |>
  filter(method %in% c("3PSM", "p-uniform"),
         tau == 0.2, wts %in% c(.125), k!= 10, mu!= 0, mu!= 0.8) |> 
  select(mu, k, bias, rmse, coverage, width, method) |> 
  pivot_longer(cols = bias:width, names_to = "criteria") |>
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
  ggplot(aes(x = k, y = value, color = method, fill = method)) +
  geom_boxplot() +
  facet_grid(criteria ~ paste0("mu == ", mu), scales = "free_y", labeller = label_parsed) +
  geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
  labs(x = "Number of studies", y = "Bias", title = "Weight = .125, tau = 0.2", 
       fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank())
```

# RQ3: Compare across methods

## RQ3: Compare one- and two-step

```{r}
main_dat_comp |> 
  filter(k == 30) |> 
  mutate(method = ifelse(method == "MV_EK", "Multivariate EK",
                           ifelse(method == "MV_PET-PEESE", "Multivariate PET-PEESE",
                                  method))) |> 
  select(mu, wts, sel_mechanism, bias, rmse, coverage, width, method) |> 
  pivot_longer(cols = bias:width, names_to = "criteria") |>
  mutate(criteria = factor(criteria, 
                           levels = c("bias", "rmse", "coverage", "width"),
                           labels = c("Bias", "RMSE", "Coverage", "Width"))) |> 
  ggplot(aes(x = wts, y = value, color = method, fill = method)) +
  geom_boxplot(alpha = .3, coef = Inf) +
  facet_grid(criteria ~ sel_mechanism, scales = "free_y") +
  geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
  labs(x = "Selection weight", y = "", fill = "", color = "") +
  theme_bw() +
  theme(legend.position = "bottom", legend.title = element_blank()) +
  scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
                         labels = dropLeadingZero)

ggsave("graphs/RQ3-one-two.png", device = "png", dpi = 500, 
       height = 10, width = plot_width)
```

## RQ3: Compare promising adaptations with comparison methods

```{r}
data <- 
  main_dat_comp |> 
  filter(k == 30, sel_mechanism == "One-step selection") |> 
  mutate(method = ifelse(method == "MV_EK", "Multivariate EK",
                           ifelse(method == "MV_PET-PEESE", "Multivariate PET-PEESE",
                                  method)))

plot_SR(dat = data, x = wts, y = bias, 
        rowfacet = tau, colfacet = mu, scale = TRUE)
ggsave("graphs/RQ3-bias-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

plot_SR(dat = data, x = wts, y = rmse,
        rowfacet = tau, colfacet = mu, scale = TRUE)
ggsave("graphs/RQ3-rmse-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

plot_SR(dat = data, x = wts, y = coverage,
        rowfacet = tau, colfacet = mu, scale = FALSE)
ggsave("graphs/RQ3-cover-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

plot_SR(dat = data, x = wts, y = width,
        rowfacet = tau, colfacet = mu, scale = TRUE)
ggsave("graphs/RQ3-width-one-step.png", device = "png", 
       dpi = 500, height = plot_height, width = plot_width)

# dat_RQ3 %>% 
#   filter(k == 30, sel_mechanism == "One-step selection", mu == 0, tau %in% c(0.1, 0.4)) %>% 
#   mutate(method = ifelse(method == "MV_EK", "Multivariate EK",
#                            ifelse(method == "MV_PET-PEESE", "Multivariate PET-PEESE",
#                                   method))) |> 
#   select(mu, tau, wts, sel_mechanism, bias, rmse, coverage, method) |> 
#   pivot_longer(cols = bias:coverage, names_to = "criteria") |>
#   mutate(criteria = factor(criteria, 
#                            levels = c("bias", "rmse", "coverage"),
#                            labels = c("Bias", "RMSE", "Coverage"))) |> 
#   ggplot(aes(x = wts, y = value, color = method, group = method, shape = method)) +
#   geom_point() +
#   geom_line(aes(linetype = method), linewidth = 0.8) +
#   geom_hline(data = yints, aes(yintercept = yint), col = "black", linetype = "dashed") +
#   facet_grid(criteria ~ paste0("tau == ", tau), scales = "free_y", labeller = label_parsed) +
#   labs(x = "Selection weight", y = "", color = "", group = "", shape = "", linetype = "") +
#   theme_bw() +
#   theme(legend.position = "bottom", 
#         axis.title = element_text(size = 12),
#         legend.text = element_text(size = 12),
#         strip.text = element_text(size = 12)) +
#   scale_x_discrete(breaks = c(.05, .125, .25, .5, .8, 1),
#                          labels = dropLeadingZero)
# 
# ggsave("../Dissertation/presentation/figures/study1-RQ3.png", 
#        device = "png", dpi = 500, height = 6, width = 8)
```
