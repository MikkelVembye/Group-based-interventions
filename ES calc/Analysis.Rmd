---
title: "Statistical Analysis for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness'"
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: show
    code_download: true
    css: styles.css
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(eval = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```

# R package

```{r, echo=FALSE}

library(dplyr)
library(tibble)
library(ggplot2)
library(stringr)
library(robvis)
library(tidyr)
library(rempsyc)
library(flextable)
library(purrr)
library(metafor)
library(patchwork)

# Loading in helper function used to calculate effect size and conduct the analysis
source("Helpers.R")

```

# Load data

```{r, eval = TRUE}
# Loading the needed data for analysis
group_based_dat <- readRDS("Group-based interventions data.RDS") |> 
  # The post-measurement of Empowerment Scale seems flawed for the study by 
  # Barbic et al. 2009 we therefore we exclude it from the analysis
  filter(!(authors == "Barbic et al." & test_name == "The Empowerment Scale")) |> 
  mutate(
    author_year = paste(authors, year)
  )

```

# Descriptive plots

## Timeline

```{r, echo=FALSE, eval=TRUE, fig.cap='FIGURE 1:  Number of studies included in the meta-analysis by year'}
# Figure 1: Number of included studies in the meta-analysis by year
G_timepllot <- group_based_dat |> 
  summarise(year = unique(year), .by =  author_year)

# DONE
timeline_plot <-  ggplot(G_timepllot,aes(x = year)) + 
  geom_bar(colour = "black", fill = "cornflowerblue", alpha = 1, width = 1) +
  scale_x_continuous(breaks = seq(2000, 2022, 1)) + 
  scale_y_continuous(breaks = seq(0, 6.5, 1), limits = c(0, 7), expand = c(0,0)) + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.border = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.line = element_line(colour = "black")
  ) +
  labs(
    x = "Year of Publication",
    y = "Number of Studies"
  )

timeline_plot

```

## Primary study sample size and effective sample sizes (SUPPLEMENTARY MATERIAL)

### Making a effetive sample size (ESS)

```{r}
GBD_effect <- 
  group_based_dat |> 
  filter(variable_type != "Binary") |>
  mutate(
    es_id = 1:n(),
    gt = if_else(!is.na(gt_post), gt_post, NA_real_),
    gt = if_else(!is.na(gt_DD), gt_DD, gt),
    gt = if_else(!is.na(gt_adj), gt_adj, gt),
    gt = if_else(!is.na(gt_reg), gt_reg, gt),
    
    vgt = if_else(!is.na(vgt_post), vgt_post, NA_real_),
    vgt = if_else(!is.na(vgt_DD), vgt_DD, vgt),
    vgt = if_else(!is.na(vgt_adj), vgt_adj, vgt),
    vgt = if_else(!is.na(vgt_reg), vgt_reg, vgt),
    
    Wgt = if_else(!is.na(Wgt_post), Wgt_post, NA_real_),
    Wgt = if_else(!is.na(Wgt_DD), Wgt_DD, Wgt),
    Wgt = if_else(!is.na(Wgt_adj), Wgt_adj, Wgt),
    Wgt = if_else(!is.na(Wgt_reg), Wgt_reg, Wgt),
    
   # ESS = round(4/vgt), # Using cluster bias corrected sampling variance
    
    studyid = if_else(authors == "Gonzalez & Prihoda", 500, studyid), 
    
    cnt = if_else(cnt == "USA", "US", cnt),
    
    design = if_else(design  == "QES-pretest", "QES", design),
    
    # MHV: Jeg synes ikke det er en god ide at Ã¦ndre CRCT til RCT. Jeg vil gerne kunne se forskel.  
    # design = ifelse(design  == "CRCT", "RCT", design), 
    
    assessment = if_else(assessment == "Self  assesment", "Self assesment", assessment),
    
    randomization = if_else(randomization == "Simple Block Randomization", "Block randomized",
                           randomization),
    randomization = if_else(randomization == "Simple with permuted blocks, stratified by site",
                           "Stratified randomization", randomization),
   
   randomization = if_else(randomization == "Stratified?",
                           "Stratified randomization", randomization),
   
    randomization = if_else(is.na(randomization) & studyid == 102, 
                            "Stratified randomization", randomization),
   
    randomization = if_else(randomization == "Ratio and block randomized",
                           "Block randomized", randomization),
   
   randomization = if_else(randomization == "Block randomized stratified by site",
                           "Block randomized", randomization),
    
   randomization = if_else(randomization == "Resticted and adapted randomization (i.e. minimization)",
                           "Stratified randomization", randomization),
   
   randomization = if_else(randomization == "Unequal simple randomization",
                           "Block randomized", randomization),
   
   randomization = if_else(randomization == "Within-site basis and unequal allocation ratio",
                           "Stratified randomization", randomization),
    
    trt_type = if_else(trt_type == "Group-based  Cognitive Behavioral Therapy", 
                      "Group based Cognitive Behavioural Therapy", trt_type),
    trt_type = if_else(trt_type == "Group-based Cognitive Behavioral Therapy", 
                      "Group based Cognitive Behavioural Therapy", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation & Social skill training", 
                      "Group psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation", 
                      "Group Psychoeducation", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation & Social Skill Training", 
                      "Group Psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Education and Illness Management", 
                      "Group Psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Illness management", 
                      "Illness Management", trt_type),
    
    sample_factors = if_else(sample_factors =="Older with depression and anxiety", 
                            "Mixed", sample_factors), 
    sample_factors = if_else(sample_factors =="All suffered from severe mental illness", 
                            "Shared Social problem(s)/challenge(s)", sample_factors),
    sample_factors = if_else(sample_factors =="Shared origin and psychological distress", 
                            "Mixed", sample_factors),
    sample_factors = if_else(sample_factors =="persons with major psychiatric problems", 
                            "Shared Social problem(s)/challenge(s)", sample_factors),
    
    analysis_plan = if_else(analysis_plan == "Unused", "Unused outcomes", analysis_plan), 
    
    test_type = if_else(test_type == "Clinical administered", "Clinician-rated measure", test_type),
    test_type = if_else(test_type == "Clinical interviews", "Clinician-rated measure", test_type),
    test_type = if_else(test_type == "Self report", "Self-reported", test_type),
    test_type = if_else(test_type == "Self report through clinical interview", "Self-reported", test_type),
    test_type = if_else(test_type == "Self-reported via diagnostic interview", "Self-reported", test_type), 
    
    measure_type = if_else(measure_type == "Pre-post with controls", "Post-intervention", measure_type),
   
   cluster_treatment = if_else(cluster_treatment == "Hierarchical mixed models", "Mixed-model", cluster_treatment),
   
   cluster_treatment = if_else(cluster_treatment == "Multilevel analysis and clustered standard errors", 
                        "Multilevel analysis", cluster_treatment),
   
   rob_tool = if_else(rob_tool == "Rob2", "RoB2", rob_tool),
   rob_tool = if_else(rob_tool == "Rob2 CRCT", "RoB2", rob_tool)
   
 ) |> 
 # Remove unused outcomes
 filter(!str_detect(analysis_plan, "Unused"))
```

```{r}
sample_size_dat <- 
  GBD_effect |> 
  group_by(year, studyid, sample_id) |> 
  summarise_at(
    vars(N_t, N_c, N_total), list(mean = mean)
  )

sample_size_dat |> 
  pivot_longer(
        cols = N_t_mean:N_total_mean,
    names_to = "sample_sizes_char",
    values_to = "sample_size"
  ) |> 
  group_by(sample_sizes_char) |> 
  summarise(
    mean = mean(sample_size, na.rm = TRUE),
    sd = sd(sample_size, na.rm = TRUE),
    q = list(quantile(sample_size, na.rm = TRUE))
  ) |> 
  unnest_wider(q, names_repair = ~paste0('Q_', sub('%', '', .))) |> 
  rename(mean = Q_mean, sd = Q_sd) |> 
  mutate(
    id = rev(1:3)
  ) |> 
  arrange(id) |> 
  select(-id)

SS1 <- ggplot(sample_size_dat, aes(N_t_mean)) + 
  geom_density(fill = "cornflowerblue", trim = TRUE) + 
  geom_blank(aes(x = 0, y = 0)) + 
  geom_rug() + 
  theme_minimal() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Treatment group sample size")

SS2 <- ggplot(sample_size_dat, aes(N_c_mean)) + 
  geom_density(fill = "cornflowerblue", trim = TRUE) + 
  geom_blank(aes(x = 0, y = 0)) + 
  geom_rug() + 
  theme_minimal() +
  theme(axis.title.y = element_blank()) +
  labs(x = "Control group sample size")

SS3 <- ggplot(sample_size_dat, aes(N_total_mean)) + 
  geom_density(fill = "cornflowerblue", trim = TRUE) + 
  geom_blank(aes(x = 0, y = 0)) + 
  geom_rug() + 
  theme_minimal() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Total sample size")

library(patchwork)

sample_dist_plot <- SS1 / SS2 / SS3
sample_dist_plot


```

# Empirical distribution of effect size estimates (SUPPLEMENTARY MATERIAL) {.tabset}

## Overall distribution
```{r}
qrtls <- quantile(GBD_effect$gt, c(.25, .75), na.rm = TRUE)
fences <-  qrtls + 3 * diff(qrtls) * c(-1, 1)
fence_dat <- data.frame(qrtl = qrtls, fence = fences)

es_dist_plot <- 
  ggplot(GBD_effect, aes(gt)) + 
  geom_density(fill = "cornflowerblue") + 
  geom_vline(data = fence_dat, aes(xintercept = qrtl), linetype = "solid") + 
  geom_vline(data = fence_dat, aes(xintercept = fence), linetype = "dashed") + 
  geom_rug(alpha = 0.25) + 
  theme_minimal() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Effect size estimate"); es_dist_plot
```

## Reintergrational/social outcomes
```{r}
# Making data for plotting the specific outcomes

# Without mental health outcomes and only reintergration-outcomes
GB_outcome_reintergration <- GBD_effect |> 
  filter(!str_detect(analysis_plan, "mental|used|hospi")) |>
  group_by(analysis_plan) |> 
  reframe(
    qrtl = quantile(gt,  c(.25, .75)),
    fence = qrtl + 3 * diff(qrtl) * c(-1,1),
    
    .groups = "drop"
  )


# Therefore All mental health outcomes, Unused outcome and hospitalization are excluded
reintegration_outcome_plot <- GBD_effect |> 
 filter(!str_detect(analysis_plan, "mental|used|hospi")) |>
  ggplot(aes(x = gt, fill = analysis_plan)) + 
  geom_density(alpha = 0.7) +
  geom_vline(data = GB_outcome_reintergration, aes(xintercept = qrtl), linetype = "solid")+
  geom_vline(data = GB_outcome_reintergration, aes(xintercept = fence), linetype = "dashed")+
  geom_rug(alpha = 0.25) +
  facet_wrap(~analysis_plan, scales = "free", ncol = 4) +
  theme_minimal() +
  theme(legend.position = "none", axis.title.y = element_blank()) +
  labs(x = "Effect size estimate"); reintegration_outcome_plot

```

## Plot with all mental health outcomes 
```{r}
# Total mental health:
GB_outcome_mental_health <- GBD_effect |> 
  filter(str_detect(analysis_plan, "mental")) |> 
  filter(!str_detect(analysis_plan, "Unused")) |>
  reframe(
    qrtl = quantile(gt,  c(.25, .75)),
    fence = qrtl + 3 * diff(qrtl) * c(-1,1),
    
    .groups = "drop"
  )

mental_health_outcome_plot <- GBD_effect |> 
 filter(str_detect(analysis_plan, "mental")) |>
  ggplot(aes(x = gt)) + 
  geom_density(alpha = 0.7, fill = "cornflowerblue") +
  geom_vline(data = GB_outcome_mental_health, aes(xintercept = qrtl), linetype = "solid")+
  geom_vline(data = GB_outcome_mental_health, aes(xintercept = fence), linetype = "dashed")+
  geom_rug(alpha = 0.25) +
  theme_minimal() +
  theme(legend.position = "none", axis.title.y = element_blank()) +
  labs(x = "Effect size estimate"); mental_health_outcome_plot

```

## Seperated mental health outcomes
```{r}
GB_outcomes_mental_health <- GBD_effect |> 
  mutate(analysis_plan = case_when(
  str_detect(analysis_plan, "All mental health outcomes/Symptoms of psychosis|All mental health outcomes/Negative symptoms") ~ "All mental health outcomes/Symptoms of psychosis",
   TRUE ~ analysis_plan)) |> 
   filter(str_detect(analysis_plan, "mental")) |>
  filter(!str_detect(analysis_plan, "Unused")) |>
  group_by(analysis_plan) |> 
  reframe(
    qrtl = quantile(gt,  c(.25, .75)),
    fence = qrtl + 3 * diff(qrtl) * c(-1,1),
    
    .groups = "drop"
  )


mental_health_outcomes_plot <- GBD_effect |> mutate(analysis_plan = case_when(
  # Gathering negative symptoms and symptoms of psychosis as negative symptoms refers to same symptoms
  str_detect(analysis_plan, "All mental health outcomes/Symptoms of psychosis|All mental health outcomes/Negative symptoms") ~ "All mental health outcomes/Symptoms of psychosis", 
   TRUE ~ analysis_plan)) |> 
  filter(str_detect(analysis_plan, "mental")) |> 
  filter(!str_detect(analysis_plan, "Unused")) |>
  ggplot(aes(x = gt, fill = analysis_plan)) + 
  geom_density(alpha = 0.7) +
  geom_vline(data = GB_outcomes_mental_health, aes(xintercept = qrtl), linetype = "solid")+
  geom_vline(data = GB_outcomes_mental_health, aes(xintercept = fence), linetype = "dashed")+
  geom_rug(alpha = 0.25) +
  facet_wrap(~analysis_plan, scales = "free") +
  theme_minimal() +
  theme(legend.position = "none", axis.title.y = element_blank()) +
  labs(x = "Effect size estimate"); mental_health_outcomes_plot
```

# Funnel-plot {.tabset}

## Funnel plot for overall effect sizes
```{r, echo=FALSE}


# data prep
GBD_effect <- GBD_effect |> 
  mutate(timing = case_when(
    timing == "Followup" ~ "3m",
    timing == "Posttest" ~ "Post",
    timing == "12" ~ "12m",
    timing == "24" ~ "24m",
    timing == "post" ~ "Post",
    timing == "3 months" ~ "3m",
    timing == "6 months" ~ "6m",
    timing == "6w" ~ "Post",
    TRUE ~ timing))

unique_values <- unique(GBD_effect$timing)

GB_dat <- 
  GBD_effect |> 
  select(studyid, gt, vgt, timing, analysis_plan, outcome) |> 
  mutate(
    seg = sqrt(vgt),
    timing = if_else(is.na(timing), "Post", timing),
    timing = factor(
      timing, 
      levels = c("Post", "3m", "6m", "9m", "12m", "18m", "24m")
    ),
    es_ID = 1:n()
  ) |> 
  arrange(timing)

# Who are those with big seg
GB_high_seg <- GB_dat |> 
  filter(seg > 0.75) |> 
  left_join(GBD_effect, by = c("studyid", "outcome"))
  

# Discarded in this data frame
GB_dat <- GB_dat |> 
  filter(!seg > 0.75)


#es_exp <- as.numeric(mean_es_GB$b)
y_lim_exp1 <- max(sqrt(GB_dat$vgt)) + 0.02 



funnel_exp1 <-  tribble(
  ~ x90, ~ x95, ~ x99, ~ y,
  0,     0,     0,     0,
  qnorm(0.05) * y_lim_exp1, qnorm(0.025) * y_lim_exp1, qnorm(0.005) * y_lim_exp1, y_lim_exp1,
  qnorm(0.95) * y_lim_exp1, qnorm(0.975) * y_lim_exp1, qnorm(0.995) * y_lim_exp1, y_lim_exp1,
  0,     0,     0,     0
) 


GB_plot_all <-
  GB_dat |> 
  ggplot() + 
  geom_polygon(data = funnel_exp1, aes(x = y, y = x99), fill = "grey", alpha = 0.5) + 
  geom_polygon(data = funnel_exp1, aes(x = y, y = x95), fill = "grey10", alpha = 0.5) + 
  geom_polygon(data = funnel_exp1, aes(x = y, y = x90), fill = "lightcyan", alpha = 0.7) + 
  geom_point(aes(seg, gt), alpha = 1, size = 1.2) +
  scale_color_brewer(type = "qual", palette = 2) + 
  coord_flip() + 
  scale_x_reverse(limits = c(y_lim_exp1, 0.0), expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() + 
  labs(x = "Standard error (adjusted)", 
       y = "Standardized mean difference (Hedges' g)", 
       color = "", shape = "") +
  theme(legend.position = "bottom"); GB_plot_all

```


## Funnelplot reintegrational/social outcomes - Subgroup analysis {.tabset}
```{r}
GB_dat_reintergration <- 
  GBD_effect |> 
  filter(!str_detect(analysis_plan, "mental|used|hospi|Employment|Physical")) |> 
  select(studyid, gt, vgt, timing, analysis_plan) |> 
  mutate(
    seg = sqrt(vgt),
    timing = if_else(is.na(timing), "Post", timing),
    timing = factor(
      timing, 
      levels = c("Post", "3m", "6m", "9m", "12m", "18m", "24m")
    ),
    es_ID = 1:n()
  ) |> 
  filter(!seg > 0.75) |> 
  arrange(timing)


y_lim_exp2 <- max(sqrt(GB_dat_reintergration$vgt)) + 0.02 

funnel_exp2 <-  tribble(
  ~ x90, ~ x95, ~ x99, ~ y,
  0,     0,     0,     0,
  qnorm(0.05) * y_lim_exp2, qnorm(0.025) * y_lim_exp2, qnorm(0.005) * y_lim_exp2, y_lim_exp2,
  qnorm(0.95) * y_lim_exp2, qnorm(0.975) * y_lim_exp2, qnorm(0.995) * y_lim_exp2, y_lim_exp2,
  0,     0,     0,     0
) 


```


### Overall effect-size for reintegrational/social outcome
```{r}
FP_plot_reintegration_overall <-
  GB_dat_reintergration |> 
  ggplot() + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x99), fill = "grey", alpha = 0.5) + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x95), fill = "grey10", alpha = 0.5) + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x90), fill = "lightcyan", alpha = 0.7) + 
  geom_point(aes(seg, gt), alpha = 1, size = 1.2) +
  scale_color_brewer(type = "qual", palette = 2) + 
  coord_flip() + 
  scale_x_reverse(limits = c(y_lim_exp2, 0.0), expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() + 
  labs(x = "Standard error (adjusted)", 
       y = "Standardized mean difference (Hedges' g)", 
       color = "", shape = "") +
  theme(legend.position = "none");FP_plot_reintegration_overall
```

### Effect-sizes for separated reintegrational/social outcomes
```{r}
FP_plot_reintergration_subgrp <-
  GB_dat_reintergration |> 
  ggplot() + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x99), fill = "grey", alpha = 0.5) + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x95), fill = "grey10", alpha = 0.5) + 
  geom_polygon(data = funnel_exp2, aes(x = y, y = x90), fill = "lightcyan", alpha = 0.7) + 
  geom_point(aes(seg, gt), alpha = 1, size = 1.2) +
  scale_color_brewer(type = "qual", palette = 2) + 
  coord_flip() + 
  facet_wrap(~analysis_plan, scales = "free") +
  scale_x_reverse(limits = c(y_lim_exp2, 0.0), expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() + 
  labs(x = "Standard error (adjusted)", 
       y = "Standardized mean difference (Hedges' g)", 
       color = "", shape = "") +
  theme(legend.position = "none"); FP_plot_reintergration_subgrp

```

## Funnel-plot health outcomes - Subgroup analysis {.tabset}

```{r}
GB_dat_mental_health <- 
  GBD_effect |> 
  mutate(analysis_plan = case_when(
  str_detect(analysis_plan, "All mental health outcomes/Symptoms of psychosis|All mental health outcomes/Negative symptoms") ~ "All mental health outcomes/Symptoms of psychosis",
   TRUE ~ analysis_plan)) |> 
  filter(str_detect(analysis_plan, "mental")) |>
  filter(!str_detect(analysis_plan, "Unused")) |>
  select(studyid, gt, vgt, timing, analysis_plan) |> 
  mutate(
    seg = sqrt(vgt),
    timing = if_else(is.na(timing), "Post", timing),
    timing = factor(
      timing, 
      levels = c("Post", "3m", "6m", "9m", "12m", "18m", "24m")
    ),
    es_ID = 1:n()
  ) |> 
  arrange(timing)


y_lim_exp3 <- max(sqrt(GB_dat_mental_health$vgt)) + 0.02 

funnel_exp3 <-  tribble(
  ~ x90, ~ x95, ~ x99, ~ y,
  0,     0,     0,     0,
  qnorm(0.05) * y_lim_exp3, qnorm(0.025) * y_lim_exp3, qnorm(0.005) * y_lim_exp3, y_lim_exp3,
  qnorm(0.95) * y_lim_exp3, qnorm(0.975) * y_lim_exp3, qnorm(0.995) * y_lim_exp3, y_lim_exp3,
  0,     0,     0,     0
) 
```

### Overall effect size for mental health outcome
```{r}
FP_plot_overall_mental <-
  GB_dat_mental_health |> 
  ggplot() + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x99), fill = "grey", alpha = 0.5) + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x95), fill = "grey10", alpha = 0.5) + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x90), fill = "lightcyan", alpha = 0.7) + 
  geom_point(aes(seg, gt), alpha = 1, size = 1.2) +
  scale_color_brewer(type = "qual", palette = 2) + 
  coord_flip() + 
  scale_x_reverse(limits = c(y_lim_exp3, 0.0), expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() + 
  labs(x = "Standard error (adjusted)", 
       y = "Standardized mean difference (Hedges' g)", 
       color = "", shape = "") +
  theme(legend.position = "none"); FP_plot_overall_mental
```

### Subgroup effect size for mental health outcome
```{r}
FP_plot_subgrp_mental <-
  GB_dat_mental_health |> 
  filter(!(analysis_plan == "All mental health outcomes")) |>
  ggplot() + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x99), fill = "grey", alpha = 0.5) + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x95), fill = "grey10", alpha = 0.5) + 
  geom_polygon(data = funnel_exp3, aes(x = y, y = x90), fill = "lightcyan", alpha = 0.7) + 
  geom_point(aes(seg, gt), alpha = 1, size = 1.2) +
  scale_color_brewer(type = "qual", palette = 2) + 
  coord_flip() + 
  facet_wrap(~analysis_plan, scales = "free") +
  scale_x_reverse(limits = c(y_lim_exp3, 0.0), expand = c(0,0)) + 
  scale_y_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() + 
  labs(x = "Standard error (adjusted)", 
       y = "Standardized mean difference (Hedges' g)", 
       color = "", shape = "") +
  theme(legend.position = "none"); FP_plot_subgrp_mental

```

# Descriptive Tables {.tabset}

## Study Context
```{r}
# Study context
# Percent studies by countries
study_country <- GBD_effect |> 
  group_by(studyid, cnt) |> 
  summarise(
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  group_by(cnt) |>
  summarise(
    study_char = paste0("% ", unique(cnt)), 
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
   # SD = NA,
    
    range = "0-1",
    
    .groups = "drop"
  ) |> 
  select(-cnt); study_country

# Average number of participants per effect size 

participants <- GBD_effect |> 
  group_by(studyid) |> 
  summarise(
    study_avg_sample = mean(N_total),
    es_n = n(), 
    .groups = "drop"
  ) |> 
  summarise(
    study_char = "Number of particiapnts",
    
    Study = n_distinct(studyid), # Studies
    Effect_size = sum(es_n), # Effect size
    
    Mean = round(mean(study_avg_sample)),
  #  SD = round(sd(study_avg_sample)),
    
    range = paste0(min(study_avg_sample), "-", max(study_avg_sample))
    
  ); participants


# Average size of the groups
group_size <- GBD_effect |> 
  group_by(studyid) |> 
  summarise(
    treat_SampS = mean(N_t),
    cont_SampS = mean(N_c),
    
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  summarise(
    study_char = c("Intervention group", "Control group"),
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = c(mean(treat_SampS), mean(cont_SampS)),
   # SD = c(sd(treat_SampS), sd(cont_SampS)),
    
    range = c(
      paste0(min(treat_SampS), "-", round(max(treat_SampS))),
      paste0(min(cont_SampS), "-", round(max(cont_SampS)))
    )
    
  ); group_size

# Number of samples per study 
samples_per_study <- GBD_effect |> 
  group_by(studyid) |> 
  summarise(
    samples = n_distinct(sample_id), 
    es_n = n(),
    
    .groups = "drop"
  ) |>
  summarise(
    study_char = "Samples per study",
    
    Study = sum(samples),  
    Effect_size = sum(es_n),  
    
    Mean = mean(samples), 
   # SD = sd(samples),  
    
    range = paste0(min(samples), "-", max(samples)),
    
    .groups = "drop"
  ); samples_per_study


# Number of distinct studies in review

n_distinct(GBD_effect$studyid)

study_context <- 
  bind_rows(
    study_country,
    participants,
    group_size,
    samples_per_study
    
); study_context


```

## Descriptive of studies design

```{r}

# Proportion cluster randomized or RCT studies

study_design <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    design = unique(design),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(design) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", design),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(design)); study_design

# Dont no if relevant to show details about study outlet and publishment as
# Every indcluded study is a journal article and published. 

# Randomization
study_randomization <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    randomization = unique(randomization),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(randomization) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", randomization),
    
    Mean = Study/sum(Study),
    #SD = NA,
    range = "0-1",
   ) |> 
  relocate(study_char) |>  
  select(-c(randomization)); study_randomization

# Handling of clustering
clustering <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    clustering = unique(cluster_treatment[!is.na(cluster_treatment)]),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(clustering) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", clustering),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(clustering)); clustering

# Analysis strategy 
analysis_strategy <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    analysis_strat = unique(analysis_strategy),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  filter(!is.na(analysis_strat)) |> 
  group_by(analysis_strat) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |>
  mutate(
    
    study_char = paste("%", analysis_strat),
    
    Mean = Study / sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(analysis_strat)); analysis_strategy

design <- 
  bind_rows(
    study_design,
    study_randomization,
    clustering,
    analysis_strategy
); design


```

## Participants characteristics

```{r}
# % Males in treatment and control group

male_per <- 
  GBD_effect |> 
  group_by(studyid) |>  
  summarise(
    
    t_male = mean(as.numeric(male_pct_t), na.rm = TRUE),
    c_male = mean(as.numeric(male_pct_c), na.rm = TRUE),
    
     es_n = sum(!is.na(male_pct_t)),
    
    .groups = "drop"
    
  ) |> 
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"), 
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_male, na.rm = TRUE), mean(c_male, na.rm = TRUE)), 
  #  SD = c(sd(t_male, na.rm = TRUE), sd(c_male, na.rm = TRUE)), 
    range = c(paste(min(t_male, na.rm = TRUE), "-", max(t_male, na.rm = TRUE)),  
              paste(min(c_male, na.rm = TRUE), "-", max(c_male, na.rm = TRUE)))
  ); male_per

# Mean age
age_mean <- 
  GBD_effect |> 
  group_by(studyid) |> 
  summarise(
    
    t_age = mean(as.numeric(age_mean_t), na.rm = TRUE),
    c_age = mean(as.numeric(age_mean_c), na.rm = TRUE),
    
     es_n = sum(!is.na(age_mean_c)),
    
    .groups = "drop"
    
  ) |>  
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"),  # Kategorier for hver gruppe
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_age, na.rm = TRUE), mean(c_age, na.rm = TRUE)),  # Gennemsnit for hver gruppe
    #SD = c(sd(t_age, na.rm = TRUE), sd(c_age, na.rm = TRUE)),  # Standardafvigelse for hver gruppe
    range = c(paste(min(t_age, na.rm = TRUE), "-", max(t_age, na.rm = TRUE)),  # Range for hver gruppe
              paste(min(c_age, na.rm = TRUE), "-", max(c_age, na.rm = TRUE)))
  ); age_mean

# Disorder type
disorder_type <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    disorder = unique(disorder_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(disorder) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", disorder),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(disorder)); disorder_type


assesment <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    assessment = unique(assessment),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(assessment) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", assessment),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
    #SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(assessment)); assesment

# Sample composition
sample_composition <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    composition = unique(sample_comp),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(composition) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", composition),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(composition)); sample_composition

# Sample factors
sample_factors <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    sample_factors = unique(sample_factors),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(sample_factors) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", sample_factors),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(sample_factors)); sample_factors


study_participants <- 
  bind_rows(
    male_per, age_mean, 
   # disorder_type, 
    assesment,
    sample_composition,
    sample_factors
); study_participants


```

## Intervention characteristics

```{r}
# Duration of intervention
duration <- 
  GBD_effect |> 
  group_by(studyid) |>  
  summarise(
    
    m_duration = mean(duration_weeks, na.rm = TRUE),
  
    es_n = n(),
    
    miss_dur = sum(is.na(duration_weeks)),
    
    dur_report = if_else(miss_dur == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |>  
  filter(dur_report != "Not reported") |>  
  summarise(
    study_char = "Duration in weeks",
    
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_duration, na.rm = TRUE),
 #   SD = sd(m_duration, na.rm = TRUE),
    
    range = paste0(min(m_duration, na.rm = TRUE), "-",
                   max(m_duration, na.rm = TRUE)),
  
    
  ); duration

# Mean number of sessions per week

sessions_per_week <- 
  GBD_effect|> 
  mutate(sessions_per_week = as.numeric(sessions_per_week)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(sessions_per_week, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(sessions_per_week)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Number of sessions per week",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
 #   SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  ); sessions_per_week

# Average group size in the treatment intervention
avg_intevention_group_size <- 
  GBD_effect|> 
  mutate(avg_group_size = as.numeric(avg_group_size)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(avg_group_size, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(avg_group_size)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Average group size",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
    #SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  ); avg_intevention_group_size

# Number of interventions of each study
interventions <- GBD_effect|> 
 mutate(N_treatments = as.numeric(N_treatments)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(N_treatments, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(N_treatments)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Treatments",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
  #  SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  ); interventions

# Treatment types 
treatment_types <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    treatment_type = unique(trt_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(treatment_type) |> 
  summarise(

    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", treatment_type),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(treatment_type)); treatment_types



# Implementation types 
implementation <- GBD_effect |>  
  group_by(studyid) |> 
  summarise(
    implementation = unique(implementation),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(implementation) |> 
  summarise(
    Study = n_distinct(studyid),
    effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", implementation),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(implementation)); implementation


intervention_characteristics <- bind_rows(
  duration, sessions_per_week, 
  avg_intevention_group_size, 
  interventions, 
  treatment_types
)


```

## Control group

```{r}
# Control types 
control <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    control = unique(control),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(control) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", control),
    
    Mean = Study/n_distinct(GBD_effect$studyid),
    # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(control)); control
```

## Methodological features

```{r}
# Average number of effect size per study
avg_es_study <- 
  GBD_effect |> 
  group_by(studyid) |> 
  summarise(
    
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  summarise(
    study_char = "Average n of es",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(es_n),
  #  SD = sd(es_n),
    
    range = paste0(min(es_n), "-", max(es_n))
    
  ); avg_es_study
```

## Outcome and measurement characteristics

```{r}
# Overall constructs
construct <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    overall_construct = unique(analysis_plan),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(overall_construct) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", overall_construct),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(overall_construct)); construct


# Type of test 
test <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    test_type = unique(test_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(test_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", test_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(test_type)); test

# Type of measurement
measure_type <- GBD_effect |>  
  group_by(studyid) |>  
  summarise(
    measure_type = unique(measure_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(measure_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", measure_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(measure_type)); measure_type

outcome_measurement <- bind_rows(
  construct, test, measure_type
  
)

```

## Table 1 and 2

```{r, echo=FALSE}
table1 <- bind_rows(
  study_context, design, 
  study_participants, 
  intervention_characteristics, 
  control, 
  avg_es_study, 
  outcome_measurement
)



table1_percent <- 
  table1 |> 
  filter(str_detect(study_char, "%")) |> 
  select(-c(range)) |> 
  mutate(
    Mean = round(Mean, 3),
    
  ); table1_percent


table2_rest_desc <- 
  table1 |> 
  filter(!str_detect(study_char, "%")) |> 
  mutate(
    
    across(Mean, ~ round(.x, 3))
    
  ); table2_rest_desc

# Converting into readable APA-style in word
table1_percent_out <- nice_table(table1_percent); table1_percent_out

#flextable::save_as_docx(table1_percent_out, path = "table1_percent.docx")

table2_rest_desc_out <- nice_table(table2_rest_desc); table2_rest_desc_out

#flextable::save_as_docx(table2_rest_desc_out, path = "table2_rest_desc.docx")


```

## Risk of Bias details

```{r}
# Distribution of RoB2 evaluations
RoB2_dat <- GBD_effect |> 
  select(rob_tool:Overall, studyid, Author) |> 
  filter(rob_tool == "RoB2") |> 
  select(-c(rob_tool,D6:D7))

p_rob2 <- rob_summary(data = RoB2_dat, tool = "ROB2", overall = TRUE)

# Distribution of ROBINS-I evaluations
ROBINS1_dat <- GBD_effect |> 
  select(rob_tool:Overall, studyid, Author) |> 
  filter(rob_tool == "ROBINS-I") |> 
  select(-c(rob_tool))

p_robins <- rob_summary(data = ROBINS1_dat, tool = "ROBINS-I", overall = TRUE)

```

# Descriptive tables for each outcome {.tabset}

## Generating descrptive tables: Wellbeing and Quality of life

```{r}
wellbeing_QoL <- GBD_effect |> 
  filter(analysis_plan == "Wellbeing and Quality of Life")


# Study context
# Percent studies by countries
study_context_WQoL <- wellbeing_QoL |> 
  group_by(studyid, cnt) |> 
  summarise(
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  group_by(cnt) |>
  summarise(
    study_char = paste0("% ", unique(cnt)), 
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
   # SD = NA,
    
    range = "0-1",
    
    .groups = "drop"
  ) |> 
  select(-cnt)

# Average number of participants per effect size 

participants_WQoL <- wellbeing_QoL |> 
  group_by(studyid) |> 
  summarise(
    study_avg_sample = mean(N_total),
    es_n = n(), 
    .groups = "drop"
  ) |> 
  summarise(
    study_char = "Number of particiapnts",
    
    Study = n_distinct(studyid), # Studies
    Effect_size = sum(es_n), # Effect size
    
    Mean = round(mean(study_avg_sample)),
  #  SD = round(sd(study_avg_sample)),
    
    range = paste0(min(study_avg_sample), "-", max(study_avg_sample))
    
  )



# Average size of the groups
group_size_WQoL <- wellbeing_QoL |> 
  group_by(studyid) |> 
  summarise(
    treat_SampS = mean(N_t),
    cont_SampS = mean(N_c),
    
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  summarise(
    study_char = c("Intervention group", "Control group"),
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = c(mean(treat_SampS), mean(cont_SampS)),
   # SD = c(sd(treat_SampS), sd(cont_SampS)),
    
    range = c(
      paste0(min(treat_SampS), "-", round(max(treat_SampS))),
      paste0(min(cont_SampS), "-", round(max(cont_SampS)))
    )
    
  )

# Number of samples per study 
samples_per_study_WQoL <- wellbeing_QoL |> 
  group_by(studyid) |> 
  summarise(
    samples = n_distinct(sample_id), 
    es_n = n(),
    
    .groups = "drop"
  ) |>
  summarise(
    study_char = "Samples per study",
    
    Study = sum(samples),  
    Effect_size = sum(es_n),  
    
    Mean = mean(samples), 
   # SD = sd(samples),  
    
    range = paste0(min(samples), "-", max(samples)),
    
    .groups = "drop"
  )


# Number of distinct studies in review

n_distinct(wellbeing_QoL$studyid)

study_context_WQoL <- 
  bind_rows(
    study_context_WQoL,
    participants_WQoL,
 #   ESS,
    group_size_WQoL,
    samples_per_study_WQoL
    
)

# Study Design
# Proportion cluster randomized or RCT studies
study_design_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    design = unique(design),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(design) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", design),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(design))


# Randomization
study_randomization_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |>  
  summarise(
    randomization = unique(randomization),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(randomization) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", randomization),
    
    Mean = Study/sum(Study),
    #SD = NA,
    range = "0-1",
   ) |> 
  relocate(study_char) |>  
  select(-c(randomization))

# Handling of clustering
clustering_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    clustering = unique(cluster_treatment[!is.na(cluster_treatment)]),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(clustering) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", clustering),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(clustering))

# Analysis strategy 
analysis_strategy_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    analysis_strat = unique(analysis_strategy),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  filter(!is.na(analysis_strat)) |> 
  group_by(analysis_strat) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |>
  mutate(
    
    study_char = paste("%", analysis_strat),
    
    Mean = Study / sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(analysis_strat))

design_WQoL <- 
  bind_rows(
    study_design_WQoL,
    study_randomization_WQoL,
    clustering_WQoL,
    analysis_strategy_WQoL
)


# Study participants
# % Males in treatment and control group

male_per_WQoL <- 
  wellbeing_QoL |> 
  group_by(studyid) |>  
  summarise(
    
    t_male = mean(as.numeric(male_pct_t), na.rm = TRUE),
    c_male = mean(as.numeric(male_pct_c), na.rm = TRUE),
    
     es_n = sum(!is.na(male_pct_t)),
    
    .groups = "drop"
    
  ) |> 
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"), 
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_male, na.rm = TRUE), mean(c_male, na.rm = TRUE)), 
  #  SD = c(sd(t_male, na.rm = TRUE), sd(c_male, na.rm = TRUE)), 
    range = c(paste(min(t_male, na.rm = TRUE), "-", max(t_male, na.rm = TRUE)),  
              paste(min(c_male, na.rm = TRUE), "-", max(c_male, na.rm = TRUE)))
  )

# Mean age
age_mean_WQoL <- 
  wellbeing_QoL |> 
  group_by(studyid) |> 
  summarise(
    
    t_age = mean(as.numeric(age_mean_t), na.rm = TRUE),
    c_age = mean(as.numeric(age_mean_c), na.rm = TRUE),
    
     es_n = sum(!is.na(age_mean_c)),
    
    .groups = "drop"
    
  ) |>  
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"),  # Kategorier for hver gruppe
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_age, na.rm = TRUE), mean(c_age, na.rm = TRUE)),  # Gennemsnit for hver gruppe
    #SD = c(sd(t_age, na.rm = TRUE), sd(c_age, na.rm = TRUE)),  # Standardafvigelse for hver gruppe
    range = c(paste(min(t_age, na.rm = TRUE), "-", max(t_age, na.rm = TRUE)),  # Range for hver gruppe
              paste(min(c_age, na.rm = TRUE), "-", max(c_age, na.rm = TRUE)))
  )

# Disorder type
disorder_type_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    disorder = unique(disorder_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(disorder) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", disorder),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(disorder))


assesment_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |>  
  summarise(
    assessment = unique(assessment),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(assessment) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", assessment),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
    #SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(assessment))

# Sample composition
sample_composition_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    composition = unique(sample_comp),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(composition) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", composition),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(composition))

# Sample factors
sample_factors_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    sample_factors = unique(sample_factors),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(sample_factors) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", sample_factors),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(sample_factors))


study_participants_WQoL <- 
  bind_rows(
    male_per_WQoL, age_mean_WQoL, 
   # disorder_type, 
    assesment_WQoL,
    sample_composition_WQoL,
    sample_factors_WQoL
)


# Intervention characteristics 

# Duration of intervention
duration_WQoL <- 
  wellbeing_QoL |> 
  group_by(studyid) |>  
  summarise(
    
    m_duration = mean(duration_weeks, na.rm = TRUE),
  
    es_n = n(),
    
    miss_dur = sum(is.na(duration_weeks)),
    
    dur_report = if_else(miss_dur == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |>  
  filter(dur_report != "Not reported") |>  
  summarise(
    study_char = "Duration in weeks",
    
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_duration, na.rm = TRUE),
 #   SD = sd(m_duration, na.rm = TRUE),
    
    range = paste0(min(m_duration, na.rm = TRUE), "-",
                   max(m_duration, na.rm = TRUE)),
  
    
  )

# Mean number of sessions per week

sessions_per_week_WQoL <- 
  wellbeing_QoL|> 
  mutate(sessions_per_week = as.numeric(sessions_per_week)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(sessions_per_week, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(sessions_per_week)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Number of sessions per week",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
 #   SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Average group size in the treatment intervention
avg_intevention_group_size_WQoL <- 
  wellbeing_QoL|> 
  mutate(avg_group_size = as.numeric(avg_group_size)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(avg_group_size, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(avg_group_size)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Average group size",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
    #SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Number of interventions of each study
interventions_WQoL <- wellbeing_QoL|> 
 mutate(N_treatments = as.numeric(N_treatments)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(N_treatments, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(N_treatments)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Treatments",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
  #  SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Treatment types 
treatment_types_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    treatment_type = unique(trt_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(treatment_type) |> 
  summarise(

    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", treatment_type),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(treatment_type))



# Implementation types 
implementation_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |> 
  summarise(
    implementation = unique(implementation),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(implementation) |> 
  summarise(
    Study = n_distinct(studyid),
    effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", implementation),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(implementation))


intervention_characteristics_WQoL <- bind_rows(
  duration_WQoL, sessions_per_week_WQoL, 
  avg_intevention_group_size_WQoL, 
  interventions_WQoL, 
  treatment_types_WQoL
)

# Control group 
# Control types 
control_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |>  
  summarise(
    control = unique(control),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(control) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", control),
    
    Mean = Study/n_distinct(wellbeing_QoL$studyid),
    # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(control))

# Methodological features
# Average number of effect size per study
avg_es_study_WQoL <- 
  wellbeing_QoL |> 
  group_by(studyid) |> 
  summarise(
    
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  summarise(
    study_char = "Average n of es",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(es_n),
  #  SD = sd(es_n),
    
    range = paste0(min(es_n), "-", max(es_n))
    
  )



# Outcome and measurement characteristics
# Type of test 
test_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |>  
  summarise(
    test_type = unique(test_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(test_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", test_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(test_type))

# Type of measurement
measure_type_WQoL <- wellbeing_QoL |>  
  group_by(studyid) |>  
  summarise(
    measure_type = unique(measure_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(measure_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", measure_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(measure_type))

outcome_measurement_WQoL <- bind_rows(
  test_WQoL, measure_type_WQoL
)
```

## Tables for Wellbeing and Quality of Life

```{r}
table_WQoL <- bind_rows(
  study_context_WQoL, design_WQoL, 
  study_participants_WQoL, 
  intervention_characteristics_WQoL, 
  control_WQoL, 
  avg_es_study_WQoL, 
  outcome_measurement_WQoL
)



table_WQoL_percent <- 
  table_WQoL |> 
  filter(str_detect(study_char, "%")) |> 
  select(-c(range)) |> 
  mutate(
    Mean = round(Mean, 3),
    
  )


table_WQoL_rest_desc <- 
  table_WQoL |> 
  filter(!str_detect(study_char, "%")) |> 
  mutate(
    
    across(Mean, ~ round(.x, 3))
    
  )


# Converting into readable APA-style in word
table_WQoL_percent_out <- nice_table(table_WQoL_percent); table_WQoL_percent_out

#flextable::save_as_docx(table1_percent_out, path = "table1_percent.docx")

table_WQoL_rest_desc_out <- nice_table(table_WQoL_rest_desc); table_WQoL_rest_desc_out


```

## Descrptive tables: Social functioning (degree of impairment)

```{r, echo=FALSE}
social_functioning <- GBD_effect |> 
  filter(analysis_plan == "Social functioning (degree of impairment)")


# Study context
# Percent studies by countries
study_context_functioning <- social_functioning |> 
  group_by(studyid, cnt) |> 
  summarise(
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  group_by(cnt) |>
  summarise(
    study_char = paste0("% ", unique(cnt)), 
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = Study/n_distinct(social_functioning$studyid),
   # SD = NA,
    
    range = "0-1",
    
    .groups = "drop"
  ) |> 
  select(-cnt)

# Average number of participants per effect size 

participants_functioning <- social_functioning |> 
  group_by(studyid) |> 
  summarise(
    study_avg_sample = mean(N_total),
    es_n = n(), 
    .groups = "drop"
  ) |> 
  summarise(
    study_char = "Number of particiapnts",
    
    Study = n_distinct(studyid), # Studies
    Effect_size = sum(es_n), # Effect size
    
    Mean = round(mean(study_avg_sample)),
  #  SD = round(sd(study_avg_sample)),
    
    range = paste0(min(study_avg_sample), "-", max(study_avg_sample))
    
  )



# Average size of the groups
group_size_functioning <- social_functioning |> 
  group_by(studyid) |> 
  summarise(
    treat_SampS = mean(N_t),
    cont_SampS = mean(N_c),
    
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  summarise(
    study_char = c("Intervention group", "Control group"),
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = c(mean(treat_SampS), mean(cont_SampS)),
   # SD = c(sd(treat_SampS), sd(cont_SampS)),
    
    range = c(
      paste0(min(treat_SampS), "-", round(max(treat_SampS))),
      paste0(min(cont_SampS), "-", round(max(cont_SampS)))
    )
    
  )

# Number of samples per study 
samples_per_study_functioning <- social_functioning |> 
  group_by(studyid) |> 
  summarise(
    samples = n_distinct(sample_id), 
    es_n = n(),
    
    .groups = "drop"
  ) |>
  summarise(
    study_char = "Samples per study",
    
    Study = sum(samples),  
    Effect_size = sum(es_n),  
    
    Mean = mean(samples), 
   # SD = sd(samples),  
    
    range = paste0(min(samples), "-", max(samples)),
    
    .groups = "drop"
  )


# Number of distinct studies in review

n_distinct(social_functioning$studyid)

study_context_functioning <- 
  bind_rows(
    study_context_functioning,
    participants_functioning,
 #   ESS,
    group_size_functioning,
    samples_per_study_functioning
    
)

# Study Design
# Proportion cluster randomized or RCT studies
study_design_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    design = unique(design),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(design) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", design),
    
    Mean = Study/n_distinct(social_functioning$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(design))


# Randomization
study_randomization_functioning <- social_functioning |>  
  group_by(studyid) |>  
  summarise(
    randomization = unique(randomization),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(randomization) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", randomization),
    
    Mean = Study/sum(Study),
    #SD = NA,
    range = "0-1",
   ) |> 
  relocate(study_char) |>  
  select(-c(randomization))

# Handling of clustering
clustering_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    clustering = unique(cluster_treatment[!is.na(cluster_treatment)]),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(clustering) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", clustering),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(clustering))

# Analysis strategy 
analysis_strategy_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    analysis_strat = unique(analysis_strategy),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  filter(!is.na(analysis_strat)) |> 
  group_by(analysis_strat) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |>
  mutate(
    
    study_char = paste("%", analysis_strat),
    
    Mean = Study / sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(analysis_strat))

design_functioning <- 
  bind_rows(
    study_design_functioning,
    study_randomization_functioning,
    clustering_functioning,
    analysis_strategy_functioning
)


# Study participants
# % Males in treatment and control group

male_per_functioning <- 
  social_functioning |> 
  group_by(studyid) |>  
  summarise(
    
    t_male = mean(as.numeric(male_pct_t), na.rm = TRUE),
    c_male = mean(as.numeric(male_pct_c), na.rm = TRUE),
    
     es_n = sum(!is.na(male_pct_t)),
    
    .groups = "drop"
    
  ) |> 
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"), 
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_male, na.rm = TRUE), mean(c_male, na.rm = TRUE)), 
  #  SD = c(sd(t_male, na.rm = TRUE), sd(c_male, na.rm = TRUE)), 
    range = c(paste(min(t_male, na.rm = TRUE), "-", max(t_male, na.rm = TRUE)),  
              paste(min(c_male, na.rm = TRUE), "-", max(c_male, na.rm = TRUE)))
  )

# Mean age
age_mean_functioning <- 
  social_functioning |> 
  group_by(studyid) |> 
  summarise(
    
    t_age = mean(as.numeric(age_mean_t), na.rm = TRUE),
    c_age = mean(as.numeric(age_mean_c), na.rm = TRUE),
    
     es_n = sum(!is.na(age_mean_c)),
    
    .groups = "drop"
    
  ) |>  
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"),  # Kategorier for hver gruppe
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_age, na.rm = TRUE), mean(c_age, na.rm = TRUE)),  # Gennemsnit for hver gruppe
    #SD = c(sd(t_age, na.rm = TRUE), sd(c_age, na.rm = TRUE)),  # Standardafvigelse for hver gruppe
    range = c(paste(min(t_age, na.rm = TRUE), "-", max(t_age, na.rm = TRUE)),  # Range for hver gruppe
              paste(min(c_age, na.rm = TRUE), "-", max(c_age, na.rm = TRUE)))
  )

# Disorder type
disorder_type_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    disorder = unique(disorder_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(disorder) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", disorder),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(disorder))


assesment_functioning <- social_functioning |>  
  group_by(studyid) |>  
  summarise(
    assessment = unique(assessment),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(assessment) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", assessment),
    
    Mean = Study/n_distinct(social_functioning$studyid),
    #SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(assessment))

# Sample composition
sample_composition_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    composition = unique(sample_comp),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(composition) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", composition),
    
    Mean = Study/n_distinct(social_functioning$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(composition))

# Sample factors
sample_factors_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    sample_factors = unique(sample_factors),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(sample_factors) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", sample_factors),
    
    Mean = Study/n_distinct(social_functioning$studyid),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(sample_factors))


study_participants_functioning <- 
  bind_rows(
    male_per_functioning, age_mean_functioning, 
   # disorder_type, 
    assesment_functioning,
    sample_composition_functioning,
    sample_factors_functioning
)


# Intervention characteristics 

# Duration of intervention
duration_functioning <- 
  social_functioning |> 
  group_by(studyid) |>  
  summarise(
    
    m_duration = mean(duration_weeks, na.rm = TRUE),
  
    es_n = n(),
    
    miss_dur = sum(is.na(duration_weeks)),
    
    dur_report = if_else(miss_dur == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |>  
  filter(dur_report != "Not reported") |>  
  summarise(
    study_char = "Duration in weeks",
    
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_duration, na.rm = TRUE),
 #   SD = sd(m_duration, na.rm = TRUE),
    
    range = paste0(min(m_duration, na.rm = TRUE), "-",
                   max(m_duration, na.rm = TRUE)),
  
    
  )

# Mean number of sessions per week

sessions_per_week_functioning <- 
  social_functioning|> 
  mutate(sessions_per_week = as.numeric(sessions_per_week)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(sessions_per_week, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(sessions_per_week)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Number of sessions per week",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
 #   SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Average group size in the treatment intervention
avg_intevention_group_size_functioning <- 
  social_functioning|> 
  mutate(avg_group_size = as.numeric(avg_group_size)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(avg_group_size, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(avg_group_size)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Average group size",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
    #SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Number of interventions of each study
interventions_functioning <- social_functioning|> 
 mutate(N_treatments = as.numeric(N_treatments)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(N_treatments, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(N_treatments)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Treatments",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
  #  SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Treatment types 
treatment_types_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    treatment_type = unique(trt_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(treatment_type) |> 
  summarise(

    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", treatment_type),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(treatment_type))



# Implementation types 
implementation_functioning <- social_functioning |>  
  group_by(studyid) |> 
  summarise(
    implementation = unique(implementation),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(implementation) |> 
  summarise(
    Study = n_distinct(studyid),
    effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", implementation),
    
    Mean = Study/n_distinct(social_functioning$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(implementation))


intervention_characteristics_functioning <- bind_rows(
  duration_functioning, sessions_per_week_functioning, 
  avg_intevention_group_size_functioning, 
  interventions_functioning, 
  treatment_types_functioning
)

# Control group 
# Control types 
control_functioning <- social_functioning |>  
  group_by(studyid) |>  
  summarise(
    control = unique(control),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(control) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", control),
    
    Mean = Study/n_distinct(social_functioning$studyid),
    # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(control))

# Methodological features
# Average number of effect size per study
avg_es_study_functioning <- 
  social_functioning |> 
  group_by(studyid) |> 
  summarise(
    
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  summarise(
    study_char = "Average n of es",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(es_n),
  #  SD = sd(es_n),
    
    range = paste0(min(es_n), "-", max(es_n))
    
  )



# Outcome and measurement characteristics
# Type of test 
test_functioning <- social_functioning |>  
  group_by(studyid) |>  
  summarise(
    test_type = unique(test_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(test_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", test_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(test_type))

# Type of measurement
measure_type_functioning <- social_functioning |>  
  group_by(studyid) |>  
  summarise(
    measure_type = unique(measure_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(measure_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", measure_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(measure_type))

outcome_measurement_functioning <- bind_rows(
  test_functioning, measure_type_functioning
)
```

## Tables for Social functioning (degree of impairment)

```{r, echo=FALSE}
table_functioning <- bind_rows(
  study_context_functioning, design_functioning, 
  study_participants_functioning, 
  intervention_characteristics_functioning, 
  control_functioning, 
  avg_es_study_functioning, 
  outcome_measurement_functioning
)



table_functioning_percent <- 
  table_functioning |> 
  filter(str_detect(study_char, "%")) |> 
  select(-c(range)) |> 
  mutate(
    Mean = round(Mean, 3),
    
  )

table_functioning_rest_desc <- 
  table_functioning |> 
  filter(!str_detect(study_char, "%")) |> 
  mutate(
    
    across(Mean, ~ round(.x, 3))
    
  )




# Converting into readable APA-style in word
table_functioning_percent_out <- nice_table(table_functioning_percent); table_functioning_percent_out

#flextable::save_as_docx(table1_percent_out, path = "table1_percent.docx")

table_functioning_rest_desc_out <- nice_table(table_functioning_rest_desc); table_functioning_rest_desc_out

```

## Descrptive tables: Hope, Empowerment & Self-efficacy

```{r, echo=FALSE}
hope <- GBD_effect |> 
  filter(analysis_plan == "Hope, Empowerment & Self-efficacy")


# Study context
# Percent studies by countries
study_context_hope <- hope |> 
  group_by(studyid, cnt) |> 
  summarise(
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  group_by(cnt) |>
  summarise(
    study_char = paste0("% ", unique(cnt)), 
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = Study/n_distinct(hope$studyid),
   # SD = NA,
    
    range = "0-1",
    
    .groups = "drop"
  ) |> 
  select(-cnt)

# Average number of participants per effect size 

participants_hope <- hope |> 
  group_by(studyid) |> 
  summarise(
    study_avg_sample = mean(N_total),
    es_n = n(), 
    .groups = "drop"
  ) |> 
  summarise(
    study_char = "Number of particiapnts",
    
    Study = n_distinct(studyid), # Studies
    Effect_size = sum(es_n), # Effect size
    
    Mean = round(mean(study_avg_sample)),
  #  SD = round(sd(study_avg_sample)),
    
    range = paste0(min(study_avg_sample), "-", max(study_avg_sample))
    
  )



# Average size of the groups
group_size_hope <- hope |> 
  group_by(studyid) |> 
  summarise(
    treat_SampS = mean(N_t),
    cont_SampS = mean(N_c),
    
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  summarise(
    study_char = c("Intervention group", "Control group"),
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = c(mean(treat_SampS), mean(cont_SampS)),
   # SD = c(sd(treat_SampS), sd(cont_SampS)),
    
    range = c(
      paste0(min(treat_SampS), "-", round(max(treat_SampS))),
      paste0(min(cont_SampS), "-", round(max(cont_SampS)))
    )
    
  )

# Number of samples per study 
samples_per_study_hope <- hope |> 
  group_by(studyid) |> 
  summarise(
    samples = n_distinct(sample_id), 
    es_n = n(),
    
    .groups = "drop"
  ) |>
  summarise(
    study_char = "Samples per study",
    
    Study = sum(samples),  
    Effect_size = sum(es_n),  
    
    Mean = mean(samples), 
   # SD = sd(samples),  
    
    range = paste0(min(samples), "-", max(samples)),
    
    .groups = "drop"
  )

# Number of distinct studies in review

n_distinct(hope$studyid)

study_context_hope <- 
  bind_rows(
    study_context_hope,
    participants_hope,
 #   ESS,
    group_size_hope,
    samples_per_study_hope
    
)

# Study Design
# Proportion cluster randomized or RCT studies
study_design_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    design = unique(design),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(design) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", design),
    
    Mean = Study/n_distinct(hope$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(design))


# Randomization
study_randomization_hope <- hope |>  
  group_by(studyid) |>  
  summarise(
    randomization = unique(randomization),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(randomization) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", randomization),
    
    Mean = Study/sum(Study),
    #SD = NA,
    range = "0-1",
   ) |> 
  relocate(study_char) |>  
  select(-c(randomization))

# Handling of clustering
clustering_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    clustering = unique(cluster_treatment[!is.na(cluster_treatment)]),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(clustering) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", clustering),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(clustering))

# Analysis strategy 
analysis_strategy_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    analysis_strat = unique(analysis_strategy),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  filter(!is.na(analysis_strat)) |> 
  group_by(analysis_strat) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |>
  mutate(
    
    study_char = paste("%", analysis_strat),
    
    Mean = Study / sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(analysis_strat))

design_hope <- 
  bind_rows(
    study_design_hope,
    study_randomization_hope,
    clustering_hope,
    analysis_strategy_hope
)

# Study participants
# % Males in treatment and control group

male_per_hope <- 
  hope |> 
  group_by(studyid) |>  
  summarise(
    
    t_male = mean(as.numeric(male_pct_t), na.rm = TRUE),
    c_male = mean(as.numeric(male_pct_c), na.rm = TRUE),
    
     es_n = sum(!is.na(male_pct_t)),
    
    .groups = "drop"
    
  ) |> 
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"), 
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_male, na.rm = TRUE), mean(c_male, na.rm = TRUE)), 
  #  SD = c(sd(t_male, na.rm = TRUE), sd(c_male, na.rm = TRUE)), 
    range = c(paste(min(t_male, na.rm = TRUE), "-", max(t_male, na.rm = TRUE)),  
              paste(min(c_male, na.rm = TRUE), "-", max(c_male, na.rm = TRUE)))
  )

# Mean age
age_mean_hope <- 
  hope |> 
  group_by(studyid) |> 
  summarise(
    
    t_age = mean(as.numeric(age_mean_t), na.rm = TRUE),
    c_age = mean(as.numeric(age_mean_c), na.rm = TRUE),
    
     es_n = sum(!is.na(age_mean_c)),
    
    .groups = "drop"
    
  ) |>  
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"),  # Kategorier for hver gruppe
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_age, na.rm = TRUE), mean(c_age, na.rm = TRUE)),  # Gennemsnit for hver gruppe
    #SD = c(sd(t_age, na.rm = TRUE), sd(c_age, na.rm = TRUE)),  # Standardafvigelse for hver gruppe
    range = c(paste(min(t_age, na.rm = TRUE), "-", max(t_age, na.rm = TRUE)),  # Range for hver gruppe
              paste(min(c_age, na.rm = TRUE), "-", max(c_age, na.rm = TRUE)))
  )

# Disorder type
disorder_type_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    disorder = unique(disorder_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(disorder) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", disorder),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(disorder))


assesment_hope <- hope |>  
  group_by(studyid) |>  
  summarise(
    assessment = unique(assessment),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(assessment) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", assessment),
    
    Mean = Study/n_distinct(hope$studyid),
    #SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(assessment))

# Sample composition
sample_composition_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    composition = unique(sample_comp),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(composition) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", composition),
    
    Mean = Study/n_distinct(hope$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(composition))

# Sample factors
sample_factors_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    sample_factors = unique(sample_factors),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(sample_factors) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", sample_factors),
    
    Mean = Study/n_distinct(hope$studyid),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(sample_factors))


study_participants_hope <- 
  bind_rows(
    male_per_hope, age_mean_hope, 
   # disorder_type, 
    assesment_hope,
    sample_composition_hope,
    sample_factors_hope
)


# Intervention characteristics 

# Duration of intervention
duration_hope <- 
  hope |> 
  group_by(studyid) |>  
  summarise(
    
    m_duration = mean(duration_weeks, na.rm = TRUE),
  
    es_n = n(),
    
    miss_dur = sum(is.na(duration_weeks)),
    
    dur_report = if_else(miss_dur == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |>  
  filter(dur_report != "Not reported") |>  
  summarise(
    study_char = "Duration in weeks",
    
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_duration, na.rm = TRUE),
 #   SD = sd(m_duration, na.rm = TRUE),
    
    range = paste0(min(m_duration, na.rm = TRUE), "-",
                   max(m_duration, na.rm = TRUE)),
  
    
  )

# Mean number of sessions per week

sessions_per_week_hope <- 
  hope|> 
  mutate(sessions_per_week = as.numeric(sessions_per_week)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(sessions_per_week, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(sessions_per_week)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Number of sessions per week",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
 #   SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Average group size in the treatment intervention
avg_intevention_group_size_hope <- 
  hope|> 
  mutate(avg_group_size = as.numeric(avg_group_size)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(avg_group_size, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(avg_group_size)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Average group size",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
    #SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Number of interventions of each study
interventions_hope <- hope|> 
 mutate(N_treatments = as.numeric(N_treatments)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(N_treatments, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(N_treatments)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Treatments",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
  #  SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Treatment types 
treatment_types_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    treatment_type = unique(trt_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(treatment_type) |> 
  summarise(

    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", treatment_type),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(treatment_type))



# Implementation types 
implementation_hope <- hope |>  
  group_by(studyid) |> 
  summarise(
    implementation = unique(implementation),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(implementation) |> 
  summarise(
    Study = n_distinct(studyid),
    effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", implementation),
    
    Mean = Study/n_distinct(hope$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(implementation))


intervention_characteristics_hope <- bind_rows(
  duration_hope, sessions_per_week_hope, 
  avg_intevention_group_size_hope, 
  interventions_hope, 
  treatment_types_hope
)

# Control group 
# Control types 
control_hope <- hope |>  
  group_by(studyid) |>  
  summarise(
    control = unique(control),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(control) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", control),
    
    Mean = Study/n_distinct(hope$studyid),
    # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(control))

# Methodological features
# Average number of effect size per study
avg_es_study_hope <- 
  hope |> 
  group_by(studyid) |> 
  summarise(
    
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  summarise(
    study_char = "Average n of es",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(es_n),
  #  SD = sd(es_n),
    
    range = paste0(min(es_n), "-", max(es_n))
    
  )



# Outcome and measurement characteristics
# Type of test 
test_hope <- hope |>  
  group_by(studyid) |>  
  summarise(
    test_type = unique(test_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(test_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", test_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(test_type))

# Type of measurement
measure_type_hope <- hope |>  
  group_by(studyid) |>  
  summarise(
    measure_type = unique(measure_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(measure_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", measure_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(measure_type))

outcome_measurement_hope <- bind_rows(
  test_hope, measure_type_hope
)
```

## Tables for Hope, Empowerment & Self-efficacy

```{r, echo=FALSE}
table_hope <- bind_rows(
  study_context_hope, design_hope, 
  study_participants_hope, 
  intervention_characteristics_hope, 
  control_hope, 
  avg_es_study_hope, 
  outcome_measurement_hope
)



table_hope_percent <- 
  table_hope |> 
  filter(str_detect(study_char, "%")) |> 
  select(-c(range)) |> 
  mutate(
    Mean = round(Mean, 3),
    
  )


table_hope_rest_desc <- 
  table_hope |> 
  filter(!str_detect(study_char, "%")) |> 
  mutate(
    
    across(Mean, ~ round(.x, 3))
    
  )


# Converting into readable APA-style in word
table_hope_percent_out <- nice_table(table_hope_percent); table_hope_percent_out

#flextable::save_as_docx(table1_percent_out, path = "table1_percent.docx")

table_hope_rest_desc_out <- nice_table(table_hope_rest_desc); table_hope_rest_desc_out

```

## Descrptive tables: Alcohol and drug abuse/misuse

```{r, echo=FALSE}
abuse_misuse <- GBD_effect |> 
  filter(analysis_plan == "Alcohol and drug abuse/misuse")


# Study context
# Percent studies by countries
study_context_abuse_misuse <- abuse_misuse |> 
  group_by(studyid, cnt) |> 
  summarise(
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  group_by(cnt) |>
  summarise(
    study_char = paste0("% ", unique(cnt)), 
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
   # SD = NA,
    
    range = "0-1",
    
    .groups = "drop"
  ) |> 
  select(-cnt)

# Average number of participants per effect size 

participants_abuse_misuse <- abuse_misuse |> 
  group_by(studyid) |> 
  summarise(
    study_avg_sample = mean(N_total),
    es_n = n(), 
    .groups = "drop"
  ) |> 
  summarise(
    study_char = "Number of particiapnts",
    
    Study = n_distinct(studyid), # Studies
    Effect_size = sum(es_n), # Effect size
    
    Mean = round(mean(study_avg_sample)),
  #  SD = round(sd(study_avg_sample)),
    
    range = paste0(min(study_avg_sample), "-", max(study_avg_sample))
    
  )



# Average size of the groups
group_size_abuse_misuse <- abuse_misuse |> 
  group_by(studyid) |> 
  summarise(
    treat_SampS = mean(N_t),
    cont_SampS = mean(N_c),
    
    es_n = n(),
    
    .groups = "drop"
  ) |> 
  summarise(
    study_char = c("Intervention group", "Control group"),
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = c(mean(treat_SampS), mean(cont_SampS)),
   # SD = c(sd(treat_SampS), sd(cont_SampS)),
    
    range = c(
      paste0(min(treat_SampS), "-", round(max(treat_SampS))),
      paste0(min(cont_SampS), "-", round(max(cont_SampS)))
    )
    
  )

# Number of samples per study 
samples_per_study_abuse_misuse <- abuse_misuse |> 
  group_by(studyid) |> 
  summarise(
    samples = n_distinct(sample_id), 
    es_n = n(),
    
    .groups = "drop"
  ) |>
  summarise(
    study_char = "Samples per study",
    
    Study = sum(samples),  
    Effect_size = sum(es_n),  
    
    Mean = mean(samples), 
   # SD = sd(samples),  
    
    range = paste0(min(samples), "-", max(samples)),
    
    .groups = "drop"
  )


# Number of distinct studies in review

n_distinct(abuse_misuse$studyid)

study_context_abuse_misuse <- 
  bind_rows(
    study_context_abuse_misuse,
    participants_abuse_misuse,
 #   ESS,
    group_size_abuse_misuse,
    samples_per_study_abuse_misuse
    
)

# Study Design
# Proportion cluster randomized or RCT studies
study_design_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    design = unique(design),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(design) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", design),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(design))


# Randomization
study_randomization_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |>  
  summarise(
    randomization = unique(randomization),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(randomization) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", randomization),
    
    Mean = Study/sum(Study),
    #SD = NA,
    range = "0-1",
   ) |> 
  relocate(study_char) |>  
  select(-c(randomization))

# Handling of clustering
clustering_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    clustering = unique(cluster_treatment[!is.na(cluster_treatment)]),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(clustering) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", clustering),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(clustering))

# Analysis strategy 
analysis_strategy_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    analysis_strat = unique(analysis_strategy),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  filter(!is.na(analysis_strat)) |> 
  group_by(analysis_strat) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |>
  mutate(
    
    study_char = paste("%", analysis_strat),
    
    Mean = Study / sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(analysis_strat))

design_abuse_misuse <- 
  bind_rows(
    study_design_abuse_misuse,
    study_randomization_abuse_misuse,
    clustering_abuse_misuse,
    analysis_strategy_abuse_misuse
)


# Study participants
# % Males in treatment and control group

male_per_abuse_misuse <- 
  abuse_misuse |> 
  group_by(studyid) |>  
  summarise(
    
    t_male = mean(as.numeric(male_pct_t), na.rm = TRUE),
    c_male = mean(as.numeric(male_pct_c), na.rm = TRUE),
    
     es_n = sum(!is.na(male_pct_t)),
    
    .groups = "drop"
    
  ) |> 
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"), 
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_male, na.rm = TRUE), mean(c_male, na.rm = TRUE)), 
  #  SD = c(sd(t_male, na.rm = TRUE), sd(c_male, na.rm = TRUE)), 
    range = c(paste(min(t_male, na.rm = TRUE), "-", max(t_male, na.rm = TRUE)),  
              paste(min(c_male, na.rm = TRUE), "-", max(c_male, na.rm = TRUE)))
  )

# Mean age
age_mean_abuse_misuse <- 
  abuse_misuse |> 
  group_by(studyid) |> 
  summarise(
    
    t_age = mean(as.numeric(age_mean_t), na.rm = TRUE),
    c_age = mean(as.numeric(age_mean_c), na.rm = TRUE),
    
     es_n = sum(!is.na(age_mean_c)),
    
    .groups = "drop"
    
  ) |>  
  filter(es_n != 0) |> 
   summarise(
    study_char = c("Intervention group", "Control group"),  # Kategorier for hver gruppe
    Study = n_distinct(studyid),  
    Effect_size = sum(es_n, na.rm = TRUE),
    
    Mean = c(mean(t_age, na.rm = TRUE), mean(c_age, na.rm = TRUE)),  # Gennemsnit for hver gruppe
    #SD = c(sd(t_age, na.rm = TRUE), sd(c_age, na.rm = TRUE)),  # Standardafvigelse for hver gruppe
    range = c(paste(min(t_age, na.rm = TRUE), "-", max(t_age, na.rm = TRUE)),  # Range for hver gruppe
              paste(min(c_age, na.rm = TRUE), "-", max(c_age, na.rm = TRUE)))
  )

# Disorder type
disorder_type_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    disorder = unique(disorder_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(disorder) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", disorder),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(disorder))


assesment_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |>  
  summarise(
    assessment = unique(assessment),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(assessment) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", assessment),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
    #SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(assessment))

# Sample composition
sample_composition_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    composition = unique(sample_comp),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(composition) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", composition),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(composition))

# Sample factors
sample_factors_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    sample_factors = unique(sample_factors),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(sample_factors) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", sample_factors),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(sample_factors))


study_participants_abuse_misuse <- 
  bind_rows(
    male_per_abuse_misuse, age_mean_abuse_misuse, 
   # disorder_type, 
    assesment_abuse_misuse,
    sample_composition_abuse_misuse,
    sample_factors_abuse_misuse
)


# Intervention characteristics 

# Duration of intervention
duration_abuse_misuse <- 
  abuse_misuse |> 
  group_by(studyid) |>  
  summarise(
    
    m_duration = mean(duration_weeks, na.rm = TRUE),
  
    es_n = n(),
    
    miss_dur = sum(is.na(duration_weeks)),
    
    dur_report = if_else(miss_dur == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |>  
  filter(dur_report != "Not reported") |>  
  summarise(
    study_char = "Duration in weeks",
    
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_duration, na.rm = TRUE),
 #   SD = sd(m_duration, na.rm = TRUE),
    
    range = paste0(min(m_duration, na.rm = TRUE), "-",
                   max(m_duration, na.rm = TRUE)),
  
    
  )

# Mean number of sessions per week

sessions_per_week_abuse_misuse <- 
  abuse_misuse|> 
  mutate(sessions_per_week = as.numeric(sessions_per_week)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(sessions_per_week, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(sessions_per_week)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Number of sessions per week",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
 #   SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Average group size in the treatment intervention
avg_intevention_group_size_abuse_misuse <- 
  abuse_misuse|> 
  mutate(avg_group_size = as.numeric(avg_group_size)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(avg_group_size, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(avg_group_size)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Average group size",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
    #SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Number of interventions of each study
interventions_abuse_misuse <- abuse_misuse|> 
 mutate(N_treatments = as.numeric(N_treatments)) |> 
  group_by(studyid)  |>  
  summarise(
    
    m_intensity = mean(N_treatments, na.rm = TRUE),
  
    es_n = n(),
    
    miss_int = sum(is.na(N_treatments)),
    
    int_report = if_else(miss_int == 0, "Reported", "Not reported"),
    
    .groups = "drop"
     
  ) |> 
  filter(int_report != "Not reported") |>  
  summarise(
    study_char = "Treatments",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(m_intensity, na.rm = TRUE),
  #  SD = sd(m_intensity, na.rm = TRUE),
    
    range = paste0(min(m_intensity, na.rm = TRUE), "-",
                   max(m_intensity, na.rm = TRUE))
    
  )

# Treatment types 
treatment_types_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    treatment_type = unique(trt_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(treatment_type) |> 
  summarise(

    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", treatment_type),
    
    Mean = Study/sum(Study),
   # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(treatment_type))



# Implementation types 
implementation_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |> 
  summarise(
    implementation = unique(implementation),
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  group_by(implementation) |> 
  summarise(
    Study = n_distinct(studyid),
    effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", implementation),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(implementation))


intervention_characteristics_abuse_misuse <- bind_rows(
  duration_abuse_misuse, sessions_per_week_abuse_misuse, 
  avg_intevention_group_size_abuse_misuse, 
  interventions_abuse_misuse, 
  treatment_types_abuse_misuse
)

# Control group 
# Control types 
control_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |>  
  summarise(
    control = unique(control),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(control) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", control),
    
    Mean = Study/n_distinct(abuse_misuse$studyid),
    # SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |>  
  select(-c(control))

# Methodological features
# Average number of effect size per study
avg_es_study_abuse_misuse <- 
  abuse_misuse |> 
  group_by(studyid) |> 
  summarise(
    
    es_n = n(),
    
    .groups = "drop"
    
  ) |> 
  summarise(
    study_char = "Average n of es",
    
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
    Mean = mean(es_n),
  #  SD = sd(es_n),
    
    range = paste0(min(es_n), "-", max(es_n))
    
  )



# Outcome and measurement characteristics
# Type of test 
test_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |>  
  summarise(
    test_type = unique(test_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(test_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    
    study_char = paste("%", test_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(test_type))

# Type of measurement
measure_type_abuse_misuse <- abuse_misuse |>  
  group_by(studyid) |>  
  summarise(
    measure_type = unique(measure_type),
    es_n = n(),
    
    .groups = "drop"
    
  ) |>  
  group_by(measure_type) |> 
  summarise(
    Study = n_distinct(studyid),
    Effect_size = sum(es_n),
    
  ) |> 
  mutate(
    study_char = paste("%", measure_type),
    
    Mean = Study/sum(Study),
  #  SD = NA,
    range = "0-1",
    
   ) |> 
  relocate(study_char) |> 
  select(-c(measure_type))

outcome_measurement_abuse_misuse <- bind_rows(
  test_abuse_misuse, measure_type_abuse_misuse
)
```

## Tables for Alcohol and drug abuse/misuse

```{r}
table_abuse_misuse <- bind_rows(
  study_context_abuse_misuse, design_abuse_misuse, 
  study_participants_abuse_misuse, 
  intervention_characteristics_abuse_misuse, 
  control_abuse_misuse, 
  avg_es_study_abuse_misuse, 
  outcome_measurement_abuse_misuse
)



table_abuse_misuse_percent <- 
  table_abuse_misuse |> 
  filter(str_detect(study_char, "%")) |> 
  select(-c(range)) |> 
  mutate(
    Mean = round(Mean, 3),
    
  )


table_abuse_misuse_rest_desc <- 
  table_abuse_misuse |> 
  filter(!str_detect(study_char, "%")) |> 
  mutate(
    
    across(Mean, ~ round(.x, 3))
    
  )

# Converting into readable APA-style in word
table_abuse_misuse_percent_out <- nice_table(table_abuse_misuse_percent); table_abuse_misuse_percent_out

#flextable::save_as_docx(table1_percent_out, path = "table1_percent.docx")

table_abuse_misuse_rest_desc_out <- nice_table(table_abuse_misuse_rest_desc); table_abuse_misuse_rest_desc_out

```

# Print Table

```{r}

# Report table function --------------------------------------------------------------
report_table <- 
  function(table, file_name, format = "html_document", ...){
    
    if (!require(gt)){
      install.packages(gt)
    }  
    
    if (!is.data.frame(table)) stop("This function only takes object of class 'data.frame'") 
    
    if (missing(file_name)) stop("Please provide a name to the word file you want to generate. Use file_name")
    
    # Make if command with .Rmd     
    name <- paste0(file_name, ".Rmd")  
    
    if (length(unique(names(table))) !=  length(names(table))){
      
     output <- suppressMessages(tibble::tibble(table, .name_repair = "universal"))
      
    } else {
      
      output <- table
      
    }
    
    
    
    cat("---
title: \"Table output\"
output: html_document
---
           
\`\`\`{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gt)
\`\`\`


\`\`\`{r, echo=FALSE, results='asis', include=TRUE}

output |> gt()

\`\`\`", 
        file = name
    )
    #message(paste0("Saving to", getwd(), "/", "StudyReport.Rmd")) 
    message(paste("Rendering", name))  
    file_out <-  rmarkdown::render(name, output_format = format, quiet = TRUE, ...) 
    
    message(paste("Opening", name))  
    shell.exec(file_out)
    
    invisible(file_out)
    invisible(file.remove(name))
    
  }


```

```{r}

# Group data and calculate the distribution of reintergrational outcomes for each interventionstype
distribution_summary <- GBD_effect |> 
  filter(!str_detect(analysis_plan, "mental|used|hospi|Employment|Physical")) |> 
  group_by(trt_type, analysis_plan) |> 
  summarise(
    count = n(), 
    .groups = "drop"
  ) |> 
  group_by(trt_type) |> 
  mutate(
    total_outcomes = sum(count),  
    proportion = count / total_outcomes  
  ) |> 
  ungroup()


ggplot(distribution_summary, aes(x = trt_type, y = proportion, fill = analysis_plan)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
    title = "Outcome Distribution by type of Intervention",
    x = "Intervention Type",
    y = "Proportion",
    fill = "Outcome Construct"
  ) +
  coord_flip()


ggplot(distribution_summary, aes(x = trt_type, y = proportion, fill = analysis_plan)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
     title = "Outcome Distribution by type of Intervention",
    x = "Intervention Type",
    y = "Proportion",
    fill = "Outcome Construct"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

# Sensitivity Analysis of Mean Effect Size using the correlated-hierarchical effects (CHE-RVE) model {.tabset}

```{r, echo=FALSE}
# Specifying the data frames to be used representing the relevant outcomes: 
# Alcohol and drug abuse/misuse, Hope, Social Functioning, Well-being and Quality of Life
data_list <- list(
  abuse_misuse = abuse_misuse, 
  hope = hope, 
  social_functioning = social_functioning, 
  wellbeing_QoL = wellbeing_QoL
)


rho_calc_all <- function(data, rho_seq = 0:9/10) {
  map_dfr(rho_seq, ~ .CHE_RVE(data = data, rho = .x))
}


for (df_name in names(data_list)) {
  # run the estimation
  results <- rho_calc_all(data_list[[df_name]])
  
  # saving results as separate data frames
  assign(paste0("rho_", df_name), results)
}

```

## *p* impact

### Outcome {.tabset}

#### Alcohol and Drug Abuse/Misuse

Plot is based on `r unique(rho_abuse_misuse$effects)` effect sizes and `r unique(rho_abuse_misuse$studies)` studies

```{r, echo= FALSE}
# Plotting "Alcohol and Drug Abuse/Misuse"
rho_beta_plot_abuse_misuse <- 
  rho_abuse_misuse |> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.6, 0.8)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )


rho_var_plot_abuse_misuse <- 
  rho_abuse_misuse |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) +
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.6, 0.8)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_abuse_misuse  <- rho_beta_plot_abuse_misuse + rho_var_plot_abuse_misuse + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Alcohol and Drug Abuse/Misuse"); plot_abuse_misuse
```

#### Hope

Plot is based on `r unique(rho_hope$effects)` effect sizes and `r unique(rho_hope$studies)` studies

```{r, echo=FALSE}
# Plotting "Hope" ----
rho_beta_plot_hope <- 
  rho_hope |> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) +
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.2, 0.8)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )

rho_var_plot_hope <- 
  rho_hope |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.2, 0.8)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )



plot_hope <- rho_beta_plot_hope + rho_var_plot_hope + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Hope"); plot_hope
```

#### Social Functioning (Degree of impairment)

Plot is based on `r unique(rho_social_functioning$effects)` effect sizes and `r unique(rho_social_functioning$studies)` studies

```{r, echo=FALSE}
# Plotting "Social Functioning" ----
rho_beta_plot_social_functioning <- 
  rho_social_functioning |> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.4, 0.8)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )

rho_var_plot_social_functioning <- 
  rho_social_functioning |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.4, 0.8)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_social_functioning <- rho_beta_plot_social_functioning + rho_var_plot_social_functioning + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Social Functioning"); plot_social_functioning

```

#### Wellbeing and Quality of Life

Plot is based on `r unique(rho_wellbeing_QoL$effects)` effect sizes and `r unique(rho_wellbeing_QoL$studies)` studies

```{r, echo=FALSE}
# Plotting "Wellbeing and Quality of Life" ----
rho_beta_plot_wellbeing_QoL <- 
  rho_wellbeing_QoL|> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.4, 0.8)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )

rho_var_plot_wellbeing_QoL <- 
  rho_wellbeing_QoL |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.4, 0.8)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_wellbeing_QoL <- rho_beta_plot_wellbeing_QoL + rho_var_plot_wellbeing_QoL + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Wellbeing and Quality of Life"); plot_wellbeing_QoL
```

## Leave one study out

```{r, echo=FALSE}
data_list_rho <- list(
  abuse_misuse = rho_abuse_misuse, 
  hope = rho_hope, 
  social_functioning = rho_social_functioning, 
  wellbeing_QoL = rho_wellbeing_QoL
)


for (df_name in names(data_list_rho)) {
  
  avg_model_res <- data_list_rho[[df_name]] |> 
    filter(rho == 0.7)
  
  assign(paste0("avg_model_res_", df_name), avg_model_res, envir = .GlobalEnv)
}

for (df_name in names(data_list)) {
  omitted_stud_dat <- map_dfr(
    unique(data_list[[df_name]]$Author), 
    ~ .CHE_RVE(study_out = .x, data = data_list[[df_name]])
  )
  
  assign(paste0("omitted_stud_", df_name), omitted_stud_dat, envir = .GlobalEnv)
}
```

### Outcome {.tabset}

#### Alcohol and Drug Abuse/Misuse

```{r, echo=FALSE}
l1out_plot_abuse_misuse <- 
  omitted_stud_abuse_misuse |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )

beta_facet_abuse_misuse <- 
  l1out_plot_abuse_misuse |> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res_abuse_misuse$lb,
    ub_all = avg_model_res_abuse_misuse$ub,
    mean = avg_model_res_abuse_misuse$b
  )

# Continue here: 
var_facet_abuse_misuse <- 
  l1out_plot_abuse_misuse |> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res_abuse_misuse$omega, avg_model_res_abuse_misuse$tau, avg_model_res_abuse_misuse$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
  l1out_abuse_misuse <- ggplot(data = l1out_plot_abuse_misuse,aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_abuse_misuse, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_abuse_misuse, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_abuse_misuse, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_abuse_misuse, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ); l1out_abuse_misuse

```

#### Hope

```{r, echo=FALSE}
l1out_plot_hope <- 
  omitted_stud_hope |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )

beta_facet_hope<- 
  l1out_plot_hope|> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res_hope$lb,
    ub_all = avg_model_res_hope$ub,
    mean = avg_model_res_hope$b
  )

# Continue here: 
var_facet_hope<- 
  l1out_plot_hope|> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res_hope$omega, avg_model_res_hope$tau, avg_model_res_hope$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_hope<- ggplot(data = l1out_plot_hope,aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_hope, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_hope, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_hope, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_hope, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ); l1out_hope
```

#### Social Functioning (Degree of impairment)

```{r, echo=FALSE}
l1out_plot_social_functioning <- 
  omitted_stud_social_functioning |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )

beta_facet_social_functioning<- 
  l1out_plot_social_functioning|> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res_social_functioning$lb,
    ub_all = avg_model_res_social_functioning$ub,
    mean = avg_model_res_social_functioning$b
  )

# Continue here: 
var_facet_social_functioning<- 
  l1out_plot_social_functioning|> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res_social_functioning$omega, avg_model_res_social_functioning$tau, avg_model_res_social_functioning$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_social_functioning<- ggplot(data = l1out_plot_social_functioning,aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_social_functioning, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_social_functioning, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_social_functioning, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_social_functioning, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ); l1out_social_functioning
```

#### Wellbeing and Quality of Life

```{r, echo=FALSE}
l1out_plot_wellbeing_QoL <- 
  omitted_stud_wellbeing_QoL |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )

beta_facet_wellbeing_QoL<- 
  l1out_plot_wellbeing_QoL|> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res_wellbeing_QoL$lb,
    ub_all = avg_model_res_wellbeing_QoL$ub,
    mean = avg_model_res_wellbeing_QoL$b
  )

# Continue here: 
var_facet_wellbeing_QoL<- 
  l1out_plot_wellbeing_QoL|> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res_wellbeing_QoL$omega, avg_model_res_wellbeing_QoL$tau, avg_model_res_wellbeing_QoL$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_wellbeing_QoL<- ggplot(data = l1out_plot_wellbeing_QoL,aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_wellbeing_QoL, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_wellbeing_QoL, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_wellbeing_QoL, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_wellbeing_QoL, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ); l1out_wellbeing_QoL
```

## Mental health outcome {.tabset}

### p-impact {.tabset}

#### All mental health
```{r, echo=FALSE}
# prepping data for plotting

# All mental health outcomes combined
all_mental_health <- 
  GBD_effect |> 
  mutate(analysis_plan = case_when(
  str_detect(analysis_plan, "All mental health outcomes/Symptoms of psychosis|All mental health outcomes/Negative symptoms") ~ "All mental health outcomes/Symptoms of psychosis",
   TRUE ~ analysis_plan)) |> 
  filter(str_detect(analysis_plan, "mental")) |>
  filter(!str_detect(analysis_plan, "Unused")) 

rho_mental_health <- map_dfr(0:9/10, ~ .CHE_RVE(data = all_mental_health, rho = .x))

# Making data frames for subgroups of mental health outcomes

# Plotting "All mental health outcome" ----
rho_beta_plot_mental_health  <- 
  rho_mental_health |> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.6, 1)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )


rho_var_plot_mental_health <- 
  rho_mental_health |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) +
  scale_y_continuous(breaks = seq(-1, 1, .2), limits = c(-0.6, 1)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_mental_health  <- rho_beta_plot_mental_health+ rho_var_plot_mental_health + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: All mental health outcomes"); plot_mental_health

```

#### Depression
```{r, echo=FALSE}
# All mental health outcomes combined
depression <- 
  all_mental_health |> 
  filter(str_detect(analysis_plan, "Depression"))

rho_depression <- map_dfr(0:9/10, ~ .CHE_RVE(data = depression, rho = .x))



# Plotting "Depression" ----
rho_beta_plot_depression  <- 
  rho_depression |> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-1, 1.2, .2), limits = c(-0.6, 1.1)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )


rho_var_plot_depression <- 
  rho_depression |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) +
  scale_y_continuous(breaks = seq(-1, 1.2, .2), limits = c(-0.6, 1.1)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_depression  <- rho_beta_plot_depression+ rho_var_plot_depression + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Depression"); plot_depression

```

#### Anxiety
```{r, echo=FALSE}
# Outcome: Anxiety
anxiety <- 
  all_mental_health |> 
  filter(str_detect(analysis_plan, "Anxiety"))

rho_anxiety <- map_dfr(0:9/10, ~ .CHE_RVE(data = anxiety, rho = .x))



# Plotting "Depression" ----
rho_beta_plot_anxiety  <- 
  rho_anxiety|> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-2, 2, .2), limits = c(-1.1, 1.7)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )


rho_var_plot_anxiety <- 
  rho_anxiety |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) +
  scale_y_continuous(breaks = seq(-2, 2, .2), limits = c(-1.1, 1.7)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_anxiety  <- rho_beta_plot_anxiety+ rho_var_plot_anxiety + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Anxiety"); plot_anxiety

```


#### Symptoms of psychosis
```{r, echo=FALSE}
# Outcome: Symptoms of psychosis
psychosis <- 
  all_mental_health |> 
  filter(str_detect(analysis_plan, "psychosis"))

rho_psychosis <- map_dfr(0:9/10, ~ .CHE_RVE(data = psychosis, rho = .x))



# Plotting "Symptoms of psychosis" ----
rho_beta_plot_psychosis  <- 
  rho_psychosis|> 
  mutate(param = "CHE-RVE") |> 
  ggplot(aes(x = rho, y = b)) +
  geom_line(aes(color = param), linewidth = 1) +
  geom_ribbon(aes(ymin = pi_lb, ymax = pi_ub), fill = "grey", alpha = 0.5) +
  geom_ribbon(aes(ymin = lb, ymax = ub, 
                  fill = param), alpha = .2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  scale_x_continuous(breaks = 0:9/10) + 
  scale_y_continuous(breaks = seq(-2, 2, .2), limits = c(-0.8, 1)) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.position = "none"
  ) + 
  facet_grid(~param) +
  scale_fill_manual(values = "cornflowerblue", name = "fill") +
  scale_color_manual(values = "cornflowerblue") + 
  labs(y = "Average effect size", 
       x = expression(Assumed~sampling~correlation~(rho))
  )


rho_var_plot_psychosis <- 
  rho_psychosis |> 
  pivot_longer(
    cols = tau:sd_total,
    names_to = "var"
  ) |>  
  arrange(var, rho) |> 
  mutate(
    Variance = case_when(
      var == "omega" ~ "Within-study SD",
      var == "tau" ~ "Between-study SD",
      var == "sd_total" ~ "SD total",
      .default = NA_character_
    ),
    
    Variance = factor(Variance, levels = c("Within-study SD", "Between-study SD", "SD total")),
    
    param = "Variance components"
    
  ) |> 
  ggplot(aes(x = rho, y = value, color = Variance)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(0,0.9,0.1)) +
  scale_y_continuous(breaks = seq(-2, 2, .2), limits = c(-0.8, 1)) +
  scale_color_brewer(type = "qual", palette = 2) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0.7, linetype = "dashed") +
  facet_grid(~param) +
  theme_light() +
  theme(
    strip.text = element_text(color = "black"),
    legend.title=element_blank()
  ) + 
  labs(
    y = "Variance component", 
    x = expression(Assumed~sampling~correlation~(rho))
  )


plot_psychosis  <- rho_beta_plot_psychosis+ rho_var_plot_psychosis + 
  plot_layout(guides = 'collect') & 
  plot_annotation(title = "Outcome: Symptoms of psychosis"); plot_psychosis

```

### Leave one study out {.tabset}

#### All mental health 
```{r}
omitted_stud_all_mental <- map_dfr(
  unique(all_mental_health$Author), 
  ~ .CHE_RVE(data= all_mental_health,study_out = .x)
)


l1out_plot_all_mental <- 
  omitted_stud_all_mental |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )


beta_facet_all_mental <- 
  l1out_plot_all_mental |> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res$lb,
    ub_all = avg_model_res$ub,
    mean = avg_model_res$b
  )

# Continue here: 
var_facet_all_mental <- 
  l1out_plot_all_mental |> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res$omega, avg_model_res$tau, avg_model_res$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_plot_all_mental |> 
  ggplot(aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_all_mental, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_all_mental, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_all_mental, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_all_mental, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ) 

```

#### Depression
```{r, echo=FALSE}
omitted_stud_depression <- map_dfr(
  unique(depression$Author), 
  ~ .CHE_RVE(data= depression,study_out = .x)
)


l1out_plot_depression <- 
  omitted_stud_depression |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )


beta_facet_depression <- 
  l1out_plot_depression |> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res$lb,
    ub_all = avg_model_res$ub,
    mean = avg_model_res$b
  )

# Continue here: 
var_facet_depression <- 
  l1out_plot_depression |> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res$omega, avg_model_res$tau, avg_model_res$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_plot_depression |> 
  ggplot(aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_depression, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_depression, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_depression, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_depression, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ) 

```

#### Anxiety
```{r, echo=FALSE}
omitted_stud_anxiety <- map_dfr(
  unique(anxiety$Author), 
  ~ .CHE_RVE(data= anxiety,study_out = .x)
)


l1out_plot_anxiety <- 
  omitted_stud_anxiety |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )


beta_facet_anxiety <- 
  l1out_plot_anxiety |> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res$lb,
    ub_all = avg_model_res$ub,
    mean = avg_model_res$b
  )

# Continue here: 
var_facet_anxiety <- 
  l1out_plot_anxiety |> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res$omega, avg_model_res$tau, avg_model_res$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_plot_anxiety|> 
  ggplot(aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_anxiety, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_anxiety, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_anxiety, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_anxiety, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  ) 

```

#### Symptoms of psychosis
```{r, echo=FALSE}
omitted_stud_psychosis <- map_dfr(
  unique(psychosis$Author), 
  ~ .CHE_RVE(data= psychosis,study_out = .x)
)


l1out_plot_psychosis <- 
  omitted_stud_psychosis |>
  arrange(desc(b)) |> 
  mutate(
    omitted_study = factor(omitted_study, levels = unique(omitted_study))
  ) |> 
  select(omitted_study, studies:b, lb:ub, omega, tau, sd_total) |> 
  pivot_longer(
    cols = c(b, omega:sd_total),
    names_to = "param",
    values_to = "est"
  ) |>
  relocate(lb:ub, .after = est) |> 
  mutate(
  
    param = case_match(
      param,
      "b" ~ "Average ES (%95 CI)",
      "omega" ~ "Within-Study SD",
      "tau" ~ "Between-Study SD",
      "sd_total" ~ "Total SD"
    ),
    
    param = factor(
      param, 
      levels = c("Average ES (%95 CI)", "Between-Study SD", "Within-Study SD", "Total SD")
    )
  )


beta_facet_psychosis <- 
  l1out_plot_psychosis |> 
  filter(str_detect(param, "ES")) |> 
  mutate(
    lb_all = avg_model_res$lb,
    ub_all = avg_model_res$ub,
    mean = avg_model_res$b
  )

# Continue here: 
var_facet_psychosis <- 
  l1out_plot_psychosis |> 
  filter(!str_detect(param, "ES")) |>
  slice_head(n = 3) |> 
  mutate(
    sd_all = c(avg_model_res$omega, avg_model_res$tau, avg_model_res$sd_total)
  )
  
#png(filename = "Figures/Sup/l1out_plot.png", width = 9, height = 6, units = "in", res = 600)
l1out_plot_psychosis|> 
  ggplot(aes(x = est, y = omitted_study)) + 
  geom_vline(xintercept = 0) + 
  geom_rect(data = beta_facet_psychosis, aes(xmin = lb_all, xmax = ub_all, ymin = -Inf, ymax = Inf),
            fill = "gray90", alpha = 0.1, color = "gray90") +
  geom_vline(data = beta_facet_psychosis, aes(xintercept = mean), color = "blue", size = 1, alpha = 1) +
  geom_vline(data = var_facet_psychosis, aes(xintercept = sd_all), color = "blue", size = 1, alpha = 1) + 
  geom_point(size = 3) +
  geom_errorbarh(data = beta_facet_psychosis, aes(xmin = lb, xmax = ub), height=0) + 
  facet_grid(~ param) +
  theme_light() +
  labs(x = "Estimate", y = "Excluded study") +
  theme(
    legend.position = "none", 
    strip.text = element_text(color = "black")
  )

```

# Colophon

```{r}
devtools::session_info()
```
