---
title: "Statistical Analysis for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness' (til Nina)"
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: hide
    code_download: true
    css: styles.css
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(eval = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```


```{r, echo=FALSE}

library(dplyr)
library(tibble)
library(ggplot2)
library(stringr)
library(robvis)
library(tidyr)
library(rempsyc)
library(flextable)
library(purrr)
library(metafor)
library(patchwork)
library(clubSandwich)
library(wildmeta)
library(gt)


# Loading in helper function used to calculate effect size and conduct the analysis
source_path <- if (isTRUE(getOption('knitr.in.progress'))) "Helpers.R" else "ES calc/Helpers.R"

source(source_path)

```


```{r, eval = TRUE, echo = FALSE}
# Loading the needed data for analysis
group_based_dat <- readRDS("Group-based interventions data.RDS") |> 
  # The post-measurement of Empowerment Scale seems flawed for the study by 
  # Barbic et al. 2009 we therefore we exclude it from the analysis
  #filter(!(authors == "Barbic et al." & test_name == "The Empowerment Scale")) |> 
  mutate(
    author_year = paste(authors, year)
  ) |> 
 # Remove unused outcomes
 filter(!str_detect(analysis_plan, "Unused"))

```

## Number effect size across standardized mean differences (SMD) and odds ratios (OR) 

```{r}
# Number of studies reporting OR
group_based_dat |> 
  summarise(
    n = n(), 
    .by = c(author_year, effect_size)
  ) |> 
  summarise(
    n_studies = length(effect_size), 
    n_es = sum(n),
    .by = effect_size
  )
```


## Filter out apparently flawed results

```{r}

group_based_dat <- 
  group_based_dat |> 
  # The post-measurement of Empowerment Scale seems flawed for the study by 
  # Barbic et al. 2009 we therefore we exclude it from the analysis
  filter(!(authors == "Barbic et al." & test_name == "The Empowerment Scale"))

```



# Timeline

```{r, eval=TRUE, fig.cap='FIGURE 1:  Number of studies included in meta-analysis by year'}
# Figure 1: Number of included studies in the meta-analysis by year
G_timepllot <- group_based_dat |> 
  summarise(year = unique(year), .by =  author_year)

# DONE
timeline_plot <-  ggplot(G_timepllot, aes(x = year)) + 
  geom_bar(colour = "black", fill = "cornflowerblue", alpha = 1, width = 1) +
  scale_x_continuous(breaks = seq(2000, 2022, 1)) + 
  scale_y_continuous(breaks = seq(0, 6.5, 1), limits = c(0, 7), expand = c(0,0)) + 
  theme_bw() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.border = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.line = element_line(colour = "black")
  ) +
  labs(
    x = "Year of Publication",
    y = "Number of Studies"
  )

timeline_plot

```


```{r, echo = FALSE}
GBD_effect <- 
  group_based_dat |> 
  filter(variable_type != "Binary") |>
  mutate(
    es_id = 1:n(),
    gt = if_else(!is.na(gt_post), gt_post, NA_real_),
    gt = if_else(!is.na(gt_DD), gt_DD, gt),
    gt = if_else(!is.na(gt_adj), gt_adj, gt),
    gt = if_else(!is.na(gt_reg), gt_reg, gt),
    
    vgt = if_else(!is.na(vgt_post), vgt_post, NA_real_),
    vgt = if_else(!is.na(vgt_DD), vgt_DD, vgt),
    vgt = if_else(!is.na(vgt_adj), vgt_adj, vgt),
    vgt = if_else(!is.na(vgt_reg), vgt_reg, vgt),
    
    Wgt = if_else(!is.na(Wgt_post), Wgt_post, NA_real_),
    Wgt = if_else(!is.na(Wgt_DD), Wgt_DD, Wgt),
    Wgt = if_else(!is.na(Wgt_adj), Wgt_adj, Wgt),
    Wgt = if_else(!is.na(Wgt_reg), Wgt_reg, Wgt),
    
   # ESS = round(4/vgt), # Using cluster bias corrected sampling variance
    
    studyid = if_else(authors == "Gonzalez & Prihoda", 500, studyid), 
    
    cnt = if_else(cnt == "USA", "US", cnt),
    
    design = if_else(design  == "QES-pretest", "QES", design),
    
    # MHV: Jeg synes ikke det er en god ide at Ã¦ndre CRCT til RCT. Jeg vil gerne kunne se forskel.  
    # design = ifelse(design  == "CRCT", "RCT", design), 
    
    assessment = if_else(assessment == "Self  assesment", "Self assesment", assessment),
    
    randomization = if_else(randomization == "Simple Block Randomization", "Block randomized",
                           randomization),
    randomization = if_else(randomization == "Simple with permuted blocks, stratified by site",
                           "Stratified randomization", randomization),
   
   randomization = if_else(randomization == "Stratified?",
                           "Stratified randomization", randomization),
   
    randomization = if_else(is.na(randomization) & studyid == 102, 
                            "Stratified randomization", randomization),
   
    randomization = if_else(randomization == "Ratio and block randomized",
                           "Block randomized", randomization),
   
   randomization = if_else(randomization == "Block randomized stratified by site",
                           "Block randomized", randomization),
    
   randomization = if_else(randomization == "Resticted and adapted randomization (i.e. minimization)",
                           "Stratified randomization", randomization),
   
   randomization = if_else(randomization == "Unequal simple randomization",
                           "Block randomized", randomization),
   
   randomization = if_else(randomization == "Within-site basis and unequal allocation ratio",
                           "Stratified randomization", randomization),
    
    trt_type = if_else(trt_type == "Group-based  Cognitive Behavioral Therapy", 
                      "Group based Cognitive Behavioural Therapy", trt_type),
    trt_type = if_else(trt_type == "Group-based Cognitive Behavioral Therapy", 
                      "Group based Cognitive Behavioural Therapy", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation & Social skill training", 
                      "Group psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation", 
                      "Group Psychoeducation", trt_type),
    trt_type = if_else(trt_type =="Group psychoeducation & Social Skill Training", 
                      "Group Psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Education and Illness Management", 
                      "Group Psychoeducation & Social Skill Training", trt_type),
    trt_type = if_else(trt_type =="Illness management", 
                      "Illness Management", trt_type),
    
    sample_factors = if_else(sample_factors =="Older with depression and anxiety", 
                            "Mixed", sample_factors), 
    sample_factors = if_else(sample_factors =="All suffered from severe mental illness", 
                            "Shared Social problem(s)/challenge(s)", sample_factors),
    sample_factors = if_else(sample_factors =="Shared origin and psychological distress", 
                            "Mixed", sample_factors),
    sample_factors = if_else(sample_factors =="persons with major psychiatric problems", 
                            "Shared Social problem(s)/challenge(s)", sample_factors),
    
    analysis_plan = if_else(analysis_plan == "Unused", "Unused outcomes", analysis_plan), 
    
    test_type = if_else(test_type == "Clinical administered", "Clinician-rated measure", test_type),
    test_type = if_else(test_type == "Clinical interviews", "Clinician-rated measure", test_type),
    test_type = if_else(test_type == "Self report", "Self-reported", test_type),
    test_type = if_else(test_type == "Self report through clinical interview", "Self-reported", test_type),
    test_type = if_else(test_type == "Self-reported via diagnostic interview", "Self-reported", test_type), 
    
    measure_type = if_else(measure_type == "Pre-post with controls", "Post-intervention", measure_type),
   
   cluster_treatment = if_else(cluster_treatment == "Hierarchical mixed models", "Mixed-model", cluster_treatment),
   
   cluster_treatment = if_else(cluster_treatment == "Multilevel analysis and clustered standard errors", 
                        "Multilevel analysis", cluster_treatment),
   
   rob_tool = if_else(rob_tool == "Rob2", "RoB2", rob_tool),
   rob_tool = if_else(rob_tool == "Rob2 CRCT", "RoB2", rob_tool),
   
   timing = if_else(study == "Acarturk et al. 2022" & timing == "Followup", "3m", timing),
   timing = if_else(Author == "Barbic et al. 2009", "post", timing), 
   timing = if_else(Author == "Bond et al. 2015", "post", timing),
   timing = if_else(Author == "Craigie & Nathan 2009", "post", timing),
   timing = if_else(Author == "Gatz et al. 2007", "post", timing),
   timing = if_else(Author == "Gordon et al. 2018", "post", timing), 
   timing = if_else(Author == "Gutman et al. 2019", "post", timing),
   timing = if_else(Author == "Bond et al. 2015", "post", timing), 
   timing = if_else(Author == "Hagen et al. 2005", "post", timing),
   timing = if_else(Author == "Haslam et al. 2019", "post", timing),
   timing = if_else(Author == "Hilden et al. 2021", "post", timing),
   timing = if_else(Author == "James et al. 2004", "post", timing),
   timing = if_else(Author == "Lim et al. 2020", "post", timing),
   timing = if_else(Author == "Lloyd-Evans et al. 2020", "post", timing),
   timing = if_else(Author == "McCay et al. 2006", "post", timing),
   timing = if_else(Author == "McCay et al. 2007", "post", timing),
   timing = if_else(Author == "Michalak et al. 2015", "post", timing),
   timing = if_else(Author == "Morley et al. 2024", "post", timing),
   timing = if_else(Author == "Morton et al. 2012", "post", timing),
   timing = if_else(Author == "Popolo et al. 2019", "post", timing),
   timing = if_else(Author == "Rabenstein et al. 2015", "post", timing),
   timing = if_else(Author == "Rosenblum et al. 2014", "3", timing),
   timing = if_else(Author == "Sacks et al. 2011", "post", timing), 
   timing = if_else(Author == "Schrank et al. 2016", "post", timing),
   timing = if_else(Author == "Somers et al. 2017", "post", timing),
   timing = if_else(Author == "Valiente et al. 2022", "post", timing),
   timing = if_else(Author == "Volpe et al. 2015", "post", timing),
   timing = if_else(Author == "Wojtalik et al. 2022", "post", timing),
   timing = if_else(Author == "Wuthrich et al. 2013/2021", "post", timing),
   timing = if_else(Author == "Druss et al. 2010", "post", timing),
   timing = if_else(Author == "Gonzales & Prihoda 2007", "post", timing),
   timing = if_else(Author == "Dyck et al. 2000", "post", timing)
   
 ) 
```

# Number of studies and effect sizes {.tabset}

## Entire data

```{r}
GBD_effect |> 
  summarise(
    N_studies = n_distinct(author_year),
    N_ES = n()
  )
```


## Reintegrational outcomes
```{r}

GBD_effect |> 
  filter(!str_detect(analysis_plan, "mental|used|hospi")) |> 
  summarise(
    n_es = n(),
    .by = c(analysis_plan, studyid)
  ) |> 
  summarise(
    N_studies = length(studyid),
    N_es = sum(n_es),
    .by = analysis_plan
  ) |> 
  rename(
    outcome = analysis_plan
  )

```

## All mental health outcomes

```{r}

GBD_effect |> 
  filter(str_detect(analysis_plan, "mental")) |> 
  filter(!str_detect(analysis_plan, "Unused")) |> 
  mutate(
    analysis_plan = case_when(
  str_detect(analysis_plan, "Symptoms of psychosis|Negative symptoms") ~ "All mental health outcomes/Symptoms of psychosis",
   TRUE ~ analysis_plan
    )
  ) |> 
  summarise(
    n_es = n(),
    .by = c(analysis_plan, studyid)
  ) |> 
  summarise(
    N_studies = length(studyid),
    N_es = sum(n_es),
    .by = analysis_plan
  ) |> 
  rename(
    outcome = analysis_plan
  ) |> 
  mutate(
    outcome = str_remove_all(outcome, "All mental health outcomes"),
    outcome = if_else(outcome == "", "General mental health", outcome),
    outcome = str_remove(outcome, "/")
  )

```

# Overall means and contrast test using SCE+ models {.tabset}

## Reintegrational outcomes
```{r}
# We remove physical health, employment, self-esteem, and loneliness outcome since
# only few studies reported these outcomes. 
reintergation_dat <- 
  GBD_effect |> 
  filter(!str_detect(analysis_plan, "mental|used|hospi|esteem|Physical|Employ|Loneli"))

# overall_mean
reintegration_che_res <- .CHE_RVE(reintergation_dat) 

reintegration_che_res |> 
select(studies:UL, tau:sd_total, I2) |>
gt() |> 
fmt_number(columns = 3:9, decimals = 3) |> 
tab_header(
  title = "Overall average effect size",
  subtitle = "Across all reintegrational outcomes"
) 
  

# Overall means across outcomes
reintegration_sce_res <- 
  .SCEp(mod = analysis_plan, data = reintergation_dat) 

reintegration_sce_res |> 
select(Moderator:pval) |> 
gt()|> 
fmt_number(columns = 4:10, decimals = 3) |> 
tab_header(
  title = "Overall average effect sizes",
  subtitle = "Across reintegrational subgroups"
) 
```

## All mental health outcomes
```{r}
# We remove physical health, employment, self-esteem, and loneliness outcome since
# only few studies reported these outcomes. 
mental_health_dat <- 
  GBD_effect |> 
  filter(str_detect(analysis_plan, "mental")) |> 
  filter(!str_detect(analysis_plan, "Unused")) |> 
  mutate(
    analysis_plan = case_match(
      analysis_plan,
      "All mental health outcomes" ~ "General mental health",
      "All mental health outcomes/Anxiety" ~ "Anxiety",
      "All mental health outcomes/Depression" ~ "Depression",
      .default = "Symptoms of psychosis"
    )
  )

# overall_mean
mental_che_res <- .CHE_RVE(mental_health_dat) 
  
mental_che_res |> 
select(studies:UL, tau:sd_total, I2) |> 
gt() |>
fmt_number(columns = 3:9, decimals = 3) |> 
tab_header(
  title = "Overall average effect size",
  subtitle = "Across all mental health outcomes"
) 
  

# Overall means across outcomes
mental_sce_res <- 
  .SCEp(mod = analysis_plan, data = mental_health_dat)

mental_sce_res |> 
select(Moderator:pval) |> 
gt()|> 
fmt_number(columns = 4:10, decimals = 3) |> 
tab_header(
  title = "Overall average effect sizes",
  subtitle = "Across mental health subgroups"
) 

```

## Difference-in-differences effect sizes

```{r}
GBD_effect |> 
  filter(str_detect(main_es_method, "diff-in-diffs")) |> 
  summarise(n = n(), .by = author_year) |> 
  summarise(n_studies = length(author_year), n_es = sum(n))
```



# Forest plots {.tabset}

## Reintegrational outcomes {.tabset}
```{r, echo = FALSE}
outcome_group <- unique(reintergation_dat$analysis_plan)
```

### Overall

```{r, fig.height=10, fig.width=9}
forest_plot_de(data = reintergation_dat, che_data = reintegration_che_res)
```


### Wellbeing and quality of life
```{r, fig.height=10, fig.width=9}

forest_plot_de(outcome_group = outcome_group[1], data = reintergation_dat, sce_data = reintegration_sce_res)

```

### Hope, Empowerment & Self-efficacy

```{r, fig.height=10, fig.width=9}
forest_plot_de(outcome_group = outcome_group[2], data = reintergation_dat, sce_data = reintegration_sce_res)
```

### Social functioning (degree of impairment)

```{r, fig.height=10, fig.width=9}
forest_plot_de(outcome_group = outcome_group[3], data = reintergation_dat, sce_data = reintegration_sce_res)
```

### Alcohol and drug abuse/misuse

```{r, fig.height=6, fig.width=9}
forest_plot_de(outcome_group = outcome_group[4], data = reintergation_dat, sce_data = reintegration_sce_res)
```

## All mental health outcomes {.tabset}

```{r, echo = FALSE}
outcome_group_mental <- unique(mental_health_dat$analysis_plan)
```

### Overall

```{r, fig.height=10, fig.width=9}
forest_plot_de(data = mental_health_dat, che_data = mental_che_res)
```

### General mental health

```{r, fig.height=10, fig.width=9}
forest_plot_de(
  outcome_group = outcome_group_mental[1], 
  data = mental_health_dat, 
  sce_data = mental_sce_res
)
```

### Anxiety

```{r, fig.height=6, fig.width=9}
forest_plot_de(
  outcome_group = outcome_group_mental[2], 
  data = mental_health_dat, 
  sce_data = mental_sce_res
)
```

### Depression

```{r, fig.height=10, fig.width=9}
forest_plot_de(
  outcome_group = outcome_group_mental[3], 
  data = mental_health_dat, 
  sce_data = mental_sce_res
)
```

### Symptoms of psychosis

```{r, fig.height=6, fig.width=9}
forest_plot_de(
  outcome_group = outcome_group_mental[4], 
  data = mental_health_dat, 
  sce_data = mental_sce_res
)
```