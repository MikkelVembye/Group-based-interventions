---
title: Effect size calculation for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness'
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: show
    code_download: true
bibliography: Group-based interventions.bib
link-citations: yes
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```

### Introduction 
This document contains effect size calculation for the Campbell systematic review 'Group-based community interventions to support the social reintegration of marginalised adults with mental illness' [@Dalgaard2022a]. 

### R package used for effect size calculation

```{r}
#devtools::install_github("MikkelVembye/VIVECampbell")

library(tidyverse)
#library(dplyr)
library(readxl)
library(writexl)
library(purrr)
library(VIVECampbell)

```

### ICC values used for cluster adjustment

```{r}
ICC_005 <- 0.05
ICC_01 <- 0.1
ICC_02 <- 0.2

ppcor_imp <- 0.5
R2_imp <- 0

grp_size_imp <- 8

```


## **Studies in meta-analysis**

### **Acarturk et al. [-@Acarturk2022] (Change var names)**
#### (Multi-level analysis and reported raw means, at baseline, post, and followup times)

To calculate pretest-adjusted effect sizes, we first estimate pre-post and pre-followup correlations from 
the reported results in "Treatment effect" section (p. 7)

```{r Acarturk_ppcor}

# _fu = followup

Acarturk_text_res <- 
  tibble(
    
    outcome = rep(c("HSCL-25", "PCL-5", "PSYCHLOPS"), each = 2),
    
    timing = rep(c("Posttest", "Followup"), 3),
    
    N = rep(c(41, 44, 19), c(2, 2, 2)), # Obtained from df(t)/2
    
    m_pre = rep(c(2.34, 1.77, 4.06), each = 2),
    sd_pre = rep(c(0.60, 0.86, 0.76), each = 2),
    
    m_post = c(
      2.15, 2.11, # HSCL-25
      1.43, 1.19, # PCL-5
      3.82, 3.45  # PSYCHLOPS
      
      ),
    
    sd_post = c(
      0.60, 0.59,
      0.79, 0.78,
      0.86, 1.32
      ),
    
    
    paired_t = c(
      2.43, 2.83,
      2.61, 4.45,
      1.01, 2.57
      )
    
  ) |> 
  mutate(
    
    ppcor = ((sd_pre^2*paired_t^2 + sd_post^2*paired_t^2) - (m_post - m_pre)^2 * N)/
      (2*sd_pre*sd_post*paired_t^2),
    
    .by = c(outcome, timing)
    
  ); Acarturk_text_res

```

Entering data from Table 2 (p. 7)

```{r Acarturk_data}

Acarturk2022 <- 
  tibble(
    
    outcome = rep(c("HSCL-25", "PCL-5", "PSYCHLOPS"), each = 4),
    
    timing = rep(c("Posttest", "Followup"), each = 2, n_distinct(outcome)),
    
    group = rep(c("gPM+", "Control"), n_distinct(outcome)*2),
    
    N = rep(c(24, 22), n_distinct(outcome)*2),
    
    m_pre = c(
        rep(c(2.37, 2.31), 2), # HSCL-25
        rep(c(1.84, 1.70), 2), # PCL-5
        rep(c(4.20, 3.92), 2)  # PSYCHLOPS
        
      ),
    
    sd_pre = c(
        
        rep(c(0.58, 0.64), 2),
        rep(c(0.88, 0.86), 2),
        rep(c(0.68, 0.84), 2)
      
      ),
    
    m_post = c(
      
      2.01, 2.28, 2.07, 2.14, 
      1.27, 1.59, 1.12, 1.26,
      3.82, 3.82, 3.67, 3.23
      
    ),
    
    sd_post = c(
      
      0.59, 0.58, 0.52, 0.43,
      0.70, 0.86, 0.85, 0.70,
      1.00, 0.63, 1.32, 1.63
      
    ),
    
    es_paper = rep(c(
      
      0.48, 0.12,
      0.40, 0.18,
      0, -0.30
      
      ),
      each = 2
    ),
    
    pval_paper = rep(c(
      
      0.109, 0.698,
      0.185, 0.553,
      0.996, 0.319
      
      ),
      each = 2
    )
    
    
    
  ); Acarturk2022


wide_format_Acarturk2022 <- 
  function(data, filter_value, trt_name, ctr_name){
  
  filter_func <- 
    function(data, filter_value, trt_name, ctr_name){
      
        
    dat <- data |> dplyr::filter(timing == filter_value)
    
    dat |> 
    dplyr::mutate(group = case_match(group, trt_name ~ "t", ctr_name ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    )
    
    
  }
  
  purrr::pmap_dfr(
    list(filter_value), ~ 
    filter_func(data = data, filter_value = .x,
                trt_name = trt_name, ctr_name = ctr_name)) |> 
    arrange(outcome)
  
  
}

Acarturk2022_wide <- 
  wide_format_Acarturk2022(
    data = Acarturk2022, 
    filter_value = c("Posttest", "Followup"),
    trt_name = "gPM+",
    ctr_name = "Control"
  ) |> 
  mutate(
    es_paper = es_paper_t,
    pval_paper = pval_paper_t
  ) |> 
  select(-c(es_paper_t:pval_paper_c))


```

Effect size calculation and cluster bias adjustment

```{r}

eta_acarturk_sqrt <- VIVECampbell::eta_1armcluster(
  N_total = 46, Nc = 22, avg_grp_size = 10, ICC = ICC_01,
  sqrt = TRUE
)

Acarturk2022_es <- 
  Acarturk2022 |>
  mutate(
    ppcor = rep(Acarturk_text_res$ppcor, each = 2)
  ) |> 
  
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Acarturk et al. 2022",
    es_calc_method = "Raw diff-in-diffs",
    
    ppcor = ppcor[1],  
    ppcor_calc_method = "Calculated from study",
    
    R2 = NA,
    R2_calc_method = "Not relevant",
    
    N_t = N[1],
    N_c = N[2],
    
    N_total = N_t + N_c, 
    
    df_ind = N_total,
    
    n_covariates = 1,
    
    d_paper = es_paper[1],
    pval_paper = pval_paper[1],
    tval_paper = qnorm(pval_paper/2, lower.tail = FALSE),
    se_d_paper = d_paper/tval_paper,
    se_d_paper = if_else(se_d_paper == 0, sqrt(sum(1/N)) * eta_acarturk_sqrt, se_d_paper),
    vd_paper = se_d_paper^2,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_total-2) ),
    m_diff_post = (m_post[1] - m_post[2]) * -1,
    
    # Difference in differences measures
    diff_t = (m_post[1] - m_pre[1]) * -1,  
    diff_c = (m_post[2] - m_pre[2]) * -1,
    
    DD = diff_t - diff_c,
    
    d_post = m_diff_post/sd_pool, 
    vd_post = sum(1/N) + d_post^2/(2*df_ind),
    Wd_post = sum(1/N),
    
    d = DD/sd_pool,
    vd = 2*(1-ppcor) * sum(1/N) + d^2/(2*df_ind),
    Wd = 2*(1-ppcor) * sum(1/N),
    
    d_alt = d_paper,
    vd_alt = vd_paper,
    Wd_alt = vd_paper,
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = sum(1/N) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    g = J * d, 
    vg = 2*(1-ppcor) * sum(1/N) + g^2/(2*df_ind), 
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = vd_alt,
    Wg_alt = vd_alt,
    
    .by = c(outcome, timing) 
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # " eight to ten participants per group" (p. 1)
    avg_cl_size = 10, 
    avg_cl_type = "From study (p. 1)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates
      ),
    
    gt_icc005 = g * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_icc005",
      vars = vgt_icc005:Wgt_icc005
      ),
    
    gt_icc02 = g * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_icc02",
      vars = vgt_icc02:Wgt_icc02
      ),
    
    gt_alt = g_alt * gamma_sqrt,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_alt, 
      model = "posttest",
      cluster_adj = TRUE,
      q = n_covariates,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
      ), 
    
    gt_alt_type = "Posttest reported in paper",

    gt_posttest = g_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_posttest, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_posttest",
      vars = vgt_posttest:Wgt_posttest
    )
    
) |> 
ungroup()

Acarturk2022_est <- 
  left_join(Acarturk2022_wide, Acarturk2022_es) |> 
  relocate(study) |> 
  mutate(
    vary_id = paste0(outcome, "/", timing),
    analysis_plan = case_when(
      outcome == "HSCL-25" ~ "The Hopkins Symptoms Checklist (HSCL-25) ",
      outcome == "PCL-5" ~ "PCL-5 consists of 20 items asking about the symptoms of traumatic stress",
      outcome == "PSYCHLOPS" ~ "PSYCHOLOPS consists of four questions, three domains (problems, functions and well-being)",
      TRUE ~ NA_character_  # Fallback in case of unexpected outcomes
    )
  )

Acarturk2022_est

```


### **Barbic et al. [-@Barbic2009]**
#### (Randomized trial reporting raw means at baseline and after treatment. Uses repeated ANOVA and does not account for clusting in treament)

Entering data from Table 3 (p. 495).

```{r}
Barbic2009 <- tibble(
  outcome = rep(c("Hope Index", "Empowerment Scale", "Quality of Life", "Recovery Assessment"), each = 2),
  group = rep(c("Recovery Workbook", "Control"), dplyr::n_distinct(outcome)),
  N = rep(c(16, 17), dplyr::n_distinct(outcome)),
  
  m_pre = c(
    37.13, 36.00, 
    55.93, 63.88, 
    20.34, 20.70, 
    163.75, 156.41),
  
   sd_pre = c(
    6.53, 5.36, 
    6.91, 6.91, 
    5.01, 4.13, 
    22.60, 14.22),
  
  m_post = c(
    38.93, 35.06, 
    14.93, 61.96, 
    21.60, 22.27, 
    168.81, 149.11),
  
  
  sd_post = c(
    5.34, 6.21, 
    10.43, 7.33, 
    3.35, 4.91, 
    20.11, 22.09)
)

Barbic2009

Barbic2009_wide <- 
  Barbic2009 |> 
    mutate(group = case_match(group, "Recovery Workbook" ~ "t", "Control" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    ) |> 
  mutate(
# Based on the degrees of freedom value reported in Barbic et al. (2009),
# we cannot replicate the report F_values. Therefore, we do not use any F_values for 
# for the effect size correlation

  p_val_f = c(.05, .21, .96, .02), 
  df1 = 1, 
  df2 = 31,
  F_val = qf(p_val_f, df1 = df1, df2 = df2, lower.tail = FALSE)
  )
```

Effect size calculating, including cluster-bias correction
```{r}
Barbic2009_est <- 
  Barbic2009_wide |>
  mutate(
    analysis_plan = rep(
      c("Hope, Empowerment & Self-efficacy", "Wellbeing and Quality of Life", 
        "Hope, Empowerment & Self-efficacy/using all"), 
      c(2, 1, 1))
  ) |> 
  rowwise() |> 
  mutate(
    
    F_val = if_else(outcome == "Empowerment Scale", 14.93, F_val), # Retrieved from (p. 495)
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Barbic et al. 2009",
    main_es_calc_method = "Raw diff-in-diffs",
    
    ppcor = ppcor_imp,  
    ppcor_calc_method = "Imputed",
    
    R2 = NA_real_,
    R2_calc_method = "Not relevant",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Calculate d post
    m_post = if_else(outcome != "Empowerment Scale", m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    # Account for the fact that some outcomes are on different scales
    m_diff_t = if_else(outcome != "Empowerment Scale", m_post_t - m_pre_t, (m_post_t - m_pre_t) * -1),
    m_diff_c = if_else(outcome != "Empowerment Scale", m_post_c - m_pre_c, (m_post_c - m_pre_c) * -1),
    
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + d_DD^2/(2*df_ind),
    Wd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    g_DD = J * d_DD, 
    vg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + g_DD^2/(2*df_ind),
    Wg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    # Average cluster size in treatment group
    # "12 weekly two-hour group sessions with seven to nine participants." (p. 493)
    avg_cl_size = 8, 
    avg_cl_type = "From study (p. 493)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = outcome
    

  ) |> 
  ungroup() |> 
  relocate(N_total, .after = N_c); Barbic2009_est


```


### **Bond et al. [-@Bond2015]**
#### (RCT - no treatment of clustering)

Entering data from Table 3 and 4 (p. 1032). Recovery Assessnebt Scale Scores are retrieved from the text on page 1032. 
In out analysis, we do not distinguish between different types of work as done in the paper. We, therefore, amalgamate all work category.  We code the control group as the our treatment group because the control is the group-based treatment, we are main concerned about
```{r}
# _t = Work choice

Bond2015_continious <- 
  tibble(
    outcome = c("Recovery Assessment Scale", "Days hospitalized"),
    N_t = 43,
    N_c = c(42, 41),
    m_post_t = c(4.14, 4.93),
    sd_post_t = c(0.49, 7.59),
    m_post_c = c(4.14, 10.44), 
    sd_post_c = c(0.57, 23.07),
    
    analysis_plan = c("Hope, Empowerment & Self-efficacy/uses all", "Psychiatric hospitalization"),
    
    main_effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Bond et al. 2015",
    main_es_calc_method = "Posttest means",
    
    ppcor_calc_method = "Not relevant",
    R2_calc_method = "Not relevant",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Calculate d post
    m_post = if_else(outcome != "Days hospitalized", m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post
  ) |> 
  rowwise() |> 
  mutate(
    
    # Cluster bias correction
    # Average cluster size in treatment group
    # "Classes were scheduled weekly at two conveniently located sites" (p. 1029)
    # Assuming two class in the Work Choice group is 44/2 = 22
    avg_cl_size = 22, 
    avg_cl_type = "Guessed from study",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:adj_value_post
      ),
    
    gt_post_icc005 = omega_icc005 * d_post * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_post_icc005, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post_icc005",
      vars = vgt_post_icc005:Wgt_post_icc005
      ),
    
    gt_post_icc02 = omega_icc02 * d_post * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_post_icc02, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post_icc02",
      vars = vgt_post_icc02:Wgt_post_icc02
      ),
    
    vary_id = outcome
    
  )

Bond2015_binary <- 
  tibble(
    outcome = c("Employment", "Risk of Psychiatric Hospitalization"),
    N_t = c(43, 42), # See note a in Table for sample size of Table 4 (i.e., 42, 40, respectively)
    N_c = c(42, 40),
    A = c(13, 12), 
    B = c(30, 31),  
    C = c(20, 11),
    D = c(22, 30),
    
    analysis_plan = c("Employment", "Psychiatric hospitalization"),
    
    main_effect_size = "OR",
    sd_used = "Not relevant",
    
    study = "Bond et al. 2015",
    main_es_calc_method = "Raw events",
    
    ppcor_calc_method = "Not relevant",
    R2_calc_method = "Not relevant",
    
    N_total = N_t + N_c,
    
    p_t = A/N_t,
    p_c = C/N_c,
    
    RD = p_t - p_c,
    vRD = (A*B)/N_t^3 + (C*D)/N_c^3,
    
    # Average cluster size in treatment group
    # "Classes were scheduled weekly at two conveniently located sites" (p. 1029)
    # Assuming two class in the Work Choice group is 44/2 = 22
    avg_cl_size = 22, 
    avg_cl_type = "Guessed from study",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # OR calculation and cluster bias adjustment
    VIVECampbell::OR_calc(
      A = A, B = B, C = C, D = D, 
      ICC = icc, avg_cl_size = avg_cl_size, n_cluster_arms = 1
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.05
    OR_calc(
      A = A, B = B, C = C, D = D, 
      ICC = ICC_005, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc005", vars = DE_icc005:vln_OR_C_icc005
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.2
    OR_calc(
      A = A, B = B, C = C, D = D, 
      ICC = ICC_02, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc02", vars = DE_icc02:vln_OR_C_icc02
    ),
    
    vary_id = outcome
    
)

Bond2015_est <- bind_rows(Bond2015_continious, Bond2015_binary)
Bond2015_est
```


### **Cano-Vindel et al. [-@Cano-Vindel2022]**

Data entered from Tables 2 and 3 (pp. 3342-45)

```{r}
Cano_vindel2021 <- tibble(
  analysis = rep(c("ITT", "Per-protocol"), each = 80),
  group = rep(c("TAU", "TAU-GCBT"), each = 1,80),
  
  outcome = rep(c("GAD-7", "PHQ-9", "PHQ15", "working_life_Function",
                  "Socal_life_Function", "Family_life_Function", "Physical_QoL",
                  "Psychological_QoL", "Social_QoL", "Environment_QoL"), 
                each = 8,2),
  
  timing = rep(c("Post", "3m", "6m", "12m"), each = 2,20),
  
  N = c(rep(c(534, 527), 40), # ITT
        rep(c(316, 315, # per-protocol post-treatment
              238, 273,# per-protocol 3 months
              204, 229,# per-protocol 6 months
              180, 208), 1,80) # per-protocol 12 months
  ),
  
  m_pre = c(
    rep(c(12.1, 12.5), each = 1,4),  # ITT GAD-7 Anxiety Baseline)
    rep(c(13.5, 13.7), each = 1,4),  # ITT PHQ9
    rep(c(14, 14.3), each = 1,4), # ITT PHQ15
    rep(c(3.5, 3.6), each = 1,4), # ITT working life
    rep(c(4.6, 4.7), each = 1,4), # ITT social life
    rep(c(4.6, 4.8), each = 1,4), # ITT family life
    rep(c(22.4, 22.1), each = 1,4), # ITT Physical
    rep(c(16.9, 16.9), each = 1,4), # ITT Psychological
    rep(c(9.1, 9.1), each = 1,4), # ITT Social
    rep(c(25.3, 25.7), each = 1,4),  # ITT Environment 
      
    rep(c(12.1, 12.5), each = 1,4), # per-protocol GAD-7 Anxiety Baseline)
    rep(c(13.5, 13.7), each = 1,4), # per-protocol GAD-7 PHQ9
    rep(c(14, 14.3), each = 1,4),   # per-protocol GAD-7 PHQ15
    rep(c(3.5, 3.6), each = 1,4),   # per-protocol GAD-7 working life
    rep(c(4.6, 4.7), each = 1,4),   # per-protocol GAD-7 social life
    rep(c(4.6, 4.8), each = 1,4),   # per-protocol GAD-7 family life
    rep(c(22.4, 22.1), each = 1,4), # per-protocol GAD-7 Physical
    rep(c(16.9, 16.9), each = 1,4), # per-protocol GAD-7 Psychological
    rep(c(9.1, 9.1), each = 1,4),   # per-protocol GAD-7 Social
    rep(c(25.3, 25.7), each = 1,4)  # per-protocol GAD-7 Environment 
  ), 
  
  sd_pre = c(
    rep(c(4.7, 4.6), each = 1,4),  # ITT GAD-7 Standard deviation
    rep(c(5.4, 5.3), each = 1,4), # ITT PHQ9
    rep(c(4.8, 4.9),each = 1,4), # ITT PHQ15
    rep(c(3.1, 3.2), each = 1,4), # ITT working life
    rep(c(3, 3), each = 1,4), # ITT social life
    rep(c(3.1, 3), each = 1,4), # ITT family life
    rep(c(4.3, 4.3), each = 1,4), # ITT Physical
    rep(c(3.8, 3.8), each = 1,4), # ITT Psychological
    rep(c(2.4, 2.4), each = 1,4), # ITT Social
    rep(c(4.5, 4.6), each = 1,4),  # ITT Environment 
    
    rep(c(4.7, 4.6), each = 1,4),  # per-protocol GAD-7 Standard deviation
    rep(c(5.4, 5.3), each = 1,4), # per-protocol PHQ9
    rep(c(4.8, 4.9),each = 1,4), # per-protocol PHQ15
    rep(c(3.1, 3.2), each = 1,4), # per-protocol working life
    rep(c(3, 3), each = 1,4), # per-protocol social life
    rep(c(3.1, 3), each = 1,4), # per-protocol family life
    rep(c(4.3, 4.3), each = 1,4), # per-protocol Physical
    rep(c(3.8, 3.8), each = 1,4), # per-protocol Psychological
    rep(c(2.4, 2.4), each = 1,4), # per-protocol Social
    rep(c(4.5, 4.6), each = 1,4)  # per-protocol Environment 
      
    
  ), 
  m_post = c(
    9.5, 6.8, # ITT GAD-7 Anxiety post-treatment
    8.7, 7.3, # ITT GAD-7 Anxiety 3 months
    8.6, 6.9, # ITT GAD-7 Anxiety 6 months
    8.3, 6.6,  # ITT GAD-7 Anxiety 12 months
    
    10.8, 8.0, # ITT PHQ9 Depression post treatment
    10.2, 8.4, # ITT PHQ9 Depression 3 months
    9.8, 7.9, # ITT PHQ9 Depression 6 months
    9.4, 7.8, # ITT PHQ9 Depression 12 months
    
    11.7, 9.9, # ITT PHQ-15 post-treatment
    11.4, 10.1,# ITT PHQ-15 3 months
    11.1, 9.8, # ITT PHQ-15 6 months
    10.7, 9.4, # ITT PHQ-15 12 months
    
    3.0, 2.6, # ITT working life post-treatment
    2.7, 2.4, # ITT Working life 3 months 
    2.7, 2.1, # ITT working life 6 months
    3.1, 2.4, # ITT working life 12 months
    
    
    4.1, 3.2, # ITT social life post-treatment
    3.5, 3.2, # ITT social life 3 months 
    3.4, 2.7, # ITT social life 6 months
    3.8, 2.9, # ITT social life 12 months
    
    3.9, 3.1, # ITT Family life post-treatment
    3.5, 3.1, # ITT Family life 3 months 
    3.6, 2.7, # ITT Family life 6 months
    3.8, 2.8, # ITT Family life  12 months
    
    23.2, 24.7, # ITT Physical post-treatment
    23.5, 24.2, # ITT Physical 3 months
    23.6, 24.3, # ITT Physical 6 months
    24.2, 26.4, # ITT Physical12 months
    
    17.7, 19.2, # ITT Psychological post-treatment
    18.1, 18.9, # ITT Psychological 3 months
    18.5, 18.9, # ITT Psychological 6 months
    18.7, 19.9, # ITT Psychological 12 months
    
    9.4, 9.8, # ITT Social post-treatment
    9.5, 9.7, # ITT Social 3 months
    9.5, 9.7, # ITT Social 6 months
    9.7, 11.1, # ITT Social 12 months
    
    25.7, 27.2, # ITT Environment post-treatment 
    26.1, 26.9, # ITT Environment 3 months
    26.5, 27.1, # ITT Environment 6 months
    27.5, 31.2,  # ITT Environment 12 months
    
    10.2, 6.0, # Per-protocol GAD-7 Anxiety post treatment
    8.9, 6.7, # Per-protocol GAD-7 Anxiety 3 months
    8.8, 6.2, # Per-protocol GAD-7 Anxiety  6 months
    8.7, 5.8, # Per-protocol GAD-7 Anxiety 12 months 
    
    11.7, 9.9,  # Per-protocol PHQ9 Depression post-treatment
    10.3, 7.8, # Per protocol PHQ9 Depression 3 months
    10.0, 7.3,  # Per-protocol PHQ9 Depression 6 months
    10.7, 9.4, # Per-protocol PHQ9 Depression 12 months
    
    12.1, 9.1, # Per-protocol PHQ-15 post treatment
    11.7, 9.5, # Per protocol PHQ-15 3 months
    11.5, 9.2, # Per-protocol PHQ-15 6 months
    11.7, 8.8, # Per-protocol PHQ-15 12 months
    
    3.1, 2.4, # Per-protocol working life post treatment
    2.6, 2.5, # Per protocol Working life 3 months
    2.8, 1.9, # Per-protocol working life 6 months
    3.3, 2.0, # Per-protocol working life 12 months
    
    
    4.1, 2.9, # Per-protocol social life post treatment
    3.4, 3.1, # Per protocol social life 3 months
    3.6, 2.6, # Per-protocol social life 6 months
    4.0, 2.6, # Per-protocol social life 12 months
    
    4.0, 2.8, # Per-protocol Family life post treatment
    3.5, 3.0, # Per protocol Family life 3 months
    3.6, 2.6, # Per-protocol Family life 6 months
    3.9, 2.5, # Per-protocol Family life 12 months
    
    
    22.7, 25.1,# Per-protocol Physical post treatment
    23.2, 24.4, # Per protocol Physical 3 months
    23.1, 24.7, # Per-protocol Physical 6 months 
    22.7, 25.6, # Per-protocol Physical 12 months
    
    17.4, 19.9, # Per-protocol Psychological post treatment
    18.0, 19.3, # Per protocol Psychological 3 months
    18.3, 19.3, # Per-protocol Psychological 6 months
    18.3, 20.2, # Per-protocol Psychological 12 months
    
    9.2, 10.0, # Per-protocol Social post treatment
    9.3, 9.8, # Per protocol Social 3 months
    9.6, 9.8, # Per-protocol Social 6 months
    9.3, 10.0, # Per-protocol Social 12 months
    
    25.5, 27.8, # Per-protocol Environment post treatment
    26.1, 27.5, # Per protocol Environment 3 months
    26.4, 27.7, # Per-protocol Environment 6 months
    26.6, 28.3) # Per-protocol Environment 12 months
    ,
  
  sd_post = c(
    5.4, 4.7, # ITT GAD-7 Anxiety post-treatment
    5.3, 5.0, # ITT GAD-7 Standard deviation 3 months
    5.4, 5.1, # ITT GAD-7 Standard deviation 6 months
    5.7, 5.4,  # ITT GAD-7 Standard deviation 12 months
    
    6.4, 5.7, # ITT PHQ9 Depression standard deviation post-treatment 
    6.4, 6.0, # ITT PHQ9 Depression standard deviation 3 months
    6.4, 6.1, # ITT PHQ9 Depression standard deviation 6 months
    6.3, 5.9, # ITT PHQ9 Depression standard deviation 12 months
    
    5.2, 5.4, # ITT PHQ-15 standard deviation post-treatment
    5.1, 5.3, # ITT PHQ-15 standard deviation 3 months
    5.3, 5.6, # ITT PHQ-15 standard deviation 6 months
    5.6, 5.6, # ITT PHQ-15 standard deviation 12 months
    
    3.1, 3.2, # ITT working life standard deviation post-treatment
    3.0, 3.0, # ITT working life standard deviation 3 months
    3.0, 2.9, # ITT working life standard deviation 6 months
    3.3, 3.2, # ITT working life standard deviation 12 months
    
    3.1, 3.0, # ITT social life standard deviation post-treatment
    3.1, 2.9, # ITT social life standard deviation 3 months
    3.2, 3.1, # ITT social life standard deviation 6 months
    3.4, 3.4, # ITT social life standard deviation 12 months
    
    3.1, 2.9, # ITT Family life standard deviation post-treatment
    3.1, 3.1, # ITT Family life standard deviation 3 months
    3.2, 3.1, # ITT Family life standard deviation 6 months
    3.3, 3.2, # ITT Family life standard deviation 12 months
    
    4.5, 4.6, # ITT Physical standard deviation post-treatment
    4.6, 4.8, # ITT Physical standard deviation 3 months
    4.5, 4.4, # ITT Physical standard deviation 6 months
    5.1, 5.3, # ITT Physical standard deviation 12 months
    
    3.9, 4.9, # ITT Psychological standard deviation post-treatment
    3.9, 4.2, # ITT Psychological standard deviation 3 months
    3.8, 3.9, # ITT Psychological standard deviation 6 months
    4.4, 4.6, # ITT Psychological standard deviation 12 months
    
    3.1, 3.1, # ITT Social standard deviation post-treatment
    2.3, 2.3, # ITT Social standard deviation 3 months
    2.5, 2.2, # ITT Social standard deviation 6 months
    2.2, 2.6, # ITT Social standard deviation 12 months
    
    5.3, 5.6, # ITT Environment standard deviation post-treatment
    4.9, 5.1, # ITT Environment standard deviation 3 months
    4.8, 4.8, # ITT Environment standard deviation 6 months
    5.0, 5.3, # ITT Environment standard deviation 12 months
    
    5.5, 4.3, # Per-protocol GAD-7 Anxiety standard deviation post-treatment
    5.4, 4.9, # Per-protocol GAD-7 Anxiety standard deviation 3 months
    5.7, 4.9, # Per-protocol GAD-7 Anxiety standard deviation 6 months
    5.8, 5.3, # Per-protocol GAD-7 Anxiety standard deviation 12 months
    
    6.6, 5.2, # Per-protocol PHQ9 Depression standard deviation post-treatment
    6.5, 6.0, # Per-protocol PHQ9 Depression standard deviation 3 months
    6.6, 6.1, # Per-protocol PHQ9 Depression standard deviation 6 months
    6.5, 6.2, # Per-protocol PHQ9 Depression standard deviation 12 months
    
    5.2, 5.3, # Per-protocol PHQ-15 standard deviation post-treatment
    5.0, 5.4, # Per-protocol PHQ-15 standard deviation 3 months
    5.3, 5.7, # Per-protocol PHQ-15 standard deviation 6 months
    5.6, 5.7, # Per-protocol PHQ-15 standard deviation 12 months
    
    3.1, 2.9, # Per-protocol working life standard deviation post-treatment
    3.0, 2.9, # Per-protocol working life standard deviation 3 months
    3.0, 2.7, # Per-protocol working life standard deviation 6 months
    3.3, 2.7, # Per-protocol working life standard deviation 12 months
    
    3.1, 2.8, # Per-protocol social life standard deviation post-treatment
    3.2, 2.9, # Per-protocol social life standard deviation 3 months
    3.2, 2.8, # Per-protocol social life standard deviation 6 months
    3.3, 3.1, # Per-protocol social life standard deviation 12 months
    
    3.1, 3.1, # Per-protocol Family life standard deviation post-treatment
    3.1, 3.0, # Per-protocol Family life standard deviation 3 months
    3.1, 2.7, # Per-protocol Family life standard deviation 6 months
    .3, 2.8,  # Per-protocol Family life standard deviation 12 months
    
    4.6, 4.7, # Per-protocol Physical standard deviation post-treatment
    4.8, 4.9, # Per-protocol Physical standard deviation 3 months
    4.8, 4.9, # Per-protocol Physical standard deviation 6 months
    5.1, 5.3, # Per-protocol Physical standard deviation 12 months
    
    4.2, 4.0, # Per-protocol Psychological standard deviation post-treatment
    4.0, 4.2, # Per-protocol Psychological standard deviation 3 months
    4.2, 4.2, # Per-protocol Psychological standard deviation 6 months
    4.4, 4.6, # Per-protocol Psychological standard deviation 12 months
    
    2.4, 2.7, # Per-protocol Social standard deviation post-treatment
    2.2, 2.4, # Per-protocol Social standard deviation 3 months
    2.5, 2.2, # Per-protocol Social standard deviation 6 months
    2.2, 2.6, # Per-protocol Social standard deviation 12 months
    
    4.7, 4.8, # Per-protocol Environment standard deviation post-treatment
    4.8, 5.2, # Per-protocol Environment standard deviation 3 months
    4.8, 5.0, # Per-protocol Environment standard deviation 6 months
    5.0, 4.6) # Per-protocol Environment standard deviation 12 months
  
)
```

Since we could not backout any pre-posttests correlation estiamtes, we used test-retest reliability measures from the given scale literature [@Spitzer2006; @Zuithoff2010; @Ilic2019; @VanRavesteijn2009; @Arbuckle2009] as recommended by Hedges et al [-@Hedges2023_es_ancova]. 
```{r}

test_retest_cano2021 <- 
  tibble(
    # Repeat 8 times to make it fit the es data (see below)
    outcome = unique(Cano_vindel2021$outcome), 
    tr_reliability = c(
      0.83, # From Spitzer et al. 2006
      0.94, # From Zuithoff et al. 2010
      0.60, # From Ravesteijn et al. 2009
      
      0.63, # From Arbuckle et al. 2009
      0.70, # From Arbuckle et al. 2009
      0.61, # From Arbuckle et al. 2009
      
      0.665, # Ilíc et al. 2019
      0.724, # Ilíc et al. 2019
      0.725, # Ilíc et al. 2019
      0.60   # Ilíc et al. 2019
      )
    
  ); test_retest_cano2021 


```

Effect size calculation, including cluster bias correction

```{r}

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(unique(Cano_vindel2021$analysis), each = 4),
  filter_val2 = rep(c("Post", paste0(c(3, 6, 12), "m")), 2)
)

wide_cano2021_func <- 
  function(filter_val1, filter_val2){
  
    Cano_vindel2021 |> 
    filter(analysis == filter_val1 & timing == filter_val2) |> 
    mutate(group = case_match(group, "TAU-GCBT" ~ "t", "TAU" ~ "c")) |>
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    )   
      
  }
 
Cano_vindel2021_est <- 
  pmap(params, wide_cano2021_func) |> 
  list_rbind() |> 
  left_join(test_retest_cano2021) |> 
  rename(ppcor = tr_reliability) |> 
  mutate(
    analysis_plan = case_when(
      outcome == "GAD-7" ~ "using all/Anxiety",
      outcome == "PHQ-9" ~ "using all/Depression",
      outcome == "PHQ15" ~ "using all",
      str_detect(outcome, "Funct") ~ "Social functioning",
      str_detect(outcome, "QoL") ~ "Wellbeing and Quality of Life",
      TRUE ~ NA_character_
    )
  ) |>
  relocate(analysis_plan) |> 
  rowwise() |> 
  mutate(
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Cano-Vindel et al. 2021",
    main_es_calc_method = "Raw diff-in-diffs",
    
    ppcor_calc_method = "Based on test-retest reliability estimates",
    
    N_total = N_t + N_c,
    df_ind = N_total,
     
    # Calculate d post
    m_post = if_else(str_detect(outcome, "QoL"), m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
   
    # Account for the fact that some outcomes are on different scales
    m_diff_t = if_else(str_detect(outcome, "QoL"), m_post_t - m_pre_t, (m_post_t - m_pre_t) * -1),
    m_diff_c = if_else(str_detect(outcome, "QoL"), m_post_c - m_pre_c, (m_post_c - m_pre_c) * -1),
    
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + d_DD^2/(2*df_ind),
    Wd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    g_DD = J * d_DD, 
    vg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + g_DD^2/(2*df_ind),
    Wg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    # Average cluster size in treatment group
    # "held over a 12–14-week period in small groups (8–10 patients) in the primary care centre" (p. 3338)
    avg_cl_size = 9, 
    avg_cl_type = "From study (p. 3338)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = paste(analysis, outcome, timing, sep = "/")
    
  ) |> 
  ungroup(); Cano_vindel2021_est 
  

```


### **Craigie & Nathan [-@Craigie2009]**
#### (No randmoized studie, with a pre-posttest design with adjusting for clustering in treatment)

Entering data from Table 2 and Treatment Format $\times$ Time interaction estimate from text results reported on pages 307-08

```{r}
Craigie2009 <- tibble(
  analysis = rep(c(
    "ITT",
    "Completers"), each = 6),
  
  outcome = rep(c(
  "BDI_II", 
  "BAI",
  "Q_LES_Q"), each = 2,2),
  
  group = rep(c(
    "Individual",
    "Group"), each = 1, 6), 
  
  N = c(rep(c(116, 240), each = 1,3),
        rep(c(77, 157), each = 1,3)
        
  ),
  
  # pre-treatment means 
  m_pre = c( 
    # Intention to treat
    30.0, 31.3, # BDI-II
    21.1, 20.2, # BAI 
    43.2, 42.3, # Q-LES-Q
    # Completers (treatment-on-treated)
    30.8, 30.7,
    20.7, 19.6,
    46.4, 42.9
  ), 
  
  # pre-treatment standard deviation 
  sd_pre = c(
    # Intention to treat
    10.4, 11.2,
    12.2, 11.3,
    14.7, 14.1,
    # Completers (treatment-on-treated)
    10.3, 11.1,
    12.0, 11.0,
    13.5, 13.8
  ),
  
  # post-treatment means
  m_post = c(
    # Intention to treat
    16.3, 20.9,
    12.9, 15.6,
    52.3, 50.8,
    # Completers (treatment-on-treated)
    11.7, 17.7,
    9.2, 13.7,
    62.7, 55.3
  ),
  
  # post-treatment means 
  sd_post = c(
    # Intention to treat
    12.2, 13.6,
    11.2, 11.4,
    19.9, 17.9,
    # Completers (treatment-on-treated)
    9.9, 12.4,
    8.3, 10.7,
    14.7, 15.8
  ),
  
  F_within = c(
    129.79, 187.21,
    64.96, 56.00,
    42.27, 79.70,
    
    192.23, 200.75, 
    86.27, 61.57,
    62.45, 101.19
  ),
  
  # From Wilson (2016) Eq 31.
  r = ((sd_pre^2*F_within + sd_post^2*F_within) - 
        (m_post-m_pre)^2 * N)/ (2 * sd_pre*sd_post*F_within),
    
  # For pooling of correlation coefficients 
  z = 0.5 * log( (1+r)/(1-r) ),
  v = 1/(N-3)
  
) 
```

Effect size calculation
```{r}
# Calculating preposttest-correlations across groups
ppcors_Craigie2009 <- 
  Craigie2009 |> 
  summarise(
    M = sum(v*z)/sum(v),
    ppcor = (exp(2*M)-1)/(exp(2*M)+1),
    ppcor_calc_method = "From study (t^2 = F)",
    .by = c(analysis, outcome)
  )

ppcors_Craigie2009  

Craigie2009_est <- 
  Craigie2009 |> 
  mutate(group = case_match(group, "Group" ~ "t", "Individual" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    ) |> 
  left_join(ppcors_Craigie2009, by = join_by(analysis, outcome)) |> 
  mutate(
  
  analysis_plan = rep(c("using all/Depression", "using all/Anxiety", "Wellbeing and Quality of Life"), 2),  
  effect_size = "SMD",
  sd_used = "Pooled posttest SD",
    
  study = "Craigie & Nathan 2009",
  main_es_calc_method = "Raw diff-in-diffs",
  
  ppcor_calc_method = "Not relevant",
  
  R2 = NA_real_,
  R2_calc_method = "Not relevant",
  
  F_val = c(
    5.96, 9.84, 0.17, # (entered from p. 307 left side bottom)
    13.86, 16.93, 2.74 # (entered from p. 308 right side top)
  ),
    
  N_total = N_t + N_c,
  df_ind = N_total,
  
  # Calculate d post
  m_post = if_else(outcome == "Q_LES_Q", m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
  sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
  
  d_post = m_post/sd_pool, 
  vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
  Wd_post = (1/N_t + 1/N_c), 
  
  J = 1 - 3/(4*df_ind-1),
    
  g_post = J * d_post,
  vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
  Wg_post = Wd_post,
  
  # Account for the fact that some outcomes are on different scales
  m_diff_t = if_else(outcome == "Q_LES_Q", m_post_t - m_pre_t, (m_post_t - m_pre_t) * -1),
  m_diff_c = if_else(outcome == "Q_LES_Q", m_post_c - m_pre_c, (m_post_c - m_pre_c) * -1),
    
  d_DD = (m_diff_t - m_diff_c)/sd_pool,
  vd_DD = d_DD^2/F_val + d_DD^2/(2*df_ind),
  Wd_DD = d_DD^2/F_val,
  
  g_DD = J * d_DD, 
  vg_DD = g_DD^2/F_val + g_DD^2/(2*df_ind),
  Wg_DD = g_DD^2/F_val
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # "groups consisted of between 5 to 12 patients" p. 306
    avg_cl_size = 8.5, 
    avg_cl_type = "From study (p. 305)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = paste0(analysis, "/", outcome)
    
  ) |> 
  ungroup(); Craigie2009_est


```


### **Crawford et al. [-@Crawford2012]**
#### (RCT - clustering was not handle for the means we apply for effect size calculation)
Entering data from Table 2 (p. 7)
```{r}

Crawford2012 <- 
  tibble(
    
    outcome = rep(
      c(
        "Global assessment of functioning", "Positive and negative syndrome scale",
        # "Positive symptoms score", "Negative symptoms score", "General symptoms score", 
        "Social functioning", "Wellbeing" 
        # "Satisfaction with care", "Morisky score"
      ), 
      each = 6),
    group = rep(rep(c("Standard care", "Activity groups", "Art therapy"), 2), n_distinct(outcome)),
    timing = rep(rep(c(12, 24), each = n_distinct(group)), n_distinct(outcome)),
    
    N_start = rep(rep(c(137, 140, 140), 2), n_distinct(outcome)),
    N = rep(c(121, 121, 119, 117, 121, 117), n_distinct(outcome)),
    
    m_pre = c(
      rep(c(44.9, 45.0, 44.8), 2),
      rep(c(72.6, 75.3, 74.3), 2),
      #rep(c(17.3, 18.2, 18), 2),
      #rep(c(18.5, 18.7, 18.7), 2),
      #rep(c(36.8, 37.6, 37.6), 2),
      rep(c(8.1,  9., 8.6), 2),
      rep(c(64.5, 59.1, 58.3), 2)
      #rep(c(24.9, 23.8, 24.8), 2),
      #rep(c(1.2, 1.2, 1.0), 2)
    ), 
    
    sd_pre = c(
      rep(c(12.6, 12.7, 13.1), 2),
      rep(c(21.5, 22., 23.7), 2),
      #rep(c(5.6, 6.8, 6.9), 2),
      #rep(c(7.5, 7., 7.1), 2),
      #rep(c(11.3, 12.5, 12.5), 2),
      rep(c(4.7, 4.8, 4.2), 2),
      rep(c(20.6, 19.5, 21.1), 2)
      #rep(c(5.7, 6.2, 5.7), 2),
      #rep(c(1.3, 1.3, 1.2), 2)
    ),
    
    m_post = c(
      45.7, 45.5, 44.9, # GLobal assessment of functioning 12 month
      46.8, 46.4, 45.6, # GLobal assessment of functioning 24 month
      
      71.2, 69.6, 72.7, # Positive and negative syndrome scale 12 m
      68.1, 66.9, 69.2, # Positive and negative syndrome scale 24 m
      
      #16.7, 16.1, 17.3, # Positive symptoms score 12m
      #16.1, 15.6, 16.8, # Positive symptoms score 24m
      #
      #18.2, 17.3, 18.4, # Negative symptoms score 12m
      #17.2, 16.4, 16.9, # Negative symptoms score 24m
      #
      #36.3, 35.9, 37,   # General symptoms score 12m
      #34.9, 34.9, 35.3, # General symptoms score 24m
      
      8.5, 8.1, 8.3, # Social functioning 12m
      8.1, 8, 8.2,   # Social functioning 24m
      
      64.1, 63.6, 59.6, # Wellbeing 12m 
      68.1, 66.1, 65.1 # Wellbeing 24m 
      
      #24.3, 25., 23.6,  # Satisfaction with care 12m
      #24.2, 24.9, 23.1, # Satisfaction with care 24m
      
      #0.7, 0.6, 0.7, # Morisky score 12m
      #0.6, 0.5, 0.6  # Morisky score 24m
      
    ),
    
    sd_post = c(
      14.4, 14.1, 14.6, 
      12.8, 13.6, 13.1, 
      
      24.6, 23.2, 27.3,
      20.7, 23.3, 21.8,
      
      #6.3, 5.9, 7.6,
      #5.5, 6.4, 6.5,
      #
      #7.7, 7.2, 8,
      #7.3, 6.8, 7.1, 
      #
      #13, 12.7, 14,
      #11.3, 12.4, 11.4,
      
      4.9, 4.6, 5.,
      4.8, 4.5, 4.8,
      
      23.7, 23.2, 20.8,
      18.8, 18.4, 18.6
      
      #6.4, 5.2, 6.5,
      #5.3, 5., 5.9,
      
      #1.1, .9, 1.,
      #.9, .9, .9
      
    )
    
  )

Crawford2012_act_wide <- 
  Crawford2012 |> 
  filter(!str_detect(group, "Art")) |> 
  mutate(group = case_match(group, "Activity groups" ~ "t", "Standard care" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N_start:last_col()
  ) |> 
  mutate(
    treatment = "Activity groups"
  ) |> 
  relocate(treatment)
  
Crawford2012_art_wide <- 
  Crawford2012 |> 
  filter(!str_detect(group, "Act")) |> 
  mutate(group = case_match(group, "Art therapy" ~ "t", "Standard care" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N_start:last_col()
  ) |> 
  mutate(
    treatment = "Art therapy"
  ) |> 
  relocate(treatment)

Crawford2012_est <- 
  bind_rows(Crawford2012_act_wide, Crawford2012_art_wide) |> 
  arrange(outcome, timing) |> 
  mutate(
    analysis_plan = case_when(
      str_detect(outcome, "Positive") ~ "using all/Symptoms of psychosis",
      str_detect(outcome, "function") ~ "Social functioning (degree of impairment)",
      outcome == "Wellbeing" ~ "Wellbeing and Quality of Life",
      TRUE ~ NA_character_
    ),
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Crawford et al. 2012",
    main_es_calc_method = "Raw diff-in-diffs",
    
    ppcor = ppcor_imp,  
    ppcor_calc_method = "Imputed",
    
    m_post = if_else(!str_detect(outcome, "Positive"), m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    m_diff_t = if_else(outcome != "medication_adherence", m_post_t - m_pre_t, (m_post_t - m_pre_t) * -1),
    m_diff_c = if_else(outcome != "medication_adherence", m_post_c - m_pre_c, (m_post_c - m_pre_c) * -1),
    
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + d_DD^2/(2*df_ind),
    Wd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    g_DD = J * d_DD, 
    vg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + g_DD^2/(2*df_ind),
    Wg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c)
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # "Art therapy and activity groups had up to eight members 
    
    avg_cl_size = 8, 
    avg_cl_type = "From study (p. 1)",
    
    # Icc value
    icc = case_when(
      str_detect(outcome, "Global") & timing == 12 ~ 0.175,
      str_detect(outcome, "Global") & timing == 24 ~ 0.06,
      str_detect(outcome, "Positive") ~ 0.47,
      str_detect(outcome, "Social|Wellbeing") ~ ICC_01,
      TRUE ~ NA_real_
    ),
    
    icc_005 = if_else(icc == 0.1, ICC_005, icc),
    icc_02 = if_else(icc == 0.1, ICC_02, icc),
    
    icc_type = case_when(
      str_detect(outcome, "Global|Positive") ~ "From study (p. 3)",
      str_detect(outcome, "Social|Wellbeing") ~ "Imputed",
      TRUE ~ NA_character_
    ),
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    
    gamma_sqrt_icc005 = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc_005 
      ),
    
    gamma_sqrt_icc02 = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc_02 
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post =  omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = paste(outcome, timing, treatment, sep = "/")
    
  ) |> 
  ungroup() |> 
  mutate(
    # Calculating covariance using eq 19.19 from Gleser & Olkin (2009)
    covar_outcome_timing_treatment = 1/N_c[1] + prod(gt_DD)/(2*(sum(N_t) + N_c[1])),
    
    .by = c(outcome, timing)
    
  ); Crawford2012_est

rm(Crawford2012_act_wide, Crawford2012_art_wide)

```


### **Druss et al. [-@Druss2010]**
#### (RCT - no usuable treatment of clustering)
Entering data from Table 2 (p. 268)
```{r}

Druss2010 <- tibble(
  
  outcome = rep(c(
    # "patient_activation", # unused outcomes
    # "Physical_activity",
    # "medication_adherence",
    "QoL_physical",
    "QoL_mental"
  ), each = 2),
  
  group = rep(c(
    "HARP",
    "TAU"
  ), 2),
  
  N = rep(c(
    41,39
  ), 2),
  
  m_pre = c(
    #48.3, 47.6, # patient activation
    #150, 154, # Physical_activity
    #1.5, 1.5, # medication_adherence
    36.9, 37.0, # QoL_physical
    33.3, 33.9 # QoL_mental
  ),
  
  sd_pre = c(
    #11.5, 12.3,
    #236, 194,
    #1.2, 1.4,
    10.3, 12.5,
    9.13, 9.3
  ),
  
  m_post = c(
    #52.0, 44.9,
    #191, 152,
    #1.3, 1.6,
    42.9, 40,
    36.8, 37.0
  ),
  
  sd_post = c(
    #10.1, 9.6,
    #278, 249,
    #1.3, 1.4,
    14.2, 13.7,
    10.0, 11.8
  )
  
)

Druss2010_est <- 
  Druss2010 |> 
  mutate(group = case_match(group, "HARP" ~ "t", "TAU" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
  ) |> 
  mutate(
    
    analysis_plan ="Wellbeing and Quality of Life",
    
    N_total = N_t + N_c,
    p_val_baseline_diff = c(
      #0.96, 0.88, 0.78, # unused outcomes
      0.98, 0.80), # From Table 2 (p. 268)
    p_val_post_diff = c(
      #0.01,0.14, 0.25, 
      0.27, 0.95
      ), # From Table 2 (p. 268)
    t_val_baseline_diff = qt(p_val_baseline_diff/2, df = N_total - 2, lower.tail = FALSE),
    t_val_post_diff = qt(p_val_post_diff/2, df = N_total - 2, lower.tail = FALSE),
    p_val_f = c(
      #0.03, 0.4, 0.22, 
      0.41, 0.96
      ),
    F_val = qf(p_val_f, df1 = 1, df2 = N_total - 2, lower.tail = FALSE),
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Druss et al. 2010",
    main_es_calc_method = "Raw diff-in-diffs",
    
    ppcor = NA,  
    ppcor_calc_method = "F value used",
    
    R2 = NA_real_,
    R2_calc_method = "Not relevant",
    
    df_ind = N_total,
    
    m_post = if_else(outcome != "medication_adherence", m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    m_diff_t = if_else(outcome != "medication_adherence", m_post_t - m_pre_t, (m_post_t - m_pre_t) * -1),
    m_diff_c = if_else(outcome != "medication_adherence", m_post_c - m_pre_c, (m_post_c - m_pre_c) * -1),
    
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = d_DD^2/F_val + d_DD^2/(2*df_ind),
    Wd_DD = d_DD^2/F_val,
    
    g_DD = J * d_DD, 
    vg_DD = g_DD^2/F_val + g_DD^2/(2*df_ind),
    Wg_DD = g_DD^2/F_val,
  ) |> 
  rowwise() |> 
  mutate(
    # Average cluster size in treatment group
    # We don't know the average group size. Therefore, we impute this value
    avg_cl_size = grp_size_imp, 
    avg_cl_type = "Imputed",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = outcome
    
  ) |> 
  ungroup(); Druss2010_est

```

### **Druss et al. [-@Druss2018]**

```{r Druss2018}
# Data from table 2 (p. 532), containing means and SD for health related quality of life 
# (PCS and MCS),and table 3 (p. 533), containing means and SD for RAS

Druss2018 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,6)),
  
  timing = rep(c("3m", "6m"), each = 6,1),
  
  outcome = as.factor(rep(c("RAS", # Recovery Assessment Scale
                  # Both of the below measures is related to health related quality of life
                  # as measured by the Short-Form Health Survey (SF-36) (see p. 531)
                        "PCS", # The physical component summary
                        "MCS"), # The mental component summary
                        each= 2,2)),
  
  N = rep(c(198, 202), each = 1,6),
 
 
 m_pre = rep(c(
   3.72, 3.66,   # RAS
   32.73, 32.74, # PCS
   32.05, 32.04) # MCS
 , each = 1,2)
 ,
  
  sd_pre = rep(c(
    0.62, 0.57,    # RAS
    10.92, 11.29,  # PCS
    11.79, 11.36), # MCS
    each = 1,2) 
 ,
  
  m_post = c(
    3.89, 3.70,   # RAS 3 months
    34.49, 33.89, # PCS 3 months
    34.49, 34.25, # MCS 3 months
    
    3.87, 3.74,   # RAS 6 months
    35.42, 34.25, # PCS 6 months
    36.64, 34.54  # MCS 6 months
  ),
  
  sd_post = c(
    0.55, 0.68,   # RAS 3 months
    11.15, 10.41, # PCS 3 months
    11.15, 11.97, # MCS 3 months
    
    0.61, 0.59,   # RAS 6 months
    11.02, 11.52, # PCS 6 months
    12.28, 11.82  # MCS 6 months
  )
)

# Making the druss2018 tibble wide in order to estimate the effect sizes and
# further analysis. 

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(c(paste0(c(3, 6), "m")), 1)
)

wide_druss2018_func <- 
  function(filter_val1){
    
    Druss2018 |> 
      filter(timing == filter_val1) |> 
      mutate(group = case_match(group, "Intervention" ~ "t", "Control" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }

  
Druss2018_est <- 
  pmap(params, wide_druss2018_func) |>
  list_rbind() |>
# Based on the degrees of freedom value reported in Druss et al. 2018 table 2 and 3
  mutate(
    p_val_f = rep(c(0.02, 0.046, 0.039), each = 1,2),
    df1 = 2,
    df2 = rep(c(704, 697, 697), each = 1,2), 
    F_val = rep(c(3.79, 3.09, 3.25), each = 1,2),
    analysis_plan = rep(
    c("Patient activation measureMorisky scale Recovery assessment scale (RAS)", # RAS
      "Short-Form Health Survey (SF-36)= Quality of life", # PCS & MCS
      "Short-Form Health Survey (SF-36)= Quality of life" # PCS & MCS
    ), each = 1,2),
    
    study = "Druss et al. 2018"
    
 ) |> 
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    m_post =  (m_post_t - m_post_c),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
  ) |> 
  ungroup()

Druss2018_est <- Druss2018_est |> 
  mutate(vary_id = paste0(outcome, "/", timing)
         )


```

### **Dyck et al. [-@Dyck2000]**
```{r Dyck et al. 2000}
# Data from table 2 (p. 516) containing means and standard deviation

Dyck2000 <- tibble(
  group = as.factor(c("Multiple-family group", 
                          "Standard care")),
  outcome = "MSANS", #The modified Scale for the Assessment of Negative Symptoms
  N = 21,
  
  m_pre = c(
    7.9, 8.7
  ),
  
  m_post = c(
#    7.4, 9.1, # 3 months
#    7.2, 8.9, # 6 months
#    7.2, 8.9, # 9 months
    7.2, 8.4 # 12 months, the real post-treatment measure because the treatment
             # ends after 12 months.
  ),
  
  
  sd_pre = c(
    3.1, 3.3 
  ),
  
  sd_post = c(
#    2.3, 3.2, # 3 months
#    2.1, 2.7, # 6 months
#    2.1, 3,   # 9 months
    2, 3.1    # 12 months, the real post-treatment measure because the treatment
              # ends after 12 months.
  )
)



# Making the dyck2000 tibble wide in order to estimate the effect sizes and
# further analysis. 
Dyck2000_wide <-
  Dyck2000 |> 
  mutate (group = case_match(
    group, "Multiple-family group"  ~ "t", "Standard care" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )

# Effect size calculating 
Dyck2000_est <-           
  Dyck2000_wide |>
  mutate(
    analysis_plan = "The modified Scale for the Assessment of Negative Symptoms" 
    )|> 
  rowwise() |> 
  mutate(
    study = "Dyck et al. 2000",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
  # The outcome MSANS reverted because lower score is beneficial
    m_post =  (m_post_t - m_post_c)*-1,
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
  ) |> 
  ungroup()

Dyck2000_est <- Dyck2000_est |> 
   mutate(vary_id = paste0(outcome)
      )

  

```

### **Gestel-Timmermans et al. [-@VanGestel-Timmermans2012] (Change var names)**
#### (Multi-level analysis to handle clustering)

Missing data analysis to support the  RoB 2 D4 assessment 

```{r}
# Testing missing 

Timmermans_sample_size_dat <-
  tibble(
    
    outcome = rep(c("Empoverment", "Hope", "Quality", "Self-e", "Loneliness"), each = 4),
    timing = rep(c("3 months", "6 months"), each = 2, n_distinct(outcome)),
    #measure = rep(c("post", "followup"), each = 2, n_distinct(outcome)),
    group = rep(c("Treatment", "Control"), 10),
    
    N_start = rep(rep(c(168, 165), 10)),
    
    N_actual = c(
      136, 117, 121, 99,
      132, 118, 120, 97,
      124, 114, 111, 97,
      134, 116, 121, 100,
      138, 122, 125, 102
    )
    
); Timmermans_sample_size_dat
```

Missingness analysis

```{r}
Timmermans_missingness <- 
  Timmermans_sample_size_dat |> 
  summarise(
    N_start_total = sum(N_start),
    N_actual_total = sum(N_actual),
    
    #percent_missing_total = round(mean(percent_missing)),
    
    percent_missing_total = round((1 - (N_actual_total/N_start_total)) * 100),
    
    RoB_D3_assess = case_when(
      percent_missing_total >= 25 ~ "High",
      percent_missing_total < 25 ~ "Some concerns",
      TRUE ~ NA_character_
    ),
    
    .by = c(outcome, timing)
  )

Timmermans_missingness 
```

Data is retrieved from Tables 2 & 3 (p. 58) 

```{r}

Timmermans2012 <- 
  Timmermans_sample_size_dat |> 
  rename(N =  N_actual) |> 
  mutate(
    
    #From Table 2 (p. 58)
    
    m_pre = c(
      rep(c(3.40, 3.37), 2), # Empowerment
      rep(c(2.78, 2.76), 2), # Hope
      rep(c(4.32, 4.23), 2), # Quality of life
      rep(c(4.38, 4.33), 2), # Self-efficacy beliefs
      rep(c(6.40, 6.87), 2)  # Loneliness
    ),
    
    sd_pre = c(
      rep(c(0.49, 0.51), 2), # Empowerment
      rep(c(0.47, 0.48), 2), # Hope
      rep(c(0.88, 1), 2),    # Quality of life
      rep(c(0.82, 0.89), 2), # Self-efficacy beliefs
      rep(c(3.56, 3.40), 2)  # Loneliness
    ),
    
    m_post = c(
      
      3.55, 3.38, 3.59, 3.40, # Empowerment
      2.91, 2.79, 2.97, 2.73, # Hope
      4.49, 4.36, 4.63, 4.39, # Quality of life
      4.65, 4.35, 4.71, 4.4,  # Self-efficacy beliefs
      5.89, 6.27, 3.87, 3.68  # Loneliness
      
    ),
    
    sd_post = c(
      
      0.48, 0.53, 0.50, 0.56,
      0.47, 0.53, 0.46, 0.48,
      0.96, 1.07, 0.97, 1.05,
      0.81, 0.97, 0.93, 0.88,
      3.61, 3.55, 3.87, 3.68
      
    ),
    
    es_paper = rep(
      c(
        0.27, 0.36, 
        0.25, 0.48,
        0.03, 0.15,
        0.27, 0.23, 
        -0.04, 0.15
      ),
      each = 2
    ),
    
    # From Table 3 (p. 58)
    
    b_adj = c(
      .12, .021, .13, .046,   #Empowerment
      .10, .038, .17, .004,   #Hope
      .064, .11, .11, .15,    #Quality of life
      .23, .064, .21, .14,    #Self-efficacy beliefs
      .066, -.65, -.34, -.49  #Loneliness
      
    ),
    
    pval_b_adj = c(
      .016, .55, .012, .24,  #Empowerment
      .039, .28, .001, .91,  #Hope
      .471, .09, .24, .025,  #Quality of life
      .010, .31, .026, .042, #Self-efficacy beliefs
      .85, .008, .35, .07    #Loneliness
      
      ),
    
    ci_l_b_adj = c(
      .022, -.05, .026, -.025,
      NA, -.030, .026, -.025,
      -.11, -.016, -.071, 0.020,
      .059, -.062, .027, .006,
      -.60, -1.14, -1.05, -1.02
    ),
    
    ci_u_b_adj = c(
      .22, .092, .23, .12,
      NA, .11, .23, .12, 
      .23, .24, .29, .28,
      .40, .19, .39, .27,
      .74, -.16, .37, .042
    ),
    
    tval_b_adj = qt(pval_b_adj/2, df = N-2, lower.tail = FALSE),
    se_b_adj = b_adj/tval_b_adj
    
  ); Timmermans2012 


wide_format_Timmermans2012 <- function(data, filter){
  
  filter_func <- function(data, filter){
    
    dat <- data |> dplyr::filter(timing != filter)
    
    dat |> 
    dplyr::mutate(group = case_match(group, "Treatment" ~ "t", "Control" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N_start:dplyr::last_col()
    )
    
    
  }
  
  purrr::pmap_dfr(list(filter), ~ filter_func(data = data, filter = .x )) |> 
    arrange(outcome)
  
  
}

# Continue from here

Timmermans2012_wide <- 
wide_format_Timmermans2012(data = Timmermans2012, filter = c("6 months", "3 months"))

rm(wide_format_Timmermans2012)

```

Effect sizes calculation

```{r}

Timmermans2012_es <- 
  Timmermans2012 |>
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Timmermans et al. 2012",
    es_calc_method = "Pretest adj. means",
    
    ppcor = .76,  
    ppcor_calc_method = "From study (p. 57)",
    
    R2 = NA,
    R2_calc_method = "Not relevant - calculated from SE(b)",
    
    N_t = N[1],
    N_c = N[2],
    
    N_total = N_t + N_c, 
    
    df_ind = N_total,
    
    n_covariates = 1,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_total-2) ),
    m_diff_post = m_post[1] - m_post[2],
    
    # Pretest adjusted means
    b_adj = b_adj[1] - b_adj[2],
    
    # Difference in differences measures
    diff_t = m_post[1] - m_pre[1],  
    diff_c = m_post[2] - m_pre[2],
    
    DD = diff_t - diff_c,
    
    d_paper = es_paper[1],
    
    # Converting Loneliness measure since "Possible scores range from 0 to 11, 
    # with higher scores indicating more loneliness." (p. 58)
    d_post = if_else(unique(outcome) == "Loneliness", m_diff_post/sd_pool * -1, m_diff_post/sd_pool),
    vd_post = sum(1/N) + d_post^2/(2*df_ind),
    Wd_post = sum(1/N),
    
    d = if_else(unique(outcome) == "Loneliness", b_adj/sd_pool * -1, b_adj/sd_pool),
    vd = sum((se_b_adj/sd_pool)^2) + d^2/(2*df_ind),
    #vd_test = sum(1/N) + d^2/(2*df_ind),
    Wd = sum((se_b_adj/sd_pool)^2),
    #Wd_test = sum(1/N),
    
    d_alt = if_else(unique(outcome) == "Loneliness", DD/sd_pool * -1, DD/sd_pool),
    vd_alt = 2*(1-ppcor) * sum(1/N) + d_alt^2/(2*df_ind),
    Wd_alt = 2*(1-ppcor) * sum(1/N),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = sum(1/N) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    g = J * d, 
    vg = sum((se_b_adj/sd_pool)^2) + g^2/(2*df_ind), 
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = 2*(1-ppcor) * sum(1/N) + g_alt^2/(2*df_ind),
    Wg_alt = Wd_alt,
    
    
    .by = c(outcome, timing) 
    
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # "was 7.0±2.1 (range of three to 12)" (p. 57)
    avg_cl_size = 7, 
    avg_cl_type = "From study (p. 57)",
    
    # Imputed icc value
    icc = 0.06,
    icc_type = "From study (p. 56)",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt, 
      model = "std_reg_coef",
      cluster_adj = TRUE,
      SE_std = sqrt(Wg)
    ),
    
    gt_alt = g_alt * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_alt, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
    ),
    
    gt_alt_type = "DiD from raw means",
    
    gt_posttest = g_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_posttest, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_posttest",
      vars = vgt_posttest:Wgt_posttest
    )

    
    
  ) |> 
  ungroup()

# Timmermans2012_es

Timmermans2012_est <- 
  left_join(Timmermans2012_wide, Timmermans2012_es) |> 
  select(-c(es_paper_c, es_paper_t)) |> 
  mutate(vary_id = paste0(outcome, "/", timing),
         analysis_plan = case_when(
           outcome == "Empoverment"  ~  "The Dutch Empowerment Scale", 
           outcome == "Hope"  ~ "The Herth Hope Index", 
           outcome == "Quality"  ~ "The Manchester Short Assessment of Quality of Life", 
           outcome == "Self-e"  ~ "The Mental Health Confidence Scale", 
           outcome == "Loneliness"  ~ "The Loneliness Scale"
         )
      )

#clubSandwich::impute_covariance_matrix(
#  vi = Timmermans2012_est$vgt,
#  cluster = Timmermans2012_est$study,
#  r = Timmermans2012_est$ppcor,
#  smooth_vi = FALSE
#)

```


### **Gatz et al. [-@Gatz2007]**

Entering data from Table 2 (p. 872)   

```{r}

Gatz2007 <- tibble(
  outcome = rep(c("ASI alcohol", "ASI drug", "GSI", "PSS", "Coping skills"), each = 2),
  group = rep(c("Intervention", "Comparison"), dplyr::n_distinct(outcome)),
  N = c(136, 177, 135, 176, 136, 177, 136, 177, 134, 173),
  
  m_pre = c(
    .18, .27, 
    .19, .25, 
    1.07, 1.09, 
    20.43, 19.05,
    52.61, 54.26),
  
  m_post = c(
    .06, .13, 
    .04, .08, 
    .8, .86, 
    13.78, 15.11,
    56.32, 52.96),
  
  sd_pre = c(
    .29, .35, 
    .15, .14, 
    .68, .69, 
    10.22, 11.84,
    17.83, 17.51),
  
  sd_post = c(
    .17, .23, 
    .07, .11, 
    .72, .77, 
    11.1, 12.91,
    20.15, 20.09)
)


```

Effect size calculation and cluster bias adjustment

```{r}

Gatz2007_est <- 
  Gatz2007 |> 
  mutate(group = case_match(group, "Intervention" ~ "t", "Comparison" ~ "c")) |> 
  tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    ) |> 
  mutate(
    F_val = c(0.53, 1.23, 0.34, 3.99, 4.12), # Table 2 (p. 872)
    
    analysis_plan = c(
      "Alcohol and drug abuse/misuse", "Alcohol and drug abuse/misuse",
      "using all", "using all", "Hope, Empowerment & Self-efficacy"
    ),
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Gatz et al. 2012",
    main_es_calc_method = "Raw diff-in-diffs",
    
    ppcor = NA_real_,  
    ppcor_calc_method = "F value used",
    
    m_post = m_post_t - m_post_c,
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    # Account for the fact that some outcomes are on different scales
    m_diff_t = m_post_t - m_pre_t, 
    m_diff_c = m_post_c - m_pre_c, 
      
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = d_DD^2/F_val + d_DD^2/(2*df_ind),
    Wd_DD = d_DD^2/F_val,
    
    g_DD = J * d_DD, 
    vg_DD = g_DD^2/F_val + g_DD^2/(2*df_ind),
    Wg_DD = g_DD^2/F_val
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # Imputed since group sizes were not reported
    avg_cl_size = grp_size_imp, 
    avg_cl_type = "Imputed",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      F_val = F_val,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = outcome
    
  ) |> 
  ungroup(); Gatz2007_est

```



### **Gordon et al. [-@Gordon2018]**

Entering data from Table 2 (p. 124)

```{r}

Gordon2018 <- tibble(
  
  outcome = as.factor(rep(c(
   "QLS_total",
   #"QLS_interpersonal",
   #"QLS_ instrumental",
   #"BLERT",
   "LSP",
   #"SCSQ-ToM",
   "SSPA",
   "DASS-21"
   #"AIHQ-Hostility-bias"
   ), 
   each = 2)),
  
  group = rep(c("SCIT", "Control"), each = 1, n_distinct(outcome)),

  N = rep(c(21, 15), each = 1, n_distinct(outcome)),
 
 m_pre = c(
   50.24, 45.73, # QLS total
   #15.86, 13.40, # QLS interpersonal subscale 
   #6.19, 6.00,   # QLS instrumental subscale
   #14.43, 14.40, # BLERT
   13.38, 14.53, # LSP
   #7.33, 7.07,   # SCSQ-ToM
   65.19, 59.07, # SSPA
   43.33, 53.33  # DASS-21
    # 8.43, 8.53   # AIHQ-Hostility-bias
  ),  
 
 sd_pre = c(
   15.83, 13.85, 
   #7.26, 7.18, 
   #5.94, 6.21, 
   #3.62, 3.15, 
   7.44, 6.12, 
   #1.62, 1.79, 
   12.03, 10.57, 
   26.20, 32.73 
   #3.80, 4.24
 ),
 
 m_post = c(
   56.30, 47.67, 
   #17.40, 14.47, 
   #6.95, 6.53, 
   #15.90, 15.93, 
   10.29, 13.60,
   #7.50, 7.07, 
   71.25, 63.57, 
   41.10, 49.13
   #6.80, 8.87
 ),
 
 sd_post = c(
   16.34, 13.19, 
   #8.33, 6.57, 
   #5.48, 6.63, 
   #3.62, 2.76, 
   4.59, 6.10, 
   #1.53,1.40, 
   8.22, 7.89, 
   25.96, 31.40 
   #1.73, 2.29
 )
 
); Gordon2018

```

Effect size calculation and cluster bias adjustment

```{r}

Gordon2018_est <- 
  Gordon2018 |> 
  mutate(group = case_match(group, "SCIT" ~ "t", "Control" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    ) |> 
  mutate(
    F_val = c(
      2.503, #0.019, 
      0.905, #0.632, 
      0.039, 0.573 # 2.99
      ), 
    
    analysis_plan = case_when(
      outcome == "DASS-21" ~ "using all",
      str_detect(outcome, "SSPA|LSP") ~ "Social functioning (degree of impairment)",
      str_detect(outcome, "QLS") ~ "Wellbeing and Quality of Life",
      TRUE ~ NA_character_
    ),
    
    main_effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Gordon et al. 2018",
    main_es_calc_method = "Raw diff-in-diffs",
    
    
    ppcor = ppcor_imp,  
    ppcor_calc_method = "Imputed - F-vals seemed flawed",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Calculate d post
    m_post = m_post_t - m_post_c,
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    # Account for the fact that some outcomes are on different scales
    m_diff_t = m_post_t - m_pre_t, 
    m_diff_c = m_post_c - m_pre_c, 
      
    d_DD = (m_diff_t - m_diff_c)/sd_pool,
    vd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + d_DD^2/(2*df_ind),
    Wd_DD = 2*(1-ppcor) * (1/N_t + 1/N_c),
    
    g_DD = J * d_DD, 
    vg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c) + g_DD^2/(2*df_ind),
    Wg_DD = 2*(1-ppcor) * (1/N_t + 1/N_c)
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # Imputed since group sizes were not reported
    avg_cl_size = grp_size_imp, 
    avg_cl_type = "Imputed",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    n_covariates = 1,
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    # Calculated via Eq. 7 (Hedges & Citkowicz, 2015)
    df_adj = df_h_1armcluster(N_total = N_total, ICC = icc, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega = 1 - 3/(4*df_adj-1),
    
    df_adj_icc005 = df_h_1armcluster(N_total = N_total, ICC = ICC_005, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc005 = 1 - 3/(4*df_adj_icc005-1),
    
    df_adj_icc02 = df_h_1armcluster(N_total = N_total, ICC = ICC_02, N_grp = N_t, avg_grp_size = grp_size_imp),
    omega_icc02 = 1 - 3/(4*df_adj_icc02-1),
    
    # Cluster-adjusting g_post
    gt_post = omega * d_post * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_post, 
      model = "posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_post",
      vars = vgt_post:Wgt_post
      ),
    
    gt_DD = omega * d_DD * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_DD, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD"
      ),
    
    gt_DD_icc005 = omega_icc005 * d_DD * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_DD_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc005",
      vars = vgt_DD_icc005:Wgt_DD_icc005
      ),
    
    gt_DD_icc02 = omega_icc02 * d_DD * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_DD_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_DD_icc02",
      vars = vgt_DD_icc02:Wgt_DD_icc02
      ),
    
    vary_id = outcome
    
  ) |> 
  ungroup(); Gordon2018_est

```




### **Gutman et al. [-@Gutman2019]**

Entering raw data from Table 2 (p. 67)

```{r}

Gutman2019_raw <- 
  tibble(
    outcome = rep(c("PSS", "WHOQOL-BREF"), each = 20),
    
    group = rep(c("t", "c"), each = 10, 2),
    
    pre_test = c(
      25, 37, 34, 33, 19, 25, 36, 34, 32, 35, # PSS intervention
      25, 30, 31, 34, 26, 21, 32, 34, 27, 35, # PSS Control
      121, 114, 84, 89, 82, 83, 86, 70, 119, 93, # WHOQOL intervention
      97, 113, 98, 93, 86, 93, 98, 57, 01, 101 # WHOQOL control
    ),
    
    post_test = c(
      21, 32, 30, 29, 15, 23, 32, 27, 28, 30, 
      27, 30, 33, 41, 30, 27, 32, 36, 33, 36,
      125, 118, 95, 89, 87, 91, 93, 77, 125, 107,
      100, 112, 95, 90, 88, 85, 100, 43, 74, 102
    )
    
  ) |> 
  mutate(
    across(pre_test:post_test, ~ (.x - mean(.x))/sd(.x), .names = "{.col}_std"),
    
    .by = outcome
    
  )

```

Effect size calculation

```{r}

# Calculate raw means first and combine with _est object
Gutman2019 <- 
  Gutman2019_raw |> 
  summarise(
    
    N = length(post_test),
    
    m_pre = mean(pre_test),
    sd_pre = sd(pre_test),
    m_post = mean(post_test),
    sd_post = sd(post_test),
    
    r = cor(pre_test, post_test),
    
    .by = c(outcome, group)
  ) |> 
  pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  ) |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total
  )

Gutman2019_cor <- 
  Gutman2019_raw |> 
  summarise(
    
    ppcor = cor(pre_test, post_test),
    ppcor_calc_method = "From study - raw data",
    
    .by = outcome
  )

Gutman2019 <- left_join(Gutman2019, Gutman2019_cor, by = join_by(outcome))

Gutman2019_est <-
  Gutman2019_raw |> 
  summarise(
    
    d_reg = summary(lm(post_test_std ~ group + pre_test_std, data = pick(everything())))$coefficients[2],
    var_term1_reg = summary(lm(post_test_std ~ group + pre_test_std, data = pick(everything())))$coefficients[5]^2,
    
    .by = outcome
  
  ) |> 
  mutate(
    
    d_reg = if_else(outcome == "PSS", d_reg * -1, d_reg)
    
  ) |> 
  left_join(Gutman2019, by = join_by(outcome)) |> 
  mutate(
    
    analysis_plan = c("Fill-in"),  
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Gutman et al. 2019",
    main_es_calc_method = "Standardized regression",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Calculate d post
    m_post = if_else(outcome == "WHOQOL-BREF", m_post_t - m_post_c, (m_post_t - m_post_c) * -1),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c), 
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post
    
    
  ) |> 
  relocate(c(d_reg:var_term1_reg), .after = last_col()) |> 
  mutate(
    
  vd_reg = var_term1_reg + d_reg^2/(2*df_ind),
  Wd_reg = var_term1_reg,
  
  g_reg = J * d_reg, 
  vg_reg = var_term1_reg + g_reg^2/(2*df_ind),
  Wg_reg = var_term1_reg,
    
  avg_cl_size = 10, # Assuming one cluster of 10 only 
  avg_cl_type = "From study",
    
  # Imputed icc value
  icc = ICC_01,
  icc_type = "Imputed",
  
  gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
  
  gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
  
  gamma_sqrt_icc02 = gamma_1armcluster(
    N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
    ),
 
  adj_fct = eta_1armcluster(N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc),
  adj_fct_icc005 = eta_1armcluster(N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005),
  adj_fct_icc02 = eta_1armcluster(N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02),
  
  # Accounting for the fact that this study is single sited/clustered
  gt_post = gamma_sqrt * g_post * sqrt(1-icc),
  vgt_post = adj_fct * vg_post * (1-icc),
  Wgt_post = adj_fct * Wg_post * (1-icc),
  
  gt_reg = gamma_sqrt * g_reg * sqrt(1-icc),
  vgt_reg = adj_fct * vg_reg * (1-icc),
  Wgt_reg = adj_fct * Wg_reg * (1-icc),
  
  a = sqrt(2*Wgt_reg*df_ind),
  hg_reg = sqrt(2) * sign(gt_reg) * (log(abs(gt_reg) + sqrt(gt_reg^2 + a^2)) - log(a)),
  vhg_reg = 1/df_ind,
  
  gt_reg_icc005 = gamma_sqrt_icc005 * g_reg * sqrt(1-ICC_005),
  vgt_reg_icc005 = adj_fct_icc005 * vg_reg * (1-ICC_005),
  Wgt_reg_icc005 = adj_fct_icc005 * Wg_reg * (1-ICC_005),
  
  gt_reg_icc02 = gamma_sqrt_icc02 * g_reg * sqrt(1-ICC_02),
  vgt_reg_icc02 = adj_fct_icc02 * vg_reg * (1-ICC_02),
  Wgt_reg_icc02 = adj_fct_icc02 * Wg_reg * (1-ICC_02),
  
  vary_id = outcome
    
  ) |> 
  select(-a); Gutman2019_est


```

### **Hagen et al. [-@Hagen2005]**

```{r Hagen et al. 2018}
# Data from table 2, p. 39 
Hagen2005 <- tibble(
  
  outcome = rep(c(
    
  "SCL-90",
  "BAI",
  "BDI",
  "IIP-64-C"
  #"SAS-A",
  #"SAS-S",
  #"YSQ"
  ), 
  each = 2,1
 ),
 
 group = rep(c(
     
   "waiting-list", "CBGT"
   ),
   each = 1,4
 ),
 
 N = c(
     17, 15, 
     17, 15, 
     15, 15, 
     17, 14 
     # 16, 14, 
     # 16, 15, 
     # 16, 14
   ),
 m_pre = c(
     1.19, 1.15,
     20.29, 22.60,
     18.20, 15.40,
     1.35, 1.22
    # 73.06, 62.93,
    #  73.87, 70.80, 
    #  11.50, 7.21
 ),
 
  sd_pre = c(
      0.61, 0.61,
      10.08, 14.77,
      8.55, 9.86,
      0.72, 0.63
     # 20.23, 15.66,
     # 20.26, 19.16,
     # 14.15, 8.62
  ) ,
 
 m_post = c(
   1.15, 0.88, 
   22.94, 18.13, 
   18.35, 11.00, 
   1.28, 1.18 
  # 60.12, 58.57, 
  # 69.12, 60.14, 
  # 10.17, 6.63
 ),
 
 sd_post = c(
   0.47, 0.59,  
   13.46, 12.00,
   9.00, 8.36,
   0.68, 0.76
  # 14.17, 18.67,
  # 13.99, 22.52,
  # 13.41, 11.16
 ),

); Hagen2005


# Making the Hagen2006 tibble wide in order to estimate the effect sizes and
# further analysis. 


Hagen2005_wide <-
  Hagen2005 |> 
  mutate (group = case_match(
    group, "CBGT"  ~ "t", 
    "waiting-list" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )

# Effect size calculating 
Hagen2005_est <-           
  Hagen2005_wide |>
  mutate(
    analysis_plan =
      c("The Symptom Checklist 90-Revised (SCL-90-R)",
        "Beck Anxiety Inventory (BAI) ",
        "Beck Depression Inventory (BDI)",
        "Inventory of Interpersonal Problems 64-Circumplex (IIP-64C)"
      )
  
  ) |> 
  
  rowwise() |> 
  mutate(
    study = "Hagen et al. 2005",
    
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # For all measures lower scores are beneficial why these are reverted
    m_post = (m_post_t - m_post_c)*-1, 
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()
```

### **Izquierdo et al. [-@Izquierdo2021]**
```{r Izquierdo et al. 2021}
# Rows 1-10 is data from table 3, p. 10 and rows 11-22 is from table 4 p. 13. 

izquierdo2021 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,12)),
  timing = rep(c(
    "Post",
    "3m",
    "6m"
  ),
  each = 8,1),
  
  
  outcome = rep(c(
                  #"EE",
                  #"OE",
                  "CS", 
                  "ACI",
                  "SCI",
                  #"POSIT",
                  #"NEGAT",
                  #"AFFECT",
                  #"DISOR",
                  #"DISORG",
                  "Total_score"),
                each = 2,3), 
  
  N = rep(c(7)),
  
  
  m_pre = rep(c(
    # 6.57, 10.57, # EE
    # 6.86, 8.29,  # OE
    13.43, 18.86,# CS
    NA, NA,      # ACI - Basline data not reported
    NA, NA,      # SCI - Basline data not reported
    # 21.29, 15.14,# POSIT
    # 10.57, 6.86, # NEGAT
    # 35.86, 37.14,# AFFECT
    # 5.00, 3.86,  # DISOR
    # 4.86, 2.43,  # DISORG
    77.57, 65.43 # Total_score
    ), each = 1,3),
  
  sd_pre = rep(c(
    # 2.44, 3.36,
    # 2.19, 1.38,
    2.44, 4.34,
    NA, NA,
    NA, NA,
    # 11.09, 5.84,
    # 4.24, 2.54,
    # 5.64, 4.56,
    # 3.00, 3.18, 
    # 2.67, 1.90,
    18.30, 10.85), 
    each = 1,3),
  
  m_post = c(
    
    # post measurement
    # 17.86, 10.57,
    # 16.29, 8.14,
    34.14, 18.71,
    36.57, 11.14,
    4.57, 1.14,
    # 8.14, 15.71,
    # 5.43, 7.71,
    # 16.86, 37.00,
    # 2.43, 3.86,
    # 1.29, 1.57,
    34.14, 65.86,
    
    # 3 months measurement
    #  16.00, 9.71,
    #  16.29, 7.57,
    32.29, 17.29,
    37.57, 11.00,
    4.57, 1.00,
    #  7.14, 15.71,
    #  5.00, 8.00,
    #  13.29, 35.14,
    #  2.57, 3.71,
    #  1.00, 1.14,
    29.00, 63.71,
    
    
    # 6 months measurement
    # 16.71, 9.71,
    # 15.71, 6.86,
    32.43, 16.57,
   37.14, 11.57,
    4.29, 1.14,
    #  7.29, 15.29,
    #  5.00, 8.29,
    #  13.00, 36.14,
    #  2.29, 3.57,
    #  1.00, 1.29,
    28.57, 64.57
    
  ),
  
  sd_post = c(
  
  # post measurement
  #  1.86, 3.15,
  #  3.09, 1.35,
    4.81, 2.87,
    5.32, 3.19,
    0.54, 0.38,
  #  2.12, 6.40,
  #  1.27, 3.45,
  #  2.27, 3.74,
  #  0.53, 2.54,
  #  0.49, 0.79,
    3.13, 11.13,
  
  # 3 months measurement 
  #  3.21, 2.98,
  #  2.63, 2.07,
  5.28, 2.87,
  4.20, 3.21,
  0.53, 0.00,
  #  1.07, 6.97,
  #  0.82, 3.56,
  #  0.95, 4.70,
  #  0.79, 2.63,
  #  0.00, 0.38,
  1.83, 11.97,
  
  # 6 months measurement 
  # 16.71, 9.71,
  # 15.71, 6.86,
  5.19, 2.88,
  4.88, 2.94,
  0.76, 0.38,
  #  7.29, 15.29,
  #  5.00, 8.29,
  #  13.00, 36.14,
  #  2.29, 3.57,
  #  1.00, 1.29,
  1.81, 9.68
  )
  

); izquierdo2021

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(c("Post", paste0(c(3, 6), "m")), 1)
  
)



wide_izquierdo2021_func <- 
  function(filter_val1){
    
    izquierdo2021 |> 
      filter(timing == filter_val1) |> 
      mutate(group = case_match(group, "Intervention" ~ "t", "Control" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }



izquierdo2021_est <- 
  pmap(params, wide_izquierdo2021_func) |>
  list_rbind() |> 
  mutate(
    analysis_plan = rep(
      c("Coping with Stress Self-efficacy (CSSE)",
        "Perceived changes in successful daily functioning (Areas of Change Index, ACI)",
        "Satisfaction with changes in overall daily functioning (single-item self-report, SCI)",
        "The expanded brief psychiatric rating scale" # Total score
      ), each = 1,3),
    
    study = "Izquierdo et al. 2021",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Reverting m_post only for Total_score
    m_post = if_else(outcome == "Total_score", (m_post_t - m_post_c) * -1, m_post_t - m_post_c), 
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = paste0(outcome, "/", timing)
    
  ) |> 
  ungroup()
```
### **Lim et al. [-@Lim2020]**
```{r Lim et al. 2020}
# Data from table 2 (p.5)  containing means, standard deviation and ANOVA estimations
# with F-values and η2. Table 3 (p.6) has the same values but with ANCOVAS (i.e. indcludes covariates)


Lim2020 <- tibble(
  group = as.factor(rep(c("Social Cognitive Skills Training",
                          "Treatment as Usual"), each = 1,6)
                    ),
  
  outcome = as.factor(rep(c(
                            "Social Functioning (QLS)",
                            "PANSS Negative",
                            "PANSS Excitement",
                            "PANSS Cognitive",
                            "PANSS Positive",
                            "PANSS Depressive"
                            ), each = 2,1 )
                      ),
  
  N = 21,
  
  m_pre = c(46.15, 61.74, # Social Functioning (QLS) total
           18.22, 16.57,  # PANSS Negative
           6.28, 6.91,    # PANSS Excitement
           13.94,13.57,   # PANSS Cognitive
           7.67, 9.62,    # PANSS Positive
           8.67, 11.29    # PANSS Depressive
           
    ), 
  
  sd_pre = c(12.01, 18.60, # Social Functioning (QLS) total
             6.23, 3.84,   # PANSS Negative
             1.87, 2.02,   # PANSS Excitement
             4.67, 3.25,   # PANSS Cognitive
             2.00, 3.54,   # PANSS Positive
             2.47, 3.45    # PANSS Depressive
  ),
  
  m_post = c(54.76, 57.70, # Social Functioning (QLS) total
             16.89, 18.14, # PANSS Negative
             6.89, 7.33,   # PANSS Excitement
             13.44, 15.19, # PANSS Cognitive
             8.72, 8.72,   # PANSS Positive
             8.94, 13.81   # PANSS Depressive
    ),
  
  sd_post = c(10.88, 15.92, # Social Functioning (QLS) total
              4.51, 3.71,   # PANSS Negative
              2.05, 2.20,   # PANSS Excitement
              2.75, 2.98,   # PANSS Cognitive
              3.06, 2.67,   # PANSS Positive
              2.98, 4.21    # PANSS Depressive
    
  )
)

# Making the lim2020 tibble wide in order to estimate the effect sizes and
# further analysis. 


Lim2020_wide <-
  Lim2020 |> 
  mutate (group = case_match(
    group, "Social Cognitive Skills Training"  ~ "t", 
           "Treatment as Usual" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )


# Effect size calculating 
Lim2020_est <-           
  Lim2020_wide |>
  mutate(
    analysis_plan = rep(
      c("The Quality of Life Scale (QLS)",
        "Positive and Negative Syndrome Scale for Schizophrenia (PANSS)"
      ), c(1,5)),
    
    # F-Values - based on ANOVA - from table 2 (p.5)
    F_val = c(3.116, 5.157, 0.085, 5.055, 1.528, 8.487),
    #  η2 values from table 2 (p. 5)
    eta_sqrt = c(0.080, 0.125, 0.002, 0.123, 0.041, 0.191), # unsure if this should be included
    
    ) |> 
    
    rowwise() |> 
      mutate(
        study = "Lim et al. 2020",
        
  
        N_total = N_t + N_c,
        df_ind = N_total,
        
        # For PANSS lower scores is beneficial why these is reverted
        m_post = if_else(outcome != "Social Functioning (QLS)", (m_post_t - m_post_c)*-1,
                         m_post_t - m_post_c), 
                         
        sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
        
        d_post = m_post/sd_pool, 
        vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
        Wd_post = (1/N_t + 1/N_c),
        
        J = 1 - 3/(4*df_ind-1),
        
        g_post = J * d_post,
        vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
        Wg_post = Wd_post,
        
        vary_id = outcome
        
      ) |> 
  ungroup()
```

### **Lloyd-Evans et al. [-@Lloyd-Evans2020]**
```{r Lloyd-Evans et al. 2020}
# Dataextraction from Lloyd-Evans (2020)
# Attempt from Jakob

# Loading the relevant package 
library(estmeansd)

# From table 2 on page 9

# Creating a tibble containing data with IQR, and later i will estimate the mean 
# and SD from this information using bc.mean.sd (Box-Cox method) 

lloyd_Evans2020_IQR <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,5)),
  
  outcome = as.factor(rep(c("DJG-total", 
                            #"DJG-social", removed
                            #"DJG-Emotional", 
                            "GAD-7", 
                            "WEMWBS", 
                            "LSNS6", 
                            "RGUK" 
                            #"ReQoL-10", 
                            #"EQ-VAS", 
                            #"days in acute", removed
                            #"inpatient bed days", removed
                            # "kept appointments"
                            #"missed appointments" removed
                            
# DJG-social, days-in-acute, inpatient bed days, missed appointments: are all 
# removed because there was not enough variance between the IQR to get a an estimate
# Their numbers are therefore also removed further down. 
                            
                            
                          ),
                          each = 2,1)
  ),
  
  N_start = rep(c(30,10),
          each = 1,5),
  
  firstq_pre = c(
    10, 9,   #  Loneliness: De Jong-Gierveld (DJG) Loneliness Scale
    # 5, 4,
    # 5, 5,    # DJG: Emotional Loneliness subscale score
    15, 11,  # Generalized Anxiety Disorder Questionnaire (GAD-7) 
    20, 24,  # Warwick-Edinburgh Mental Well-being Scale (WEMWBS) 
    4, 9,    # Social network: Lubben Social Network scale (LSNS6)
    5, 8.8  # Perceived social capital: Resource Generator UK (RGUK)
    # 4, 5,    # Recovering Quality of Life Questionnaire (ReQoL-10)
    # 29, 30,  # Self-rated health using EQ-Visual Analogue Scale (EQ VAS)
    # 0, 0,
    # 0, 0,
    # 3, 1     # Community service kept appointments
    # 0, 0
  ), 
  
  median_pre = c(
    11, 10.5,
    # 5, 5,
    # 6, 6,
    19, 16,
    26.5, 30,
    7, 11.5,
    9.5, 13
   # 9, 9.5
   # 35, 47.5,
   # 0, 0,
   # 0, 0,
   # 6.5, 6.5
   # 0, 0
  ),
  
  thirdq_pre = c(
    11, 11,
   # 5, 5,
   # 6, 6,
    21, 18,
    32, 34,
    9, 15,
    12, 18.3
   # 14, 15,
   # 50, 50, 
   # 0,0,
   # 0,0,
   # 11, 17
   # 1, 1
  ),
  
  N = rep(c(25,10), # TOT N
               each = 1,5),
  
  firstq_post = c(
    8, 7,
    # 4, 4,
    # 4, 4,
    10.5, 11,
    23, 23,
    6, 6,
    6, 6.5
    # 8, 10,
    # 30, 35,
    # 0,0,
    # 0,0,
    # 2, 1
    # 0,0
  ),

  median_post = c(
    9, 10,
    # 5, 4,
    # 5, 6,
    14, 13.5,
    29.5, 31,
    7.5, 11,
    9, 13
    # 14.5, 13.5,
    # 40, 52.5,
    # 0,0,
    # 0,0,
    # 3.5, 8
    # 0, 1.5
    
  ),
  
  thirdq_post = c(
    11, 11,
    # 5, 5, 
    # 6, 6,
    17.5, 16, 
    34.5, 37,
    11, 15,
    12.3, 22.3
    # 19, 19,
    # 60, 60,
    # 0,0,
    # 0,0,
    # 10, 10
    # 1, 3
  )
) |> 
  rowwise() |> 
  mutate (pre = list(bc.mean.sd(
    q1.val = firstq_pre,
    med.val = median_pre,
    q3.val = thirdq_pre,
    n = N_start
  )[c("est.mean", "est.sd")])) |> 
  unnest_wider(pre, names_sep = "_") |> 
  rowwise() |> 
  mutate(post = list(bc.mean.sd(
    q1.val = firstq_post,
    med.val = median_post,
    q3.val = thirdq_post,
    n = N
  )[c("est.mean", "est.sd")]))|> 
  unnest_wider(post, names_sep = "_") |> 
  rename(
    m_pre = pre_est.mean,
    sd_pre = pre_est.sd,
    m_post = post_est.mean,
    sd_post =  post_est.sd); lloyd_Evans2020_IQR
  

# Creating a tibble with the rest of the data which is measured by mean and SD
lloyd_Evans2020_means <- tibble(          
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,1)),
  
  outcome = as.factor(rep(c("PHQ-9"
                          #  "TBD",
                           # "EQ-5D-5L
                          ),
  each = 2,1)
  ),
  
  N_start = rep(c(30,10),
          each = 1,1),
  
  m_pre = c(
    21.6, 21.1   # Depression: Patient Health Questionnaire (PHQ-9)
  #  32.7, 38.4,  # Activity: Time Budget Diary (TBD)
  #  0.283, 0.400 # EuroQol Health Questionnaire (EQ-5D-5L) Index value
  ),
  
  sd_pre = c(
    5.3, 4.5
   # 9.6, 11.2,
   # 0.40, 0.24
  ),
  
  N = rep(c(25,10), # TOT N
               each = 1,1),
  
  m_post = c(
    16.4, 18.8
    # 36.9, 35,
    # 0.472, 0.453
  ),
  
  sd_post = c(
    6.8, 4.8
   # 12.9, 14.4,
   # 0.33, 0.236
    
  )
); lloyd_Evans2020_means


# Combing the obejct so i have the all the data from table 2 in one obejct
lloyd_Evans2020 <- lloyd_Evans2020_IQR|> 
  full_join(lloyd_Evans2020_means) |> 
  select(group, outcome, N, m_pre, sd_pre, m_post, sd_post, N_start); lloyd_Evans2020


# Turning dataset into wide format
lloyd_Evans2020_wide <-
  lloyd_Evans2020 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", 
    "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )

# Effect size calculating 
lloyd_Evans2020_est <-           
  lloyd_Evans2020_wide |>
  mutate(
    analysis_plan =
      c("Loneliness, using the 11-item De Jong Gierveld scale",
        "The Generalised Anxiety Disorder (GAD-7 ",
        "Wellbeing, using the 14-item Warwick Edinburgh Mental Wellbeing Scale (WEMWBS)",
        "Social network, using the 6-item Lubben Social Network Scale", 
        "Perceived social capital, using the 27-item Resource Generator UK measure",
        "Depression, using the Patient Health Questionnaire (PHQ-9)"
      )
    
  ) |> 
  
  rowwise() |> 
  mutate(
    study = "Lloyd Evans et al. 2020",
    
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Reverting m_post for specific outcomes
    m_post = if_else(outcome %in% c("DJG-total", "GAD-7", "PHQ-9"),
                     (m_post_t - m_post_c) * -1, 
                     m_post_t - m_post_c),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()


```
## **McCay et al. [-@McCay2014]**
```{r}

```

### **Morley et al. [-@Morley2014]**
```{r Morley et al. 2014}
# Data from table 2 containing means and standard deviation on page 136

Morley2014 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,4)),
  
  outcome = as.factor(rep(c("BSS",
                            "HADS_depression",
                            "HADS_anxiety",
                            "SES"), each = 2,1
  )),
  
  N = rep(c(
    122, 63
  ), each = 1,4),
  
#   q = 6, # Controlling for Unemployment status, Suicide Ideation, recent cannabis use, 
        # recent heroin use, life time cocaine use, lifetime amphetamine use (p. 134)

  
  m_pre = c(
    9.5, 12.56, # Beck Scale for Suicide Ideation (range 0–38)
    9.3, 9.89,  # HAD Scale Depression (range 0–21)
    12.58, 12.35, # HAD Scale Anxiety (range 0–21)
    61.76, 65.09  # Self-Efficacy Scale (range 0–90)
  ),
  
  sd_pre = c(
    9.61, 8.55,
    6.66, 5.6, 
    6.66, 5.39,
    15.34, 12.55
  ),
  
  m_post = c(
    5.83, 6,
    6.4, 7.1,
    8.83, 9.71,
    65.31, 65.13
  ),
  
  sd_post = c(
    5.58, 6.61,
    5.43, 4.3,
    5.72, 4.3,
    12.49, 9.58
  ),
  
  ); Morley2014



# Turning dataset into wide format
Morley2014_wide <-
  Morley2014 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", 
    "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )


# Effect size calculating 
Morley2014_est <-           
  Morley2014_wide |>
  mutate(
    analysis_plan =
      c("Suicide Ideation",
        "Hospital Anxiety and Depression Scale",
        "Hospital Anxiety and Depression Scale",
        "Self-Efficacy Scale"
      )
    
  ) |> 
  
  rowwise() |> 
  mutate(
    study = "Morley et al. 2014",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # Reverting m_post for specific outcomes
    m_post = if_else(outcome %in% c("BSS", "HADS_depression", "HADs_anxiety"),
            (m_post_t - m_post_c) * -1, 
            m_post_t - m_post_c),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()

```

### **Morton et al. [-@Morton2012]**

```{r}
# Data from table 3 containing means and standard deviation (p. 538)
Morton2012 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,6)),
  
  outcome = as.factor(rep(c("BEST_composite",
  #                          "BEST_BPD_thoughts_&_feelings", The subscaled are removed 
  #                                                          we only use total-scale
  #                          "BEST_BPD_negative_behaviors",
  #                          "BEST_BPD_positive_behaviors",
                            "DASS_stress",
                            "DASS_anxiety",
                            "DASS_depression",
                            "BHS",
 #                            "AAQ-II",
                            "DERS_total"
 #                           "FFMQ_total",
 #                            "ACS_total"
  ),
  each = 2,1)),
  
  N = rep(c(21, 20),
          each = 1,6),
 
  
  m_pre = c(
    44.57, 49.80, # BEST composite
     28.48, 30.3, # DASS stress
     23.33, 24.20,# DASS anxiety
    31.52, 33.7, # DASS depression
    14.40, 15.7, # BHS
    # 24.10, 22.55,# AAQ-II
     131.76, 134.42 # DERS total
    # 96.52, 92.15,# FFMQ total
    # 4.86, 4.93   # ACS total
  ),
  
  sd_pre = c(
    11.16, 12.35,
    10.04, 10.16,
    9.34, 11.76,
    10.86, 8.74,
    4.87, 3.58,
    # 9.29, 8.32,
     25.15, 19.45
    # 23.01, 20.81,
    # 0.74, 0.68
  ),
  
  m_post = c(
    32.76, 47.42,
    26.55, 31.57,
    19.67, 26.28,
    22.67, 31.00,
    9.7, 16.43,
  #  35.3, 23.1,
    113.04, 140.04
  #  108.81, 90.87,
  #  4.35, 5.08
  ), 
  
  sd_post = c(
    12.47, 11.00,
    11.58, 9.93,
    11.02, 8.33,
    14.73, 8.51,
    6.34, 3.69,
  #  10.8, 7.1,
    17.64, 20.88
  #  19.11, 20.67,
  #  0.65, 0.56
  )
  

); Morton2012


Morton2012_wide <-
  Morton2012 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )



Morton2012_est <- 
  Morton2012_wide |>
  mutate(
    
    study = "Morton et al. 2012",
    
    analysis_plan = rep(
      c("BEST composite", 
        "DASS stress", 
        "DASS anxiety",
        "DASS depression", 
        "BHS", 
        "DERS total"), 
      c(1, 1, 1, 1, 1, 1))
  ) |> 
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # reverting all scores as lower score is beneficial
    m_post =  (m_post_t - m_post_c) * -1,
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |>
  ungroup()


# Regression coefficients extracted from text (pp.537-539)
morton2012_es <- tibble(
  
  study = "morton2012",
  
  es_method = "Multilevel model",
  
  group = rep(c("treatment", # Treatment is ACT + TAU
                "control", # Control is TAU.
                "interaction"), each = 1,4),
  
  outcome = rep(c(
                  "BEST_composite", 
#                  "BEST_BPD_thoughts_feelings", 
#                  "BEST_BPD_negative_behaviors", 
                  "DASS_anxiety", 
                  "BHS", 
#                  "AAQ-II", 
                  "DERS_total" 
#                  "FFMQ_total",
#                  "ACS_total"
                  ), each = 3,1),
  
  beta = c(-11.52, -1.8, 9.71,  # BEST Composite
#           -6.6, -0.05, 6.54, # BEST BPD thoughts and feelings
#           -1.11, -3.98, 2.87, # BEST BPD negative and behaviors
           -3.92, 3.98, 7.90, # DASS anxiety
           -4.93, 0.62, 5.55, # BHS
#           5.55, 0.37, -9.88, # AAQ-II
           -19.17, 4.77, 23.94 # DERS total
#           12.30, -0.31, -12.62, # FFMQ total
#           -0.54, 0.18, 0.71), # ACS total
),
  
  se = c(2.75, 3.19, 4.21, 
#         1.77, 2.05, 2.72, 
#         1.04, 0.90, 1.38,
         2.24, 2.50, 3.36,
         1.27, 1.38, 1.87,
#         1.87, 2.65, 3.60,
         5.68, 6.30, 8.48
#         3.71, 4.06, 5.50,
#         0.15, 0.16, 0.21),
),
  
  t = c(2.3, -0.57, 2.3, 
#        -3.72, -0.03, 2.41, 
#        -1.06, -4.42, 2.08,
        -1.74, 1.59, 2.35,
        -3.88, 0.45, 2.96,
#        2.96, 0.139, -2.74,
        -3.38, 0.76, 2.82
#        3.31, -0.08, -2.29,
#        -3.63, 1.15, 3.33), # unsure about this
),
  
  p = c(0.000, 0.575, 0.28, 
#        0.001, 0.979, 0.022, 
#        0.296, 0.0, 0.046,
        0.091, 0.121, 0.025,
        0.000, 0.656, 0.006,
#        0.006, 0.891, 0.010,
        0.002, 0.454, 0.008
#        0.002, 0.939, 0.028,
#        0.001, 0.258, 0.002),
),
  
  d = c(0.99,0.15, 0.81, 
#        0.88, 0.01, 0.85, 
#        1.05, 0.29, 0.75,
        0.41, 0.41, 0.83,
        0.91, 0.11, 1.02,
#        1.02, 0.04, 0.99,
        0.78, 0.19, 0.98
#        0.79, 0.02, 0.80,
#        0.89, 0.30, 1.20)
)
  
); morton2012_es
```

### **Patterson et al. [-@Patterson2003]**
```{r}
# Data from table 3 (p.21)  containing means, standard deviation. It also contains
# Time X Interaction coefficients with p-values (estimated with ANOVA) 


Patterson2003 <- tibble(
  group = as.factor(rep(c("FAST Intervention", 
                          "Treatment-as-Usual"), 
                        each = 1, 10)),
  
  timing = rep(c("3m", 
                 "6m"), 
               each = 10,1),
 
   outcome = as.factor(rep(c(
#    "UPSA", 
    "PANSS_Positive", 
    "PANSS_Negative", 
    "PANSS_General", 
    "HAM_D", 
    "QWB"), each = 2, 2)),
 
   N = 16,
  
  m_pre = rep(c(
#    31.9, 41.5,   # UPSA
    12.5, 13.0,   # PANSS Positive
    16.9, 13.0,   # PANSS Negative
    25.0, 21.9,   # PANSS General
    7.8, 7.7,     # Ham-D
    0.53, 0.55    # QWB
  ), each = 1,2),
  
  sd_pre = rep(c(
#    11.8, 8.3,    # UPSA
    5.6, 4,       # PANSS Positive
    6.6, 3.2,     # PANSS Negative
    6.2, 3.7,     # PANSS General
    6.1, 2.8,     # Ham-D
    0.08, 0.08    # QWB
  ), each = 1,2),
  
  
  m_post = c(
#    41.5, 40.3, # UPSA           3 months
    13.0, 10.4, # PANSS Positive 3 months
    13.0, 10.1, # PANSS Negative 3 months
    21.9, 22.3, # PANSS General  3 months
    7.7, 4.9,   # Ham-D          3 months
    0.55, 0.49, # QWB            3 months
    
#    42.7, 41.6,  # UPSA           6 months
    12.13, 13.1, # PANSS Positive 6 months 
    14.3, 12.4,  # PANSS Negative 6 months
    23.9, 23.9,  # PANSS General  6 months
    7.2, 7.9,    # Ham-D          6 months
    0.51, 0.49   # QWB            6 months
  
  ),

  sd_post = c(
#    9.5, 7.1,     # UPSA           3 months
    6.6, 6.3,     # PANSS Positive 3 months
    5.1, 4,       # PANSS Negative 3 months
    4.7, 4.9,     # PANSS General  3 months
    5.2, 5.3,     # Ham-D          3 months
    0.10, 0.07,   # QWB           3 months
    
    
   
#    9.7, 9.7,     # UPSA           6 months
    4.3, 5.9,     # PANSS Positive 6 months
    6, 4.4,       # PANSS Negative 6 months
    4.6, 4.4,     # PANSS General  6 months
    4.9, 5,       # Ham-D          6 months
    0.07, 0.07    # QWB            6 months
   )
)


# Making the patterson2003 tibble wide in order to estimate the effect sizes and
# further analysis. 

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(c(paste0(c(3, 6), "m")), 1)
)

wide_patterson2003_func <- 
  function(filter_val1){
    
    Patterson2003 |> 
      filter(timing == filter_val1) |> 
      mutate(group = case_match(group, "FAST Intervention" ~ "t", "Treatment-as-Usual" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }



Patterson2003_est <- 
  pmap(params, wide_patterson2003_func) |>
  list_rbind() |>
  # Based on the degrees of freedom value reported in Druss et al. 2018 table 2 and 3
  mutate(
    analysis_plan = rep(
      c(
        "Positive And Negative Syndromes Scale (PANSS)", # PANSS
        "Positive And Negative Syndromes Scale (PANSS)", # PANSS
        "Positive And Negative Syndromes Scale (PANSS)", # PANSS
        "Hamilton Depression Rating Scale (HAM-D)", # HAM-D
        "Health-related quality of life, with the Quality of Well-Being (QWB) Scale" # QWB
      ), each = 1,2),
    
    study = "Patterson et al. 2003") |> 
  
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    
    # For PANSS and HAM-D lower scores are beneficial why these is reverted
    m_post = if_else(outcome != "QWB", (m_post_t - m_post_c)*-1,
                     m_post_t - m_post_c),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
   vary_id = paste0(outcome, "/", timing)
    
  ) |> 
  ungroup()
```

### **Popolo et al. [-@Popolo2019]**
```{r Popolo et al. 2019}
# Data from table 2 containing means and standard deviation + within effect size.
# Table also contains "between group-group post treatment effect size at post-tratement"
# with a coefficient and "Post hoc power" on page 351

Popolo2019 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,3)),
  
  outcome = as.factor(rep(c("CORE_OM",
                            "DERS",
                            "TAS"
#                            "Metacognition_self",
#                            "Metacognition_others",
#                            "Metacognition_decentration",
#                            "Metacognition_mastery"
), each = 2,1)),
  
  N = rep(c(10, 10), each = 3), 
  
  m_pre = c(
    12.85, 15.24, # CORE-OM Total
    95, 100.9, # DERS Total
    54.2, 51.5 # TAS Total
#    4.3, 4.1, # Metacognition Self
#    2.1, 2.85, # Metacognition Others
#    0.75, 1.15, # Metacognition Decentration 
#    2.9, 3.3    # Metacognition Mastery
  ),
  
  sd_pre = c(
    4.6, 6.68,
    16.19, 17.67,
    11.52, 10.99
#    1.32, 0.97,
#    0.52, 1.31,
#    0.75, 1.03,
#    1.07, 0.67
  ),
  
  m_post = c(
    7.68, 11.78,
    76.4, 97.11,
    43.5, 52.63
#    5.75, 3.35,
#    2.9, 3.3,
#    1.15, 0.7,
#    4.18, 3.05
  ),
  
  sd_post = c(
    1.94, 4.59,
    26.78, 29.12,
    11.7, 12.59
#    1.36, 1.27,
#    1.07, 0.67,
#    1.03, 0.48,
#    1.35, 1.23
  ), 
  
# Within-group effect size baseline – 3-month follow-up
  within_group_effect = c( 
    1.14, 0.64,
    0.74, 0.16,
    1.11, 0.10
#    1.73, 0.56,
#    0.99, 0.32,
#    0.59, 0.51,
#    1.51, 0.20
  )

)


Popolo2019_wide <-
  Popolo2019 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )



Popolo2019_est <- 
  Popolo2019_wide |>
  mutate(
    
    study = "Morton et al. 2012",
    
    analysis_plan =
      c("Clinical Outcomes in Routine Evaluation Outcome Measure (CORE-OM)", 
        "Difficulties in Emotion Regulation Scale (DERS)", 
        "The Toronto Alexithymia Scale – 20 (TAS-2)"),
    
    # Between-group post-treatment effect size at post-treatment from table 2, p. 351
    d = c(1.16, 0.73, 0.75), 
    post_hoc_power = c(0.8, 0.47, 0.49)
    
    )|> 
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # reverting all scores as lower score is beneficial
    m_post =  (m_post_t - m_post_c) * -1,
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |>
  ungroup()

```

### **Rabenstein et al. [-@Rabenstein2015]**
```{r Rabenstein et al. 2015}
# Based on table 2, p. 6
Rabenstein2015 <- tibble(
  group = rep(c("Intervention", "Control"), each = 1, 3),
  
  outcome = rep(c(
  #  "Somatization", 
  #  "OCD", 
  #  "Insecurity", 
  #  "Depression",
  #  "Anxiety",
  #  "Aggressiveness",
  #  "Phobic Anxiety",
  #  "Paranoid Thinking",
  #  "Psychoticism",
    "GSI", 
    "BDI", 
    "WHO-QoL"
  #  "Physical",
  #  "Mental", 
  #  "Social Relations", 
  #  "Environment"
  ), each = 2,1),
  
  
  
  N = rep(c(
    153, 148
  ), each = 1, 3),
  
  
  N_start = rep(c(
    170
  )),
  
  m_pre = c(
#    8.11, 8.08,
#    9.85, 12.04,
#    5.58, 7.23,
#    9.22, 10.45,
#    7.82, 9.91,
#    4.08, 5.45,
#    5.15, 6.43,
#    5.83, 7.24,
#    4.74, 5.76,
    1.12, 1.48,
    23.39, 25.04,
    40.71, 42.87
#    50.78, 50.35,
#    38.52, 37.9,
#    53.31, 47.49,
#    61.68, 63
  ),
  
  sd_pre = c(
#    5.51, 5.79,
#    5.45, 5.30,
#    4.04, 3.67,
#    6.08, 5.28,
#    5.09, 5.20,
#    3.61, 3.23,
#    4.92, 4.83,
#    4.35, 4.09,
#    3.72, 3.87,
    0.68, 0.66,
    10.92, 9.83,
    22.38, 21.37
#    19.56, 15.96,
#    19.55, 16.43,
#    24.22, 23.85,
#    18.62, 16.04
  ),
  
  m_post = c(
#    4.49, 7.15,
#    7.02, 10.25,
#    4.06, 6.63,
#    5.68, 9.87,
#    4.45, 8.59,
#    2.74, 4.15,
#    2.91, 5.59,
#    4.82, 6.25,
#    3.12, 4.93,
    0.81, 1.30,
    15.24, 22.08,
    53.21, 46.1
#    59.43, 52.07,
#    48.45, 38.49,
#    58.23, 50.27,
#    65.83, 65.83
  ),
  
  sd_post = c(
#    4.46, 5.64,
#    5.16, 5.63,
#    3.53, 4.06,
#    5.18, 5.63,
#    4.36, 5.40,
#    2.45, 3.18,
#    3.67, 4.62,
#    4.26, 4.51,
#    3.25, 3.91,
    0.60, 0.67,
    10.78, 9.95,
    22.83, 20.44
#    21.37, 15.32,
#    19.94, 17.32,
#    23.77, 22.13,
#    18.08, 17.12
  )
)

# Making it a wide format:

Rabenstein2015_wide <-
  Rabenstein2015 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )


# Effect size calculation:

Rabenstein2015_est <-           
  Rabenstein2015_wide |>
  mutate(
    analysis_plan =
      c("Brief Symptom Inventory", 
        "Beck Depression Inventory (BDI)",
        "WHO Quality of Life-BREF"),
    
    study = "Rabenstein et al. 2015"
    
    # There are also some effect sizes in the raw text on p. 7
    
  ) |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # The outcome BSI and BDI are reverted because lower score is beneficial
    m_post = if_else(analysis_plan %in% c("Brief Symptom Inventory",
                                         "Beck Depression Inventory (BDI)"), 
                    (m_post_c - m_post_t), # Revert the difference if BSI or BDI
                    m_post_t - m_post_c),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()
```

### **Rosenblum et al. [-@Rosenblum2014]**
```{r Rosenblum et al. 2014}
# Extracting data from table 3 p. 85 

Rosenblum2014 <- tibble(
  
  group = as.factor(rep(c(
    "Double Trouble in Recovery (DTR)",
    "waiting list control group"), 
    each = 1,15
  )),
  
  sample = rep(c(
    "Total",
    "New York",
    "Michigan"
  ), each = 10,1),
  
  
  outcome = rep(c(
    "Days any alcohol past 30",
    "Days heavy alcohol past 30",
    "Days any drugs past 30",
    "Days any drugs or alcohol past 30",
    
    "Medication Adherence"
    
   # "RQOL (quality of life)c (total scale)" Only measured at follow-up 
   ), each = 2,3
 ),
 
 N = c(
   rep(c(91,70), each = 1,5), # Total 
   
   rep(c(35, 32), each = 1,5), # New York
   
   rep(c(56, 38), each = 1,5) # Michigan
   
 ),
 
 m_pre = c(
   4.5, 6.5,
   2.6, 2.1,
   6.9, 7.7,
   9.3, 11.9,
   1.5, 1.5,

   
   1.9, 3.9,
   0.3, 0.8,
   4.2, 7.1,
   4.7, 9.9,
   1.4, 1.4,

   
   6.1, 8.6, 
   4.0, 3.1,
   8.6, 8.2,
   12.2, 13.6,
   1.6, 1.6 

 ),
 
 sd_pre = c(
   8.2, 9.6,
   6.1, 5.1,
   9.3, 10.4,
   10.1, 11.2,
   0.5, 0.5,

   
   4.7, 7.2,
   1.0, 1.8,
   6.3, 10.2,
   6.1, 10.8,
   0.4, 0.4,
 
   
   9.5, 11.0,
   7.4, 6.5,
   10.5, 10.6, 
   11.0, 11.5,
   0.5, 0.5
  
 ), 
 
 m_post = c(
   3.1, 6.1,
   1.1, 2.1, 
   5.5, 8.0,
   6.8, 11.3,
   1.4, 1.4,
#   2.7, 2.0,
   
   1.6, 3.2,
   0.3, 1.0, 
   3.4, 8.0,
   4.5, 10.2,
   1.4, 1.3,
#   3.5, 3.2,
   
   4.0, 8.4,
   1.5, 3.0, 
   6.8, 8.0,
   8.3, 12.2,
   3.5, 1.6
#   2.1, 1.0
 ),

sd_post = c(
  6.4, 8.8,
  2.8, 6.0,
  9.2, 10.6,
  9.8, 11.1,
  0.4, 0.4,
  # 1.8, 1.8,
  
  4.4, 7.2,
  1.3, 4.5,
  7.1, 10.2, 
  7.8, 10.8, 
  0.3, 0.3,
  #  1.5, 1.7,
  
  7.3, 9.5, 
  3.4, 7.0,
  10.2, 11.1,
  10.6, 11.4, 
  0.5, 0.4
# 1.8, 1.3
),

q = c(
  rep(c(1), each = 1,10), # The baseline equivalent of the dependent variable was used as a covariate, p. 85
  rep(c(2), each = 1, 4), # The baseline variable PTSD diagnosis was added as a covariate to these analyses because it was correlated with study condition and the outcome variable, p. 85
  rep(c(1), each  = 1,2),
  rep(c(2), each = 1,2),
  rep(c(1), each = 1,12)
  )
); Rosenblum2014



# Turning data into wide format
params <- tibble(
  filter_val1 = rep(unique(Rosenblum2014$sample), each = 1)
)


wide_Rosenblum2014_func <- 
  function(filter_val1){
    
    Rosenblum2014 |> 
      filter(sample == filter_val1) |> 
      mutate(group = case_match(group, "Double Trouble in Recovery (DTR)" ~ "t", "waiting list control group" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }


Rosenblum2014_est <- 
  pmap(params, wide_Rosenblum2014_func) |>
  list_rbind() |> 
  mutate(
    
    p_val = c(0.03, 0.11, 0.07, 0.02, 0.45, 
              0.84, 0.47, 0.07, 0.17, 0.73,
              0.01, 0.10, 0.31, 0.06, 0.15),
    
    analyse_plan = rep(c(
      rep(c("substance and alcohol use (and adaptation of the Addiction Severity Index plus Saliva testing)"), each = 1,4),
      rep(c("medication adherence (Medication Adherence Rating Scale; MARS)"), each = 1,1)
    ), each = 1,3),
    
    study = "Rosenblum et al. 2014" 
    
) |> 
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # all scores are reverted because lower scores is beneficial 
    m_post =  (m_post_t - m_post_c)*-1,
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    
    vary_id = paste0(sample, "/", outcome)
    
  ) |> 
  ungroup() 
```

### **Sacks et al. [-@Sacks2011]**
```{r Sacks et al. 2011}
# This study makes estimations based on two different analysis based on their
# propensity scores (what i read as the level of control) - i will keep them
# in the same tibble - "sample" indicates different propensity category. 
#Extracted from table 4 p. 1682 and only means plus standard deviation is taken.

Sacks2011 <- tibble(
  
  group = rep(c("Intervention",
                "Control"), 
              each = 1,10),
  
  
  outcome = rep(c(
#    "alcohol_intoxication",
#    "drug_use",
    "BDI_total",
    "GSI_total",
    "SF-36_mental_health",
    "SF-36_social_functioning",
#    "Health_rating",
    "SF-36_physical_health"
  ), each = 2,2),
  
  
  sample = rep(c("low/medium propensity", 
                 "high propensity"), each = 10,1),
  
  
  
  
  
  N = rep(c(23,10), 
          each = 10,1),
  
  m_pre = c(# Low/medium propensity 
  #          6.8, 6.5, # alcohol
  #          12.9, 17.8, # drugs
            16.1,  18.9, # BDI
            45.3, 47.7, # GSI
            42.4, 37.6, # SF-36 mental
            46.6, 38.5, # SF-36 social functioning 
  #          3.0, 3.0, # Health rating
            44.9, 47.2, # SF-36 physical health
            
            # High propensity
  #          6.3, 7.5, # alcohol
  #          15.9, 8.3, # drugs
            15.3, 15.3, # BDI
            42.0, 41.8, # GSI
            43.5, 43.1, # SF-36 mental
            13.2, 43.6, # SF-36 social functioning
  #          3.0, 3.5, # Health rating
            42.0, 42.6 # SF-36 physical health
            
            ),
  
  
  sd_pre = c(# Low/medium propensity 
  #           2.4, 2.2, # alcohol
  #           7.2, 8.7, # drugs
             6.7, 10.0, # BDI
             4.0, 9.0, # GSI# SF-36 mental
             11.8, 13.0, # SF-36 mental
             11.3, 13.7, # SF-36 social functioning
  #           1.2, 1.1, # Health rating
             9.0, 10.3, # SF-36 physical health
             
             # High propensity
  #           2.3, 0.7, # alcohol
  #           7.5, 5.7, # drugs
             3.7, 11.9, # BDI
             10.3, 7.4, # GSI
             10.4, 9.1, # SF-36 mental
             13.9, 11.3, # SF-36 social functioning
  #           1.0, 0.6, # Health rating
             10.4, 14.0), # SF-36 physical health
  
  
  m_post = c(
    # Low/medium propensity 
  #  2.7, 0.6, # alcohol
  #  0.6, 2.1, # drugs
    13.1, 8.2, # BDI
    38.6, 36.4, # GSI
    46.5, 47.2, # SF-36 mental
    44.9, 46.5, # SF-36 social functioning
  #  2.9, 3.0, # Health rating
    45.5, 47.6, # SF-36 physical health
    
    # High propensity
  #  0.4, 1.0, # alcohol
  #  0.4, 1.3, # drugs
    10.0, 16.5, # BDI
    39.0, 42.3, # GSI
    49.5, 41.6,  # SF-36 mental
    47.5, 46.3, # SF-36 social functioning
  #  3.1, 4.3, # Health rating
    42.8, 48.8 # SF-36 physical health
  ),
  
  sd_post = c(
    # Low/medium propensity 
  #  2.1, 1.8, # alcohol
  #  1.9, 4.7, # drugs
    11.9, 6.6, # BDI
    9.2, 10.1, # GSI
    14.2, 13.7, # SF-36 mental
    12.6, 11.5, # SF-36 social functioning
  #  1.2, 1.0, # Health rating
    7.3, 10.1,  # SF-36 physical health
    
    # High propensity
  #  1.1, 1.4, # alcohol# drugs
  #  0.9, 1.9, # drugs
    10.9, 8.4, # BDI
    7.7, 5.9, # GSI
    11.1, 13.2,  # SF-36 mental
    12.0, 7.7, # SF-36 social functioning
  #  1.0, 0.5, # Health rating
    12.9, 6.6 # SF-36 physical health
  )
  
  
); Sacks2011

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(unique(Sacks2011$sample)
                    , each = 1
                    )
)

wide_sacks2011_func <- 
  function(filter_val1){
    
    Sacks2011 |> 
      filter(sample == filter_val1) |> 
      mutate(group = case_match(group, "Intervention" ~ "t", "Control" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }



Sacks2011_est <- 
  pmap(params, wide_sacks2011_func) |>
  list_rbind() |> 
  mutate(

   analysis_plan = case_when(
     outcome == "BDI_total" ~ "the Beck Depression Inventory-II (BDI-II)",
      outcome == "GSI_total" ~ "Global Severity Index (GSI)",
      str_detect(outcome, "SF-36") ~ "Short-Form Health Survey (SF-36)= Quality of life"),

  study = "Sajatovic et al. 2009"

) |> 
  
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # For GSI and BDI lower scores are beneficial why these are reverted
    m_post = if_else(!outcome %in% c("BDI_total", "GSI_total"), m_post_t - m_post_c,
                     (m_post_t - m_post_c)*-1),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),    
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = paste0(outcome, "/", sample)
    
  ) |> 
  ungroup()




```

### **Sajatovic et al. [-@Sajatovic2009]**
```{r Sajatovic et al. 2009}
# Data from table 2 (p. 1186) provides mean and standard deviation. Table also 
# indcludes p-values indicating "Test of significance between the two groups 
# using repeated-measures analysis with PROC MIXED " (Sajatovic et al. 2009: 1186)


Sajatovic2009  <- tibble(
  group = rep(c("Life Goals Program", # Intervention
                "Treatment as usual"), # Control
              each = 1,9),
  
  outcome = rep(c("HAM-D", # Hamilton Depression Rating Scale
                   "YMRS", # Young Mania Rating Scale
                   "GAS"), # Global Assessment Scale
                 each = 2,3),
  
  timing = rep(c("3m", "6m", "12m"), each = 6),
  
  
  N = c(
        # 3 months
        63, 65,
        63, 65,
        61, 61,
        
        # 6 months
        51, 55,
        51, 55,
        46, 53,
        
        # 12 months 
        41, 39, 
        41, 39, 
        40, 39
        ),
  
  N_start = rep(c(
    83, 80,
    84, 80,
    83, 78
  ), each = 1, 3),
  
  
  m_pre = rep(c(
    19.98, 17.08, # HAM-D
    7.3, 7.58,    # YMRS
    56.53, 58.22  # GAS
    
  ), each =  1,3),
  
  
  sd_pre = rep(c(
    11.45, 10.99,
    5.41, 5.44,
    12.43, 12.00
    
  ), each = 1, 3),
  
  
  m_post = c(
    # 3 months
    16.30, 16.35,
    6.14, 15.85,
    60.10, 59.05,
    
    # 6 months
    16.35, 15.96,
    6.78, 7.69,
    61.72, 62.19, 
    
    # 12 months
    16.02, 14.39,
    5.85, 7.15,
    63.70, 64.51
  ), 
  
  
  sd_post = c(
    # 3 months
    9.68, 10.52,
    4.85, 5.38,
    11.63, 12.44, 
    
    # 6 months
    10.18, 12.47,
    5.36, 6.26,
    12.76, 14.42,
    
    # 12 months
    11.73, 10.87,
    4.74, 5.60,
    12.66, 15.90
  )
  
)


# Making the sajatovic2009 tibble wide in order to estimate the effect sizes and
# further analysis. 

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(c(paste0(c(3, 6, 12), "m")), 1)
)

wide_sajatovic2009_func <- 
  function(filter_val1){
    
    Sajatovic2009 |> 
      filter(timing == filter_val1) |> 
      mutate(group = case_match(group, "Life Goals Program" ~ "t", "Treatment as usual" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }



Sajatovic2009_est <- 
  pmap(params, wide_sajatovic2009_func) |>
  list_rbind() |> 
  mutate(
    # P-values obtained from table 2, calculated with repeated-measures analysis with 
    # PROC MIXED in SAS (p. 1186) - 
    p_val = rep(c(0.40, 0.22, 0.97), each = 1,3), # Should be checked

   analysis_plan = rep(
    c("Hamilton Depression Rating Scale (HAM-D)", # HAM-D
      "Young Mania Rating Scale (YMRS)", # YMRS
      "Functional impairments caused by illness were assessed with the Global Assessment Scale (GAS)" # GAS
  ), each = 1,3),

  study = "Sajatovic et al. 2009", 
  
  
  

) |> 
  
  rowwise() |> 
  mutate(
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # For YMRS and HAM-D lower scores are beneficial why these are reverted
    m_post = if_else(outcome != "GAS", (m_post_t - m_post_c)*-1,
                     m_post_t - m_post_c),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),    
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = paste0(outcome, "/", timing)
    
  ) |> 
  ungroup()
```
### **Schrank et al. [-@Schrank2016]**
```{r Schrank et al. 2016}
# Based on table 1, 2 and 3 in the same article 
Schrank2016 <- tibble(
  group = rep(c("Intervention", "Control"), each = 1, 8),
  
  outcome = rep(c(
    "WEMWBS", 
    "MANSA", 
    "PPI", 
    "BPRS",
    "SDHS",
    "IHS",
    "RSES", 
    "RES"
  ), each = 2,1),
  
  
  N = rep(c(
    41, 43
  ), each = 1, 8),
  
 m_pre = c(3.19, 3.00,
  4.05, 4.14,
  3.58, 3.44,
  30.70, 33.57,
  2.29, 2.48,
  4.02, 3.72, 
  2.24, 2.09,
  2.74, 2.71),
 
sd_pre = c(
  0.76, 0.89,
  0.85, 1.01,
  0.73, 0.80,
  8.81, 8.42,
  0.69, 0.76,
  0.79, 0.85,
  0.64, 0.66,
  0.32, 0.32
),

m_post = c(
  3.36,3.24,
  4.42, 4.21,
  3.72, 3.48,
  29.37, 33.23,
  2.13, 3.34,
  4.11, 4.04,
  2.37, 2.21,
  2.8,2.73
),

se_post = c(
  0.10, 0.10,
  0.10, 0.10,
  0.07, 0.07,
  0.96, 0.98,
  0.08, 0.09,
  0.1, 0.1,
  0.07, 0.07,
  0.04,0.04) 
) |> 
  mutate(sd_post = se_post * sqrt(N)) # Calculating the standard deviation from the standard error




Schrank2016_wide <-
  Schrank2016 |> 
  mutate (group = case_match(
    group, "Intervention"  ~ "t", "Control" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )



Schrank2016_est <-           
  Schrank2016_wide |>
  mutate(
    analysis_plan = c(
      "Warwick-Edinburgh Mental Well-Being Scale (WEMWBS)",
      "Manchester Short Assessment (MANSA)",
      "Positive psychotherapy inventory (PPI)",
      "Brief Psychiatric Rating Scale (BPRS)",
      "The Short Depression-Happiness Scale (SDHS)",
      "The Integrative Hope Scale (IHS)",
      "Rosenberg Self-Esteem Scale (RSES)",
      "Rogers Empowerment Scale (RES)"
    ),
    
    # ANCOVA results from table 3, p. 242
    F_val = c(
      0.8,
      2.3,
      5.9,
      7.8,
      3.0,
      3.0,
      2.9,
      2.0
    ),
    
    df1 = rep(c(1)),
    df2 = rep(c(81)),
    
    p_val_f = c(
      0.15,
      0.21,
      0.30,
      0.42,
      0.29,
      0.08,
      0.23,
      0.22
    )
    
) |> 
  rowwise() |> 
  mutate(
    study = "Schrank et al. 2016",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # The outcome BPRS is reverted because lower score is beneficial
    m_post = if_else(analysis_plan != "Brief Psychiatric Rating Scale (BPRS)", 
                     m_post_t - m_post_c,
                     (m_post_t - m_post_c) * -1),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()
```

### **Rüsch et al. [-@Rüsch2019]**
```{r}
# Data from table 1 containing means and standard deviation on page 335
# The table also contains partial η2 values, p-values and F-test

Rüsch2019 <- tibble(
  group = as.factor(rep(c("Intervention", 
                          "Control"), 
                        each = 1,12)),
  
  timing = rep(c("6w", 
                 "12w"), 
               each = 12,1),

  outcome = as.factor(rep(c("Job_search", 
                            "Help_seeking", 
                            "SISR",
                            "SSMIS_SF",
                            "CES-D", 
                            "BHS"  
                          #  "Secrecy"
                            ), 
                          each = 2,2 )
                      ),
  
  N = c(rep(c(
    18, 17), # 6 weeks 
     times = 6), 
        rep(c(
    
    20, 13), # 12 weeks
    times = 6)),
  
  N_start = rep(c(
    23, 19
  ), each = 1,12),
  
  m_pre = rep(c(
    3.1, 3.3, # Job-search self-efficacy (1–5)
    3.4, 3.0,  # Help-seeking intentions (1–7)
    15.3, 16.3, # Recovery (SISR: 4–24)
    17.3, 17.3,  # Self-stigma (SSMIS-SF: 5–45)
    39.2, 41.4, # Depressive symptoms (CES-D: 15–60)
    14.9, 14.1 # Hopelessness (BHS: 4–24)
#    4.0, 3.7   # Link’s 5-item Secrecy Scale
  ), each = 1,2),
  
  sd_pre = rep(c(
    0.8, 0.8,
    1, 1,
    4.1, 4.2,
    4.3, 8.1,
    7.4, 7.2,
    3.6, 4.5 
#    1.2, 1.6
  ), each = 1,2),
  
  m_post = c(
  # 3 Weeks
  #  3.2, 3.2, 
  #  3.6, 3,
  #  16.1, 15.9, 
  #  15.3, 16.9, 
  #  35.2, 39.1,
  #  13.8, 13.7,
  #  3.8, 3.7
    
  # 6 weeks
    3.4, 3.3, 
    3.5, 3.2, 
    17.8, 16.1, 
    14.6, 19.1, 
    31.5, 40.1, 
    12.6, 14.2, 
#    3.5, 3.9,
    
    # 12 weeks 
    3.2, 3.2,
    3.3, 3.1,
    17.3, 15.7,
    15.4, 18.3,
    32, 37.5,
    12.3, 14.4
#    3.7, 4.4
    
  ),
  
 
sd_post = c(
  # 3 weeks
  # 0.7, 0.9, 
  # 1, 0.9, 
  # 4.2, 3.6, 
  # 6.2, 8, 
  # 8.8, 10.2, 
  # 3.9, 4.6, 
  # 1, 1.7
  
  # 6 weeks
  0.8, 0.9,
  1, 1, 
  3.4, 4.4,
  7.9, 8.7,
  8.5, 10.1,
  3.6, 5, 
#  1.3, 1.7,
  
  # 12 weeks
  1, 0.9, 
  0.6, 0.9,
  3.5, 2.6,
  7, 9.6,
  7.6, 9.8,
  4.2, 3
#  0.9, 1.4
 )
); Rüsch2019



# Turning data into wide format
params <- tibble(
  filter_val1 = rep(c(paste0(c(6, 12), "w")), 1)
)

wide_Rüsch2019_func <- 
  function(filter_val1){
    
    Rüsch2019 |> 
      filter(timing == filter_val1) |> 
      mutate(group = case_match(group, "Intervention" ~ "t", "Control" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }


Rüsch2019_est <- 
  pmap(params, wide_Rüsch2019_func) |>
  list_rbind() |>
  
  mutate(
    analysis_plan = rep(
      c(
        "6-item Job Search Self-Efficacy Scale",
        "item General Help-Seeking Questionnaire",
        "the 4-item part B of the Self-Identified Stage of Recovery Scale",
        "5-item self-concurrence subscale of the Self-Stigma of Mental Illness Scale-Short Form",
        "the 15-item German version of the Center for Epidemiologic Studies-Depression Scale",
        "short 4-item version of Beck’s Hopelessness Scale"
      #  "Link’s 5-item Secrecy Scale"
        
      ), each = 1,2),
    
    # ANCOVA estimates taken from table 1, p. 335
    F_val = c(
      # 6 weeks
      1.4, 0.2, 4.6, 10.8, 6.3, 3.4,
      # 12 weeks
      0.01, 0.04, 1.9, 1.5, 0.9, 2.4
    ),
    
    eta_sqrt = c(
      # 6 weeks
      0.04, 0.007, 0.13, 0.25, 0.17, 0.10,
      
      # 12 weeks
      0.01, 0.01, 0.06, 0.05, 0.03, 0.07
    ),
    
    p_val_f = c(
      # 6 weeks
      0.24, 0.64, 0.039, 0.08, 0.17, 0.08,
      
      # 12 weeks
      0.96, 0.85, 0.17, 0.23, 0.35, 0.14
      
    ),
      
      study = "Rüsch et al. 2019") |> 
      
      rowwise() |> 
      mutate(
        N_total = N_t + N_c,
        df_ind = N_total,
        

        m_post = case_when(
          outcome %in% c("Job_search", "Help_seeking", "SISR") ~ (m_post_t - m_post_c), # Higher is beneficial
          outcome %in% c("SSMIS_SF", "CES-D", "BHS") ~ (m_post_t - m_post_c) * -1), # Lower is beneficial
          
        sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
        
        d_post = m_post/sd_pool, 
        vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
        Wd_post = (1/N_t + 1/N_c),
        
        J = 1 - 3/(4*df_ind-1),
        
        g_post = J * d_post,
        vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
        Wg_post = Wd_post,
        
        vary_id = paste0(outcome, "/", timing)
      
      ) |> 
      ungroup()
```

### **Valiente et al. [-@Valiente2022]**
```{r Valiente et al. 2022}
# Data from table 3 and table (p. 4)  containing means, standard deviation. It also contains
# difference Morris' d and p

Valiente2022  <- tibble(
  group = rep(c("Multicomponent PPI", # Intervention
                "Treatment as usual"), # Control
              each = 1,16),
  
  outcome = rep(c(
                  # Table 3
                  "SPWB Autonomy",          #Scales of Psychological Well-Being (SPWB)
                  "SPWB Positive_relationship", 
                  "SPWB Self_acceptance",
                  "SPWB Enviormental mastery",
                  "SPWB Purpose_in_life",
                  "SPWB Personal_Growth",
                  "SWLS",                  # Satisfaction With Life Scale (SWLS)
                  
                  # Table 4
                  "Somatization",         # Symptom checklist-90-Revised (SCL-90-R)
                  "Obsessive–compulsive", 
                  "Interpersonal sensibility",
                  "Depression", 
                  "Anxiety", 
                  "Hostility", 
                  "Phobic anxiety",
                  "Paranoid ideation", 
                  "Psychoticism"
                  
                  ), 
                each = 2,1),
  
  N = rep(c(52,61),
          each = 1,16),
  
  N_start = rep(c(71, 70), n_distinct(outcome)),
  
  
  m_pre = c(
    
    # Table 3
    19.5, 20.1,
    34.7, 33.9,
    29.9, 31.6,
    30.6, 31.4,
    34.4, 34.4,
    35.3, 35.7,
    17.4, 18.2,
   
    # Table 4
    1.00, 1.02,
    1.66, 1.62,
    1.42, 1.41,
    1.51, 1.47,
    1.12, 1.31,
    0.75, 0.63,
    0.89, 1.09,
    1.15, 1.15,
    1.14, 0.99
    
  ),
  
  sd_pre = c(
    # Table 3
    4.4,  4.2,
    8.0, 7.5,
    8.7, 7.8,
    7.8, 7.3,
    7.7, 5.9,
    7.4, 6.8,
    7.1, 6.8,
    
    # Table 4
    0.83, 0.81,
    0.87, 0.93,
    0.81, 0.95,
    0.87, 0.89,
    0.82, 0.97,
    0.83, 0.80,
    0.77, 1.01,
    0.86, 0.86,
    0.82, 0.83
    
  ),
        
 
  
  m_post = c(
    # Table 3
    19.9, 19.7,
    35.7, 34.4,
    31.7, 31.1,
    32.7, 30.8,
    34.9, 34.2,
    35.5, 35.5,
    19.0, 19.2,
    
    # Table 4
    0.90, 0.96,
    1.50, 1.48,
    1.28, 1.27,
    1.30, 1.40,
    1.07, 1.14,
    0.71, 0.61,
    0.91, 1.07,
    1.18, 1.21,
    0.99, 0.98
  ),
  
  sd_post = c(
    # Table 3
    3.4, 4.2, 
    7.1, 7.6, 
    7.5, 7.8, 
    7.5, 7.3, 
    6.9, 5.9,
    6.8, 6.8,
    6.6, 6.8,
    
    # Table 4
    0.82, 0.84,
    0.86, 0.96,
    0.79, 0.89,
    0.80, 0.94,
    0.84, 0.91,
    0.76, 0.79,
    0.80, 0.97,
    0.90, 0.87,
    0.85, 0.86
  )
    
)

# Making the tibble wide 

Valiente2022_wide <-
  Valiente2022 |> 
  mutate (group = case_match(
    group, "Multicomponent PPI"  ~ "t", "Treatment as usual" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  )
  
# Effect sizes: Estimating G and D (pre-post test) (Not finished yest)
Valiente2022_est <-           
  Valiente2022_wide |>
  mutate(
    analysis_plan = rep(c(
                      "Scales of Psychological Well-Being (SPWB)",
                      "Satisfaction With Life Scale (SWLS)",
                      "Symptom checklist-90-Revised (SCL-90-R)"
                      ), c(6,1,9))
    
    
  )|> 
  rowwise() |> 
  mutate(
    study = "Valiente et al. 2022",
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    # The outcome SCL-90-R reverted because lower score is beneficial
    m_post = if_else(analysis_plan != "Symptom checklist-90-Revised (SCL-90-R)", 
                     m_post_t - m_post_c,
                     (m_post_t - m_post_c) * -1),
    
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()
```

### **Volpe et al. [-@Volpe2015]**
```{r Volpe et al. 2015}
Volpe_2015 <- tibble(
# Taken from table 2, p. 19
  outcome = rep(c(
    "BPRS",   # Brief Psychiatric Rating Scale
    "PHQ-9",  # Patient Health Questionnaire
    "PSP",    # Personal and Social Performance Scale
    "DAS-II"  # Disability Assessment Schedule 2.0
  ), each = 2, 1), 
  
  
  group = rep(c(
    "Reading group",
    "Control group"
  ), each = 1, 4), 

  
  N = rep(c(21,20), each = 1, 4), 
  
   N_start = rep(c(25)),
  
  m_pre = c(
    49.95, 51.2, # Brief Psychiatric Rating Scale
    9.74, 9.9,   # Patient Health Questionnaire
    44.09, 46.2, # Personal and Social Performance Scale
    2.64, 2.95   # Disability Assessment Schedule 2.0
  ),
  
  sd_pre =c(
    15.14, 17.75,
    4.58, 4.35,
    16.19, 18.23,
    0.93, 0.94
  ),
  
  m_post = c(
    36.21, 41.2,
    4.7, 5.66,
    49.95, 47.25,
    1.25, 2.12
  ), 
  
  sd_post = c(
    17.43, 15.69,
    2.78, 2.45,
    15.53, 18.35,
    0.5, 0.25
  )
)



# Making the tibble into wideformat
Volpe2015_est <-
  Volpe_2015 |> 
  mutate(group = case_match(group, "Reading group" ~ "t", "Control group" ~ "c")) |> 
  tidyr::pivot_wider(
    names_from = group,
    names_glue = "{.value}_{group}",
    values_from = N:last_col()
  ) |> 
  mutate(
    
    analysis_plan = c(
      "The Brief Psychiatric Rating Scale (BPRS)",
      "Personal Health Questionnaire Depression Scale (PHQ-9)",
      "Personal and Social Performance Scale (PSP)",
      "The Disability Assessment Schedule (DAS-II)"
    ),
    
     # MANOVA estimates obtained from raw text on page 18 for between-group comparisons. 
    F_val = c(NA_real_, 
              NA_real_,
              7.29,
              3.07),
    
    df1 = c(NA_real_,
            NA_real_,
            1, 
            1),
    
    df2 = c(NA_real_,
            NA_real_,
            39,
            39),
    
    p_val_F = c(NA_real_,
                NA_real_,
                0.008,
                0.005
    ),
    
    N_total = N_t + N_c,
    
    N_total = N_t + N_c,
    df_ind = N_total,
    
    
    # For BPRS, PHQ-9, and DAs-II lower scores are beneficial why these is reverted
    m_post = if_else(outcome != "PSP", (m_post_t - m_post_c)*-1,
                     m_post_t - m_post_c),
    sd_pool = sqrt(((N_t-1)*sd_post_t^2 + (N_c-1)*sd_post_c^2)/(N_t + N_c - 2)),  
    
    d_post = m_post/sd_pool, 
    
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = outcome
    
  ) |> 
  ungroup()

```

### **Wojtalik et al. [-@Wojtalik2022]**
```{r}
# Data from table 2 and table (p. 505)  containing marginal means with standard error
# It also contains standard error. To calculate pre-post test we will use the standard 
# deviation from table 1 (p. 504)

Wojtalik2019 <- tibble( 
  group = as.factor(rep(c("Cognitive enhancement therapy (CET)", # Intervention
                "Enriched supportive therapy (EST)"), # Control
              each = 1,4)),
  
  analysis = rep(c("ITT", "Completers"), each = 4),
  
  
  timing = rep(c(
          #       "9m", 
                 "18m"), 
               each = 4, 2),
  
  outcome = as.factor(rep(c(
           #      "Cognition composite",
                  "Social adjustment composite",
                  "Symptoms composite"), 
                each = 2,2)),
  
  N = c(rep(c(58, 44), each = 1,2),
        rep(c(26, 23),each = 1,2)),
  
  N_start = rep(c(
    58, 44
  ), each = 1,4),
  
  me_pre = c(rep(c(
    # ITT
#    34.4, 38,  # Baseline Cognition composite 
    49.5, 51.0,# Baseline Social adjustment composite
    40.1, 50.4), # Baseline Symptoms composite
    each = 1,1),
    
    # Completers
    rep(c(
#    34.6, 39.4, # Baseline Cognition composite
    47.1, 50.4, # Baseline Social adjustment composite
    49.4, 50.2 # Baseline Symptoms composite
  ), each = 1,1)
  ),
  
  # Taken from table 1 (p. 504)
  sd_pre = c(rep(c(
    # ITT
#    11.3, 11.8, # Baseline Cognition composite  
    9.6, 10.5,  # Baseline Social adjustment composite
    10.4, 10.0), each = 1,1),  # Baseline Symptoms composite
    
    # Completer (taken from online supplements)
    rep(c(
#    12.52, 12.52,
    8.80, 8.80,
    9.18, 9.18
  ), each = 1,1)),
  
  se_pre = rep(c(
    # ITT
#    1.5, 1.7,  # Baseline Cognition composite 
    1.3, 1.4,  # Baseline Social adjustment composite
    1.3, 1.5,   # Baseline Symptoms composite
    
    # Completer
#    2.4, 2.6,
    1.8, 1.8,
    1.9, 2.0
    
  ), each = 1,1),
  
  me_post = c(
    # ITT
#    38.4, 37.1, # 9 months Cognition composite
#    54.1, 56.8, # 9 months Social adjustment composite
#    53.5, 53.4, # 9 months Symptoms composite
    
#    40.1, 39.8, # 18 months Cognition composite
    56.3, 55.5, # 18 months Social adjustment composite
    54.3, 53.5,  # 18 months Symptoms composite
    
    # Completer
#    40.0, 37.5, # 9 months Cognition composite
#    52.2, 54.9, # 9 months Social adjustment composite
#    53.2, 52.8, # 9 months Symptoms composite
    
#    41.3, 40.6, # 18 months Cognition composite
    54.5, 53.4, # 18 months Social adjustment composite
    54.0, 53.1  # 18 months Symptoms composite
    
  ),
  
  se_post = c(
    # ITT
#    1.6, 1.9, # 9 months Cognition composite
#    1.4, 1.7, # 9 months Social adjustment composite
#    1.4, 1.7, # 9 months Symptoms composite
    
#    1.8, 2.0, # 18 months Cognition composite
    2.0, 2.3, # 18 months Social adjustment composite
    1.8, 1.9,  # 18 months Symptoms composite
    
    # Completer
#    2.4, 2.6, # 9 months Cognition composite
#    1.9, 2.0, # 9 months Social adjustment composite
#    1.8, 1.9, # 9 months Symptoms composite
    
#    2.5, 2.6, # 18 months Cognition composite
    2.4, 2.5, # 18 months Social adjustment composite
    2.0, 2.1  # 18 months Symptoms composite
    
  )
  
)


# Making the wojtalik2019 tibble wide in order to estimate the effect sizes and
# further analysis. 

# Turning data into wide format
params <- tibble(
  filter_val1 = rep(unique(Wojtalik2019$analysis), each = 1)
 # filter_val2 = rep(c(paste0(c(9, 18), "m")), 2)
)


wide_wojtalik2019_func <- 
  function(filter_val1 
           #,filter_val2
           ){
    
    Wojtalik2019 |> 
      filter(analysis == filter_val1) |> 
      mutate(group = case_match(group, "Cognitive enhancement therapy (CET)" ~ "t", 
                                "Enriched supportive therapy (EST)" ~ "c")) |>
      tidyr::pivot_wider(
        names_from = group,
        names_glue = "{.value}_{group}",
        values_from = N:last_col()
      )   
    
  }


Wojtalik2019_est <- 
  pmap(params, wide_wojtalik2019_func) |>
  list_rbind() |> 
  
  mutate(
    
     analyse_plan = rep(c(
       "Social Functioning",
       "Symptoms"
     ), each = 1,2),
    
    study = "Wojtalik et al. 2019", 
    
    t_val = c(
      # ITT
     # 2.81, # 9 months Cognition composite
     #   -0.78, # 9 months Social adjustment composite
     #    0.20, # 9 months Symptoms composite
      
    #  2.04, # 18 months Cognition composite
      0.80, # 18 months Social adjustment composite
      0.43,  # 18 months Symptoms composite
      
      # Completer
    #  3.44, # 9 months Cognition composite
    #  0.32, # 9 months Social adjustment composite
    #  0.51, # 9 months Symptoms composite
      
    #  2.58, # 18 months Cognition composite
      1.60, # 18 months Social adjustment composite
      0.60  # 18 months Symptoms composite
      
    ),
    
    df = c(
      # ITT
    #  106,  # 9 months Cognition composite
    #  107,  # 9 months Social adjustment composite
    #  107,  # 9 months Symptoms composite
      
    #  106, # 18 months Cognition composite
      107, # 18 months Social adjustment composite
      107, # 18 months Symptoms composite
      
      # Completer
    #  88, # 9 months Cognition composite
    #  91, # 9 months Social adjustment composite
    #  91, # 9 months Symptoms composite
      
    #  88, # 18 months Cognition composite
      91, # 18 months Social adjustment composite
      91  # 18 months Symptoms composite
      
    ),
    
    p_values_t = c(
      # ITT
    #  0.003,  # 9 months Cognition composite
    #  0.219,  # 9 months Social adjustment composite
    #  0.421,  # 9 months Symptoms composite
      
    #  0.022, # 18 months Cognition composite
      0.214, # 18 months Social adjustment composite
      0.335,  # 18 months Symptoms composite
      
      # Completer
    #  0.001,  # 9 months Cognition composite
    #  0.376,  # 9 months Social adjustment composite
    #  0.305,  # 9 months Symptoms composite
      
    #  0.006, # 18 months Cognition composite
      0.057, # 18 months Social adjustment composite
      0.275  # 18 months Symptoms composite
      
    ),
    
    d = c(
      # ITT
    #  0.44,  # 9 months Cognition composite
    #  -0.14, # 9 months Social adjustment composite
    #  0.04,  # 9 months Symptoms composite
      
    #  0.35, # 18 months Cognition composite
      0.23, # 18 months Social adjustment composite
      0.11, # 18 months Symptoms composite
      
      # Completer
    #  0.59, # 9 months Cognition composite
    #  0.07, # 9 months Social adjustment composite
    #  0.12, # 9 months Symptoms composite
      
   #   0.45, # 18 months Cognition composite
      0.51, # 18 months Social adjustment composite
      0.18  # 18 months Symptoms composite
      
    )
  ) |> 
  rowwise() |> 
  mutate(
    study = "Wojtalik et al. 2020",
    N_total = N_t + N_c,
    df_ind = N_total,
    
    
    # m_post og sd_pool skal regnes efter
    
    m_post = if_else(analysis == "ITT",
                     
                     # ((T_post1-T_pre0) - (C_post1 - C_pre0)) / SD_basline 
                     
                                                                      # This is done to get the combined SD
                     (me_post_t - me_pre_t - me_post_c + me_pre_c) / sqrt((N_t * sd_pre_t^2 + N_c * sd_pre_c^2) / (N_t + N_c)),
                     
                     (me_post_t - me_pre_t - me_post_c + me_pre_c) / sd_pre_c
    ),
                      # E.14 (WWC Handbook 5, p. 168)
    sd_pool = if_else(analysis == "ITT",
                      #ITT                                  # To get the combined SD           
                      sqrt((N_total - 1) / (N_total - 2) * (N_t * sd_pre_t^2 + N_c * sd_pre_c^2) / (N_t + N_c) - (N_t * N_c) / (N_total * (N_total - 2)) * (me_pre_t - me_pre_c)^2),
                      # Completers
                      sqrt((N_total - 1) / (N_total - 2) * sd_pre_c^2 - (N_t * N_c) / (N_total * (N_total - 2)) * (me_pre_t - me_pre_c)^2)
      ),
    
    
    
    d_post = m_post/sd_pool, 
    vd_post = (1/N_t + 1/N_c) + d_post^2/(2*df_ind),
    Wd_post = (1/N_t + 1/N_c),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_post = J * d_post,
    vg_post = (1/N_t + 1/N_c) + g_post^2/(2*df_ind),
    Wg_post = Wd_post,
    
    vary_id = paste0(outcome, "/", analysis)
  )|> 
  ungroup ()
```

### **Wuthrich & Rapee [-@Wuthrich2013] and Smith et al. [-@Smith2021] (Change var names)**
#### (Accounts for clustering via the use of mixed-effects models/multi-level models)

Entering data from Table 2 (p. 445). Sample size information is retrieved from Table 1 (p. 442). 

```{r Wuthrich20132021dat}
# Calculate paired t-test statistics to obtain pre-posttest score correlation estimates

#-----------------------------------------------------------------
# OUTCOME ANCRONYMS AND FULL NAMES
#-----------------------------------------------------------------
# GDS = Geriatric Depression Scale
# CES-D = The Centre for Epidemiological Studies Depression Scale (loneliness only item used)
# GAI = Geriatric Anxiety Inventory
# PSWQ = The Penn State Worry Questionnaire
# SF12 = The Short Form 12 version 1 Mental Health Subscale
#-----------------------------------------------------------------


# F-stats from the interaction between time and group for mean
# It was uncertain whether we could use these estimates. Therefore, we didn't use
# the reported F-statistics. 
F_stat_Wuthrich <- 
  tibble(
    
    year = c(13, 21, 21, 13, 21, 13, 13, 13),
    
    outcome = c(
      "Primary problem", 
      "Anxiety", 
      "Depression", 
      "GDS", 
      "Loneliness (CES-D 14)", 
      "GAI", 
      "PSWQ", 
      "SF12"),
    
    df1 = 1,
    df2 = c(
      
      47.95,  # Primary problem severity (2013, p. 783)
      49.603, # Anxiety disorder severity (2021, p. 444)
      45.451, # Depressive disorder severity [Mood] (2021, p. 444)
      50.88,  # GDS (2013, p. 783)
      40.609, # Loneliness (2021, p. 444)
      55.65,  # GAI (2013, p. 783)
      54.95,  # PSWQ (2013, p. 783)
      51.39   # SF15 (2013, p. 783)
      
      ),
    F_val = c(
      
      17.36, 
      17.858,
      30.884,
      8.86,
      7.070,
      7.4,
      0.57,
      qf(.988, df1 = 1, df2 = df2[8], lower.tail = FALSE)
      
    ),
    
    pval_reported = c(
      
      pf(F_val[1], df1 = 1, df2 = df2[1], lower.tail = FALSE),
      pf(F_val[2], df1 = 1, df2 = df2[2], lower.tail = FALSE),
      pf(F_val[3], df1 = 1, df2 = df2[3], lower.tail = FALSE),
      .004,
      .011,
      .009,
      .452,
      .988
      
    )
  
)

F_stat_Wuthrich

## emm = estimated marginal means

Wuthrich2013_2021_smd <- 
  tibble(
    
    outcome = rep(
      c("Primary problem", 
        "Anxiety", 
        "Depression", 
        "GDS", 
        "Loneliness (CES-D 14)",
        "GAI",
        "PSWQ",
        "SF12"
        ), 
      each = 2),
    
    group = rep(c("CBT", "Waitlist"), n_distinct(outcome)),
    
    N_start = rep(c(27, 35), n_distinct(outcome)), # From Table 2, 2013, p. 783
    
    N = rep(c(27, 35), n_distinct(outcome)), # From Table 2, 2013, p. 783
    
    emm_pre = c(
      
      6.33, 5.81,    # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      5.2, 4.58,     # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      5.48, 4.98,    # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      18.14, 16.35,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      1.59, 1.36,    # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      11.59, 9.48,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      53.62, 49.27,  # Penn State Worry Questionnaire (from Table 3, 2013, p. 784) 
      37.09, 38.45   # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    emm_post = c(
      
      3.46, 5.15,   # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      2.68, 4.01,   # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      2.02, 4.25,   # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      9.21, 14.38,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      .593, 1.24,   # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      5.84, 8.33,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      46.54, 47.24, # Penn State Worry Questionnaire (from Table 3, 2013, p. 784)
      47.79, 43.56  # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    sd_pre = c(
      
      0.653, 1.16,  # ADIS primary disorder severity (from Table 2, 2013, p. 783)
      0.74, 1.07,   # ADIS mean anxiety disorder severity (from Table 1, 2021, p. 442)
      1.05, 1.27,   # ADIS depressive disorder severity (from Table 1, 2021, p. 442)
      6.18, 5.99,   # Geriatric Depression Scale (from Table 2, 2013, p. 783)
      0.82, 0.97,   # Loneliness (CES-D item 14)  (from Table 1, 2021, p. 442)
      4.72, 5.43,   # Geriatric Anxiety Inventory (from Table 2, 2013, p. 783)
      12.39, 13.06, # Penn State Worry Questionnaire (from Table 2, 2013, p. 783)
      9.22, 6.69    # Short Form-12 (Mental) (from Table 2, 2013, p. 783)
      
    ),
    
    # Number of controlled covariates
    q = rep(c(2, 4, 4, 2, 4, rep(2, 3)), each = 2)
    
  )

Wuthrich2013_2021_smd

Wuthrich2013_2021_wide <- 
  Wuthrich2013_2021_smd |>
  select(-q) |> 
  mutate(group = case_match(group, "CBT" ~ "t", "Waitlist" ~ "c")) |> 
  pivot_wider(
    names_from = group,
    values_from = N_start:sd_pre
  )

#Wuthrich2013_2021_wide
```

Calculating effect sizes and conducting a small number of clusters correction, as suggested by WWC [-@WWC_clusterbias].

```{r Wuthrich20132021SMDcalc}

Wuthrich2013_2021_es_smd <- 
  Wuthrich2013_2021_smd |> 
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled pretest SD",
    
    study = "Wuthrich et al.",
    es_calc_method = "DiD emmeans",
    
    ppcor = NA,  
    ppcor_calc_method = "Not relevant",
    
    R2 = R2_imp,
    R2_calc_method = "Imputed",
    
    N_t = N[1],
    N_c = N[2],
    N_total = sum(N),
    
    df_ind = N_total,
    
    n_covariates = q[1],
    
    b_adj_emm = emm_post[1] - emm_post[2],
    
    # Reverting outcomes so all outcomes has the same direction
    b_adj_emm = if_else(unique(outcome) != "SF12", b_adj_emm * -1, b_adj_emm),
    
    dif_t_emm = emm_post[1] - emm_pre[1],
    dif_c_emm = emm_post[2] - emm_pre[2],
    
    
    DD_emm = dif_t_emm - dif_c_emm,
    # Reverting outcomes so all outcomes has the same direction
    DD_emm = if_else(unique(outcome) != "SF12", DD_emm * -1, DD_emm),
    sd_pool = sqrt(sum((N - 1) * sd_pre^2) / (N_total-2)),
    
    d = DD_emm/sd_pool,
    vd = sum(1/N) + d^2/(2*df_ind),
    Wd = sum(1/N),
    
    d_alt = b_adj_emm/sd_pool,
    vd_alt = sum(1/N) + d_alt^2/(2*df_ind),
    Wd_alt = sum(1/N),
    
    J = 1 - 3/(4*df_ind-1),
    
    g = J * d,
    vg = sum(1/N) + g^2/(2*df_ind),
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = sum(1/N) + g_alt^2/(2*df_ind),
    Wg_alt = sum(1/N),
    
    .by = outcome
    
  ) |> 
  mutate(
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_total, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates
      ),
    
    gt_icc005 = g * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_icc005, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc005",
      vars = vgt_icc005:Wgt_icc005
      ),
    
    gt_icc02 = g * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_icc02, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc02",
      vars = vgt_icc02:Wgt_icc02
      ),
    
    gt_alt = g_alt * gamma_sqrt,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_alt, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
      ), 
    
    gt_alt_type = "Posttest emmeans",
    
    .by = outcome
    
  )

# Wuthrich2013_2021_es_smd

Wuthrich2013_2021_smd_est <- 
  left_join(Wuthrich2013_2021_wide, Wuthrich2013_2021_es_smd) |> 
  relocate(study, .before = outcome)

Wuthrich2013_2021_smd_est

#rm(Wuthrich2013_2021_wide, Wuthrich2013_2021_es_smd)

```

Calculating odds ratio effect sizes from Recovery rates reported in @Wuthrich2013[p.784]

```{r Wuthrich20132021ORcalc}

# Odd ratio based on recovery rates reported in Wuthrich 2013 (p. 784)

Wuthrich2013_OR_dat <- 
  tibble(
    study = "Wuthrich et al.",
    outcome = "Recovery rates",
    effect_size = "OR",
    es_calc_method = "Proportions",
    
    N_start_t = 27,
    N_start_c = 35,
    
    N_t = 20,
    N_c = 26,
    p_t = 0.53, 
    p_c = 0.11,
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # OR calculation and cluster bias adjustment
    VIVECampbell::OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = icc, avg_cl_size = avg_cl_size, n_cluster_arms = 1
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.05
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_005, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc005", vars = DE_icc005:vln_OR_C_icc005
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.2
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_02, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc02", vars = DE_icc02:vln_OR_C_icc02
    )
    
    
  )

Wuthrich2013_OR_dat


# Amalgamating the SMD and OR results
Wuthrich2013_2021_est <- 
  bind_rows(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat) |> 
  mutate(
    vary_id = outcome,
    analysis_plan = case_when(
      
           outcome == "Primary problem"  ~  "the Anxiety Disorders Interview Schedule for DSM-IV (ADIS- IV)", 
           outcome == "Anxiety"  ~ "the Anxiety Disorders Interview Schedule for DSM-IV (ADIS- IV)", 
           outcome == "Depression"  ~ "Geriatric Depression Scale (GDS)", 
           outcome == "GDS"  ~ "Geriatric Depression Scale (GDS)", 
           outcome == "Loneliness (CES-D 14)"  ~ "The Center for Epidemiologic Studies-Depression Scale",
           outcome == "GAI" ~ "The Geriatric Anxiety Inventory (GAI)",
           outcome == "PSWQ" ~ "The Penn State Worry Questionnaire (PSWQ)",
           outcome == "SF12" ~ "Short Form-12",
           outcome == "Recovery rates" ~ "???" # Couldn't figure this one out (Jakob)
         )
  )


Wuthrich2013_2021_est

#rm(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat)


```


## Amalgamation of data

Amalgamating effect size data

```{r, include=FALSE, eval=FALSE}

#select_across_df <- function(dataframes = list(), list_labels){
#  
#  map_dfr(dataframes, ~ select(., !!!list_labels))
#  
#}
#
## Extend variables
#var_label <- c(
#  "study", "es_method", "ppcor", "ppcor_type", "Nt", "Nc", "N_tot",
#  "df_ind", "d",  "vd", "Wd", "g", "vg", "Wg", # Continue here more variables are needed
#  "vary_id"
#)
#
#es_dat <- 
#  select_across_df(
#    list(
#      Timmermans2012_est
#    ),
#    
#    var_label
#
#); es_dat



```

Amalgating covariates and effect size data
```{r dataamalgamation, eval=FALSE}
# REMEMBER TO REMOVE EMPOWERMENT OUTCOME FROM BARBIC2009

#Remember to see working directory to "Group-based-interventions/ES calc"

 covariates <- read_xlsx(
  "ES calc/Descriptive coding scheme for group-based interventions (data).xlsx",
  na = c(".", "")
 )



# Integrate the timing variable across datasets, it's necessary to convert  the timing 
# column in the Crawford2012 dataset to a character type, aligning it with the 
# corresponding column in other datasets
Crawford2012_est <- Crawford2012_est |> 
  mutate(timing = as.character(timing))

group_based_dat_es <- 
  bind_rows(
    Timmermans2012_est,
    Wuthrich2013_2021_est,
    Acarturk2022_est,
    Barbic2009_est,
    Bond2015_est,
    Cano_vindel2021_est,
    Craigie2009_est,
    Crawford2012_est,
    Druss2010_est,
    Druss2018_est,
    Dyck2000_est,
    Gatz2007_est,
    Gordon2018_est,
    Hagen2005_est,
    izquierdo2021_est,
    Lim2020_est,
    lloyd_Evans2020_est,
    Morley2014_est,
    Morton2012_est, 
    Patterson2003_est,
    Popolo2019_est,
    Rabenstein2015_est,
    Rosenblum2014_est,
    Rüsch2019_est, 
    Sacks2011_est,
    Sajatovic2009_est,
    Schrank2016_est,
    Valiente2022_est,
    Volpe2015_est,
    Wojtalik2019_est
    
  ) |> 
  relocate(sd_pool, .after = sd_used) 

group_based_dat <- 
  bind_cols(
    covariates,
    group_based_dat_es

)

write_xlsx(group_based_dat, "Group-based interventions data.xlsx")
save(group_based_dat, file = "Group-based interventions data.RData")

#clubSandwich::impute_covariance_matrix(
#  vi = group_based_dat$vgt,
#  cluster = group_based_dat$studyid,
#  r = c(.7, 0.1),
#  smooth_vi = TRUE
#)

```

```{r, eval=FALSE, include=FALSE}

test_dat <- covariates |> 
  filter(str_detect(authors, "Gordon")) |> 
  bind_cols(Gordon_2018_est)

select(test_dat, varifier, vary_id)

```



## **References**




























