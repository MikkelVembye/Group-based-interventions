---
title: Effect size calculation for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness'
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: show
    code_download: true
bibliography: Group-based interventions.bib
link-citations: yes
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```

### Introduction 

### R package used for effect size calculation

```{r}
#devtools::install_github("MikkelVembye/VIVECampbell")

library(tidyverse)
library(readxl)
library(writexl)
library(purrr)
library(VIVECampbell)

```

### ICC values used for cluster adjustment

```{r}
ICC_005 <- 0.05
ICC_01 <- 0.1
ICC_02 <- 0.2

ppcor_imp <- 0.5
R2_imp <- 0

```


### Function building to conduct cluster design adjustment

We use Hedges & Citkowicz [-@Hedges2015_onetreatcluster] to cluster bias correct effect size variance estimates in study where clustering is not treated properly since we in many cases only will experience clustering in the treatment group. It might happen that clustering should be handled in the Cochrane and Hedges 2007. 

```{r}

# Equation (7) in Hedges & Citkowicz (2015)
df_h <- function(total_sample_size, ICC, trt_sample_size, avg_grp_size){
  
  N <- total_sample_size
  rho <- ICC
  NT <- trt_sample_size
  n <- avg_grp_size
  
  h <- ((N-2)*(1-rho) + (NT-n)*rho)^2 /
       ((N-2)*(1-rho)^2 + (NT-n)*n*rho^2 + 2*(NT-2)*(1-rho)*rho)
  
  h
}

# Test
#df_h(
#  total_sample_size = 100,
#  ICC = 0.2,
#  trt_sample_size = 80,
#  avg_grp_size = 5
#)

```


## **Studies in meta-analysis**

### **Gestel-Timmermans et al. [-@VanGestel-Timmermans2012]**
#### (Multi-level analysis to handle clustering)

Data is retrieved from Tables 2 & 3 (p. 58) 

```{r}
# Testing missing 

Timmermans_sample_size_dat <-
  tibble(
    
    measure = rep(c("Empoverment", "Hope", "Quality", "Self-e", "Loneliness"), each = 4),
    timing = rep(c("3 months", "6 months"), each = 2, 5),
    group = rep(c("Treatment", "Control"), 10),
    
    N_start = rep(rep(c(168, 165), 10)),
    
    N_actual = c(
      136, 117, 121, 99,
      132, 118, 120, 97,
      124, 114, 111, 97,
      134, 116, 121, 100,
      138, 122, 125, 102
    ),
    
    #non_missing = N_actual/N_start,
    #
    #percent_missing = (1 - non_missing) * 100
    
); Timmermans_sample_size_dat
```

Missingness analysis

```{r}
Timmermans_missingness <- 
  Timmermans_sample_size_dat |> 
  group_by(measure, timing) |> 
  summarise(
    N_start_total = sum(N_start),
    N_actual_total = sum(N_actual),
    
    #percent_missing_total = round(mean(percent_missing)),
    
    percent_missing_total = round((1 - (N_actual_total/N_start_total)) * 100),
    
    .groups = "drop"
  )

Timmermans_missingness 
```

Data entrance 
```{r}

Timmermans2012 <- 
  Timmermans_sample_size_dat |> 
  rename(N =  N_actual) |> 
  mutate(
    
    #From Table 2 (p. 58)
    m_post = c(
      
      3.55, 3.38, 3.59, 3.40,
      2.91, 2.79, 2.97, 2.73,
      4.49, 4.36, 4.63, 4.39,
      4.65, 4.35, 4.71, 4.4,
      5.89, 6.27, 3.87, 3.68
      
    ),
    
    sd_post = c(
      
      0.48, 0.53, 0.50, 0.56,
      0.47, 0.53, 0.46, 0.48,
      0.96, 1.07, 0.97, 1.05,
      0.81, 0.97, 0.93, 0.88,
      3.61, 3.55, 3.87, 3.68
      
    ),
    
    es_paper = rep(
      c(
        0.27, 0.36, 
        0.25, 0.48,
        0.03, 0.15,
        0.27, 0.23, 
        -0.04, 0.15
      ),
      each = 2
    ),
    
    # From Table 3 (p. 58)
    
    b_adj = c(
      .12, .021, .13, .046,   #Empowerment
      .10, .038, .17, .004,   #Hope
      .064, .11, .11, .15,    #Quality of life
      .23, .064, .21, .14,    #Self-efficacy beliefs
      .066, -.65, -.34, -.49  # Loneliness
      
    ),
    
    pval = c(
      .016, .55, .012, .24,  #Empowerment
      .039, .28, .001, .91,  #Hope
      .471, .09, .24, .025,  #Quality of life
      .010, .31, .026, .042, #Self-efficacy beliefs
      .85, .008, .35, .07    #Loneliness
      
      ),
    
    ci_l = c(
      .022, -.05, .026, -.025,
      NA, -.030, .026, -.025,
      -.11, -.016, -.071, 0.020,
      .059, -.062, .027, .006,
      -.60, -1.14, -1.05, -1.02
    ),
    
    ci_u = c(
      .22, .092, .23, .12,
      NA, .11, .23, .12, 
      .23, .24, .29, .28,
      .40, .19, .39, .27,
      .74, -.16, .37, .042
    ),
    
    tval = qt(pval/2, df = N-2, lower.tail = FALSE),
    se_b = b_adj/tval
    
  ); Timmermans2012 


```

Effect sizes calculation

```{r}

Timmermans2012_est <- 
  Timmermans2012 |> 
  group_by(measure, timing) |> 
  summarise(
    
    study = "Timmermans2012",
    es_calc_method = "Posttest",
    
    ppcor = NA,  
    ppcor_calc_method = "Not relevant",
    
    Nt = N[1],
    Nc = N[2],
    
    N_tot = Nt + Nc, 
    
    df_ind = N_tot,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_tot-2) ),
    
    diff_raw = m_post[1] - m_post[2],
    
    d_paper = es_paper[1],
    d = diff_raw/sd_pool,
    vd = sum(N)/prod(N) + d^2/(2*df_ind),
    Wd = sum(N)/prod(N),
    
    cov_ds = "Not obtainable",
    
    DD = b_adj[1] - b_adj[2],
    
    d_adj = DD/sd_pool,
    vd_adj = sum((se_b/sd_pool)^2) + d^2/(2*df_ind),
    Wd_adj = sum((se_b/sd_pool)^2),
    
    J = 1 - 3/(4*df_ind-1),
    
    g = J * d,
    vg = J^2 * vd,
    Wg = J^2 * Wd,
    
    g_adj = J * d_adj,
    vg_adj = J^2 * vd_adj,
    Wg_adj = J^2 * Wd_adj, 
    
    .groups = "drop"
    
    
  ) |> 
  rowwise() |> 
  # Cluster bias correction
  mutate(
  
    
    n_group = 7, 
    icc = ICC_01,
    icc_type = "Imputed",
    
    gamma = 1 - (Nc + n_group-2)*ICC_01 / (N_tot-2), # Change when discussed
    df_h = df_h(total_sample_size = N_tot, ICC = ICC_01, avg_grp_size = n_group, trt_sample_size = Nt),
    eta = 1 + ( (n_group*Nc/N_tot)-1 ) * ICC_01,
    
    gt = g * sqrt(gamma),
    vgt = Wg * eta + gt^2/(2*df_h),
    Wgt = Wg * eta,
    
    gt_alt = g_adj * sqrt(gamma),
    vgt_alt = Wg_adj * gamma + gt_alt^2/(2*df_h),
    Wgt_alt = Wg_adj * gamma,
    
    vary_id = paste0(measure, "/", timing)
    
    
  ) |> 
  ungroup(); Timmermans2012_est



```


### **Wuthrich & Rapee [-@Wuthrich2013] and Smith et al. [-@Smith2021]**
#### (Accounts for clustering via the use of mixed-effects models/multi-level models)


Entering data from Table 2 (p. 445). Sample size information is retrieved from Table 1 (p. 442). 

```{r Wuthrich20132021dat}
# Calculate paired t-test statistics to obtain pre-posttest score correlation estimates

#-----------------------------------------------------------------
# OUTCOME ANCRONYMS AND FULL NAMES
#-----------------------------------------------------------------
# GDS = Geriatric Depression Scale
# CES-D = The Centre for Epidemiological Studies Depression Scale (loneliness only item used)
# GAI = Geriatric Anxiety Inventory
# PSWQ = The Penn State Worry Questionnaire
# SF12 = The Short Form 12 version 1 Mental Health Subscale
#-----------------------------------------------------------------


# F-stats from the interaction between time and group for mean
# It was uncertain whether we could use these estimates. Therefore, we didn't use
# the reported F-statistics. 
F_stat_Wuthrich <- 
  tibble(
    
    year = c(13, 21, 21, 13, 21, 13, 13, 13),
    
    outcome = c(
      "Primary problem", 
      "Anxiety", 
      "Depression", 
      "GDS", 
      "Loneliness (CES-D 14)", 
      "GAI", 
      "PSWQ", 
      "SF12"),
    
    df1 = 1,
    df2 = c(
      
      47.95,  # Primary problem severity (2013, p. 783)
      49.603, # Anxiety disorder severity (2021, p. 444)
      45.451, # Depressive disorder severity [Mood] (2021, p. 444)
      50.88,  # GDS (2013, p. 783)
      40.609, # Loneliness (2021, p. 444)
      55.65,  # GAI (2013, p. 783)
      54.95,  # PSWQ (2013, p. 783)
      51.39   # SF15 (2013, p. 783)
      
      ),
    F_val = c(
      
      17.36, 
      17.858,
      30.884,
      8.86,
      7.070,
      7.4,
      0.57,
      qf(.988, df1 = 1, df2 = df2[8], lower.tail = FALSE)
      
    ),
    
    pval_reported = c(
      
      pf(F_val[1], df1 = 1, df2 = df2[1], lower.tail = FALSE),
      pf(F_val[2], df1 = 1, df2 = df2[2], lower.tail = FALSE),
      pf(F_val[3], df1 = 1, df2 = df2[3], lower.tail = FALSE),
      .004,
      .011,
      .009,
      .452,
      .988
      
    )
  
)

F_stat_Wuthrich

## emm = estimated marginal means

Wuthrich2013_2021_smd <- 
  tibble(
    
    outcome = rep(
      c("Primary problem", 
        "Anxiety", 
        "Depression", 
        "GDS", 
        "Loneliness (CES-D 14)",
        "GAI",
        "PSWQ",
        "SF12"
        ), 
      each = 2),
    
    group = rep(c("CBT", "Waitlist"), n_distinct(outcome)),
    
    N = rep(c(27, 35), n_distinct(outcome)), # From Table 2, 2013, p. 783
    
    emm_pre = c(
      
      6.33, 5.81,    # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      5.2, 4.58,     # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      5.48, 4.98,    # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      18.14, 16.35,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      1.59, 1.36,    # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      11.59, 9.48,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      53.62, 49.27,  # Penn State Worry Questionnaire (from Table 3, 2013, p. 784) 
      37.09, 38.45   # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    emm_post = c(
      
      3.46, 5.15,   # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      2.68, 4.01,   # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      2.02, 4.25,   # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      9.21, 14.38,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      .593, 1.24,   # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      5.84, 8.33,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      46.54, 47.24, # Penn State Worry Questionnaire (from Table 3, 2013, p. 784)
      47.79, 43.56  # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    sd_pre = c(
      
      0.653, 1.16,  # ADIS primary disorder severity (from Table 2, 2013, p. 783)
      0.74, 1.07,   # ADIS mean anxiety disorder severity (from Table 1, 2021, p. 442)
      1.05, 1.27,   # ADIS depressive disorder severity (from Table 1, 2021, p. 442)
      6.18, 5.99,   # Geriatric Depression Scale (from Table 2, 2013, p. 783)
      0.82, 0.97,   # Loneliness (CES-D item 14)  (from Table 1, 2021, p. 442)
      4.72, 5.43,   # Geriatric Anxiety Inventory (from Table 2, 2013, p. 783)
      12.39, 13.06, # Penn State Worry Questionnaire (from Table 2, 2013, p. 783)
      9.22, 6.69    # Short Form-12 (Mental) (from Table 2, 2013, p. 783)
      
    ),
    
    # Number of controlled covariates
    q = rep(c(2, 4, 4, 2, 4, rep(2, 3)), each = 2)
    
  )

Wuthrich2013_2021_smd

Wuthrich2013_2021_long <- 
  Wuthrich2013_2021_smd |>
  select(-q) |> 
  mutate(group = case_match(group, "CBT" ~ "t", "Waitlist" ~ "c")) |> 
  pivot_wider(
    names_from = group,
    values_from = N:sd_pre
  )

#Wuthrich2013_2021_long
```

Calculating effect sizes and conducting a small number of clusters correction, as suggested by WWC [-@WWC_clusterbias].

```{r Wuthrich20132021SMDcalc}
Wuthrich2013_2021_es_smd <- 
  Wuthrich2013_2021_smd |> 
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled pretest SD",
    
    study = "Wuthrich et al.",
    es_calc_method = "emmeans",
    
    ppcor = NA,  
    ppcor_calc_method = "Not relevant",
    
    R2 = R2_imp,
    R2_calc_method = "Imputed",
    
    N_t = N[1],
    N_c = N[2],
    N_tot = sum(N),
    n_covariates = q[1],
    
    b = emm_post[1] - emm_post[2],
    # Reverting outcomes so all outcomes has the same direction
    b = if_else(unique(outcome) != "SF12", b * -1, b),
    
    dif_t = emm_post[1] - emm_pre[1],
    dif_c = emm_post[2] - emm_pre[2],
    
    
    DD = dif_t - dif_c,
    # Reverting outcomes so all outcomes has the same direction
    DD = if_else(unique(outcome) != "SF12", DD * -1, DD),
    s_pool = sqrt(sum((N - 1) * sd_pre^2) / (N_tot-2)),
    
    d_posttest = b/s_pool,
    d = DD/s_pool,
    
    .by = outcome
    
  ) |> 
  mutate(
    
    vd = (1/N_t + 1/N_c) + d^2/(2*N_tot),
    Wd = 1/N_t + 1/N_c,
    
    J = 1 - 3/(4*N_tot-1),
    
    g = J * d,
    vg = vd,
    Wg = Wd,
    
    g_posttest = J * d_posttest,
    vg_posttest = (1/N_t + 1/N_c) + d_posttest^2/(2*N_tot),
    Wg_posttest = 1/N_t + 1/N_c,
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc),
    gamma_sqrt_005 = gamma_1armcluster(N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005),
    gamma_sqrt_02 = gamma_1armcluster(N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt, 
      model = es_calc_method,
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates
      ),
    
    gt_icc005 = g * gamma_sqrt_005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_icc005, 
      model = es_calc_method,
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc005",
      vars = vgt_icc005:Wgt_icc005
      ),
    
    gt_icc02 = g * gamma_sqrt_02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_icc02, 
      model = es_calc_method,
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc02",
      vars = vgt_icc02:Wgt_icc02
      ),
    
    gt_alt = gt,
    vgt_alt = vgt,
    Wgt_alt = Wgt,
    
    gt_posttest = g_posttest * gamma_sqrt,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_posttest, 
      model = es_calc_method,
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_posttest",
      vars = vgt_posttest:Wgt_posttest
      ), 
    
    .by = outcome
    
  )

# Wuthrich2013_2021_es_smd

Wuthrich2013_2021_smd_est <- 
  left_join(Wuthrich2013_2021_long, Wuthrich2013_2021_es_smd) |> 
  relocate(study, .before = outcome)

Wuthrich2013_2021_smd_est

rm(Wuthrich2013_2021_long, Wuthrich2013_2021_es_smd)

```

Calculating odds ratio effect sizes from Recovery rates reported in @Wuthrich2013[p.784]

```{r Wuthrich20132021ORcalc}

# Odd ratio based on recovery rates reported in Wuthrich 2013 (p. 784)

Wuthrich2013_OR_dat <- 
  tibble(
    study = "Wuthrich et al.",
    outcome = "Recovery rates",
    effect_size = "OR",
    es_calc_method = "Proportions",
    
    N_t = 20,
    N_c = 26,
    p_t = 0.53, 
    p_c = 0.11,
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # OR calculation and cluster bias adjustment
    VIVECampbell::OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = icc, avg_cl_size = avg_cl_size, n_cluster_arms = 1
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.05
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_005, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc005", vars = DE_icc005:vln_OR_C_icc005
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.2
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_02, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc02", vars = DE_icc02:vln_OR_C_icc02
    )
    
    
  )

Wuthrich2013_OR_dat


# Amalgamating the SMD and OR results
Wuthrich2013_2021_est <- 
  bind_rows(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat)

Wuthrich2013_2021_est

rm(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat)


```


## Amalgamation of data

Amalgamating effect size data

```{r, include=FALSE, eval=FALSE}

#select_across_df <- function(dataframes = list(), list_labels){
#  
#  map_dfr(dataframes, ~ select(., !!!list_labels))
#  
#}
#
## Extend variables
#var_label <- c(
#  "study", "es_method", "ppcor", "ppcor_type", "Nt", "Nc", "N_tot",
#  "df_ind", "d",  "vd", "Wd", "g", "vg", "Wg", # Continue here more variables are needed
#  "vary_id"
#)
#
#es_dat <- 
#  select_across_df(
#    list(
#      Timmermans2012_est
#    ),
#    
#    var_label
#
#); es_dat



```

Amalgating covariates and effect size data
```{r, include=FALSE, eval=FALSE}
#Remember to see working directory to "Group-based-interventions/ES calc"

covariates <- read_xlsx(
  "ES calc/Descriptive coding scheme for group-based interventions (data) MHV 2.xlsx",
  na = c(".", "")
)

group_based_dat <- 
  bind_cols(
    covariates,
    Wuthrich2013_2021_est

); glimpse(group_based_dat)

#write_xlsx(group_based_dat, "ES calc/Group-based interventions data.xlsx")

#save(group_based_dat, file = "ES calc/Group-based interventions data.RData")

```


## **Reference**




























