---
title: Effect size calculation for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness'
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: show
    code_download: true
bibliography: Group-based interventions.bib
biblio-style: apa
link-citations: yes
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```

### Introduction 

### R package used for effect size calculation

```{r}
#devtools::install_github("MikkelVembye/VIVECampbell")

library(tidyverse)
library(readxl)
library(purrr)
library(VIVECampbell)

```

### ICC values used for cluster adjustment

```{r}
ICC_01 <- 0.1
```


### Function building to conduct cluster design adjustment

We use Hedges & Citkowicz [-@Hedges2015_onetreatcluster] to cluster bias correct effect size variance estimates in study where clustering is not treated properly since we in many cases only will experience clustering in the treatment group. It might happen that clustering should be handled in the Cochrane and Hedges 2007. 

```{r}

# Equation (7) in Hedges & Citkowicz (2015)
df_h <- function(total_sample_size, ICC, trt_sample_size, avg_grp_size){
  
  N <- total_sample_size
  rho <- ICC
  NT <- trt_sample_size
  n <- avg_grp_size
  
  h <- ((N-2)*(1-rho) + (NT-n)*rho)^2 /
       ((N-2)*(1-rho)^2 + (NT-n)*n*rho^2 + 2*(NT-2)*(1-rho)*rho)
  
  h
}

# Test
#df_h(
#  total_sample_size = 100,
#  ICC = 0.2,
#  trt_sample_size = 80,
#  avg_grp_size = 5
#)

```


## **Studies in meta-analysis**

### **Gestel-Timmermans et al. [-@VanGestel-Timmermans2012]**
#### (Multi-level analysis to handle clustering)

Data is retrieved from Tables 2 & 3 (p. 58) 

```{r}
# Testing missing 

Timmermans_sample_size_dat <-
  tibble(
    
    measure = rep(c("Empoverment", "Hope", "Quality", "Self-e", "Loneliness"), each = 4),
    timing = rep(c("3 months", "6 months"), each = 2, 5),
    group = rep(c("Treatment", "Control"), 10),
    
    N_start = rep(rep(c(168, 165), 10)),
    
    N_actual = c(
      136, 117, 121, 99,
      132, 118, 120, 97,
      124, 114, 111, 97,
      134, 116, 121, 100,
      138, 122, 125, 102
    ),
    
    #non_missing = N_actual/N_start,
    #
    #percent_missing = (1 - non_missing) * 100
    
); Timmermans_sample_size_dat
```

Missingness analysis

```{r}
Timmermans_missingness <- 
  Timmermans_sample_size_dat |> 
  group_by(measure, timing) |> 
  summarise(
    N_start_total = sum(N_start),
    N_actual_total = sum(N_actual),
    
    #percent_missing_total = round(mean(percent_missing)),
    
    percent_missing_total = round((1 - (N_actual_total/N_start_total)) * 100),
    
    .groups = "drop"
  )

Timmermans_missingness 
```

Data entrance 
```{r}

Timmermans2012 <- 
  Timmermans_sample_size_dat |> 
  rename(N =  N_actual) |> 
  mutate(
    
    #From Table 2 (p. 58)
    m_post = c(
      
      3.55, 3.38, 3.59, 3.40,
      2.91, 2.79, 2.97, 2.73,
      4.49, 4.36, 4.63, 4.39,
      4.65, 4.35, 4.71, 4.4,
      5.89, 6.27, 3.87, 3.68
      
    ),
    
    sd_post = c(
      
      0.48, 0.53, 0.50, 0.56,
      0.47, 0.53, 0.46, 0.48,
      0.96, 1.07, 0.97, 1.05,
      0.81, 0.97, 0.93, 0.88,
      3.61, 3.55, 3.87, 3.68
      
    ),
    
    es_paper = rep(
      c(
        0.27, 0.36, 
        0.25, 0.48,
        0.03, 0.15,
        0.27, 0.23, 
        -0.04, 0.15
      ),
      each = 2
    ),
    
    # From Table 3 (p. 58)
    
    b_adj = c(
      .12, .021, .13, .046,   #Empowerment
      .10, .038, .17, .004,   #Hope
      .064, .11, .11, .15,    #Quality of life
      .23, .064, .21, .14,    #Self-efficacy beliefs
      .066, -.65, -.34, -.49  # Loneliness
      
    ),
    
    pval = c(
      .016, .55, .012, .24,  #Empowerment
      .039, .28, .001, .91,  #Hope
      .471, .09, .24, .025,  #Quality of life
      .010, .31, .026, .042, #Self-efficacy beliefs
      .85, .008, .35, .07    #Loneliness
      
      ),
    
    ci_l = c(
      .022, -.05, .026, -.025,
      NA, -.030, .026, -.025,
      -.11, -.016, -.071, 0.020,
      .059, -.062, .027, .006,
      -.60, -1.14, -1.05, -1.02
    ),
    
    ci_u = c(
      .22, .092, .23, .12,
      NA, .11, .23, .12, 
      .23, .24, .29, .28,
      .40, .19, .39, .27,
      .74, -.16, .37, .042
    ),
    
    tval = qt(pval/2, df = N-2, lower.tail = FALSE),
    se_b = b_adj/tval
    
  ); Timmermans2012 


```

Effect sizes calculation

```{r}

Timmermans2012_est <- 
  Timmermans2012 |> 
  group_by(measure, timing) |> 
  summarise(
    
    study = "Timmermans2012",
    es_calc_method = "Posttest",
    
    ppcor = NA,  
    ppcor_calc_method = "Not relevant",
    
    Nt = N[1],
    Nc = N[2],
    
    N_tot = Nt + Nc, 
    
    df_ind = N_tot,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_tot-2) ),
    
    diff_raw = m_post[1] - m_post[2],
    
    d_paper = es_paper[1],
    d = diff_raw/sd_pool,
    vd = sum(N)/prod(N) + d^2/(2*df_ind),
    Wd = sum(N)/prod(N),
    
    cov_ds = "Not obtainable",
    
    DD = b_adj[1] - b_adj[2],
    
    d_adj = DD/sd_pool,
    vd_adj = sum((se_b/sd_pool)^2) + d^2/(2*df_ind),
    Wd_adj = sum((se_b/sd_pool)^2),
    
    J = 1 - 3/(4*df_ind-1),
    
    g = J * d,
    vg = J^2 * vd,
    Wg = J^2 * Wd,
    
    g_adj = J * d_adj,
    vg_adj = J^2 * vd_adj,
    Wg_adj = J^2 * Wd_adj, 
    
    .groups = "drop"
    
    
  ) |> 
  rowwise() |> 
  # Cluster bias correction
  mutate(
  
    
    n_group = 7, 
    icc = ICC_01,
    icc_type = "Imputed",
    
    gamma = 1 - (Nc + n_group-2)*ICC_01 / (N_tot-2), # Change when discussed
    df_h = df_h(total_sample_size = N_tot, ICC = ICC_01, avg_grp_size = n_group, trt_sample_size = Nt),
    eta = 1 + ( (n_group*Nc/N_tot)-1 ) * ICC_01,
    
    gt = g * sqrt(gamma),
    vgt = Wg * eta + gt^2/(2*df_h),
    Wgt = Wg * eta,
    
    gt_alt = g_adj * sqrt(gamma),
    vgt_alt = Wg_adj * gamma + gt_alt^2/(2*df_h),
    Wgt_alt = Wg_adj * gamma,
    
    vary_id = paste0(measure, "/", timing)
    
    
  ) |> 
  ungroup(); Timmermans2012_est



```


### **Wuthrich & Rapee [-@Wuthrich2013] and Smith et al. [-@Smith2021]**

Entering data from Table 2 (p. 445). Sample size information is retrived from Table 1 (p. 442)

```{r Smith2021dat}

# Calculate paired t-test statistics to obtain pre-posttest score correlation estimates

## _rep = reported

Smith2021 <- 
  tibble(
  
  outcome = rep(c("Loneliness", "Anxiety", "Depressive"), each = 2),
  
  group = rep(c("CBT", "Waitlist"), 3),
  
  N = rep(c(27, 35), 3),
   
  m_pre = c(
    
    1.59, 1.36, # Loneliness
    5.20, 4.58, # Anxiety
    5.48, 4.98  # Depressive
    
  ),
  
  se_pre = c(
    
    0.209, 0.169,
    0.246, 0.200,
    0.272, 0.217
    
  ),
  
  sd_pre = se_pre * sqrt(N),
  
  m_post = c(
    
    0.593, 1.24,
    2.68, 4.01,
    2.02, 4.25
    
  ),
  
  se_post = c(
    
    0.169, 0.194,
    0.307, 0.227,
    0.319, 0.260
  
  ),
  
  sd_post = se_post * sqrt(N),
  
  d_rep = c(
    
    1.25, 0.11, 
    2.33, 0.45, 
    2.48, 0.52  
    
    ),
  
  ci_l_rep = c(
    
    0.62, -0.41,
    1.55, -0.07,
    1.70, -0.02
    
    ),
  
  ci_u_rep = c(
    
    1.88, 0.63,
    3.11, 0.97, 
    3.26, 1.06
    
    ),
      
  se_d_rep = (ci_u_rep - ci_l_rep) / 3.92,
  
  t_pair = d_rep/se_d_rep,
  
  # Using Eq. (31) from Wilson 2016
  r = ((sd_pre^2*t_pair^2 + sd_post^2*t_pair^2) - 
        (m_post-m_pre)^2 * N)/ (2 * sd_pre*sd_post*t_pair^2),
    
  z = 0.5 * log( (1+r)/(1-r)),
  v = 1/(N-3)
  
  
  ); Smith2021

Smith2021_long <- 
  Smith2021 |>
  mutate(group = case_match(group, "CBT" ~ "t", "Waitlist" ~ "c")) |> 
  pivot_wider(
    names_from = group,
    values_from = N:v
  )

```

Calculating effect sizes and correcting for cluster at the treatment level 

```{r}

## ppcor = pre-posttest correlation
## _calc_method = calculation method 

Smith2021_es <- 
  Smith2021 |> 
  summarise(
    
    study = "Smith et al. 2021",
    es_calc_method = "DiD",
    
    N_t = N[1],
    N_c = N[2],
    
    N_tot = sum(N),
    
    M = sum(v*z)/sum(v),
    ppcor = (exp(2*M)-1)/(exp(2*M)+1) * -1,
    ppcor_calc_method = "From study",
    
    df_ind = sum(N-1),
    
    dif_t = (m_post[1] - m_pre[1]),
    dif_c = (m_post[2] - m_pre[2]),
    
    DD = (dif_c - dif_t),
    s_pool = sqrt(sum((N - 1) * sd_post^2) / df_ind),

    d = DD/s_pool,
    vd = 2*(1-ppcor) * sum(1/N) + d^2/(2*df_ind),
    
    Wd = 2*(1-ppcor) * sum(1/N),
    
    J = 1 - 3/(4*df_ind-1),
    
    # Based on d calculated from the sd_post 
    g = J * d,
    vg = J^2 * vd,
    Wg = J^2 * Wd,
    
    # Cluster bias adjustment
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Average cluster size
    # Obtained from "6-8 group members" (Wuthrich & Rapee, 2013, p. 781)
    n_cluster = 7, 
    n_type = "From study (2013, p. 781)",
    
    
    .by = outcome
  
); Smith2021_es


Smith2021_est <- left_join(Smith2021_long, Smith2021_es)
Smith2021_est


```


## Amalgamation of data

Amalgamating effect size data

```{r, include=FALSE, eval=FALSE}

select_across_df <- function(dataframes = list(), list_labels){
  
  map_dfr(dataframes, ~ select(., !!!list_labels))
  
}

# Extend variables
var_label <- c(
  "study", "es_method", "ppcor", "ppcor_type", "Nt", "Nc", "N_tot",
  "df_ind", "d",  "vd", "Wd", "g", "vg", "Wg", # Continue here more variables are needed
  "vary_id"
)

es_dat <- 
  select_across_df(
    list(
      Timmermans2012_est
    ),
    
    var_label

); es_dat


```

Amalgating covariates and effect size data
```{r, include=FALSE, eval=FALSE}
#Remember to see working directory to "Group-based-interventions/ES calc"

covariates <- read_xlsx(
  "Descriptive coding scheme for group-based interventions (data).xlsx",
  na = c(".", "")
)

group_based_dat <- 
  bind_cols(
    covariates,
    es_dat

); glimpse(group_based_dat)

```


## **Reference**




























