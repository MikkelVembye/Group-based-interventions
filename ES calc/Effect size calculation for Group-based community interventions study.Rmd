---
title: Effect size calculation for 'Group-based community interventions to support
  the social reintegration of marginalised adults with mental illness'
date: "Last updated `r format(Sys.time(), '%Y.%m.%d')`"
output: 
  html_document:
    toc: true
    code_folding: show
    code_download: true
bibliography: Group-based interventions.bib
link-citations: yes
fontsize: 11pt
spacing: single
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

options(pillar.sigfig = 4) # ensure tibble include 4 digits
options(tibble.width = Inf)
options(dplyr.print_min = 310)
options(scipen = 10)
options(dplyr.summarise.inform = FALSE) # Avoids summarize info from tidyverse

```

### Introduction 

### R package used for effect size calculation

```{r}
#devtools::install_github("MikkelVembye/VIVECampbell")

library(tidyverse)
library(readxl)
library(writexl)
library(purrr)
library(VIVECampbell)

```

### ICC values used for cluster adjustment

```{r}
ICC_005 <- 0.05
ICC_01 <- 0.1
ICC_02 <- 0.2

ppcor_imp <- 0.5
R2_imp <- 0

```


## **Studies in meta-analysis**

### **Acarturk et al [-@Acarturk2022]**
#### (Multi-level analysis and reported raw means, at baseline, post, and followup times)

To calculate pretest-adjusted effect sizes, we first estimate pre-post and pre-followup correlations from 
the reported results in "Treatment effect" section (p. 7)

```{r Acarturk_ppcor}

# _fu = followup

Acarturk_text_res <- 
  tibble(
    
    outcome = rep(c("HSCL-25", "PCL-5", "PSYCHLOPS"), each = 2),
    
    timing = rep(c("Posttest", "Followup"), 3),
    
    N = rep(c(41, 44, 19), c(2, 2, 2)), # Obtained from df(t)/2
    
    m_pre = rep(c(2.34, 1.77, 4.06), each = 2),
    sd_pre = rep(c(0.60, 0.86, 0.76), each = 2),
    
    m_post = c(
      2.15, 2.11, # HSCL-25
      1.43, 1.19, # PCL-5
      3.82, 3.45  # PSYCHLOPS
      
      ),
    
    sd_post = c(
      0.60, 0.59,
      0.79, 0.78,
      0.86, 1.32
      ),
    
    
    paired_t = c(
      2.43, 2.83,
      2.61, 4.45,
      1.01, 2.57
      )
    
  ) |> 
  mutate(
    
    ppcor = ((sd_pre^2*paired_t^2 + sd_post^2*paired_t^2) - (m_post - m_pre)^2 * N)/
      (2*sd_pre*sd_post*paired_t^2),
    
    .by = c(outcome, timing)
    
  ); Acarturk_text_res

```

Entering data from Table 2 (p. 7)

```{r Acarturk_data}

Acarturk2022 <- 
  tibble(
    
    outcome = rep(c("HSCL-25", "PCL-5", "PSYCHLOPS"), each = 4),
    
    timing = rep(c("Posttest", "Followup"), each = 2, n_distinct(outcome)),
    
    group = rep(c("gPM+", "Control"), n_distinct(outcome)*2),
    
    N = rep(c(24, 22), n_distinct(outcome)*2),
    
    m_pre = c(
        rep(c(2.37, 2.31), 2), # HSCL-25
        rep(c(1.84, 1.70), 2), # PCL-5
        rep(c(4.20, 3.92), 2)  # PSYCHLOPS
        
      ),
    
    sd_pre = c(
        
        rep(c(0.58, 0.64), 2),
        rep(c(0.88, 0.86), 2),
        rep(c(0.68, 0.84), 2)
      
      ),
    
    m_post = c(
      
      2.01, 2.28, 2.07, 2.14, 
      1.27, 1.59, 1.12, 1.26,
      3.82, 3.82, 3.67, 3.23
      
    ),
    
    sd_post = c(
      
      0.59, 0.58, 0.52, 0.43,
      0.70, 0.86, 0.85, 0.70,
      1.00, 0.63, 1.32, 1.63
      
    ),
    
    es_paper = rep(c(
      
      0.48, 0.12,
      0.40, 0.18,
      0, -0.30
      
      ),
      each = 2
    ),
    
    pval_paper = rep(c(
      
      0.109, 0.698,
      0.185, 0.553,
      0.996, 0.319
      
      ),
      each = 2
    )
    
    
    
  ); Acarturk2022


wide_format_Acarturk2022 <- 
  function(data, filter_value, trt_name, ctr_name){
  
  filter_func <- 
    function(data, filter_value, trt_name, ctr_name){
      
        
    dat <- data |> dplyr::filter(timing == filter_value)
    
    dat |> 
    dplyr::mutate(group = case_match(group, trt_name ~ "t", ctr_name ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N:last_col()
    )
    
    
  }
  
  purrr::pmap_dfr(
    list(filter_value), ~ 
    filter_func(data = data, filter_value = .x,
                trt_name = trt_name, ctr_name = ctr_name)) |> 
    arrange(outcome)
  
  
}

Acarturk2022_wide <- 
  wide_format_Acarturk2022(
    data = Acarturk2022, 
    filter_value = c("Posttest", "Followup"),
    trt_name = "gPM+",
    ctr_name = "Control"
  ) |> 
  mutate(
    es_paper = es_paper_t,
    pval_paper = pval_paper_t
  ) |> 
  select(-c(es_paper_t:pval_paper_c))


```

Effect size calculation and cluster bias adjustment

```{r}

eta_acarturk_sqrt <- VIVECampbell::eta_1armcluster(
  N_total = 46, Nc = 22, avg_grp_size = 10, ICC = ICC_01,
  sqrt = TRUE
)

Acarturk2022_es <- 
  Acarturk2022 |>
  mutate(
    ppcor = rep(Acarturk_text_res$ppcor, each = 2)
  ) |> 
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Acarturk et al. 2022",
    es_calc_method = "Raw diff-in-diffs",
    
    ppcor = ppcor[1],  
    ppcor_calc_method = "Calculated from study",
    
    R2 = NA,
    R2_calc_method = "Not relevant",
    
    N_t = N[1],
    N_c = N[2],
    
    N_tot = N_t + N_c, 
    
    df_ind = N_tot,
    
    n_covariates = 1,
    
    d_paper = es_paper[1],
    pval_paper = pval_paper[1],
    tval_paper = qnorm(pval_paper/2, lower.tail = FALSE),
    se_d_paper = d_paper/tval_paper,
    se_d_paper = if_else(se_d_paper == 0, sqrt(sum(1/N)) * eta_acarturk_sqrt, se_d_paper),
    vd_paper = se_d_paper^2,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_tot-2) ),
    m_diff_post = (m_post[1] - m_post[2]) * -1,
    
    # Difference in differences measures
    diff_t = (m_post[1] - m_pre[1]) * -1,  
    diff_c = (m_post[2] - m_pre[2]) * -1,
    
    DD = diff_t - diff_c,
    
    d_posttest = m_diff_post/sd_pool, 
    vd_posttest = sum(1/N) + d_posttest^2/(2*df_ind),
    Wd_posttest = sum(1/N),
    
    d = DD/sd_pool,
    vd = 2*(1-ppcor) * sum(1/N) + d^2/(2*df_ind),
    Wd = 2*(1-ppcor) * sum(1/N),
    
    d_alt = d_paper,
    vd_alt = vd_paper,
    Wd_alt = vd_paper,
    
    J = 1 - 3/(4*df_ind-1),
    
    g_posttest = J * d_posttest,
    vg_posttest = sum(1/N) + g_posttest^2/(2*df_ind),
    Wg_posttest = Wd_posttest,
    
    g = J * d, 
    vg = 2*(1-ppcor) * sum(1/N) + g^2/(2*df_ind), 
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = vd_alt,
    Wg_alt = vd_alt,
    
    .by = c(outcome, timing) 
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # " eight to ten participants per group" (p. 1)
    avg_cl_size = 10, 
    avg_cl_type = "From study (p. 1)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates
      ),
    
    gt_icc005 = g * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_icc005, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_icc005",
      vars = vgt_icc005:Wgt_icc005
      ),
    
    gt_icc02 = g * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_icc02, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      q = n_covariates,
      add_name_to_vars = "_icc02",
      vars = vgt_icc02:Wgt_icc02
      ),
    
    gt_alt = g_alt * gamma_sqrt,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_alt, 
      model = "Posttest",
      cluster_adj = TRUE,
      q = n_covariates,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
      ), 
    
    gt_alt_type = "Posttest reported in paper",

    gt_posttest = g_posttest * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_posttest, 
      model = "Posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_posttest",
      vars = vgt_posttest:Wgt_posttest
    )
    
) |> 
ungroup()

Acarturk2022_est <- 
  left_join(Acarturk2022_wide, Acarturk2022_es) |> 
  relocate(study) |> 
  mutate(
    vary_id = paste0(outcome, "/", timing)
  )

Acarturk2022_est

```


### **Gestel-Timmermans et al. [-@VanGestel-Timmermans2012]**
#### (Multi-level analysis to handle clustering)

Missing data analysis to support the  RoB 2 D4 assessment 

```{r}
# Testing missing 

Timmermans_sample_size_dat <-
  tibble(
    
    outcome = rep(c("Empoverment", "Hope", "Quality", "Self-e", "Loneliness"), each = 4),
    timing = rep(c("3 months", "6 months"), each = 2, n_distinct(outcome)),
    #measure = rep(c("post", "followup"), each = 2, n_distinct(outcome)),
    group = rep(c("Treatment", "Control"), 10),
    
    N_start = rep(rep(c(168, 165), 10)),
    
    N_actual = c(
      136, 117, 121, 99,
      132, 118, 120, 97,
      124, 114, 111, 97,
      134, 116, 121, 100,
      138, 122, 125, 102
    )
    
); Timmermans_sample_size_dat
```

Missingness analysis

```{r}
Timmermans_missingness <- 
  Timmermans_sample_size_dat |> 
  summarise(
    N_start_total = sum(N_start),
    N_actual_total = sum(N_actual),
    
    #percent_missing_total = round(mean(percent_missing)),
    
    percent_missing_total = round((1 - (N_actual_total/N_start_total)) * 100),
    
    RoB_D3_assess = case_when(
      percent_missing_total >= 25 ~ "High",
      percent_missing_total < 25 ~ "Some concerns",
      TRUE ~ NA_character_
    ),
    
    .by = c(outcome, timing)
  )

Timmermans_missingness 
```

Data is retrieved from Tables 2 & 3 (p. 58) 

```{r}

Timmermans2012 <- 
  Timmermans_sample_size_dat |> 
  rename(N =  N_actual) |> 
  mutate(
    
    #From Table 2 (p. 58)
    
    m_pre = c(
      rep(c(3.40, 3.37), 2), # Empowerment
      rep(c(2.78, 2.76), 2), # Hope
      rep(c(4.32, 4.23), 2), # Quality of life
      rep(c(4.38, 4.33), 2), # Self-efficacy beliefs
      rep(c(6.40, 6.87), 2)  # Loneliness
    ),
    
    sd_pre = c(
      rep(c(0.49, 0.51), 2), # Empowerment
      rep(c(0.47, 0.48), 2), # Hope
      rep(c(0.88, 1), 2),    # Quality of life
      rep(c(0.82, 0.89), 2), # Self-efficacy beliefs
      rep(c(3.56, 3.40), 2)  # Loneliness
    ),
    
    m_post = c(
      
      3.55, 3.38, 3.59, 3.40, # Empowerment
      2.91, 2.79, 2.97, 2.73, # Hope
      4.49, 4.36, 4.63, 4.39, # Quality of life
      4.65, 4.35, 4.71, 4.4,  # Self-efficacy beliefs
      5.89, 6.27, 3.87, 3.68  # Loneliness
      
    ),
    
    sd_post = c(
      
      0.48, 0.53, 0.50, 0.56,
      0.47, 0.53, 0.46, 0.48,
      0.96, 1.07, 0.97, 1.05,
      0.81, 0.97, 0.93, 0.88,
      3.61, 3.55, 3.87, 3.68
      
    ),
    
    es_paper = rep(
      c(
        0.27, 0.36, 
        0.25, 0.48,
        0.03, 0.15,
        0.27, 0.23, 
        -0.04, 0.15
      ),
      each = 2
    ),
    
    # From Table 3 (p. 58)
    
    b_adj = c(
      .12, .021, .13, .046,   #Empowerment
      .10, .038, .17, .004,   #Hope
      .064, .11, .11, .15,    #Quality of life
      .23, .064, .21, .14,    #Self-efficacy beliefs
      .066, -.65, -.34, -.49  #Loneliness
      
    ),
    
    pval_b_adj = c(
      .016, .55, .012, .24,  #Empowerment
      .039, .28, .001, .91,  #Hope
      .471, .09, .24, .025,  #Quality of life
      .010, .31, .026, .042, #Self-efficacy beliefs
      .85, .008, .35, .07    #Loneliness
      
      ),
    
    ci_l_b_adj = c(
      .022, -.05, .026, -.025,
      NA, -.030, .026, -.025,
      -.11, -.016, -.071, 0.020,
      .059, -.062, .027, .006,
      -.60, -1.14, -1.05, -1.02
    ),
    
    ci_u_b_adj = c(
      .22, .092, .23, .12,
      NA, .11, .23, .12, 
      .23, .24, .29, .28,
      .40, .19, .39, .27,
      .74, -.16, .37, .042
    ),
    
    tval_b_adj = qt(pval_b_adj/2, df = N-2, lower.tail = FALSE),
    se_b_adj = b_adj/tval_b_adj
    
  ); Timmermans2012 


wide_format_Timmermans2012 <- function(data, filter){
  
  filter_func <- function(data, filter){
    
    dat <- data |> dplyr::filter(timing != filter)
    
    dat |> 
    dplyr::mutate(group = case_match(group, "Treatment" ~ "t", "Control" ~ "c")) |> 
    tidyr::pivot_wider(
      names_from = group,
      names_glue = "{.value}_{group}",
      values_from = N_start:dplyr::last_col()
    )
    
    
  }
  
  purrr::pmap_dfr(list(filter), ~ filter_func(data = data, filter = .x )) |> 
    arrange(outcome)
  
  
}

# Continue from here

Timmermans2012_wide <- 
wide_format_Timmermans2012(data = Timmermans2012, filter = c("6 months", "3 months"))

rm(wide_format_Timmermans2012)

```

Effect sizes calculation

```{r}

Timmermans2012_es <- 
  Timmermans2012 |>
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled posttest SD",
    
    study = "Timmermans et al. 2012",
    es_calc_method = "Pretest adj. means",
    
    ppcor = .76,  
    ppcor_calc_method = "From study (p. 57)",
    
    R2 = NA,
    R2_calc_method = "Not relevant - calculated from SE(b)",
    
    N_t = N[1],
    N_c = N[2],
    
    N_tot = N_t + N_c, 
    
    df_ind = N_tot,
    
    n_covariates = 1,
    
    sd_pool = sqrt( sum((N-1)*sd_post^2)/ (N_tot-2) ),
    m_diff_post = m_post[1] - m_post[2],
    
    # Pretest adjusted means
    b_adj = b_adj[1] - b_adj[2],
    
    # Difference in differences measures
    diff_t = m_post[1] - m_pre[1],  
    diff_c = m_post[2] - m_pre[2],
    
    DD = diff_t - diff_c,
    
    d_paper = es_paper[1],
    
    # Converting Loneliness measure since "Possible scores range from 0 to 11, 
    # with higher scores indicating more loneliness." (p. 58)
    d_posttest = if_else(unique(outcome) == "Loneliness", m_diff_post/sd_pool * -1, m_diff_post/sd_pool),
    vd_posttest = sum(1/N) + d_posttest^2/(2*df_ind),
    Wd_posttest = sum(1/N),
    
    d = if_else(unique(outcome) == "Loneliness", b_adj/sd_pool * -1, b_adj/sd_pool),
    vd = sum((se_b_adj/sd_pool)^2) + d^2/(2*df_ind),
    #vd_test = sum(1/N) + d^2/(2*df_ind),
    Wd = sum((se_b_adj/sd_pool)^2),
    #Wd_test = sum(1/N),
    
    d_alt = if_else(unique(outcome) == "Loneliness", DD/sd_pool * -1, DD/sd_pool),
    vd_alt = 2*(1-ppcor) * sum(1/N) + d_alt^2/(2*df_ind),
    Wd_alt = 2*(1-ppcor) * sum(1/N),
    
    J = 1 - 3/(4*df_ind-1),
    
    g_posttest = J * d_posttest,
    vg_posttest = sum(1/N) + g_posttest^2/(2*df_ind),
    Wg_posttest = Wd_posttest,
    
    g = J * d, 
    vg = sum((se_b_adj/sd_pool)^2) + g^2/(2*df_ind), 
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = 2*(1-ppcor) * sum(1/N) + g_alt^2/(2*df_ind),
    Wg_alt = Wd_alt,
    
    
    .by = c(outcome, timing) 
    
    
  ) |> 
  rowwise() |> 
  mutate(
    
    # Average cluster size in treatment group
    # "was 7.0Â±2.1 (range of three to 12)" (p. 57)
    avg_cl_size = 7, 
    avg_cl_type = "From study (p. 57)",
    
    # Imputed icc value
    icc = 0.06,
    icc_type = "From study (p. 56)",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt, 
      model = "Std_reg_coef",
      cluster_adj = TRUE,
      SE_std = sqrt(Wg)
    ),
    
    gt_alt = g_alt * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_alt, 
      model = "DiD",
      cluster_adj = FALSE,
      prepost_cor = ppcor,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
    ),
    
    gt_alt_type = "DiD from raw means",
    
    gt_posttest = g_posttest * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t,
      N_ind_grp = N_c,
      avg_grp_size = avg_cl_size,
      ICC = icc, 
      g = gt_posttest, 
      model = "Posttest",
      cluster_adj = FALSE,
      add_name_to_vars = "_posttest",
      vars = vgt_posttest:Wgt_posttest
    )

    
    
  ) |> 
  ungroup()

# Timmermans2012_es

Timmermans2012_est <- 
  left_join(Timmermans2012_wide, Timmermans2012_es) |> 
  select(-c(es_paper_c, es_paper_t)) |> 
  mutate(vary_id = paste0(outcome, "/", timing))


#clubSandwich::impute_covariance_matrix(
#  vi = Timmermans2012_est$vgt,
#  cluster = Timmermans2012_est$study,
#  r = Timmermans2012_est$ppcor,
#  smooth_vi = FALSE
#)

```


### **Wuthrich & Rapee [-@Wuthrich2013] and Smith et al. [-@Smith2021]**
#### (Accounts for clustering via the use of mixed-effects models/multi-level models)


Entering data from Table 2 (p. 445). Sample size information is retrieved from Table 1 (p. 442). 

```{r Wuthrich20132021dat}
# Calculate paired t-test statistics to obtain pre-posttest score correlation estimates

#-----------------------------------------------------------------
# OUTCOME ANCRONYMS AND FULL NAMES
#-----------------------------------------------------------------
# GDS = Geriatric Depression Scale
# CES-D = The Centre for Epidemiological Studies Depression Scale (loneliness only item used)
# GAI = Geriatric Anxiety Inventory
# PSWQ = The Penn State Worry Questionnaire
# SF12 = The Short Form 12 version 1 Mental Health Subscale
#-----------------------------------------------------------------


# F-stats from the interaction between time and group for mean
# It was uncertain whether we could use these estimates. Therefore, we didn't use
# the reported F-statistics. 
F_stat_Wuthrich <- 
  tibble(
    
    year = c(13, 21, 21, 13, 21, 13, 13, 13),
    
    outcome = c(
      "Primary problem", 
      "Anxiety", 
      "Depression", 
      "GDS", 
      "Loneliness (CES-D 14)", 
      "GAI", 
      "PSWQ", 
      "SF12"),
    
    df1 = 1,
    df2 = c(
      
      47.95,  # Primary problem severity (2013, p. 783)
      49.603, # Anxiety disorder severity (2021, p. 444)
      45.451, # Depressive disorder severity [Mood] (2021, p. 444)
      50.88,  # GDS (2013, p. 783)
      40.609, # Loneliness (2021, p. 444)
      55.65,  # GAI (2013, p. 783)
      54.95,  # PSWQ (2013, p. 783)
      51.39   # SF15 (2013, p. 783)
      
      ),
    F_val = c(
      
      17.36, 
      17.858,
      30.884,
      8.86,
      7.070,
      7.4,
      0.57,
      qf(.988, df1 = 1, df2 = df2[8], lower.tail = FALSE)
      
    ),
    
    pval_reported = c(
      
      pf(F_val[1], df1 = 1, df2 = df2[1], lower.tail = FALSE),
      pf(F_val[2], df1 = 1, df2 = df2[2], lower.tail = FALSE),
      pf(F_val[3], df1 = 1, df2 = df2[3], lower.tail = FALSE),
      .004,
      .011,
      .009,
      .452,
      .988
      
    )
  
)

F_stat_Wuthrich

## emm = estimated marginal means

Wuthrich2013_2021_smd <- 
  tibble(
    
    outcome = rep(
      c("Primary problem", 
        "Anxiety", 
        "Depression", 
        "GDS", 
        "Loneliness (CES-D 14)",
        "GAI",
        "PSWQ",
        "SF12"
        ), 
      each = 2),
    
    group = rep(c("CBT", "Waitlist"), n_distinct(outcome)),
    
    N_start = rep(c(27, 35), n_distinct(outcome)), # From Table 2, 2013, p. 783
    
    N = rep(c(27, 35), n_distinct(outcome)), # From Table 2, 2013, p. 783
    
    emm_pre = c(
      
      6.33, 5.81,    # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      5.2, 4.58,     # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      5.48, 4.98,    # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      18.14, 16.35,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      1.59, 1.36,    # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      11.59, 9.48,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      53.62, 49.27,  # Penn State Worry Questionnaire (from Table 3, 2013, p. 784) 
      37.09, 38.45   # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    emm_post = c(
      
      3.46, 5.15,   # ADIS primary disorder severity (from Table 3, 2013, p. 784)
      2.68, 4.01,   # ADIS mean anxiety disorder severity (from Table 2, 2021, p. 445)
      2.02, 4.25,   # ADIS depressive disorder severity (from Table 2, 2021, p. 445)
      9.21, 14.38,  # Geriatric Depression Scale (from Table 3, 2013, p. 784)
      .593, 1.24,   # Loneliness (CES-D item 14) (from Table 2, 2021, p. 445)
      5.84, 8.33,   # Geriatric Anxiety Inventory (from Table 3, 2013, p. 784)
      46.54, 47.24, # Penn State Worry Questionnaire (from Table 3, 2013, p. 784)
      47.79, 43.56  # Short Form-12 (Mental) (from Table 3, 2013, p. 784)
      
    ),
    
    sd_pre = c(
      
      0.653, 1.16,  # ADIS primary disorder severity (from Table 2, 2013, p. 783)
      0.74, 1.07,   # ADIS mean anxiety disorder severity (from Table 1, 2021, p. 442)
      1.05, 1.27,   # ADIS depressive disorder severity (from Table 1, 2021, p. 442)
      6.18, 5.99,   # Geriatric Depression Scale (from Table 2, 2013, p. 783)
      0.82, 0.97,   # Loneliness (CES-D item 14)  (from Table 1, 2021, p. 442)
      4.72, 5.43,   # Geriatric Anxiety Inventory (from Table 2, 2013, p. 783)
      12.39, 13.06, # Penn State Worry Questionnaire (from Table 2, 2013, p. 783)
      9.22, 6.69    # Short Form-12 (Mental) (from Table 2, 2013, p. 783)
      
    ),
    
    # Number of controlled covariates
    q = rep(c(2, 4, 4, 2, 4, rep(2, 3)), each = 2)
    
  )

Wuthrich2013_2021_smd

Wuthrich2013_2021_wide <- 
  Wuthrich2013_2021_smd |>
  select(-q) |> 
  mutate(group = case_match(group, "CBT" ~ "t", "Waitlist" ~ "c")) |> 
  pivot_wider(
    names_from = group,
    values_from = N_start:sd_pre
  )

#Wuthrich2013_2021_wide
```

Calculating effect sizes and conducting a small number of clusters correction, as suggested by WWC [-@WWC_clusterbias].

```{r Wuthrich20132021SMDcalc}

Wuthrich2013_2021_es_smd <- 
  Wuthrich2013_2021_smd |> 
  summarise(
    
    effect_size = "SMD",
    sd_used = "Pooled pretest SD",
    
    study = "Wuthrich et al.",
    es_calc_method = "DiD emmeans",
    
    ppcor = NA,  
    ppcor_calc_method = "Not relevant",
    
    R2 = R2_imp,
    R2_calc_method = "Imputed",
    
    N_t = N[1],
    N_c = N[2],
    N_tot = sum(N),
    
    df_ind = N_tot,
    
    n_covariates = q[1],
    
    b_adj_emm = emm_post[1] - emm_post[2],
    
    # Reverting outcomes so all outcomes has the same direction
    b_adj_emm = if_else(unique(outcome) != "SF12", b_adj_emm * -1, b_adj_emm),
    
    dif_t_emm = emm_post[1] - emm_pre[1],
    dif_c_emm = emm_post[2] - emm_pre[2],
    
    
    DD_emm = dif_t_emm - dif_c_emm,
    # Reverting outcomes so all outcomes has the same direction
    DD_emm = if_else(unique(outcome) != "SF12", DD_emm * -1, DD_emm),
    sd_pool = sqrt(sum((N - 1) * sd_pre^2) / (N_tot-2)),
    
    d = DD_emm/sd_pool,
    vd = sum(1/N) + d^2/(2*df_ind),
    Wd = sum(1/N),
    
    d_alt = b_adj_emm/sd_pool,
    vd_alt = sum(1/N) + d_alt^2/(2*df_ind),
    Wd_alt = sum(1/N),
    
    J = 1 - 3/(4*df_ind-1),
    
    g = J * d,
    vg = sum(1/N) + g^2/(2*df_ind),
    Wg = Wd,
    
    g_alt = J * d_alt,
    vg_alt = sum(1/N) + g_alt^2/(2*df_ind),
    Wg_alt = sum(1/N),
    
    .by = outcome
    
  ) |> 
  mutate(
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # Find info about the function via ?VIVECampbell::gamma_1armcluster
    gamma_sqrt = VIVECampbell::gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = icc
      ),
    gamma_sqrt_icc005 = gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_005
      ),
    gamma_sqrt_icc02 = gamma_1armcluster(
      N_total = N_tot, Nc = N_c, avg_grp_size = avg_cl_size, ICC = ICC_02
      ),
    
    gt = g * gamma_sqrt,
    VIVECampbell::vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates
      ),
    
    gt_icc005 = g * gamma_sqrt_icc005,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_005, 
      g = gt_icc005, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc005",
      vars = vgt_icc005:Wgt_icc005
      ),
    
    gt_icc02 = g * gamma_sqrt_icc02,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = ICC_02, 
      g = gt_icc02, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_icc02",
      vars = vgt_icc02:Wgt_icc02
      ),
    
    gt_alt = g_alt * gamma_sqrt,
    vgt_smd_1armcluster(
      N_cl_grp = N_t, 
      N_ind_grp = N_c, 
      avg_grp_size = avg_cl_size, 
      ICC = icc, 
      g = gt_alt, 
      model = "emmeans",
      cluster_adj = TRUE,
      R2 = R2,
      q = n_covariates,
      add_name_to_vars = "_alt",
      vars = vgt_alt:Wgt_alt
      ), 
    
    gt_alt_type = "Posttest emmeans",
    
    .by = outcome
    
  )

# Wuthrich2013_2021_es_smd

Wuthrich2013_2021_smd_est <- 
  left_join(Wuthrich2013_2021_wide, Wuthrich2013_2021_es_smd) |> 
  relocate(study, .before = outcome)

Wuthrich2013_2021_smd_est

#rm(Wuthrich2013_2021_wide, Wuthrich2013_2021_es_smd)

```

Calculating odds ratio effect sizes from Recovery rates reported in @Wuthrich2013[p.784]

```{r Wuthrich20132021ORcalc}

# Odd ratio based on recovery rates reported in Wuthrich 2013 (p. 784)

Wuthrich2013_OR_dat <- 
  tibble(
    study = "Wuthrich et al.",
    outcome = "Recovery rates",
    effect_size = "OR",
    es_calc_method = "Proportions",
    
    N_start_t = 27,
    N_start_c = 35,
    
    N_t = 20,
    N_c = 26,
    p_t = 0.53, 
    p_c = 0.11,
    
    # Average cluster size in treatment group
    # "in blocks of 8 participants." (2013, p. 781)
    avg_cl_size = 8, 
    avg_cl_type = "From study (2013, p. 781)",
    
    # Imputed icc value
    icc = ICC_01,
    icc_type = "Imputed",
    
    # OR calculation and cluster bias adjustment
    VIVECampbell::OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = icc, avg_cl_size = avg_cl_size, n_cluster_arms = 1
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.05
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_005, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc005", vars = DE_icc005:vln_OR_C_icc005
    ),
    
    # Calculating the sampling variance of the odds ratio based on ICC = 0.2
    OR_calc(
      p1 = p_t, p2 = p_c, n1 = N_t, n2 = N_c, 
      ICC = ICC_02, avg_cl_size = avg_cl_size, n_cluster_arms = 1,
      add_name_to_vars = "_icc02", vars = DE_icc02:vln_OR_C_icc02
    )
    
    
  )

Wuthrich2013_OR_dat


# Amalgamating the SMD and OR results
Wuthrich2013_2021_est <- 
  bind_rows(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat) |> 
  mutate(
    vary_id = outcome
  )

Wuthrich2013_2021_est

#rm(Wuthrich2013_2021_smd_est, Wuthrich2013_OR_dat)


```


## Amalgamation of data

Amalgamating effect size data

```{r, include=FALSE, eval=FALSE}

#select_across_df <- function(dataframes = list(), list_labels){
#  
#  map_dfr(dataframes, ~ select(., !!!list_labels))
#  
#}
#
## Extend variables
#var_label <- c(
#  "study", "es_method", "ppcor", "ppcor_type", "Nt", "Nc", "N_tot",
#  "df_ind", "d",  "vd", "Wd", "g", "vg", "Wg", # Continue here more variables are needed
#  "vary_id"
#)
#
#es_dat <- 
#  select_across_df(
#    list(
#      Timmermans2012_est
#    ),
#    
#    var_label
#
#); es_dat



```

Amalgating covariates and effect size data
```{r dataamalgamation, eval=FALSE}
#Remember to see working directory to "Group-based-interventions/ES calc"

covariates <- read_xlsx(
  "Descriptive coding scheme for group-based interventions (data).xlsx",
  na = c(".", "")
)


group_based_dat_es <- 
  bind_rows(
    Timmermans2012_est,
    Wuthrich2013_2021_est,
    Acarturk2022_est
  ) |> 
  relocate(sd_pool, .after = sd_used) |> 
  relocate(emm_pre_t:DD_emm, .after = se_b_adj_c)

group_based_dat <- 
  bind_cols(
    covariates,
    group_based_dat_es

)

write_xlsx(group_based_dat, "Group-based interventions data.xlsx")
save(group_based_dat, file = "Group-based interventions data.RData")

#clubSandwich::impute_covariance_matrix(
#  vi = group_based_dat$vgt,
#  cluster = group_based_dat$studyid,
#  r = c(.7, 0.1),
#  smooth_vi = TRUE
#)

```


## **Reference**




























