---
title: "Main analysis (group-based)"
author: "Mikkel H. Vembye"
subtitle: ""
date: "`r Sys.Date()`"
format:
  html: 
    keep-md: true
    self-contained: true
    grid: 
      margin-width: 350px
    code-fold: true
    code-summary: "Show the code"
    toc: true
    toc-location: left
pdf-engine: pdflatex
execute: 
  echo: fenced
  warning: false
  message: false
knitr:
  opts_chunk: 
    fig.pos: "H"
    fig.retina: 2
    cache: FALSE
    R.options:
      knitr.graphics.auto_pdf: true
      width: 100
      knitr.kable.NA: ""
      dplyr.summarise.inform: FALSE
reference-location: margin
citation-location: margin
bibliography: bibliography.bib 
editor_options: 
  chunk_output_type: console
---

## Loading R packages and data

Below, we load the R package and data used for you main analyses. You can find the generated datasets and the corresponding variables in the PRIMED workflow document. 

```{r packages-and-source-file}
RNGkind("L'Ecuyer-CMRG") # My naive try to steer seed across OS

library(dplyr)
library(tibble)
library(ggplot2)
library(stringr)
library(tidyr)
library(rempsyc)
library(purrr)
library(metafor)
library(clubSandwich)
library(knitr)
library(kableExtra)
library(forcats)
library(future)
library(furrr)
library(gt)
library(fastDummies)
library(rlang)
library(wildmeta)
library(tictoc)

source("Helpers.R")

reintegration_dat <- readRDS("reintegration_dat.rds")
mental_health_dat <- readRDS("mental_health_dat.rds")


```


# Moderators and control variables manipulation

## Reintegration
In this section, we manipulate all variables used in meta-regression analyses. 

```{r, manipulate-data}
# List all relevant moderator variables here: 
## Type of outcome: analysis_plan
## 

# Read: reint_ma_dat = reintegrational meta-analysis data
reint_ma_dat <- 
  reintegration_dat |> 
  mutate(
    outcome_time = paste(outcome, time, sep = "_"),
  ) |> 
  select(
    # Various types of effect size estimates 
    study, gt_pop, vgt_pop, Wgt_pop, gt, vgt, Wgt, g, vg, d, vd, gt_post, vgt_post,
    
    
    # Categorical moderators and control variables 
    analysis_plan, schizophrenia, CBT_intervention = CBT_int, prereg_chr, conventional, 
    test_type, analysis_strategy, QES_design, control, D1:D7, overall_rob, 
    
    # Continuous moderators and control variables
    age_mean, male_pct, total_number_of_sessions, sessions_per_week, duration_in_weeks,
    time_after_end_intervention_weeks, time_from_baseline_weeks,
    
    # For vcalc
    outcome, outcome_time, N_t, N_c, N_total, trt_name, trt_id, control, ctr_id,
    
    # Miscellaneous 
    vary_id, varifier, time, rob_tool
    
  ) |> 
  mutate(
    esid = 1:n(),
    
    # Outcome variables
    outcome_type = case_match(
      analysis_plan, 
      c("Employment", "Physical health", "Psychiatric hospitalization") ~ "Other",
      .default = analysis_plan
    ),
    
    outcome_type = fct_relevel(outcome_type, sort),
    outcome_type = fct_relevel(outcome_type, "Other", after = Inf),
    
    prereg_c = conventional - mean(conventional),
    
    schizophrenia_in_sample = if_else(schizophrenia == "Schizophrenia", "Yes", "No"),
    schizophrenia_in_sample = factor(schizophrenia_in_sample, levels = c("Yes", "No")),
    
    schizo_in_sample = if_else(schizophrenia == "Schizophrenia", 1, 0),
    schizo_c = schizo_in_sample - mean(schizo_in_sample),
    
    cbt = if_else(CBT_intervention == "CBT", 1, 0),
    cbt_c = cbt - mean(cbt),
    
    test_type = if_else(test_type != "Clinician-rated measure", "Self reported/raw events", test_type),
    
    clin_measure = if_else(test_type == "Clinician-rated measure", 1, 0),
    clinical_c = clin_measure - mean(clin_measure),
    
    tot = if_else(analysis_strategy == "TOT", 1, 0),
    tot_c = tot - mean(tot),
    
    qes = if_else(QES_design == "QES", 1, 0),
    qes_c = qes - mean(qes),
    
    indi_treat_ctr = if_else(str_detect(control, "Ind"), "Individual treatment", "TAU and Waitlist"),
    
    control_modified = if_else(str_detect(control, "TAU"), "TAU with/without Waitlist", control),
    
    crt_grp = if_else(str_detect(control, "Ind"), 1, 0),
    crt_grp_c = crt_grp - mean(crt_grp),
    
    ctl_ind = if_else(str_detect(control, "Ind"), 1, 0),
    ctl_tau = if_else(str_detect(control, "TAU"), 1, 0),
    ctl_wait = if_else(control == "Waiting-list only", 1, 0),
    
    risk_of_bias = if_else(overall_rob == "Serious/High", "Serious/High", "Low/Some concerns/Moderate"),
    rob = if_else(str_detect(risk_of_bias, "Serious"), 1, 0),
    rob_c = rob - mean(rob),
    
    sessions_per_week = if_else(is.na(sessions_per_week), mean(sessions_per_week, na.rm = TRUE), sessions_per_week),
    male_pct = if_else(is.na(male_pct), mean(male_pct, na.rm = TRUE), male_pct),
    
    age_c = age_mean - 40,
    male_c = male_pct/100 - 0.5,
    sessions_c = sessions_per_week - 1,
    duration_c = duration_in_weeks - 12,
    fu_time_c = time_after_end_intervention_weeks - 1,
    
    study = stringi::stri_trans_general(study, "Latin-ASCII"),
    study = fct_relevel(study, sort)
    
  ) |> 
  arrange(study) |> 
  mutate(
    study = as.character(study)
  )

reint_ma_dat <- 
  fastDummies::dummy_cols(reint_ma_dat, select_columns = "outcome_type", omit_colname_prefix = TRUE) |> 
  rename(
    alcohol = `Alcohol and drug abuse/misuse`, 
    hope = `Hope, empowerment & self-efficacy`, 
    lonely = Loneliness,
    self_est = `Self-esteem`,
    social_fun = `outcome_type_Social functioning (degree of impairment)`,
    wellbeing = `Wellbeing and quality of life`,
    other = Other
  ) |> 
  mutate(
    across(where(is.double), as.double),
    across(where(is.integer), as.integer)
  )

#reint_ma_dat <- 
#  reint_ma_dat |> 
#  metafor::escalc(
#    data = _, 
#    yi = gt_pop, 
#    vi = vgt_pop
#  )

attr(reint_ma_dat , "data_name") <- "reint_ma_dat"

saveRDS(reint_ma_dat, "reint_ma_dat.rds")

```

### Overall effect

```{r}



.PECHE_RVE(data = reint_ma_dat)

#study_names <- unique(reint_ma_dat$study) |> as.character()
#
#omit_test <- map(.x = study_names[1:2], .f = .PECHE_RVE, data = reint_ma_dat) 

```


### Outcome
```{r outcome-test}
rho <- 0.8

V_mat <- 
  metafor::vcalc(
    data = reint_ma_dat,
    vi = vgt_pop, 
    cluster = study,
    subgroup = outcome_type,
    type = outcome_time, 
    grp1 = trt_name,
    w1 = N_t, 
    grp2 = control,
    w2 = N_c, 
    rho = rho
  )

#V_mat2 <- 
#  metafor::vcalc(
#    data = reint_ma_dat,
#    vi = vgt_pop, 
#    cluster = study,
#    obs = esid, 
#    rho = rho
#  )


# Checking correct v_mat
blsplit(V_mat, reint_ma_dat$study) |> 
  lapply(cov2cor) |> 
  map(~ round(.x, 2))

outcome_obj <- 
  metafor::rma.mv(
    yi = gt_pop ~ outcome_type - 1,
    V = V_mat, 
    random = list(~ outcome_type | study, ~ outcome_type | esid),
    struct = c("DIAG", "DIAG"),
    data = reint_ma_dat,
    sparse=TRUE
  )

#saveRDS(outcome_obj, file = "outcome_obj.rds")

outcome_obj_robu <- 
  outcome_obj |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

outcome_obj_robu

club_wald_test <- Wald_test(outcome_obj, constraints = constrain_equal(1:3), vcov = "CR2")
club_wald_test


tic()
plan(multisession, workers = parallel::detectCores()-1)

cwb_test <- 
  try(
    Wald_test_cwb(
      full_model = outcome_obj,
      constraints = constrain_equal(1:7),
      R = 19, 
      seed = 26082025L
    )
  ); cwb_test

plan(sequential)
toc()

# Continuous model

age_obj <- 
  rma.mv(
    yi = gt_pop ~ age_c + prereg_chr - 1,
    V = V_mat, 
    random = ~ 1 | study / esid,
    data = reint_ma_dat,
    sparse = TRUE
  ) |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

age_obj

prereg_obj <- 
    rma.mv(
    yi = gt_pop ~ prereg_chr + male_c - 1,
    V = V_mat, 
    random = list(~ prereg_chr | study, ~ prereg_chr | esid),
    struct = c("DIAG", "DIAG"),
    data = reint_ma_dat,
    sparse=TRUE
  ) |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

prereg_obj

#y_test <- 
#  try(
#    Wald_test_cwb(
#      full_model = prereg_obj,
#      constraints = constrain_equal(1:2),
#      R = 19, 
#      adjust = "CR2",
#      seed = 12345
#    )
#  )


```
### Theory and methods tables
```{r reint-table-data}

arg_tbl <- 
  tibble::tibble(
    yi = "gt_pop",
    vi = "vgt_pop",
    
    covars = rep(
      c(
        "outcome_type", 
        paste0(
          "outcome_type;schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;crt_grp_c;rob_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "schizophrenia_in_sample",
        paste0(
          "schizophrenia_in_sample;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "cbt_c;prereg_c;clinical_c;tot_c;qes_c;crt_grp_c;rob_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "CBT_intervention",
        paste0(
          "CBT_intervention;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;prereg_c;clinical_c;tot_c;qes_c;crt_grp_c;rob_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "prereg_chr", 
        paste0(
          "prereg_chr;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;clinical_c;tot_c;qes_c;crt_grp_c;rob_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "test_type",
        paste0(
          "test_type;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;tot_c;qes_c;crt_grp_c;rob_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "analysis_strategy",
        paste0(
          "analysis_strategy;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;clinical_c;qes_c;crt_grp_c;rob_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "QES_design",
        paste0(
          "QES_design;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;crt_grp_c;rob_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "control_modified",
        paste0(
          "control_modified;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;rob_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "risk_of_bias", 
        paste0(
          "risk_of_bias;alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;crt_grp_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        )
        
      ),
      each = 5),
    
    model = "SCEp",
    
    r = rep(seq(0, 0.8, 0.2), 18),
    
    type = rep(c(rep("theory", 3), rep("methods", 6)), each = 10)
  )

es_names <- list("gt", "g", "d", "gt_post")
var_es_names <-  list("vgt", "vg", "vd", "vgt_post")

arg_tbl_alt_es <- 
  map2(es_names, var_es_names, ~ {
    arg_tbl |> 
      #filter(r == 0.8) |> 
      mutate(
        yi = .x,
        vi = .y
      )
  } ) |> 
  list_rbind()

arg_tbl_all <- 
  rbind(arg_tbl, arg_tbl_alt_es)


# For SCE models
arg_list_tbl <- 
  pmap(.l = arg_tbl_all, .f = .rma_arg_tbl, data = reint_ma_dat) |> 
  list_rbind() |> 
  mutate(
    R = 19L,
    seed = 26082025L
  )


arg_list_tbl_rho08 <- arg_list_tbl |> filter(rho == 0.8 & var == "vgt_pop")

tic()
plan(multisession)
x_test <- 
  pmap(
    .l = arg_list_tbl_rho08, 
    .f = .PESCE_RVE, 
    return_rma_obj = FALSE,
    CWB = FALSE
  ); x_test
plan(sequential)
toc()

#blsplit(x_test[[1]], reint_ma_dat$study) |> 
#  lapply(cov2cor) |> 
#  map(~ round(.x, 2))


#opts <- furrr::furrr_options(
#  stdout = FALSE,        # don't forward cat/print output
#  conditions = NULL,      # don't forward messages/warnings
#  seed = TRUE
#)
#
#n_workers <- max(1L, future::availableCores() - 1L)
#
#
#future::plan(future::multisession, workers = n_workers)
#tic()
#main_res <- 
#  future_pmap(
#    .l = arg_list_tbl_rho08[1:2,], 
#    .f = .PESCE_RVE, 
#    return_rma_obj = FALSE,
#    CWB = FALSE,
#    .options = opts,
#    .progress = TRUE
#  ); main_res
#toc()
#
#future::plan(future::sequential)
#future::plan()


#rho <- 0.8
#
#V_mat <- 
#  metafor::vcalc(
#    data = reint_ma_dat,
#    vi = vgt_pop, 
#    cluster = study,
#    type = outcome_time, 
#    grp1 = trt_name,
#    w1 = N_t, 
#    grp2 = control,
#    w2 = N_c, 
#    rho = rho
#  )
#
#future::plan(future::multisession, workers = n_workers)
#wildmeta::Wald_test_cwb(
#  full_model = outcome_obj,
#  constraints = wildmeta::constrain_equal(1:7),
#  R = 10,
#  seed = 26082025L
#)
#future::plan(future::sequential)
#future::plan()

```

```{r tables-reint}
#| eval: false 
wider_dat_theory_factors <- 
  x_test |> 
  list_rbind() |> 
  filter(table == "theory") |> 
  select(Characteric:SD_total, controls) |> 
  pivot_wider(names_from = controls, values_from = c(avg_effect_ci:SD_total)) |> 
  relocate(contains("no",  ignore.case = TRUE), .after = effects) |>          
  relocate(contains("yes", ignore.case = TRUE), .after = last_col())


main_res_table <- 
  wider_dat_theory_factors |> 
  select(-1) |> 
  gt() |> 
  tab_spanner(label = "Subgroup analyses", columns = c("Moderator", "studies", "effects")) |> 
  tab_spanner(label = "Unadjusted effects", columns = contains("No")) |> 
  tab_spanner(label = "Covariate-adjusted effects", columns = contains("Yes")) |> 
  cols_label(
    studies = "Studes",
    effects = "Effects",
    avg_effect_ci_No  = html("Est [95% CI]<br>F stats"),
    pval_No = "Sig.",
    df_satt_No = "Satt. df",
    SD_total_No = "SD total",
    avg_effect_ci_Yes  = html("Est [95% CI]<br>F stats"),
    pval_Yes = "Sig.",
    df_satt_Yes = "Satt. df",
    SD_total_Yes = "SD total"
  ) |> 
    sub_missing(
    columns = everything(),   
    missing_text = ""         
  ); main_res_table

#main_res_table |> gtsave("Tables/main_res_table_reint.docx")

wider_dat_methods_factors <- 
  x_test |> 
  list_rbind() |> 
  filter(table == "methods") |> 
  select(Characteric:SD_total, controls) |> 
  pivot_wider(names_from = controls, values_from = c(avg_effect_ci:SD_total)) |> 
  relocate(contains("no",  ignore.case = TRUE), .after = effects) |>          
  relocate(contains("yes", ignore.case = TRUE), .after = last_col())


methods_res_table <- 
  wider_dat_methods_factors |> 
  select(-1) |> 
  gt() |> 
  tab_spanner(label = "Subgroup analyses", columns = c("Moderator", "studies", "effects")) |> 
  tab_spanner(label = "Unadjusted effects", columns = contains("No")) |> 
  tab_spanner(label = "Covariate-adjusted effects", columns = contains("Yes")) |> 
  cols_label(
    studies = "Studes",
    effects = "Effects",
    avg_effect_ci_No  = html("Est [95% CI]<br>F stats"),
    pval_No = "Sig.",
    df_satt_No = "Satt. df",
    SD_total_No = "SD total",
    avg_effect_ci_Yes  = html("Est [95% CI]<br>F stats"),
    pval_Yes = "Sig.",
    df_satt_Yes = "Satt. df",
    SD_total_Yes = "SD total"
  ) |>
  sub_missing(
    columns = everything(),   
    missing_text = ""         
  ); methods_res_table

#methods_res_table |> gtsave("Tables/methods_res_table_reint.docx")

```


### PECHE-RVE for meta-regression


```{r che-rve-meta-regression}

cor_val <- 0L:10L/10L
cor_val <- cor_val[seq(1, 10L, 2L)]

arg_tbl_contin <- 
  tibble::tibble(
    yi = "gt_pop",
    vi = "vgt_pop",
    
    covars = rep(
      c(
        "age_c", 
        "male_c",
        "sessions_c",
        "duration_c",
        "fu_time_c",
        
        paste0(
          "age_c;male_c;sessions_c;duration_c;fu_time_c;",
          "alcohol;hope;lonely;self_est;social_fun;wellbeing;other;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;crt_grp_c"
        )
      ),
      each = 5),
    
    model = "CHE",
    
    r = rep(cor_val, 6),
    
    type = "Continuous"
  )

es_names <- list("gt", "g", "d", "gt_post")
var_es_names <-  list("vgt", "vg", "vd", "vgt_post")

arg_tbl_alt_es_contin <- 
  map2(es_names, var_es_names, ~ {
    arg_tbl_contin |> 
      filter(r == 0.8) |> 
      mutate(
        yi = .x,
        vi = .y
      )
  } ) |> 
  list_rbind()

arg_tbl_all_contin <- 
  rbind(arg_tbl_contin, arg_tbl_alt_es_contin)



# Model type to replicate with function

rho <- 0.8

V_mat <- 
  metafor::vcalc(
    data = reint_ma_dat,
    vi = vgt_pop, 
    cluster = study,
    type = outcome_time, 
    grp1 = trt_name,
    w1 = N_t, 
    grp2 = control,
    w2 = N_c, 
    rho = rho
  )

male_obj <- 
  metafor::rma.mv(
    gt_pop ~ male_c, 
    V = V_mat, 
    random = ~ 1 | study / esid,
    data = reint_ma_dat,
    sparse = TRUE
  ) |> 
  robust(
    cluster = study, 
    clubSandwich = TRUE
  )


arg_list_tbl_contin <- 
  pmap(.l = arg_tbl_contin, .f = .rma_arg_tbl, data = reint_ma_dat) |> 
  list_rbind() 


continuous_res_reint <- 
  purrr::pmap(
    #subset to main specification
    .l = arg_list_tbl_contin[arg_list_tbl_contin$rho == 0.8,], 
    .f = .PECHE_meta_reg, 
    return_rma_obj = FALSE
    
  ) |> 
  purrr::list_rbind(names_to = "Model") |> 
  dplyr::mutate(
    Model = paste("Model", Model)
  ) |> 
  tidyr::pivot_wider(
    names_from = Model,               
    values_from = Coef
  )  

continuous_res_reint

#rho <- 0.8
#
#V_mat <- 
#  metafor::vcalc(
#    vi = vgt_pop, 
#    cluster = study, 
#    obs = esid, 
#    data = reint_ma_dat, 
#    rho = rho
#  )
#
#all_in_one_obj <- 
#  metafor::rma.mv(
#    arg_list_tbl_contin$formula[26][[1]], 
#    V = V_mat, 
#    random = ~ 1 | study / esid,
#    data = reint_ma_dat,
#    sparse = TRUE
#  ) |> 
#  robust(
#    cluster = study, 
#    clubSandwich = TRUE
#  )






```

```{r making-gt-tables-contin}

reint_contin_res_table <- 
  continuous_res_reint |> 
  gt() |> 
  sub_missing(
    columns = everything(),   
    missing_text = ""         
  ) |> 
  cols_align(align = "left", columns = gt::everything()) |> 
  tab_style(
    style = cell_text(weight = "bold", align = "left"),
    locations = cells_column_labels(columns = gt::everything())
  ) |> 
  tab_style(
    style = cell_borders(sides = "top", color = "black", weight = px(1)),
    locations = list(
      cells_stub(rows  = Moderators == "Study-level SD"),
      cells_body(rows  = Moderators == "Study-level SD")
    )
  )

reint_contin_res_table

#reint_contin_res_table |> gtsave("Tables/reint_contin_res_table.docx")

```


## Mental health
In this section, we manipulate all variables used in meta-regression analyses based on mental health outcomes 

```{r, manipulate-data}
# List all relevant moderator variables here: 
## Type of outcome: analysis_plan
## 

# Read: mental_ma_dat = mental healt meta-analysis data
mental_ma_dat <- 
  mental_health_dat |> 
  mutate(
    outcome_time = paste(outcome, time, sep = "_"),
  ) |> 
  select(
    # Various types of effect size estimates 
    study, gt_pop, vgt_pop, Wgt_pop, gt, vgt, Wgt, g, vg, d, vd, gt_post, vgt_post,
    
    
    # Categorical moderators and control variables 
    analysis_plan, schizophrenia, CBT_intervention = CBT_int, prereg_chr, conventional, 
    test_type, analysis_strategy, QES_design, control, D1:D7, overall_rob, 
    
    # Continuous moderators and control variables
    age_mean, male_pct, total_number_of_sessions, sessions_per_week, duration_in_weeks,
    time_after_end_intervention_weeks, time_from_baseline_weeks,
    
    # For vcalc
    outcome, outcome_time, N_t, N_c, N_total, trt_name, trt_id, control, ctr_id,
    
    # Miscellaneous 
    vary_id, varifier, time, rob_tool
    
  ) |> 
  mutate(
    esid = 1:n(),
    
    # Outcome variables
    outcome_type = analysis_plan,
    
    prereg_c = conventional - mean(conventional),
    
    schizophrenia_in_sample = if_else(schizophrenia == "Schizophrenia", "Yes", "No"),
    schizophrenia_in_sample = factor(schizophrenia_in_sample, levels = c("Yes", "No")),
    
    schizo_in_sample = if_else(schizophrenia == "Schizophrenia", 1, 0),
    schizo_c = schizo_in_sample - mean(schizo_in_sample),
    
    cbt = if_else(CBT_intervention == "CBT", 1, 0),
    cbt_c = cbt - mean(cbt),
    
    test_type = if_else(test_type != "Clinician-rated measure", "Self reported/raw events", test_type),
    
    clin_measure = if_else(test_type == "Clinician-rated measure", 1, 0),
    clinical_c = clin_measure - mean(clin_measure),
    
    tot = if_else(analysis_strategy == "TOT", 1, 0),
    tot_c = tot - mean(tot),
    
    qes = if_else(QES_design == "QES", 1, 0),
    qes_c = qes - mean(qes),
    
    indi_treat_ctr = if_else(str_detect(control, "Ind"), "Individual treatment", "TAU and Waitlist"),
    
    control_modified = if_else(str_detect(control, "TAU"), "TAU with/without Waitlist", control),
    
    crt_grp = if_else(str_detect(control, "Ind"), 1, 0),
    crt_grp_c = crt_grp - mean(crt_grp),
    
    ctl_ind = if_else(str_detect(control, "Ind"), 1, 0),
    ctl_tau = if_else(str_detect(control, "TAU"), 1, 0),
    ctl_wait = if_else(control == "Waiting-list only", 1, 0),
    
    risk_of_bias = if_else(overall_rob == "Serious/High", "Serious/High", "Low/Some concerns/Moderate"),
    rob = if_else(str_detect(risk_of_bias, "Serious"), 1, 0),
    rob_c = rob - mean(rob),
    
    sessions_per_week = if_else(is.na(sessions_per_week), mean(sessions_per_week, na.rm = TRUE), sessions_per_week),
    male_pct = if_else(is.na(male_pct), mean(male_pct, na.rm = TRUE), male_pct),
    
    age_c = age_mean - 40,
    male_c = male_pct/100 - 0.5,
    sessions_c = sessions_per_week - 1,
    duration_c = duration_in_weeks - 12,
    fu_time_c = time_after_end_intervention_weeks - 1,
    
    study = stringi::stri_trans_general(study, "Latin-ASCII"),
    study = fct_relevel(study, sort)
    
  ) |> 
  arrange(study) |> 
  mutate(
    study = as.character(study)
  )

mental_ma_dat <- 
  fastDummies::dummy_cols(mental_ma_dat, select_columns = "outcome_type", omit_colname_prefix = TRUE) |> 
  rename(
    anxiety = Anxiety, 
    depression = Depression, 
    gen_mental = `General mental health`,
    symptoms = `Symptoms of psychosis`
  ) |> 
  mutate(
    across(where(is.double), as.double),
    across(where(is.integer), as.integer)
  )


attr(mental_ma_dat, "data_name") <- "mental_ma_dat"

saveRDS(mental_ma_dat, "mental_ma_dat.rds")

```

### Overall effect

```{r}

.PECHE_RVE(data = mental_ma_dat)

#study_names <- unique(reint_ma_dat$study) |> as.character()
#
#omit_test <- map(.x = study_names[1:2], .f = .PECHE_RVE, data = reint_ma_dat) 

```


### Outcome
```{r outcome-test-mental}
rho <- 0.8

V_mat_mental <- 
  metafor::vcalc(
    data = mental_ma_dat,
    vi = vgt_pop, 
    cluster = study,
    subgroup = outcome_type,
    type = outcome_time, 
    grp1 = trt_name,
    w1 = N_t, 
    grp2 = control,
    w2 = N_c, 
    rho = rho
  )


# Checking correct v_mat
blsplit(V_mat_mental, mental_ma_dat$study) |> 
  lapply(cov2cor) |> 
  map(~ round(.x, 2))

outcome_obj_mental <- 
  metafor::rma.mv(
    yi = gt_pop ~ outcome_type - 1,
    V = V_mat_mental, 
    random = list(~ outcome_type | study, ~ outcome_type | esid),
    struct = c("DIAG", "DIAG"),
    data = mental_ma_dat,
    sparse=TRUE
  )

#saveRDS(outcome_obj, file = "outcome_obj.rds")

outcome_obj_mental_robu <- 
  outcome_obj_mental |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

outcome_obj_mental_robu

club_wald_test <- Wald_test(outcome_obj_mental, constraints = constrain_equal(1:4), vcov = "CR2")
club_wald_test


tic()
plan(multisession, workers = parallel::detectCores()-1)

cwb_test_mental <- 
  try(
    Wald_test_cwb(
      full_model = outcome_obj_mental,
      constraints = constrain_equal(1:4),
      R = 19, 
      seed = 26082025L
    )
  ); cwb_test_mental

plan(sequential)
toc()

# Continuous model

age_obj_mental <- 
  rma.mv(
    yi = gt_pop ~ age_c + prereg_chr - 1,
    V = V_mat_mental, 
    random = ~ 1 | study / esid,
    data = mental_ma_dat,
    sparse = TRUE
  ) |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

age_obj_mental

prereg_obj_mental <- 
    rma.mv(
    yi = gt_pop ~ prereg_chr + male_c - 1,
    V = V_mat_mental, 
    random = list(~ prereg_chr | study, ~ prereg_chr | esid),
    struct = c("DIAG", "DIAG"),
    data = mental_ma_dat,
    sparse=TRUE
  ) |> 
  metafor::robust(cluster = study, clubSandwich = TRUE)

prereg_obj_mental

#y_test <- 
#  try(
#    Wald_test_cwb(
#      full_model = prereg_obj_mental,
#      constraints = constrain_equal(1:2),
#      R = 19, 
#      adjust = "CR2",
#      seed = 12345
#    )
#  )


```
### Theory and methods tables
```{r reint-table-data}

arg_tbl_mental <- 
  tibble::tibble(
    yi = "gt_pop",
    vi = "vgt_pop",
    
    covars = rep(
      c(
        "outcome_type", 
        paste0(
          "outcome_type;schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "schizophrenia_in_sample",
        paste0(
          "schizophrenia_in_sample;anxiety;depression;gen_mental;symptoms;",
          "cbt_c;prereg_c;clinical_c;tot_c;qes_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "CBT_intervention",
        paste0(
          "CBT_intervention;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;prereg_c;clinical_c;tot_c;qes_c;",
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "prereg_chr", 
        paste0(
          "prereg_chr;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;clinical_c;tot_c;qes_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "test_type",
        paste0(
          "test_type;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;prereg_c;tot_c;qes_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "analysis_strategy",
        paste0(
          "analysis_strategy;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;prereg_c;clinical_c;qes_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "QES_design",
        paste0(
          "QES_design;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "control_modified",
        paste0(
          "control_modified;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        ),
        
        "risk_of_bias", 
        paste0(
          "risk_of_bias;anxiety;depression;gen_mental;symptoms;",
          "schizo_c;cbt_c;prereg_c;clinical_c;tot_c;qes_c;", 
          "age_c;sessions_c;duration_c;fu_time_c"
        )
        
      ),
      each = 5),
    
    model = "SCEp",
    
    r = rep(seq(0, 0.8, 0.2), 18),
    
    type = rep(c(rep("theory", 3), rep("methods", 6)), each = 10)
  )

es_names <- list("gt", "g", "d", "gt_post")
var_es_names <-  list("vgt", "vg", "vd", "vgt_post")

arg_tbl_alt_es_mental <- 
  map2(es_names, var_es_names, ~ {
    arg_tbl_mental |> 
      #filter(r == 0.8) |> 
      mutate(
        yi = .x,
        vi = .y
      )
  } ) |> 
  list_rbind()

arg_tbl_all_mental <- 
  rbind(arg_tbl_mental, arg_tbl_alt_es_mental)


# For PESCE models
arg_list_tbl_mental <- 
  pmap(.l = arg_tbl_all_mental, .f = .rma_arg_tbl, data = mental_ma_dat) |> 
  list_rbind() |> 
  mutate(
    R = 19L,
    seed = 26082025L
  )


arg_list_tbl_rho08_mental <- arg_list_tbl_mental |> filter(rho == 0.8 & var == "vgt_pop")

tic()
plan(multisession)
res_mental <- 
  pmap(
    .l = arg_list_tbl_rho08_mental, 
    .f = .PESCE_RVE, 
    return_rma_obj = FALSE,
    CWB = FALSE
  ); res_mental
plan(sequential)
toc()


#opts <- furrr::furrr_options(
#  stdout = FALSE,        # don't forward cat/print output
#  conditions = NULL,      # don't forward messages/warnings
#  seed = TRUE
#)
#
#n_workers <- max(1L, future::availableCores() - 1L)
#
#
#future::plan(future::multisession, workers = n_workers)
#tic()
#main_res <- 
#  future_pmap(
#    .l = arg_list_tbl_rho08_mental[1:2,], 
#    .f = .PESCE_RVE, 
#    return_rma_obj = FALSE,
#    CWB = FALSE,
#    .options = opts,
#    .progress = TRUE
#  ); main_res
#toc()
#
#future::plan(future::sequential)
#future::plan()


#rho <- 0.8
#
#V_mat_mental <- 
#  metafor::vcalc(
#    data = mental_ma_dat,
#    vi = vgt_pop, 
#    cluster = study,
#    subgroup = outcome_type,
#    type = outcome_time, 
#    grp1 = trt_name,
#    w1 = N_t, 
#    grp2 = control,
#    w2 = N_c, 
#    rho = rho
#  )
#
#future::plan(future::multisession, workers = n_workers)
#wildmeta::Wald_test_cwb(
#  full_model = outcome_obj_mental,
#  constraints = wildmeta::constrain_equal(1:4),
#  R = 10,
#  seed = 26082025L
#)
#future::plan(future::sequential)
#future::plan()

```

```{r tables-reint}
#| eval: false

wider_dat_theory_factors_mental <- 
  res_mental |> 
  list_rbind() |> 
  filter(table == "theory") |> 
  select(Characteric:SD_total, controls) |> 
  pivot_wider(names_from = controls, values_from = c(avg_effect_ci:SD_total)) |> 
  relocate(contains("no",  ignore.case = TRUE), .after = effects) |>          
  relocate(contains("yes", ignore.case = TRUE), .after = last_col())


main_res_table_mental <- 
  wider_dat_theory_factors_mental |> 
  select(-1) |> 
  gt() |> 
  tab_spanner(label = "Subgroup analyses", columns = c("Moderator", "studies", "effects")) |> 
  tab_spanner(label = "Unadjusted effects", columns = contains("No")) |> 
  tab_spanner(label = "Covariate-adjusted effects", columns = contains("Yes")) |> 
  cols_label(
    studies = "Studes",
    effects = "Effects",
    avg_effect_ci_No  = html("Est [95% CI]<br>F stats"),
    pval_No = "Sig.",
    df_satt_No = "Satt. df",
    SD_total_No = "SD total",
    avg_effect_ci_Yes  = html("Est [95% CI]<br>F stats"),
    pval_Yes = "Sig.",
    df_satt_Yes = "Satt. df",
    SD_total_Yes = "SD total"
  ) |> 
    sub_missing(
    columns = everything(),   
    missing_text = ""         
  ); main_res_table_mental

#main_res_table_mental |> gtsave("Tables/main_res_table_mental.docx")

wider_dat_methods_factors_mental <- 
  res_mental |> 
  list_rbind() |> 
  filter(table == "methods") |> 
  select(Characteric:SD_total, controls) |> 
  pivot_wider(names_from = controls, values_from = c(avg_effect_ci:SD_total)) |> 
  relocate(contains("no",  ignore.case = TRUE), .after = effects) |>          
  relocate(contains("yes", ignore.case = TRUE), .after = last_col())


methods_res_table_mental <- 
  wider_dat_methods_factors_mental |> 
  select(-1) |> 
  gt() |> 
  tab_spanner(label = "Subgroup analyses", columns = c("Moderator", "studies", "effects")) |> 
  tab_spanner(label = "Unadjusted effects", columns = contains("No")) |> 
  tab_spanner(label = "Covariate-adjusted effects", columns = contains("Yes")) |> 
  cols_label(
    studies = "Studes",
    effects = "Effects",
    avg_effect_ci_No  = html("Est [95% CI]<br>F stats"),
    pval_No = "Sig.",
    df_satt_No = "Satt. df",
    SD_total_No = "SD total",
    avg_effect_ci_Yes  = html("Est [95% CI]<br>F stats"),
    pval_Yes = "Sig.",
    df_satt_Yes = "Satt. df",
    SD_total_Yes = "SD total"
  ) |>
  sub_missing(
    columns = everything(),   
    missing_text = ""         
  ); methods_res_table_mental

#methods_res_table_mental |> gtsave("Tables/methods_res_table_mental.docx")

```


### PECHE-RVE for meta-regression
## 
```{r}

cor_val <- 0L:10L/10L
cor_val <- cor_val[seq(1, 10L, 2L)]

arg_tbl_contin_mental <- 
  tibble::tibble(
    yi = "gt_pop",
    vi = "vgt_pop",
    
    covars = rep(
      c(
        "age_c", 
        "male_c",
        "sessions_c",
        "duration_c",
        "fu_time_c",
        
        paste0(
          "age_c;male_c;sessions_c;duration_c;fu_time_c;",
          "anxiety;depression;gen_mental;symptoms;schizo_c;",
          "cbt_c;prereg_c;clinical_c;tot_c;qes_c"
        )
      ),
      each = 5),
    
    model = "CHE",
    
    r = rep(cor_val, 6),
    
    type = "Continuous"
  )

es_names <- list("gt", "g", "d", "gt_post")
var_es_names <-  list("vgt", "vg", "vd", "vgt_post")

arg_tbl_alt_es_contin_mental <- 
  map2(es_names, var_es_names, ~ {
    arg_tbl_contin_mental |> 
      filter(r == 0.8) |> 
      mutate(
        yi = .x,
        vi = .y
      )
  } ) |> 
  list_rbind()

arg_tbl_all_contin_mental <- 
  rbind(arg_tbl_contin_mental, arg_tbl_alt_es_contin_mental)



#Model type to replicate with function

rho <- 0.8

V_mat_mental <- 
  metafor::vcalc(
    data = mental_ma_dat,
    vi = vgt_pop, 
    cluster = study,
    type = outcome_time, 
    grp1 = trt_name,
    w1 = N_t, 
    grp2 = control,
    w2 = N_c, 
    rho = rho
  )

male_obj <- 
  metafor::rma.mv(
    gt_pop ~ male_c, 
    V = V_mat_mental, 
    random = ~ 1 | study / esid,
    data = mental_ma_dat,
    sparse = TRUE
  ) |> 
  robust(
    cluster = study, 
    clubSandwich = TRUE
  )




arg_list_tbl_contin_mental <- 
  pmap(.l = arg_tbl_contin_mental, .f = .rma_arg_tbl, data = mental_ma_dat) |> 
  list_rbind() 



continuous_res_mental <- 
  purrr::pmap(
    #subset to main specification
    .l = arg_list_tbl_contin_mental[arg_list_tbl_contin_mental$rho == 0.8,], 
    .f = .PECHE_meta_reg, 
    return_rma_obj = FALSE
    
  ) |> 
  purrr::list_rbind(names_to = "Model") |> 
  dplyr::mutate(
    Model = paste("Model", Model)
  ) |> 
  tidyr::pivot_wider(
    names_from = Model,               
    values_from = Coef
  )  

continuous_res_mental

#rho <- 0.8
#
#V_mat <- 
#  metafor::vcalc(
#    vi = vgt_pop, 
#    cluster = study, 
#    obs = esid, 
#    data = reint_ma_dat, 
#    rho = rho
#  )
#
#all_in_one_obj <- 
#  metafor::rma.mv(
#    arg_list_tbl_contin$formula[26][[1]], 
#    V = V_mat, 
#    random = ~ 1 | study / esid,
#    data = reint_ma_dat,
#    sparse = TRUE
#  ) |> 
#  robust(
#    cluster = study, 
#    clubSandwich = TRUE
#  )






```

```{r making-gt-tables-contin}

mental_contin_res_table <- 
  continuous_res_mental |> 
  gt() |> 
  sub_missing(
    columns = everything(),   
    missing_text = ""         
  ) |> 
  cols_align(align = "left", columns = gt::everything()) |> 
  tab_style(
    style = cell_text(weight = "bold", align = "left"),
    locations = cells_column_labels(columns = gt::everything())
  ) |> 
  tab_style(
    style = cell_borders(sides = "top", color = "black", weight = px(1)),
    locations = list(
      cells_stub(rows  = Moderators == "Study-level SD"),
      cells_body(rows  = Moderators == "Study-level SD")
    )
  )

mental_contin_res_table

#mental_contin_res_table |> gtsave("Tables/mental_contin_res_table.docx")

```












